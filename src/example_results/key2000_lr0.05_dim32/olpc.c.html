<!DOCTYPE html>
<html>
<head>
<style>
span.c {
    background-color: #CCFFCC;
}
span.pc {
    background-color: #FFEEBB;
}
span.w {
    background-color: #FFCCCC;
}
</style>
</head>
<body>
<pre>


<span class="w">#include</span> <span class="w">&lt;linux/kernel.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/init.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/module.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/delay.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux</span><span class="c">/</span><span class="w">i</span><span class="pc">o</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">s</span><span class="pc">t</span><span class="c">ring.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">p</span><span class="c">latform_device.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">o</span><span class="c">f.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">syscore_ops</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">m</span><span class="c">utex.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">olpc</span><span class="pc">-</span><span class="w">e</span><span class="c">c.h&gt;</span>

<span class="c">#include</span> <span class="c">&lt;</span><span class="pc">a</span><span class="c">sm/</span><span class="w">geode</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;</span><span class="pc">a</span><span class="c">sm/</span><span class="w">set</span><span class="c">up.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">o</span><span class="pc">l</span><span class="c">pc.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">olpc_ofw</span><span class="c">.h&gt;</span>

<span class="pc">s</span><span class="c">truct</span> <span class="w">olpc_platform_t</span> <span class="w">olpc_platform_info</span><span class="c">;</span>
<span class="w">E</span><span class="c">XPORT_SYMBOL_GPL(olpc_platform_info);</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="w">ec_wakeup_mask</span><span class="pc">;</span>


<span class="w">#</span><span class="c">define</span> <span class="w">EC_BASE_TIMEOUT</span> <span class="w">2</span><span class="pc">0</span>


<span class="pc">sta</span><span class="c">tic</span> <span class="c">int</span> <span class="w">ec_timeout</span> <span class="pc">=</span> <span class="pc">E</span><span class="c">C_BASE_TIMEOUT</span><span class="pc">;</span>

<span class="c">static</span> <span class="c">int</span> <span class="c">__init</span> <span class="w">olpc_ec_timeout_set</span><span class="c">(</span><span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="c">*</span><span class="pc">s</span><span class="c">tr</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">if</span> <span class="pc">(</span><span class="w">get_option</span><span class="pc">(&amp;</span><span class="w">s</span><span class="c">tr</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">e</span><span class="c">c_timeout</span><span class="pc">) !</span><span class="c">=</span> <span class="pc">1) </span><span class="c">{</span>
		<span class="w">e</span><span class="pc">c</span><span class="c">_timeout</span> <span class="c">=</span> <span class="w">E</span><span class="c">C_BASE_TIMEOUT;</span>
		<span class="w">p</span><span class="c">rintk(</span><span class="pc">KERN_E</span><span class="c">RR</span> <span class="c">"</span><span class="w">olpc</span><span class="pc">-</span><span class="w">ec:</span>  <span class="w">i</span><span class="pc">nv</span><span class="c">alid</span> <span class="w">argument</span> <span class="w">t</span><span class="c">o</span> <span class="pc">"</span>
				<span class="w">"'olpc_ec_timeout=',</span> <span class="w">ignoring</span><span class="pc">!</span><span class="c">\n");</span>
	<span class="pc">}</span>
	<span class="w">p</span><span class="c">rintk(</span><span class="pc">KERN_D</span><span class="c">EBUG</span> <span class="c">"</span><span class="w">o</span><span class="c">lpc</span><span class="pc">-</span><span class="w">ec:</span>  <span class="w">using</span> <span class="w">%</span><span class="c">d</span> <span class="w">m</span><span class="pc">s</span> <span class="w">del</span><span class="pc">a</span><span class="c">y</span> <span class="w">f</span><span class="c">or</span> <span class="w">EC</span> <span class="w">commands</span><span class="pc">.</span><span class="c">\n",</span>
			<span class="w">ec_timeout</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">1</span><span class="c">;</span>
<span class="c">}</span>
<span class="w">__setup(</span><span class="pc">"</span><span class="w">o</span><span class="pc">lpc_</span><span class="c">ec_timeout</span><span class="w">=",</span> <span class="w">olpc_ec_timeout_set)</span><span class="c">;</span>



<span class="w">s</span><span class="c">tatic</span> <span class="pc">inl</span><span class="c">ine</span> <span class="pc">un</span><span class="c">signed</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">ibf_status</span><span class="c">(</span><span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">p</span><span class="c">ort</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">return</span> <span class="w">!!(inb</span><span class="c">(</span><span class="w">p</span><span class="pc">o</span><span class="c">rt</span><span class="w">)</span><span class="pc"> &amp;</span> <span class="w">0</span><span class="pc">x0</span><span class="c">2</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">inline</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">obf_status</span><span class="c">(</span><span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="pc">p</span><span class="c">ort</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">return</span> <span class="w">i</span><span class="pc">n</span><span class="c">b(port</span><span class="w">)</span><span class="pc"> &amp;</span> <span class="pc">0</span><span class="c">x01</span><span class="pc">;</span>
<span class="c">}</span>

<span class="c">#</span><span class="pc">d</span><span class="c">efine</span> <span class="w">wait_on_ibf</span><span class="c">(</span><span class="pc">p,</span> <span class="w">d</span><span class="pc">)</span> <span class="w">__wait_on_ibf</span><span class="c">(</span><span class="w">__L</span><span class="c">INE__</span><span class="pc">, </span><span class="c">(p</span><span class="w">)</span><span class="pc">,</span><span class="c"> (</span><span class="w">d</span><span class="pc">))</span>
<span class="pc">s</span><span class="c">tatic</span> <span class="pc">int</span> <span class="w">_</span><span class="pc">_w</span><span class="c">ait_on_ibf(</span><span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">li</span><span class="c">ne</span><span class="pc">,</span> <span class="c">unsigned</span> <span class="c">int</span> <span class="w">p</span><span class="c">ort,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">desired</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">unsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">timeo</span><span class="pc">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">st</span><span class="pc">ate</span> <span class="pc">=</span> <span class="w">ibf_status</span><span class="pc">(</span><span class="c">port);</span>

	<span class="w">f</span><span class="c">or</span> <span class="c">(</span><span class="w">t</span><span class="c">imeo</span> <span class="c">=</span> <span class="w">ec_timeout</span><span class="pc">;</span> <span class="w">st</span><span class="pc">ate</span> <span class="w">!</span><span class="c">=</span> <span class="w">d</span><span class="pc">esi</span><span class="c">red</span> <span class="w">&amp;</span><span class="c">&amp;</span> <span class="c">timeo</span><span class="pc">;</span> <span class="pc">t</span><span class="c">imeo</span><span class="w">-</span><span class="pc">-</span><span class="c">) {</span>
		<span class="w">md</span><span class="pc">e</span><span class="c">lay(</span><span class="pc">1</span><span class="c">);</span>
		<span class="w">s</span><span class="pc">t</span><span class="c">ate</span> <span class="c">=</span> <span class="pc">ib</span><span class="c">f_status</span><span class="pc">(p</span><span class="c">ort);</span>
	<span class="pc">}</span>

	<span class="w">i</span><span class="c">f</span> <span class="pc">((</span><span class="w">s</span><span class="pc">tate</span> <span class="pc">=</span><span class="c">=</span> <span class="w">d</span><span class="c">esired</span><span class="pc">) &amp;</span><span class="c">&amp; (</span><span class="pc">e</span><span class="c">c_timeout</span> <span class="pc">&gt;</span> <span class="w">EC_BASE_TIMEOUT</span><span class="c">) &amp;&amp;</span>
			<span class="pc">t</span><span class="c">imeo</span> <span class="w">&lt; </span><span class="c">(ec_timeout</span> <span class="w">-</span> <span class="w">E</span><span class="c">C_BASE_TIMEOUT</span><span class="w">))</span><span class="pc"> </span><span class="c">{</span>
		<span class="w">p</span><span class="c">rintk(</span><span class="pc">KERN_W</span><span class="c">ARNING</span> <span class="c">"</span><span class="w">olpc-ec:  %d:</span> <span class="w">waited</span> <span class="w">%</span><span class="pc">u</span> <span class="w">ms</span> <span class="w">fo</span><span class="pc">r</span> <span class="w">IBF!</span><span class="c">\n",</span>
				<span class="w">lin</span><span class="pc">e,</span> <span class="c">ec_timeout</span> <span class="w">-</span> <span class="pc">t</span><span class="c">imeo</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">!</span><span class="pc">(</span><span class="w">s</span><span class="c">tate</span> <span class="w">=</span><span class="pc">=</span> <span class="w">desired)</span><span class="pc">;</span>
<span class="c">}</span>

<span class="pc">#</span><span class="c">define</span> <span class="w">wait_on_obf</span><span class="c">(</span><span class="w">p</span><span class="c">,</span> <span class="w">d</span><span class="pc">)</span> <span class="w">__wait_on_obf</span><span class="c">(</span><span class="w">__L</span><span class="c">INE__</span><span class="w">,</span><span class="pc"> (p</span><span class="w">),</span><span class="pc"> </span><span class="c">(</span><span class="w">d</span><span class="pc">))</span>
<span class="pc">s</span><span class="c">tatic</span> <span class="pc">int</span> <span class="w">_</span><span class="pc">_w</span><span class="c">ait_on_obf(</span><span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">li</span><span class="c">ne</span><span class="pc">,</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">p</span><span class="pc">o</span><span class="c">rt,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">d</span><span class="c">esired</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">unsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">timeo</span><span class="pc">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">st</span><span class="pc">ate</span> <span class="pc">=</span> <span class="w">obf_status</span><span class="pc">(</span><span class="c">port);</span>

	<span class="w">f</span><span class="c">or</span> <span class="c">(</span><span class="w">t</span><span class="c">imeo</span> <span class="c">=</span> <span class="w">ec_timeout</span><span class="pc">;</span> <span class="w">st</span><span class="pc">ate</span> <span class="w">!</span><span class="c">=</span> <span class="w">d</span><span class="pc">esi</span><span class="c">red</span> <span class="w">&amp;</span><span class="c">&amp;</span> <span class="c">timeo</span><span class="pc">;</span> <span class="pc">t</span><span class="c">imeo</span><span class="w">-</span><span class="pc">-</span><span class="c">) {</span>
		<span class="w">md</span><span class="pc">e</span><span class="c">lay(</span><span class="pc">1</span><span class="c">);</span>
		<span class="w">s</span><span class="pc">t</span><span class="c">ate</span> <span class="c">=</span> <span class="pc">o</span><span class="c">bf_status</span><span class="pc">(p</span><span class="c">ort);</span>
	<span class="pc">}</span>

	<span class="w">i</span><span class="c">f</span> <span class="pc">((</span><span class="w">s</span><span class="pc">tate</span> <span class="pc">=</span><span class="c">=</span> <span class="w">d</span><span class="c">esired</span><span class="pc">) &amp;</span><span class="c">&amp; (</span><span class="pc">e</span><span class="c">c_timeout</span> <span class="pc">&gt;</span> <span class="w">EC_BASE_TIMEOUT</span><span class="c">) &amp;&amp;</span>
			<span class="pc">t</span><span class="c">imeo</span> <span class="w">&lt; </span><span class="c">(ec_timeout</span> <span class="w">-</span> <span class="w">E</span><span class="c">C_BASE_TIMEOUT</span><span class="w">))</span><span class="pc"> </span><span class="c">{</span>
		<span class="w">p</span><span class="c">rintk(</span><span class="pc">KERN_W</span><span class="c">ARNING</span> <span class="c">"</span><span class="w">olpc-ec:  %d:</span> <span class="w">waited</span> <span class="w">%</span><span class="pc">u</span> <span class="w">ms</span> <span class="w">fo</span><span class="pc">r</span> <span class="w">OBF!</span><span class="c">\n",</span>
				<span class="w">lin</span><span class="pc">e,</span> <span class="c">ec_timeout</span> <span class="w">-</span> <span class="pc">t</span><span class="c">imeo</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">!</span><span class="pc">(</span><span class="w">s</span><span class="c">tate</span> <span class="w">=</span><span class="pc">=</span> <span class="w">desired)</span><span class="pc">;</span>
<span class="c">}</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="c">int</span> <span class="w">olpc_xo1_ec_cmd</span><span class="c">(</span><span class="w">u</span><span class="pc">8</span> <span class="w">c</span><span class="pc">m</span><span class="c">d,</span> <span class="c">u8</span> <span class="c">*</span><span class="w">inbuf</span><span class="c">,</span> <span class="w">s</span><span class="pc">i</span><span class="c">ze_t</span> <span class="w">inlen</span><span class="c">,</span> <span class="c">u8</span> <span class="c">*</span><span class="w">outbuf</span><span class="c">,</span>
		<span class="w">s</span><span class="pc">i</span><span class="c">ze_t</span> <span class="w">outlen</span><span class="c">,</span> <span class="w">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">a</span><span class="pc">r</span><span class="c">g</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">ret</span> <span class="pc">= </span><span class="c">-</span><span class="w">E</span><span class="pc">IO</span><span class="c">;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="pc">i;</span>
	<span class="c">int</span> <span class="w">restarts</span> <span class="pc">=</span> <span class="c">0;</span>

	
	<span class="w">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">1</span><span class="pc">0</span> <span class="w">&amp;</span><span class="pc">&amp; </span><span class="c">(</span><span class="w">obf_status</span><span class="c">(</span><span class="w">0x6</span><span class="pc">c</span><span class="w">) =</span><span class="c">=</span> <span class="pc">1</span><span class="w">);</span> <span class="pc">i++)</span>
		<span class="w">i</span><span class="pc">n</span><span class="c">b(</span><span class="w">0x6</span><span class="pc">8)</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">i</span> <span class="pc">=</span><span class="c">=</span> <span class="w">1</span><span class="pc">0</span><span class="c">) {</span>
		<span class="c">printk(</span><span class="pc">KERN_E</span><span class="c">RR</span> <span class="c">"</span><span class="w">olpc</span><span class="pc">-</span><span class="w">e</span><span class="pc">c</span><span class="w">:</span>  <span class="w">ti</span><span class="pc">meo</span><span class="c">ut</span> <span class="w">wh</span><span class="c">ile</span> <span class="w">attempting</span> <span class="w">t</span><span class="c">o</span> <span class="w">"</span>
				<span class="pc">"</span><span class="w">cl</span><span class="pc">e</span><span class="c">ar</span> <span class="w">OBF</span> <span class="w">fl</span><span class="pc">ag</span><span class="w">!</span><span class="c">\n");</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">e</span><span class="pc">rr</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">wait_on_ibf</span><span class="c">(</span><span class="w">0x6</span><span class="pc">c</span><span class="c">,</span> <span class="c">0</span><span class="pc">))</span><span class="c"> {</span>
		<span class="c">printk(KERN_ERR</span> <span class="c">"</span><span class="pc">o</span><span class="c">lpc</span><span class="pc">-</span><span class="w">ec</span><span class="pc">:</span>  <span class="w">t</span><span class="pc">i</span><span class="c">meout</span> <span class="w">waiting</span> <span class="w">f</span><span class="pc">o</span><span class="c">r</span> <span class="w">EC</span> <span class="w">t</span><span class="c">o</span> <span class="w">"</span>
				<span class="c">"</span><span class="w">quiesce!</span><span class="c">\n");</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="pc">er</span><span class="c">r;</span>
	<span class="c">}</span>

<span class="w">restart:</span>
	
	<span class="w">pr_devel(</span><span class="pc">"</span><span class="w">o</span><span class="pc">l</span><span class="c">pc</span><span class="pc">-</span><span class="w">ec:</span>  <span class="w">running</span> <span class="w">cm</span><span class="c">d</span> <span class="pc">0</span><span class="c">x%</span><span class="w">x</span><span class="c">\n",</span> <span class="w">c</span><span class="pc">m</span><span class="c">d);</span>
	<span class="w">o</span><span class="pc">utb</span><span class="c">(</span><span class="w">c</span><span class="pc">m</span><span class="c">d,</span> <span class="w">0x6c</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">wait_on_ibf</span><span class="c">(</span><span class="w">0x6c</span><span class="c">,</span> <span class="c">0</span><span class="pc">)) </span><span class="c">{</span>
		<span class="pc">p</span><span class="c">rintk(</span><span class="pc">KERN_E</span><span class="c">RR</span> <span class="c">"</span><span class="w">o</span><span class="c">lpc</span><span class="pc">-</span><span class="w">ec</span><span class="pc">:</span>  <span class="w">t</span><span class="c">imeout</span> <span class="w">waiting</span> <span class="w">f</span><span class="c">or</span> <span class="w">EC</span> <span class="w">t</span><span class="c">o</span> <span class="pc">r</span><span class="c">ead</span> <span class="w">"</span>
				<span class="w">"co</span><span class="pc">mm</span><span class="c">and</span><span class="w">!</span><span class="c">\n</span><span class="pc">")</span><span class="c">;</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">e</span><span class="pc">rr</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">inbuf</span> <span class="w">&amp;</span><span class="c">&amp;</span> <span class="w">inlen)</span><span class="c"> {</span>
		
		<span class="w">f</span><span class="pc">o</span><span class="c">r</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="pc">i</span><span class="c">nlen;</span> <span class="c">i</span><span class="pc">++) </span><span class="c">{</span>
			<span class="w">pr_devel</span><span class="pc">("</span><span class="w">o</span><span class="c">lpc</span><span class="pc">-</span><span class="w">ec:</span>  <span class="w">sending</span> <span class="w">cm</span><span class="c">d</span> <span class="w">ar</span><span class="pc">g</span> <span class="w">0</span><span class="c">x%x\n",</span> <span class="w">i</span><span class="pc">nb</span><span class="c">uf</span><span class="pc">[</span><span class="c">i]);</span>
			<span class="w">o</span><span class="pc">utb</span><span class="c">(</span><span class="w">i</span><span class="pc">nb</span><span class="c">uf</span><span class="pc">[</span><span class="c">i</span><span class="pc">],</span> <span class="w">0x6</span><span class="pc">8)</span><span class="c">;</span>
			<span class="pc">if</span> <span class="c">(</span><span class="w">wait_on_ibf</span><span class="pc">(</span><span class="w">0x6</span><span class="pc">c</span><span class="c">,</span> <span class="pc">0))</span><span class="c"> {</span>
				<span class="c">printk(KERN_ERR</span> <span class="c">"</span><span class="w">o</span><span class="c">lpc</span><span class="pc">-</span><span class="w">ec</span><span class="c">:</span>  <span class="w">ti</span><span class="c">meout</span> <span class="w">waiting</span> <span class="w">f</span><span class="c">or</span><span class="w">"</span>
						<span class="w">"</span> <span class="w">EC</span> <span class="w">accept</span> <span class="w">da</span><span class="c">ta</span><span class="w">!</span><span class="c">\n</span><span class="pc">")</span><span class="c">;</span>
				<span class="pc">g</span><span class="c">oto</span> <span class="w">e</span><span class="pc">r</span><span class="c">r;</span>
			<span class="c">}</span>
		<span class="c">}</span>
	<span class="c">}</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">outbuf</span> <span class="w">&amp;</span><span class="c">&amp;</span> <span class="w">outlen</span><span class="pc">)</span><span class="c"> {</span>
		
		<span class="w">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="pc">o</span><span class="c">utlen;</span> <span class="c">i</span><span class="pc">++) </span><span class="c">{</span>
			<span class="c">if</span> <span class="c">(</span><span class="w">wait_on_obf</span><span class="pc">(</span><span class="w">0x6c</span><span class="c">,</span> <span class="w">1</span><span class="pc">))</span><span class="c"> {</span>
				<span class="pc">p</span><span class="c">rintk(KERN_ERR</span> <span class="c">"</span><span class="w">olpc</span><span class="pc">-</span><span class="w">ec</span><span class="pc">:</span>  <span class="w">t</span><span class="pc">i</span><span class="c">meout</span> <span class="w">waiting</span> <span class="w">f</span><span class="c">or</span><span class="w">"</span>
						<span class="w">"</span> <span class="w">EC</span> <span class="w">t</span><span class="c">o</span> <span class="w">provide</span> <span class="w">da</span><span class="c">ta</span><span class="w">!</span><span class="c">\n");</span>
				<span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="w">restarts++ &lt;</span> <span class="w">1</span><span class="pc">0)</span>
					<span class="pc">g</span><span class="c">oto</span> <span class="w">restart</span><span class="c">;</span>
				<span class="w">g</span><span class="c">oto</span> <span class="w">e</span><span class="pc">rr</span><span class="c">;</span>
			<span class="c">}</span>
			<span class="w">outbuf[</span><span class="c">i</span><span class="pc">] </span><span class="c">=</span> <span class="w">inb</span><span class="c">(</span><span class="w">0x6</span><span class="pc">8)</span><span class="c">;</span>
			<span class="w">pr_devel(</span><span class="pc">"ol</span><span class="c">pc</span><span class="w">-ec:</span>  <span class="w">received</span> <span class="w">0</span><span class="c">x%x\n",</span> <span class="pc">o</span><span class="c">utbuf</span><span class="pc">[</span><span class="c">i</span><span class="pc">])</span><span class="c">;</span>
		<span class="pc">}</span>
	<span class="w">}</span>

	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
<span class="w">e</span><span class="c">rr</span><span class="pc">:</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">r</span><span class="c">et;</span>
<span class="c">}</span>

<span class="w">v</span><span class="c">oid</span> <span class="w">olpc_ec_wakeup_set</span><span class="c">(</span><span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">ec_wakeup_mask</span> <span class="w">|</span><span class="pc">=</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e;</span>
<span class="c">}</span>
<span class="w">E</span><span class="pc">XPORT_SYMBOL_</span><span class="c">GPL(</span><span class="w">o</span><span class="pc">l</span><span class="c">pc_ec_wakeup_set);</span>

<span class="pc">v</span><span class="c">oid</span> <span class="w">olpc_ec_wakeup_clear</span><span class="c">(</span><span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="pc">v</span><span class="c">alue</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">e</span><span class="c">c_wakeup_mask</span> <span class="w">&amp;</span><span class="c">= ~</span><span class="w">v</span><span class="pc">alu</span><span class="c">e;</span>
<span class="c">}</span>
<span class="w">E</span><span class="pc">XPORT_SYMBOL_</span><span class="c">GPL(</span><span class="w">o</span><span class="pc">lpc_ec_wakeup_c</span><span class="c">lear);</span>


<span class="w">b</span><span class="c">ool</span> <span class="w">olpc_ec_wakeup_available</span><span class="c">(</span><span class="pc">v</span><span class="c">oid</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">i</span><span class="pc">f</span> <span class="pc">(!</span><span class="w">machine_is_olpc</span><span class="pc">()</span><span class="c">)</span>
		<span class="c">return</span> <span class="w">f</span><span class="c">alse;</span>

	
<span class="w">#</span><span class="c">ifdef</span> <span class="w">CONFIG_OLPC_XO1_SCI</span>
	<span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="w">olpc_platform_info.boardrev</span> <span class="w">&lt;</span> <span class="w">olpc_board_pre(0xd0</span><span class="c">))</span> 
		<span class="c">return</span> <span class="pc">t</span><span class="c">rue;</span>
<span class="w">#</span><span class="c">endif</span>

	
<span class="pc">#</span><span class="c">ifdef</span> <span class="w">CONFIG_OLPC_XO15_SCI</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">o</span><span class="c">lpc_platform_info</span><span class="pc">.b</span><span class="c">oardrev</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="pc">o</span><span class="c">lpc_board_pre</span><span class="w">(</span><span class="pc">0</span><span class="c">xd0</span><span class="pc">))</span> 
		<span class="c">return</span> <span class="w">t</span><span class="c">rue;</span>
<span class="w">#</span><span class="c">endif</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">f</span><span class="c">alse;</span>
<span class="c">}</span>
<span class="w">E</span><span class="pc">XPORT_SYMBOL_</span><span class="c">GPL(</span><span class="w">olpc_ec_wakeup_available</span><span class="c">);</span>

<span class="pc">i</span><span class="c">nt</span> <span class="w">olpc_ec_mask_write</span><span class="c">(</span><span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="w">bi</span><span class="pc">ts)</span>
<span class="c">{</span>
	<span class="pc">if</span> <span class="c">(</span><span class="pc">olpc_p</span><span class="c">latform_info</span><span class="w">.</span><span class="pc">f</span><span class="c">lags</span> <span class="pc">&amp;</span> <span class="w">OLPC_F_EC_WIDE_SCI</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">_</span><span class="pc">_be1</span><span class="c">6</span> <span class="w">ec_word</span> <span class="c">=</span> <span class="w">cp</span><span class="pc">u_to_be1</span><span class="c">6(</span><span class="w">bi</span><span class="pc">t</span><span class="c">s);</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">olpc_ec_cmd</span><span class="pc">(</span><span class="w">EC_WRITE_EXT_SCI_MASK,</span><span class="pc"> (v</span><span class="c">oid</span> <span class="w">*)</span><span class="pc"> </span><span class="c">&amp;</span><span class="pc">e</span><span class="c">c_word,</span> <span class="w">2</span><span class="c">,</span>
				   <span class="w">N</span><span class="c">ULL,</span> <span class="c">0</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span> <span class="w">e</span><span class="c">lse</span> <span class="c">{</span>
		<span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="pc">c</span><span class="c">har</span> <span class="w">ec_byte</span> <span class="pc">=</span> <span class="w">bi</span><span class="c">ts</span> <span class="w">&amp;</span> <span class="w">0</span><span class="pc">xf</span><span class="c">f;</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">o</span><span class="pc">lpc_e</span><span class="c">c_cmd</span><span class="pc">(</span><span class="w">EC_WRITE_SCI_MASK</span><span class="pc">, </span><span class="c">&amp;ec_byte,</span> <span class="w">1</span><span class="pc">,</span> <span class="pc">N</span><span class="c">ULL</span><span class="pc">,</span> <span class="pc">0</span><span class="c">);</span>
	<span class="c">}</span>
<span class="w">}</span>
<span class="w">E</span><span class="pc">X</span><span class="c">PORT_SYMBOL_GPL(</span><span class="w">olpc_ec_mask_write</span><span class="c">);</span>

<span class="pc">i</span><span class="c">nt</span> <span class="w">olpc_ec_sci_query</span><span class="c">(</span><span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="c">*</span><span class="w">sci_value</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">r</span><span class="c">et</span><span class="pc">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">olpc_platform_info.f</span><span class="c">lags</span> <span class="c">&amp;</span> <span class="w">OLPC_F_EC_WIDE_SCI</span><span class="c">) {</span>
		<span class="w">_</span><span class="pc">_be1</span><span class="c">6</span> <span class="w">ec_word</span><span class="pc">;</span>
		<span class="w">r</span><span class="c">et</span> <span class="c">=</span> <span class="w">olpc_ec_cmd</span><span class="c">(</span><span class="w">EC_EXT_SCI_QUERY</span><span class="c">,</span>
			<span class="w">N</span><span class="c">ULL</span><span class="pc">,</span> <span class="c">0</span><span class="w">,</span><span class="pc"> (</span><span class="c">void</span> <span class="w">*)</span><span class="pc"> </span><span class="c">&amp;</span><span class="w">e</span><span class="pc">c</span><span class="c">_word,</span> <span class="w">2</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(ret</span> <span class="pc">=</span><span class="c">=</span> <span class="c">0)</span>
			<span class="w">*s</span><span class="pc">c</span><span class="c">i_value</span> <span class="pc">=</span> <span class="w">be16_to_cpu</span><span class="c">(</span><span class="w">e</span><span class="c">c_word</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">}</span> <span class="c">else</span> <span class="pc">{</span>
		<span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="pc">c</span><span class="c">har</span> <span class="w">ec_byte</span><span class="pc">;</span>
		<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">o</span><span class="c">lpc_ec_cmd(</span><span class="w">EC_SCI_QUERY</span><span class="c">,</span> <span class="w">N</span><span class="c">ULL,</span> <span class="c">0</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">e</span><span class="c">c_byte</span><span class="pc">,</span> <span class="pc">1)</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(ret</span> <span class="pc">=</span><span class="c">=</span> <span class="c">0</span><span class="pc">)</span>
			<span class="w">*s</span><span class="pc">c</span><span class="c">i_value</span> <span class="pc">=</span> <span class="pc">e</span><span class="c">c_byte</span><span class="pc">;</span>
	<span class="w">}</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">r</span><span class="c">et;</span>
<span class="c">}</span>
<span class="w">E</span><span class="pc">XPORT_SYMBOL_</span><span class="c">GPL(</span><span class="w">olpc_ec_sci_query</span><span class="c">);</span>

<span class="pc">sta</span><span class="c">tic</span> <span class="w">b</span><span class="c">ool</span> <span class="c">__init</span> <span class="w">check_ofw_architecture</span><span class="c">(</span><span class="pc">s</span><span class="c">truct</span> <span class="c">device_node</span> <span class="c">*</span><span class="w">ro</span><span class="c">ot)</span>
<span class="c">{</span>
	<span class="pc">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="w">olpc_arch</span><span class="c">;</span>
	<span class="c">int</span> <span class="w">propsize</span><span class="c">;</span>

	<span class="w">o</span><span class="c">lpc_arch</span> <span class="c">=</span> <span class="w">of_get_property</span><span class="c">(</span><span class="w">r</span><span class="pc">o</span><span class="c">ot</span><span class="w">,</span><span class="pc"> "</span><span class="w">architecture"</span><span class="pc">, &amp;p</span><span class="c">ropsize);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">p</span><span class="c">ropsize</span> <span class="w">=</span><span class="pc">=</span> <span class="w">5</span> <span class="w">&amp;</span><span class="c">&amp;</span> <span class="w">strn</span><span class="c">cmp</span><span class="w">(</span><span class="pc">"</span><span class="w">OLPC</span><span class="pc">"</span><span class="c">,</span> <span class="pc">o</span><span class="c">lpc_arch,</span> <span class="w">5) =</span><span class="c">=</span> <span class="c">0</span><span class="w">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="c">__init</span> <span class="w">get_board_revision</span><span class="c">(</span><span class="pc">s</span><span class="c">truct</span> <span class="c">device_node</span> <span class="c">*</span><span class="w">ro</span><span class="c">ot)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">p</span><span class="c">ropsize</span><span class="pc">;</span>
	<span class="w">c</span><span class="pc">o</span><span class="c">nst</span> <span class="w">_</span><span class="pc">_b</span><span class="c">e32</span> <span class="c">*</span><span class="w">rev</span><span class="c">;</span>

	<span class="w">rev</span> <span class="c">=</span> <span class="w">of_get_property</span><span class="c">(</span><span class="w">ro</span><span class="c">ot</span><span class="pc">, "</span><span class="w">bo</span><span class="pc">a</span><span class="c">rd</span><span class="w">-rev</span><span class="pc">i</span><span class="c">sion-</span><span class="w">int</span><span class="c">", &amp;</span><span class="pc">p</span><span class="c">ropsize);</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">p</span><span class="c">ropsize</span> <span class="w">!</span><span class="c">=</span> <span class="w">4</span><span class="c">)</span>
		<span class="c">return</span> <span class="w">0</span><span class="c">;</span>

	<span class="c">return</span> <span class="w">be</span><span class="c">32_to_cpu</span><span class="pc">(*</span><span class="w">rev)</span><span class="pc">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="w">b</span><span class="c">ool</span> <span class="c">__init</span> <span class="w">platform_detect</span><span class="c">(void)</span>
<span class="c">{</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="c">device_node</span> <span class="c">*</span><span class="w">ro</span><span class="c">ot</span> <span class="c">=</span> <span class="w">of_find_node_by_path("/");</span>
	<span class="w">b</span><span class="pc">o</span><span class="c">ol</span> <span class="w">success</span><span class="pc">;</span>

	<span class="w">i</span><span class="pc">f</span> <span class="c">(!</span><span class="w">ro</span><span class="c">ot)</span>
		<span class="c">return</span> <span class="w">f</span><span class="c">alse;</span>

	<span class="w">s</span><span class="c">uccess</span> <span class="c">=</span> <span class="w">check_ofw_architecture</span><span class="c">(</span><span class="w">ro</span><span class="c">ot</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">s</span><span class="c">uccess</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">olpc_platform_info.boardrev</span> <span class="c">=</span> <span class="w">get_board_revision</span><span class="pc">(</span><span class="w">ro</span><span class="c">ot</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">o</span><span class="c">lpc_platform_info</span><span class="pc">.f</span><span class="c">lags</span> <span class="pc">|</span><span class="c">=</span> <span class="w">OLPC_F_PRESENT</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">of_node_put</span><span class="pc">(</span><span class="w">ro</span><span class="c">ot);</span>
	<span class="w">r</span><span class="c">eturn</span> <span class="w">s</span><span class="c">uccess;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="c">__init</span> <span class="w">add_xo1_platform_devices</span><span class="c">(void)</span>
<span class="c">{</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">p</span><span class="pc">l</span><span class="c">atform_device</span> <span class="c">*pdev;</span>

	<span class="w">p</span><span class="pc">d</span><span class="c">ev</span> <span class="pc">=</span> <span class="w">platform_device_register_simple(</span><span class="pc">"</span><span class="w">xo1-rfkill", -1,</span> <span class="w">N</span><span class="c">ULL</span><span class="pc">,</span> <span class="c">0);</span>
	<span class="c">if</span> <span class="c">(IS_ERR(</span><span class="pc">p</span><span class="c">dev</span><span class="pc">))</span>
		<span class="c">return</span> <span class="c">PTR_ERR(</span><span class="w">p</span><span class="pc">d</span><span class="c">ev);</span>

	<span class="w">p</span><span class="pc">d</span><span class="c">ev</span> <span class="pc">=</span> <span class="w">p</span><span class="pc">l</span><span class="c">atform_device_register_simple</span><span class="w">(</span><span class="pc">"</span><span class="w">olpc</span><span class="pc">-</span><span class="w">x</span><span class="c">o1</span><span class="w">",</span><span class="pc"> -</span><span class="w">1,</span> <span class="w">N</span><span class="c">ULL</span><span class="pc">,</span> <span class="c">0);</span>
	<span class="c">if</span> <span class="c">(IS_ERR(</span><span class="pc">p</span><span class="c">dev</span><span class="pc">))</span>
		<span class="c">return</span> <span class="c">PTR_ERR(</span><span class="w">p</span><span class="pc">de</span><span class="c">v);</span>

	<span class="c">return</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">olpc_xo1_ec_probe</span><span class="c">(struct</span> <span class="c">platform_device</span> <span class="c">*pdev)</span>
<span class="c">{</span>
	
	<span class="w">olpc_ec_cmd</span><span class="c">(</span><span class="w">EC_FIRMWARE_REV</span><span class="c">,</span> <span class="pc">N</span><span class="c">ULL</span><span class="pc">,</span> <span class="c">0</span><span class="pc">,</span>
			<span class="w">(</span><span class="pc">u</span><span class="c">nsigned</span> <span class="pc">c</span><span class="c">har</span> <span class="w">*)</span><span class="pc"> </span><span class="c">&amp;</span><span class="w">olpc_platform_info.ecver</span><span class="c">,</span> <span class="w">1</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="c">if</span> <span class="c">(</span><span class="pc">o</span><span class="c">lpc_platform_info</span><span class="w">.</span><span class="pc">e</span><span class="c">cver</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="w">0x5f</span><span class="c">)</span>
		<span class="pc">o</span><span class="c">lpc_platform_info</span><span class="pc">.</span><span class="w">f</span><span class="c">lags</span> <span class="pc">|</span><span class="c">=</span> <span class="w">OLPC_F_EC_WIDE_SCI</span><span class="c">;</span>

	<span class="w">pr</span><span class="pc">_i</span><span class="c">nfo("</span><span class="w">OLPC</span> <span class="w">b</span><span class="pc">o</span><span class="c">ard</span> <span class="w">rev</span><span class="c">ision</span> <span class="pc">%s%</span><span class="w">X</span> <span class="w">(EC</span><span class="c">=%</span><span class="w">x</span><span class="pc">)</span><span class="c">\n",</span>
			<span class="w">(</span><span class="pc">(o</span><span class="c">lpc_platform_info</span><span class="w">.boardrev</span> <span class="w">&amp;</span> <span class="w">0xf) &lt;</span> <span class="w">8) </span><span class="pc">? </span><span class="c">"</span><span class="w">pre" : "",</span>
			<span class="w">o</span><span class="c">lpc_platform_info.boardrev</span> <span class="w">&gt;</span><span class="pc">&gt;</span> <span class="w">4</span><span class="pc">,</span>
			<span class="pc">o</span><span class="c">lpc_platform_info</span><span class="pc">.</span><span class="w">ecver</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>
<span class="c">static</span> <span class="c">int</span> <span class="w">olpc_xo1_ec_suspend</span><span class="c">(struct</span> <span class="pc">p</span><span class="c">latform_device</span> <span class="c">*pdev</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">olpc_ec_mask_write</span><span class="c">(</span><span class="w">ec_wakeup_mask</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">olpc_ec_cmd</span><span class="c">(</span><span class="w">EC_SET_SCI_INHIBIT</span><span class="pc">,</span> <span class="w">N</span><span class="c">ULL,</span> <span class="c">0</span><span class="pc">,</span> <span class="c">NULL</span><span class="pc">,</span> <span class="pc">0</span><span class="c">);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">olpc_xo1_ec_resume</span><span class="c">(struct</span> <span class="w">p</span><span class="c">latform_device</span> <span class="c">*pdev)</span>
<span class="c">{</span>
	
	<span class="w">o</span><span class="pc">lpc_ec_c</span><span class="c">md(</span><span class="w">EC_SET_SCI_INHIBIT_RELEASE</span><span class="c">,</span> <span class="w">N</span><span class="c">ULL,</span> <span class="c">0</span><span class="pc">,</span> <span class="pc">N</span><span class="c">ULL</span><span class="pc">,</span> <span class="c">0);</span>

	
	<span class="w">o</span><span class="pc">lpc_ec_c</span><span class="c">md(</span><span class="w">EC_WAKE_UP_WLAN</span><span class="c">,</span> <span class="pc">N</span><span class="c">ULL,</span> <span class="c">0</span><span class="pc">,</span> <span class="pc">N</span><span class="c">ULL</span><span class="pc">,</span> <span class="c">0</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">o</span><span class="c">lpc_ec_cmd(</span><span class="w">E</span><span class="pc">C_W</span><span class="c">AKE_UP_WLAN,</span> <span class="pc">N</span><span class="c">ULL,</span> <span class="pc">0</span><span class="c">,</span> <span class="pc">N</span><span class="c">ULL,</span> <span class="c">0</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">olpc_ec_driver</span> <span class="w">ec_xo1_driver</span> <span class="c">= {</span>
	<span class="c">.probe</span> <span class="c">=</span> <span class="w">olpc_xo1_ec_probe</span><span class="c">,</span>
	<span class="c">.</span><span class="w">s</span><span class="pc">u</span><span class="c">spend</span> <span class="c">=</span> <span class="w">olpc_xo1_ec_suspend</span><span class="c">,</span>
	<span class="c">.</span><span class="pc">r</span><span class="c">esume</span> <span class="c">=</span> <span class="w">olpc_xo1_ec_resume</span><span class="c">,</span>
	<span class="c">.</span><span class="w">ec_cmd</span> <span class="c">=</span> <span class="w">olpc_xo1_ec_cmd</span><span class="c">,</span>
<span class="pc">}</span><span class="c">;</span>

<span class="c">static</span> <span class="pc">s</span><span class="c">truct</span> <span class="pc">o</span><span class="c">lpc_ec_driver</span> <span class="w">ec_xo1_5_driver</span> <span class="c">= {</span>
	<span class="c">.</span><span class="w">p</span><span class="c">robe</span> <span class="c">=</span> <span class="pc">olpc_xo1_ec_p</span><span class="c">robe,</span>
	<span class="c">.</span><span class="pc">e</span><span class="c">c_cmd</span> <span class="c">=</span> <span class="pc">o</span><span class="c">lpc_xo1_ec_cmd,</span>
<span class="pc">}</span><span class="c">;</span>

<span class="c">static</span> <span class="c">int</span> <span class="c">__init</span> <span class="w">olpc_init</span><span class="c">(void)</span>
<span class="c">{</span>
	<span class="c">int</span> <span class="w">r</span> <span class="c">=</span> <span class="c">0;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">olpc_ofw_present() || !platform_detect()</span><span class="pc">)</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">olpc_platform_info.boardrev</span> <span class="w">&lt;</span> <span class="w">olpc_board_pre(0xd0</span><span class="pc">)</span><span class="c">)</span>	
		<span class="w">olpc_ec_driver_register(</span><span class="pc">&amp;</span><span class="w">ec_xo1_driver</span><span class="pc">,</span> <span class="pc">N</span><span class="c">ULL);</span>
	<span class="pc">e</span><span class="c">lse</span>
		<span class="w">o</span><span class="pc">lpc_e</span><span class="c">c_driver_register</span><span class="w">(&amp;ec_xo1_5_driver</span><span class="pc">,</span> <span class="w">N</span><span class="c">ULL);</span>
	<span class="w">platform_device_register_simple(</span><span class="pc">"</span><span class="w">olpc</span><span class="pc">-</span><span class="w">ec", -1,</span> <span class="w">N</span><span class="c">ULL</span><span class="pc">,</span> <span class="c">0</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="c">if</span> <span class="c">(</span><span class="w">olpc_board_at_least</span><span class="c">(</span><span class="w">olpc_board(0xb1))</span><span class="pc">)</span>
		<span class="w">olpc_platform_info.f</span><span class="pc">lags</span> <span class="pc">|</span><span class="c">=</span> <span class="w">OLPC_F_DCON</span><span class="c">;</span>

<span class="w">#</span><span class="pc">i</span><span class="c">fdef</span> <span class="w">CONFIG_PCI_OLPC</span>
	
	<span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="w">o</span><span class="pc">lpc_</span><span class="c">platform_info</span><span class="w">.boardrev</span> <span class="w">&lt;</span> <span class="w">olpc_board_pre(0xd0) </span><span class="pc">&amp;</span><span class="c">&amp;</span>
			<span class="pc">!</span><span class="w">cs5535_has_vsa2()</span><span class="pc">)</span>
		<span class="w">x86_init.pc</span><span class="pc">i.</span><span class="w">arch_init</span> <span class="c">=</span> <span class="w">pci_olpc_init</span><span class="c">;</span>
<span class="w">#</span><span class="c">endif</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">o</span><span class="c">lpc_platform_info.</span><span class="w">b</span><span class="c">oardrev</span> <span class="w">&lt;</span> <span class="w">o</span><span class="pc">lpc_b</span><span class="c">oard_pre</span><span class="w">(</span><span class="c">0xd0</span><span class="pc">)) </span><span class="c">{</span> 
		<span class="w">r</span> <span class="c">=</span> <span class="w">add_xo1_platform_devices</span><span class="pc">()</span><span class="c">;</span>
		<span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="w">r</span><span class="c">)</span>
			<span class="pc">r</span><span class="c">eturn</span> <span class="pc">r</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="c">return</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="w">postcore_initcall</span><span class="pc">(</span><span class="w">olpc_init</span><span class="pc">)</span><span class="c">;</span>

</pre>
</body>
</html>

