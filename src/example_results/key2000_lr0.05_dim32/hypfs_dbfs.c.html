<!DOCTYPE html>
<html>
<head>
<style>
span.c {
    background-color: #CCFFCC;
}
span.pc {
    background-color: #FFEEBB;
}
span.w {
    background-color: #FFCCCC;
}
</style>
</head>
<body>
<pre>


<span class="w">#include</span> <span class="w">&lt;linux/slab.h&gt;</span>
<span class="w">#include</span> <span class="w">"hypfs.h"</span>

<span class="w">static</span> <span class="w">struct</span> <span class="w">dentry</span> <span class="w">*dbfs_dir;</span>

<span class="w">static</span> <span class="w">struct</span> <span class="w">hypfs_dbfs_data</span> <span class="w">*hypfs_dbfs_data_alloc(struct</span> <span class="w">hypfs_dbfs_file</span> <span class="w">*f)</span>
<span class="w">{</span>
	<span class="w">struct</span> <span class="w">hypfs_dbfs_data</span> <span class="w">*data;</span>

	<span class="w">data</span> <span class="pc">=</span> <span class="pc">km</span><span class="c">alloc(sizeof(*</span><span class="pc">da</span><span class="c">ta),</span> <span class="c">GFP_KERNEL);</span>
	<span class="c">if</span> <span class="c">(!data)</span>
		<span class="c">return</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="w">d</span><span class="pc">a</span><span class="c">ta-&gt;</span><span class="w">dbfs_file</span> <span class="c">=</span> <span class="w">f</span><span class="pc">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">data;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">void</span> <span class="w">hypfs_dbfs_data_free</span><span class="c">(struct</span> <span class="pc">h</span><span class="c">ypfs_dbfs_data</span> <span class="c">*data</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">d</span><span class="pc">a</span><span class="c">ta-&gt;</span><span class="w">d</span><span class="pc">b</span><span class="c">fs_file</span><span class="w">-</span><span class="c">&gt;</span><span class="w">data_free(</span><span class="c">data</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">buf_free_ptr</span><span class="c">);</span>
	<span class="w">k</span><span class="c">free(data</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="w">s</span><span class="pc">s</span><span class="c">ize_t</span> <span class="w">dbfs_read</span><span class="c">(struct</span> <span class="pc">f</span><span class="c">ile</span> <span class="c">*</span><span class="pc">file</span><span class="c">,</span> <span class="pc">ch</span><span class="c">ar</span> <span class="pc">_</span><span class="c">_user</span> <span class="c">*buf,</span>
			 <span class="c">size_t</span> <span class="pc">s</span><span class="c">ize,</span> <span class="c">loff_t</span> <span class="c">*ppos)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">hypfs_dbfs_data</span> <span class="c">*</span><span class="pc">da</span><span class="c">ta</span><span class="pc">;</span>
	<span class="c">struct</span> <span class="w">hypfs_dbfs_file</span> <span class="c">*</span><span class="w">df</span><span class="c">;</span>
	<span class="w">s</span><span class="pc">s</span><span class="c">ize_t</span> <span class="w">r</span><span class="pc">c</span><span class="c">;</span>

	<span class="w">i</span><span class="pc">f</span> <span class="pc">(*</span><span class="w">p</span><span class="pc">p</span><span class="c">os</span> <span class="w">!</span><span class="c">=</span> <span class="pc">0)</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>

	<span class="w">d</span><span class="c">f</span> <span class="c">=</span> <span class="w">file_inode</span><span class="c">(</span><span class="w">f</span><span class="pc">ile</span><span class="w">)</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_private</span><span class="c">;</span>
	<span class="w">mu</span><span class="c">tex_lock(&amp;</span><span class="pc">d</span><span class="c">f-&gt;lock);</span>
	<span class="w">d</span><span class="pc">a</span><span class="c">ta</span> <span class="pc">=</span> <span class="w">hypfs_dbfs_data_alloc</span><span class="c">(</span><span class="pc">d</span><span class="c">f);</span>
	<span class="c">if</span> <span class="pc">(!d</span><span class="c">ata) {</span>
		<span class="w">m</span><span class="pc">u</span><span class="c">tex_unlock(&amp;df-&gt;lock);</span>
		<span class="c">return</span> <span class="pc">-EN</span><span class="c">OMEM;</span>
	<span class="c">}</span>
	<span class="w">r</span><span class="pc">c</span> <span class="c">=</span> <span class="pc">d</span><span class="c">f</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">data_create(</span><span class="pc">&amp;da</span><span class="c">ta-&gt;</span><span class="w">b</span><span class="pc">u</span><span class="c">f</span><span class="w">,</span><span class="pc"> </span><span class="c">&amp;</span><span class="pc">da</span><span class="c">ta-&gt;</span><span class="w">buf_free_ptr,</span><span class="pc"> </span><span class="c">&amp;data-&gt;</span><span class="w">s</span><span class="pc">i</span><span class="c">ze);</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">r</span><span class="pc">c</span><span class="c">) {</span>
		<span class="pc">m</span><span class="c">utex_unlock(&amp;df-&gt;lock);</span>
		<span class="pc">k</span><span class="c">free(</span><span class="pc">da</span><span class="c">ta);</span>
		<span class="c">return</span> <span class="pc">rc</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="pc">m</span><span class="c">utex_unlock(&amp;</span><span class="pc">df</span><span class="c">-&gt;lock);</span>

	<span class="w">r</span><span class="pc">c</span> <span class="c">=</span> <span class="w">simple_read_from_buffer</span><span class="c">(</span><span class="w">b</span><span class="pc">uf,</span> <span class="pc">s</span><span class="c">ize</span><span class="pc">,</span> <span class="w">p</span><span class="c">pos</span><span class="pc">,</span> <span class="pc">da</span><span class="c">ta</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">b</span><span class="c">uf,</span> <span class="w">d</span><span class="pc">a</span><span class="c">ta</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">s</span><span class="c">ize</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">hypfs_dbfs_data_free</span><span class="c">(</span><span class="pc">da</span><span class="c">ta</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">rc</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="w">l</span><span class="c">ong</span> <span class="w">dbfs_ioctl</span><span class="c">(struct</span> <span class="c">file</span> <span class="c">*file,</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="c">cmd,</span> <span class="c">unsigned</span> <span class="c">long</span> <span class="c">arg)</span>
<span class="c">{</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">hypfs_dbfs_file</span> <span class="c">*</span><span class="w">df</span> <span class="c">=</span> <span class="w">file_inode</span><span class="c">(file</span><span class="w">)</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_private</span><span class="c">;</span>
	<span class="w">l</span><span class="c">ong</span> <span class="w">r</span><span class="pc">c;</span>

	<span class="w">m</span><span class="c">utex_lock(&amp;df</span><span class="pc">-</span><span class="c">&gt;lock);</span>
	<span class="c">if</span> <span class="c">(df-&gt;</span><span class="w">unlocked_ioctl</span><span class="c">)</span>
		<span class="w">r</span><span class="pc">c</span> <span class="c">=</span> <span class="c">df</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">u</span><span class="c">nlocked_ioctl</span><span class="w">(f</span><span class="pc">ile,</span> <span class="w">cm</span><span class="c">d,</span> <span class="pc">a</span><span class="c">rg);</span>
	<span class="w">e</span><span class="c">lse</span>
		<span class="pc">rc</span> <span class="pc">= </span><span class="c">-</span><span class="w">ENOTTY</span><span class="c">;</span>
	<span class="w">m</span><span class="pc">utex_u</span><span class="c">nlock(&amp;df-&gt;lock);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">rc;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="w">c</span><span class="c">onst</span> <span class="c">struct</span> <span class="pc">f</span><span class="c">ile_operations</span> <span class="w">dbfs_ops</span> <span class="c">= {</span>
	<span class="c">.</span><span class="w">r</span><span class="c">ead</span>		<span class="c">=</span> <span class="w">dbfs_read</span><span class="c">,</span>
	<span class="c">.</span><span class="pc">l</span><span class="c">lseek</span>		<span class="c">=</span> <span class="w">no_llseek</span><span class="c">,</span>
	<span class="c">.</span><span class="w">u</span><span class="c">nlocked_ioctl</span> <span class="c">=</span> <span class="w">dbfs_ioctl</span><span class="c">,</span>
<span class="pc">}</span><span class="c">;</span>

<span class="pc">i</span><span class="c">nt</span> <span class="w">hypfs_dbfs_create_file</span><span class="c">(struct</span> <span class="w">hypfs_dbfs_file</span> <span class="c">*</span><span class="w">d</span><span class="pc">f</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">d</span><span class="pc">f</span><span class="c">-&gt;</span><span class="w">den</span><span class="c">try</span> <span class="c">=</span> <span class="w">debugfs_create_file</span><span class="pc">(</span><span class="c">df</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">n</span><span class="pc">a</span><span class="c">me,</span> <span class="w">0400</span><span class="pc">,</span> <span class="w">dbfs_dir</span><span class="c">,</span> <span class="pc">d</span><span class="c">f,</span>
					 <span class="w">&amp;dbfs_ops</span><span class="pc">);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">I</span><span class="c">S_ERR(df</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">den</span><span class="c">try))</span>
		<span class="c">return</span> <span class="pc">P</span><span class="c">TR_ERR(df</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">den</span><span class="c">try);</span>
	<span class="w">m</span><span class="pc">utex_i</span><span class="c">nit(&amp;df-&gt;lock);</span>
	<span class="c">return</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="w">v</span><span class="c">oid</span> <span class="w">hypfs_dbfs_remove_file</span><span class="c">(struct</span> <span class="w">hypfs_dbfs_file</span> <span class="c">*df</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">debugfs_remove</span><span class="c">(df</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">den</span><span class="c">try</span><span class="pc">)</span><span class="c">;</span>
<span class="pc">}</span>

<span class="w">i</span><span class="c">nt</span> <span class="w">hypfs_dbfs_init</span><span class="c">(</span><span class="pc">v</span><span class="c">oid</span><span class="w">)</span>
<span class="c">{</span>
	<span class="w">dbfs_dir</span> <span class="w">=</span> <span class="w">debugfs_create_dir(</span><span class="pc">"</span><span class="w">s390_hypfs</span><span class="c">",</span> <span class="pc">N</span><span class="c">ULL);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">PTR_ERR_OR_ZERO</span><span class="c">(dbfs_dir);</span>
<span class="c">}</span>

<span class="pc">v</span><span class="c">oid</span> <span class="w">hypfs_dbfs_exit</span><span class="c">(</span><span class="pc">v</span><span class="c">oid</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">d</span><span class="pc">ebugfs_r</span><span class="c">emove(dbfs_dir);</span>
<span class="pc">}</span>

</pre>
</body>
</html>

