<!DOCTYPE html>
<html>
<head>
<style>
span.c {
    background-color: #CCFFCC;
}
span.pc {
    background-color: #FFEEBB;
}
span.w {
    background-color: #FFCCCC;
}
</style>
</head>
<body>
<pre>


<span class="w">#include</span> <span class="w">"../perf.h"</span>
<span class="w">#include</span> <span class="w">"../util/util.h"</span>
<span class="w">#include</span> <span class="w">"../util/stat.h"</span>
<span class="w">#include</span> <span class="w">"../util/parse-options.h"</span>
<span class="w">#include</span> <span class="w">"../util</span><span class="pc">/</span><span class="w">he</span><span class="pc">ade</span><span class="c">r.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">bench</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">futex</span><span class="c">.h"</span>

<span class="c">#include</span> <span class="pc">&lt;</span><span class="w">er</span><span class="pc">r.</span><span class="c">h</span><span class="pc">&gt;</span>
<span class="c">#include</span> <span class="pc">&lt;</span><span class="w">stdlib</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;</span><span class="w">s</span><span class="pc">y</span><span class="c">s/</span><span class="w">t</span><span class="pc">i</span><span class="c">me.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;</span><span class="w">pthread</span><span class="pc">.</span><span class="c">h</span><span class="pc">&gt;</span>

<span class="pc">s</span><span class="c">truct</span> <span class="w">thread_data</span> <span class="pc">{</span>
	<span class="w">pthread_t</span> <span class="w">worker</span><span class="c">;</span>
	<span class="w">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">nwoken</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">timeval</span> <span class="w">ru</span><span class="c">ntime;</span>
<span class="pc">}</span><span class="c">;</span>

<span class="pc">sta</span><span class="c">tic</span> <span class="w">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">nwakes</span> <span class="w">=</span> <span class="c">1;</span>


<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="w">u_int32_t</span> <span class="w">futex</span> <span class="w">=</span> <span class="pc">0</span><span class="c">;</span>

<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="w">p</span><span class="c">thread_t</span> <span class="pc">*</span><span class="w">blocked_worker</span><span class="pc">;</span>
<span class="pc">s</span><span class="c">tatic</span> <span class="w">b</span><span class="c">ool</span> <span class="w">do</span><span class="pc">n</span><span class="c">e</span> <span class="pc">=</span> <span class="w">f</span><span class="pc">a</span><span class="c">lse</span><span class="w">,</span> <span class="w">silent</span> <span class="w">=</span> <span class="w">f</span><span class="pc">a</span><span class="c">lse</span><span class="pc">,</span> <span class="w">fshared</span> <span class="c">=</span> <span class="w">f</span><span class="pc">a</span><span class="c">lse</span><span class="pc">;</span>
<span class="pc">s</span><span class="c">tatic</span> <span class="w">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">nblocked_threads</span> <span class="pc">=</span> <span class="c">0</span><span class="pc">,</span> <span class="w">nwaking_threads</span> <span class="pc">=</span> <span class="c">0</span><span class="pc">;</span>
<span class="pc">s</span><span class="c">tatic</span> <span class="w">pthread_mutex_t</span> <span class="w">thread_lock</span><span class="pc">;</span>
<span class="c">static</span> <span class="w">pthread_cond_t</span> <span class="w">thread_parent,</span> <span class="w">thread_worker;</span>
<span class="c">static</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">sta</span><span class="pc">ts</span> <span class="w">waketime_stats,</span> <span class="w">wakeup_stats;</span>
<span class="c">static</span> <span class="w">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">ncpus</span><span class="pc">,</span> <span class="w">threads_starting</span><span class="pc">;</span>
<span class="c">static</span> <span class="c">int</span> <span class="w">futex_flag</span> <span class="pc">=</span> <span class="c">0;</span>

<span class="c">static</span> <span class="pc">c</span><span class="c">onst</span> <span class="c">struct</span> <span class="w">opt</span><span class="pc">ion</span> <span class="w">op</span><span class="pc">tions[]</span><span class="c"> = {</span>
	<span class="w">OPT_UINTEGER('t', "threads"</span><span class="pc">, &amp;</span><span class="w">nblocked_threads,</span><span class="pc"> "</span><span class="w">Specify</span> <span class="w">amount</span> <span class="w">o</span><span class="c">f</span> <span class="w">t</span><span class="pc">hreads</span><span class="w">")</span><span class="pc">,</span>
	<span class="w">O</span><span class="c">PT_UINTEGER</span><span class="w">('w'</span><span class="pc">, </span><span class="c">"</span><span class="w">nwakers"</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">nwaking_threads,</span><span class="pc"> "</span><span class="w">S</span><span class="c">pecify</span> <span class="w">a</span><span class="c">mount</span> <span class="w">o</span><span class="pc">f</span> <span class="w">waking</span> <span class="w">t</span><span class="pc">hreads</span><span class="w">")</span><span class="pc">,</span>
	<span class="w">OPT_BOOLEAN( 's'</span><span class="c">, "</span><span class="w">silent",  &amp;</span><span class="pc">s</span><span class="c">ilent</span><span class="w">,   "Silent</span> <span class="w">m</span><span class="pc">o</span><span class="c">de</span><span class="w">:</span> <span class="w">do</span> <span class="w">no</span><span class="c">t</span> <span class="w">display</span> <span class="w">d</span><span class="pc">a</span><span class="c">ta</span><span class="pc">/</span><span class="w">details</span><span class="pc">")</span><span class="c">,</span>
	<span class="w">O</span><span class="pc">PT_B</span><span class="c">OOLEAN</span><span class="w">( </span><span class="c">'</span><span class="w">S'</span><span class="c">, "</span><span class="w">shared"</span><span class="pc">,</span><span class="c">  &amp;</span><span class="w">fshared,  "Use</span> <span class="w">s</span><span class="pc">h</span><span class="c">ared</span> <span class="w">futexes</span> <span class="w">instead</span> <span class="w">o</span><span class="pc">f</span> <span class="w">pri</span><span class="pc">va</span><span class="c">te</span> <span class="w">ones</span><span class="pc">"</span><span class="c">),</span>
	<span class="w">OPT_END()</span>
<span class="w">}</span><span class="c">;</span>

<span class="pc">sta</span><span class="c">tic</span> <span class="w">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span> <span class="w">c</span><span class="pc">o</span><span class="c">nst</span> <span class="w">bench_futex_wake_parallel_usage</span><span class="c">[] = {</span>
	<span class="c">"</span><span class="w">perf</span> <span class="w">bench</span> <span class="w">futex</span> <span class="w">wake-parallel</span> <span class="w">&lt;opt</span><span class="pc">ions</span><span class="w">&gt;",</span>
	<span class="w">N</span><span class="c">ULL</span>
<span class="pc">}</span><span class="c">;</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="pc">v</span><span class="c">oid</span> <span class="pc">*</span><span class="w">waking_workerfn</span><span class="c">(void</span> <span class="c">*</span><span class="w">a</span><span class="pc">rg</span><span class="c">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">thread_data</span> <span class="c">*</span><span class="w">waker</span> <span class="pc">= </span><span class="c">(</span><span class="pc">s</span><span class="c">truct</span> <span class="c">thread_data</span> <span class="c">*)</span> <span class="w">a</span><span class="c">rg;</span>
	<span class="c">struct</span> <span class="w">timeval</span> <span class="w">s</span><span class="pc">tar</span><span class="c">t</span><span class="w">,</span> <span class="w">e</span><span class="pc">nd;</span>

	<span class="w">gettimeofday</span><span class="pc">(&amp;</span><span class="w">sta</span><span class="pc">r</span><span class="c">t,</span> <span class="pc">N</span><span class="c">ULL);</span>

	<span class="pc">w</span><span class="c">aker</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">nwoken</span> <span class="c">=</span> <span class="w">futex_wake</span><span class="pc">(&amp;</span><span class="w">futex</span><span class="c">,</span> <span class="w">nwakes</span><span class="c">,</span> <span class="w">futex_flag</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">w</span><span class="c">aker-&gt;</span><span class="pc">n</span><span class="c">woken</span> <span class="w">!</span><span class="c">=</span> <span class="w">n</span><span class="pc">wa</span><span class="c">kes</span><span class="pc">)</span>
		<span class="w">warnx(</span><span class="pc">"</span><span class="w">couldn'</span><span class="c">t</span> <span class="w">wakeup</span> <span class="w">al</span><span class="c">l</span> <span class="w">tasks</span> <span class="w">(</span><span class="pc">%</span><span class="c">d</span><span class="w">/</span><span class="c">%d</span><span class="w">)"</span><span class="c">,</span>
		      <span class="pc">w</span><span class="c">aker-&gt;nwoken</span><span class="pc">,</span> <span class="pc">n</span><span class="c">wakes</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">gettimeofday</span><span class="pc">(&amp;</span><span class="w">end</span><span class="c">,</span> <span class="w">N</span><span class="c">ULL);</span>
	<span class="w">timersub</span><span class="pc">(&amp;</span><span class="w">en</span><span class="pc">d, </span><span class="c">&amp;</span><span class="w">s</span><span class="pc">tar</span><span class="c">t</span><span class="pc">, </span><span class="c">&amp;waker</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ru</span><span class="c">ntime</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">pthread_exit</span><span class="pc">(</span><span class="w">N</span><span class="c">ULL</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">N</span><span class="c">ULL;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">void</span> <span class="w">wakeup_threads</span><span class="c">(struct</span> <span class="w">thread_data</span> <span class="c">*</span><span class="w">td</span><span class="pc">,</span> <span class="w">pthread_attr_t</span> <span class="w">thread_attr</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">i</span><span class="c">;</span>

	<span class="w">pthread_attr_setdetachstate</span><span class="pc">(&amp;</span><span class="w">t</span><span class="pc">hread_a</span><span class="c">ttr</span><span class="pc">,</span> <span class="w">PTHREAD_CREATE_JOINABLE</span><span class="c">);</span>

	
	<span class="w">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">nwaking_threads</span><span class="c">;</span> <span class="c">i++) {</span>
		
		<span class="c">if</span> <span class="c">(</span><span class="w">pthread_create</span><span class="pc">(&amp;</span><span class="w">td</span><span class="pc">[</span><span class="c">i</span><span class="pc">].</span><span class="w">worker,</span><span class="pc"> </span><span class="c">&amp;</span><span class="pc">thread_a</span><span class="c">ttr</span><span class="pc">,</span>
				   <span class="w">waking_workerfn,</span><span class="pc"> (</span><span class="w">v</span><span class="c">oid</span> <span class="pc">*)&amp;</span><span class="w">td</span><span class="pc">[</span><span class="c">i</span><span class="w">]))</span>
			<span class="w">e</span><span class="c">rr</span><span class="w">(EXIT_FAILURE,</span><span class="pc"> "p</span><span class="c">thread_create</span><span class="w">"</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">}</span>

	<span class="pc">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="pc">n</span><span class="c">waking_threads</span><span class="pc">;</span> <span class="c">i</span><span class="pc">++)</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">pthread_join</span><span class="c">(</span><span class="w">td</span><span class="pc">[</span><span class="c">i</span><span class="pc">].</span><span class="w">w</span><span class="c">orker</span><span class="pc">,</span> <span class="pc">N</span><span class="c">ULL</span><span class="w">))</span>
			<span class="w">e</span><span class="pc">r</span><span class="c">r</span><span class="w">(</span><span class="pc">E</span><span class="c">XIT_FAILURE</span><span class="w">,</span><span class="pc"> "p</span><span class="c">thread_join</span><span class="pc">"</span><span class="c">);</span>
<span class="pc">}</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="c">void</span> <span class="pc">*</span><span class="w">blocked_workerfn</span><span class="c">(</span><span class="pc">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">a</span><span class="pc">r</span><span class="c">g</span> <span class="w">__maybe_unused)</span>
<span class="c">{</span>
	<span class="w">pthread_mutex_lock</span><span class="pc">(&amp;</span><span class="w">thread_lock</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">threads_starting-</span><span class="pc">-</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">t</span><span class="pc">hreads</span><span class="c">_starting)</span>
		<span class="w">pthread_cond_signal</span><span class="pc">(&amp;</span><span class="w">thread_parent</span><span class="c">);</span>
	<span class="w">pthread_cond_wait</span><span class="c">(&amp;</span><span class="w">thread_worker</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">t</span><span class="c">hread_lock);</span>
	<span class="w">pthread_mutex_unlock</span><span class="c">(&amp;</span><span class="w">t</span><span class="pc">hread_l</span><span class="c">ock);</span>

	<span class="w">w</span><span class="c">hile</span> <span class="c">(</span><span class="w">1</span><span class="c">) {</span> 
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">futex_wait</span><span class="c">(&amp;</span><span class="w">futex</span><span class="pc">,</span> <span class="c">0</span><span class="pc">,</span> <span class="pc">N</span><span class="c">ULL</span><span class="pc">,</span> <span class="w">futex_flag) </span><span class="pc">!</span><span class="c">=</span> <span class="w">EINTR</span><span class="c">)</span>
			<span class="w">b</span><span class="c">reak;</span>
	<span class="c">}</span>

	<span class="w">pthread_exit</span><span class="c">(</span><span class="w">N</span><span class="c">ULL</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">N</span><span class="c">ULL;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">block_threads</span><span class="c">(</span><span class="w">pthread_t</span> <span class="pc">*</span><span class="w">w</span><span class="c">,</span> <span class="w">pthread_attr_t</span> <span class="w">thread_attr</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">cpu_set_t</span> <span class="w">cp</span><span class="pc">u;</span>
	<span class="w">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="pc">i</span><span class="c">;</span>

	<span class="w">threads_starting</span> <span class="pc">=</span> <span class="w">nblocked_threads</span><span class="pc">;</span>

	
	<span class="w">f</span><span class="pc">o</span><span class="c">r</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="pc">n</span><span class="c">blocked_threads;</span> <span class="c">i++) {</span>
		<span class="w">CPU_ZERO</span><span class="pc">(&amp;</span><span class="w">cp</span><span class="pc">u)</span><span class="c">;</span>
		<span class="w">CPU_SET</span><span class="pc">(</span><span class="c">i</span> <span class="w">%</span> <span class="w">ncpus</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">cp</span><span class="pc">u</span><span class="c">);</span>

		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">pthread_attr_setaffinity_np</span><span class="pc">(&amp;</span><span class="w">thread_attr</span><span class="pc">,</span> <span class="w">s</span><span class="c">izeof(</span><span class="w">cpu_set_t),</span><span class="pc"> </span><span class="c">&amp;</span><span class="w">cp</span><span class="pc">u</span><span class="w">)</span><span class="pc">)</span>
			<span class="w">e</span><span class="c">rr</span><span class="w">(EXIT_FAILURE,</span><span class="pc"> "p</span><span class="c">thread_attr_setaffinity_np</span><span class="pc">"</span><span class="c">);</span>

		<span class="c">if</span> <span class="c">(</span><span class="w">pthread_create</span><span class="pc">(&amp;</span><span class="w">w[</span><span class="pc">i</span><span class="c">], &amp;</span><span class="pc">t</span><span class="c">hread_attr</span><span class="w">,</span> <span class="w">blocked_workerfn</span><span class="pc">,</span> <span class="pc">N</span><span class="c">ULL</span><span class="w">)</span><span class="pc">)</span>
			<span class="w">e</span><span class="pc">r</span><span class="c">r</span><span class="w">(E</span><span class="c">XIT_FAILURE</span><span class="w">,</span><span class="pc"> "p</span><span class="c">thread_create</span><span class="w">"</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">}</span>
<span class="w">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">print_run</span><span class="c">(struct</span> <span class="w">thread_data</span> <span class="c">*</span><span class="w">waking_worker</span><span class="pc">,</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">run_num</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">unsigned</span> <span class="c">int</span> <span class="pc">i,</span> <span class="w">wakeup_avg</span><span class="pc">;</span>
	<span class="w">double</span> <span class="w">waketime_avg</span><span class="pc">,</span> <span class="w">waketime_stddev</span><span class="c">;</span>
	<span class="w">s</span><span class="c">truct</span> <span class="w">stat</span><span class="pc">s</span> <span class="w">__waketime_stats,</span> <span class="w">__wakeup_stats</span><span class="pc">;</span>

	<span class="w">init_stats</span><span class="pc">(&amp;</span><span class="w">_</span><span class="pc">_wakeu</span><span class="c">p_stats</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">i</span><span class="pc">ni</span><span class="c">t_stats</span><span class="w">(</span><span class="pc">&amp;__waket</span><span class="c">ime_stats</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">nwaking_threads</span><span class="c">;</span> <span class="c">i++) {</span>
		<span class="w">update_stats</span><span class="pc">(&amp;_</span><span class="c">_waketime_stats</span><span class="pc">,</span> <span class="w">waking_worker</span><span class="pc">[</span><span class="c">i</span><span class="pc">].</span><span class="w">ru</span><span class="c">ntime</span><span class="pc">.</span><span class="w">tv_usec)</span><span class="pc">;</span>
		<span class="w">u</span><span class="c">pdate_stats(&amp;</span><span class="pc">__wakeu</span><span class="c">p_stats</span><span class="pc">,</span> <span class="pc">w</span><span class="c">aking_worker</span><span class="pc">[</span><span class="c">i].</span><span class="w">nwoken</span><span class="c">);</span>
	<span class="c">}</span>

	<span class="w">waketime_avg</span> <span class="pc">=</span> <span class="w">avg_stats</span><span class="pc">(&amp;</span><span class="c">__waketime_stats</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">waketime_stddev</span> <span class="pc">=</span> <span class="w">stddev_stats</span><span class="pc">(&amp;</span><span class="c">__waketime_stats</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">wakeup_avg</span> <span class="c">=</span> <span class="w">a</span><span class="c">vg_stats(&amp;</span><span class="w">_</span><span class="pc">_wakeu</span><span class="c">p_stats</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">pri</span><span class="pc">ntf</span><span class="w">("[Run</span> <span class="w">%</span><span class="c">d</span><span class="w">]:</span> <span class="w">Avg</span> <span class="w">per-th</span><span class="pc">r</span><span class="c">ead</span> <span class="w">latency</span> <span class="w">(waking</span> <span class="w">%</span><span class="pc">d</span><span class="w">/</span><span class="pc">%</span><span class="c">d</span> <span class="w">threads) "</span>
	       <span class="w">"in</span> <span class="w">%.4f</span> <span class="w">ms</span> <span class="w">(+-%.2f%%)\n</span><span class="pc">",</span> <span class="w">run_num</span> <span class="w">+</span> <span class="c">1</span><span class="pc">,</span> <span class="pc">wake</span><span class="c">up_avg</span><span class="pc">,</span>
	       <span class="w">nblocked_threads</span><span class="c">,</span> <span class="w">waketime_avg/1e3</span><span class="c">,</span>
	       <span class="w">rel_stddev_stats</span><span class="pc">(</span><span class="w">waketime_stddev</span><span class="c">,</span> <span class="w">w</span><span class="pc">aket</span><span class="c">ime_avg</span><span class="pc">))</span><span class="c">;</span>
<span class="pc">}</span>

<span class="c">static</span> <span class="c">void</span> <span class="w">print_summary</span><span class="c">(</span><span class="pc">v</span><span class="c">oid</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">un</span><span class="c">signed</span> <span class="pc">i</span><span class="c">nt</span> <span class="pc">wakeu</span><span class="c">p_avg;</span>
	<span class="w">double</span> <span class="w">w</span><span class="pc">aketime_a</span><span class="c">vg</span><span class="w">,</span> <span class="w">w</span><span class="pc">aketime_s</span><span class="c">tddev;</span>

	<span class="w">w</span><span class="c">aketime_avg</span> <span class="pc">=</span> <span class="w">avg_stats</span><span class="pc">(&amp;</span><span class="w">waketime_stats</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">w</span><span class="c">aketime_stddev</span> <span class="pc">=</span> <span class="w">stddev_stats</span><span class="pc">(&amp;</span><span class="w">w</span><span class="pc">aketime_s</span><span class="c">tats</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">w</span><span class="pc">akeu</span><span class="c">p_avg</span> <span class="pc">=</span> <span class="w">a</span><span class="c">vg_stats</span><span class="pc">(&amp;</span><span class="w">wakeup_stats</span><span class="c">);</span>

	<span class="w">pri</span><span class="pc">ntf</span><span class="c">("</span><span class="w">Avg</span> <span class="w">per-th</span><span class="pc">r</span><span class="c">ead</span> <span class="w">latency</span> <span class="w">(waking</span> <span class="w">%</span><span class="c">d</span><span class="w">/</span><span class="pc">%</span><span class="c">d</span> <span class="w">threads)</span> <span class="w">i</span><span class="pc">n</span> <span class="w">%.4f</span> <span class="w">ms</span> <span class="w">(+-%.2f%%)\n</span><span class="pc">",</span>
	       <span class="w">w</span><span class="pc">akeup_a</span><span class="c">vg</span><span class="pc">,</span>
	       <span class="w">nblocked_threads</span><span class="c">,</span>
	       <span class="w">waketime_avg/1e3</span><span class="pc">,</span>
	       <span class="w">rel_stddev_stats</span><span class="pc">(</span><span class="w">waketime_stddev</span><span class="c">,</span> <span class="w">w</span><span class="pc">aketime_a</span><span class="c">vg</span><span class="pc">))</span><span class="c">;</span>
<span class="pc">}</span>


<span class="c">static</span> <span class="c">void</span> <span class="w">do_run_stats</span><span class="c">(struct</span> <span class="w">thread_data</span> <span class="c">*</span><span class="w">waking_worker</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">un</span><span class="c">signed</span> <span class="pc">i</span><span class="c">nt</span> <span class="pc">i</span><span class="c">;</span>

	<span class="w">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">nwaking_threads</span><span class="c">;</span> <span class="c">i++) {</span>
		<span class="w">update_stats</span><span class="pc">(&amp;</span><span class="w">waketime_stats</span><span class="pc">,</span> <span class="w">w</span><span class="c">aking_worker</span><span class="pc">[</span><span class="c">i</span><span class="pc">].</span><span class="w">ru</span><span class="c">ntime</span><span class="pc">.</span><span class="w">tv_usec)</span><span class="c">;</span>
		<span class="w">u</span><span class="c">pdate_stats</span><span class="pc">(&amp;</span><span class="w">wakeup_stats</span><span class="pc">,</span> <span class="pc">w</span><span class="c">aking_worker</span><span class="pc">[</span><span class="c">i].</span><span class="w">nwoken</span><span class="c">);</span>
	<span class="c">}</span>

<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">toggle_done</span><span class="c">(</span><span class="pc">i</span><span class="c">nt</span> <span class="w">si</span><span class="pc">g</span> <span class="w">__maybe_unused</span><span class="pc">,</span>
			<span class="w">siginfo_t</span> <span class="pc">*</span><span class="w">i</span><span class="pc">n</span><span class="c">fo</span> <span class="w">_</span><span class="c">_maybe_unused</span><span class="w">,</span>
			<span class="w">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">uc</span> <span class="w">_</span><span class="c">_maybe_unused</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">do</span><span class="c">ne</span> <span class="c">=</span> <span class="w">t</span><span class="pc">r</span><span class="c">ue;</span>
<span class="c">}</span>

<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">bench_futex_wake_parallel</span><span class="c">(</span><span class="pc">i</span><span class="c">nt</span> <span class="pc">a</span><span class="c">rgc,</span> <span class="pc">co</span><span class="c">nst</span> <span class="c">char</span> <span class="pc">**</span><span class="w">a</span><span class="c">rgv</span><span class="pc">,</span>
			      <span class="pc">c</span><span class="c">onst</span> <span class="c">char</span> <span class="c">*</span><span class="w">prefix</span> <span class="w">_</span><span class="pc">_m</span><span class="c">aybe_unused</span><span class="w">)</span>
<span class="c">{</span>
	<span class="c">int</span> <span class="c">ret</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="w">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">i</span><span class="pc">,</span> <span class="w">j</span><span class="c">;</span>
	<span class="w">s</span><span class="c">truct</span> <span class="w">sigaction</span> <span class="w">act</span><span class="c">;</span>
	<span class="w">pthread_attr_t</span> <span class="w">thread_attr</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">thread_data</span> <span class="c">*</span><span class="w">waking_worker</span><span class="c">;</span>

	<span class="w">arg</span><span class="pc">c</span> <span class="c">=</span> <span class="w">parse_options</span><span class="pc">(</span><span class="w">arg</span><span class="pc">c</span><span class="c">,</span> <span class="w">ar</span><span class="pc">gv,</span> <span class="w">o</span><span class="pc">p</span><span class="c">tions,</span>
			     <span class="w">bench_futex_wake_parallel_usage</span><span class="c">,</span> <span class="pc">0)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">ar</span><span class="pc">gc)</span><span class="c"> {</span>
		<span class="w">usage_with_options</span><span class="c">(</span><span class="w">b</span><span class="c">ench_futex_wake_parallel_usage,</span> <span class="w">opt</span><span class="pc">i</span><span class="c">ons</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">e</span><span class="pc">x</span><span class="c">it</span><span class="pc">(</span><span class="w">EXIT_FAILURE</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">sigfillset</span><span class="pc">(&amp;</span><span class="w">act.sa_mask</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">a</span><span class="c">ct</span><span class="w">.sa_sigaction</span> <span class="c">=</span> <span class="w">toggle_done</span><span class="c">;</span>
	<span class="w">sigaction</span><span class="pc">(</span><span class="w">SIGINT</span><span class="pc">, </span><span class="c">&amp;act,</span> <span class="w">N</span><span class="c">ULL);</span>

	<span class="w">ncpus</span> <span class="pc">=</span> <span class="w">sysconf</span><span class="c">(</span><span class="w">_SC_NPROCESSORS_ONLN</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">nblocked_threads</span><span class="c">)</span>
		<span class="w">n</span><span class="pc">b</span><span class="c">locked_threads</span> <span class="c">=</span> <span class="pc">nc</span><span class="c">pus</span><span class="pc">;</span>

	
	<span class="c">if</span> <span class="c">(</span><span class="w">nwaking_threads</span> <span class="w">&gt;</span> <span class="pc">n</span><span class="c">blocked_threads</span> <span class="w">|</span><span class="pc">| </span><span class="c">!</span><span class="pc">nw</span><span class="c">aking_threads)</span>
		<span class="pc">n</span><span class="c">waking_threads</span> <span class="c">=</span> <span class="pc">nb</span><span class="c">locked_threads;</span>

	<span class="c">if</span> <span class="c">(</span><span class="pc">nb</span><span class="c">locked_threads</span> <span class="w">%</span> <span class="c">nwaking_threads)</span>
		<span class="w">errx</span><span class="pc">(</span><span class="w">EXIT_FAILURE</span><span class="pc">, </span><span class="c">"</span><span class="w">Must</span> <span class="w">be</span> <span class="w">perfectly</span> <span class="w">divisible"</span><span class="pc">)</span><span class="c">;</span>
	
	<span class="w">nwakes</span> <span class="pc">=</span> <span class="w">n</span><span class="pc">b</span><span class="c">locked_threads</span><span class="w">/</span><span class="pc">nw</span><span class="c">aking_threads;</span>

	<span class="w">blocked_worker</span> <span class="c">=</span> <span class="w">calloc</span><span class="c">(</span><span class="pc">nb</span><span class="c">locked_threads,</span> <span class="w">s</span><span class="pc">i</span><span class="c">zeof</span><span class="pc">(*</span><span class="c">blocked_worker</span><span class="pc">))</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">blocked_worker)</span>
		<span class="w">e</span><span class="pc">rr</span><span class="w">(E</span><span class="c">XIT_FAILURE</span><span class="w">,</span><span class="pc"> </span><span class="c">"</span><span class="w">c</span><span class="c">alloc</span><span class="w">"</span><span class="c">);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">fshared</span><span class="c">)</span>
		<span class="w">futex_flag</span> <span class="pc">=</span> <span class="w">FUTEX_PRIVATE_FLAG</span><span class="pc">;</span>

	<span class="w">pri</span><span class="pc">ntf</span><span class="c">("</span><span class="w">Run</span> <span class="w">summary</span> <span class="w">[PID</span> <span class="pc">%d</span><span class="w">]:</span> <span class="w">blocking</span> <span class="w">o</span><span class="pc">n</span> <span class="pc">%d</span> <span class="w">threads</span> <span class="w">(at</span> <span class="w">[</span><span class="pc">%s</span><span class="w">] "</span>
	       <span class="w">"futex</span> <span class="pc">%p</span><span class="w">), %d</span> <span class="w">t</span><span class="pc">hr</span><span class="c">eads</span> <span class="w">waking</span> <span class="w">u</span><span class="pc">p</span> <span class="c">%d</span> <span class="w">a</span><span class="c">t</span> <span class="w">a</span> <span class="w">ti</span><span class="pc">me</span><span class="w">.</span><span class="pc">\</span><span class="c">n</span><span class="w">\</span><span class="c">n</span><span class="pc">",</span>
	       <span class="w">getpid()</span><span class="pc">,</span> <span class="w">nblocked_threads</span><span class="pc">,</span> <span class="w">fshared</span> <span class="w">?</span><span class="pc"> </span><span class="c">"</span><span class="w">shared":"pri</span><span class="pc">va</span><span class="c">te</span><span class="w">"</span><span class="pc">,</span>
	       <span class="pc">&amp;fu</span><span class="c">tex</span><span class="pc">,</span> <span class="w">nwaking_threads</span><span class="c">,</span> <span class="w">nwakes</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">init_stats</span><span class="pc">(&amp;</span><span class="w">wakeup_stats</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">i</span><span class="pc">ni</span><span class="c">t_stats</span><span class="pc">(&amp;</span><span class="w">waketime_stats</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">pthread_attr_init</span><span class="pc">(&amp;</span><span class="w">thread_attr</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">pthread_mutex_init</span><span class="pc">(&amp;</span><span class="w">thread_lock</span><span class="pc">,</span> <span class="pc">N</span><span class="c">ULL);</span>
	<span class="w">pthread_cond_init</span><span class="c">(&amp;</span><span class="w">thread_parent</span><span class="pc">,</span> <span class="c">NULL);</span>
	<span class="w">p</span><span class="pc">thread_c</span><span class="c">ond_init(&amp;</span><span class="w">thread_worker</span><span class="pc">,</span> <span class="c">NULL);</span>

	<span class="w">f</span><span class="c">or</span> <span class="c">(</span><span class="w">j</span> <span class="c">=</span> <span class="c">0;</span> <span class="pc">j</span> <span class="c">&lt;</span> <span class="w">bench_repeat</span> <span class="w">&amp;&amp;</span><span class="pc"> !</span><span class="w">do</span><span class="c">ne;</span> <span class="w">j</span><span class="c">++) {</span>
		<span class="w">waking_worker</span> <span class="pc">=</span> <span class="w">calloc</span><span class="pc">(</span><span class="w">nwaking_threads</span><span class="c">,</span> <span class="w">s</span><span class="c">izeof</span><span class="pc">(*</span><span class="c">waking_worker</span><span class="pc">))</span><span class="c">;</span>
		<span class="c">if</span> <span class="pc">(!</span><span class="c">waking_worker</span><span class="pc">)</span>
			<span class="w">e</span><span class="c">rr</span><span class="w">(EXIT_FAILURE,</span><span class="pc"> </span><span class="c">"</span><span class="w">c</span><span class="c">alloc</span><span class="pc">"</span><span class="c">);</span>

		
		<span class="w">block_threads</span><span class="c">(</span><span class="w">blocked_worker</span><span class="c">,</span> <span class="w">thread_attr</span><span class="c">);</span>

		
		<span class="w">pthread_mutex_lock</span><span class="pc">(&amp;</span><span class="w">thread_lock</span><span class="c">);</span>
		<span class="w">w</span><span class="pc">h</span><span class="c">ile</span> <span class="c">(</span><span class="w">threads_starting</span><span class="pc">)</span>
			<span class="w">pthread_cond_wait</span><span class="pc">(&amp;</span><span class="w">thread_parent</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">t</span><span class="pc">hread_l</span><span class="c">ock);</span>
		<span class="w">pthread_cond_broadcast</span><span class="pc">(&amp;</span><span class="w">thread_worker</span><span class="c">);</span>
		<span class="w">pthread_mutex_unlock</span><span class="c">(&amp;</span><span class="w">t</span><span class="pc">hread_</span><span class="c">lock);</span>

		<span class="w">usleep</span><span class="pc">(</span><span class="w">100000</span><span class="c">);</span>

		
		<span class="w">wakeup_threads</span><span class="pc">(</span><span class="w">waking_worker</span><span class="pc">,</span> <span class="w">th</span><span class="pc">read_a</span><span class="c">ttr);</span>

		<span class="w">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">nblocked_threads</span><span class="c">;</span> <span class="c">i++) {</span>
			<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">pthread_join</span><span class="c">(</span><span class="w">blocked_worker</span><span class="pc">[</span><span class="c">i</span><span class="w">],</span> <span class="pc">N</span><span class="c">ULL);</span>
			<span class="c">if</span> <span class="c">(</span><span class="pc">r</span><span class="c">et)</span>
				<span class="w">e</span><span class="c">rr</span><span class="w">(EXIT_FAILURE,</span><span class="pc"> "</span><span class="w">p</span><span class="c">thread_join</span><span class="w">"</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">}</span>

		<span class="w">do_run_stats</span><span class="c">(waking_worker);</span>
		<span class="c">if</span> <span class="pc">(!</span><span class="w">silent</span><span class="c">)</span>
			<span class="w">print_run</span><span class="c">(</span><span class="w">w</span><span class="c">aking_worker,</span> <span class="w">j</span><span class="pc">)</span><span class="c">;</span>

		<span class="w">fre</span><span class="pc">e(w</span><span class="c">aking_worker);</span>
	<span class="c">}</span>

	
	<span class="w">pthread_cond_destroy</span><span class="pc">(&amp;</span><span class="w">thread_parent</span><span class="c">);</span>
	<span class="w">p</span><span class="pc">thread_c</span><span class="c">ond_destroy</span><span class="pc">(&amp;</span><span class="w">thread_worker</span><span class="c">);</span>
	<span class="w">pthread_mutex_destroy</span><span class="pc">(&amp;</span><span class="w">thread_lock</span><span class="c">);</span>
	<span class="w">pthread_attr_destroy</span><span class="pc">(&amp;</span><span class="w">thread_attr</span><span class="c">);</span>

	<span class="w">print_summary</span><span class="pc">()</span><span class="c">;</span>

	<span class="w">fr</span><span class="pc">ee(</span><span class="w">blocked_worker</span><span class="c">);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">r</span><span class="c">et;</span>
<span class="c">}</span>

</pre>
</body>
</html>

