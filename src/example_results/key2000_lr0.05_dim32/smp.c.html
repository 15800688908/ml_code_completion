<!DOCTYPE html>
<html>
<head>
<style>
span.c {
    background-color: #CCFFCC;
}
span.pc {
    background-color: #FFEEBB;
}
span.w {
    background-color: #FFCCCC;
}
</style>
</head>
<body>
<pre>

<span class="w">#include</span> <span class="w">&lt;linux/cache.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/delay.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/init.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/interrupt.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux</span><span class="c">/</span><span class="w">sm</span><span class="c">p.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">s</span><span class="pc">p</span><span class="c">inlock.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">threads</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">m</span><span class="c">odule.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">t</span><span class="pc">ime</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">timex</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">s</span><span class="pc">c</span><span class="c">hed.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">cpumask</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">cp</span><span class="pc">u</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">e</span><span class="pc">rr</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">ftrace</span><span class="c">.h&gt;</span>

<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">atomic</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;</span><span class="pc">a</span><span class="c">sm/</span><span class="w">cp</span><span class="c">u.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">processor</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">idle</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">r4k</span><span class="pc">-</span><span class="w">ti</span><span class="pc">mer</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">mmu_context</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">t</span><span class="pc">i</span><span class="c">me.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">set</span><span class="c">up.h&gt;</span>

<span class="w">cpumask_t</span> <span class="w">cpu_callin_map;</span>		

<span class="pc">i</span><span class="c">nt</span> <span class="w">__cpu_number_map[NR_CPUS</span><span class="c">];</span>		
<span class="w">E</span><span class="pc">XPORT_SYMBOL</span><span class="c">(</span><span class="pc">_</span><span class="c">_cpu_number_map);</span>

<span class="pc">i</span><span class="c">nt</span> <span class="w">__cpu_logical_map[N</span><span class="c">R_CPUS];</span>		
<span class="w">E</span><span class="c">XPORT_SYMBOL(</span><span class="pc">__cpu_l</span><span class="c">ogical_map);</span>


<span class="pc">i</span><span class="c">nt</span> <span class="w">smp_num_siblings</span> <span class="pc">=</span> <span class="w">1</span><span class="c">;</span>
<span class="w">E</span><span class="pc">XPORT_SYMBOL</span><span class="c">(</span><span class="pc">s</span><span class="c">mp_num_siblings);</span>


<span class="w">c</span><span class="pc">pum</span><span class="c">ask_t</span> <span class="w">cpu_sibling_map</span><span class="pc">[</span><span class="w">N</span><span class="c">R_CPUS</span><span class="w">]</span> <span class="w">__r</span><span class="c">ead_mostly</span><span class="pc">;</span>
<span class="w">E</span><span class="c">XPORT_SYMBOL(</span><span class="w">c</span><span class="pc">pu_s</span><span class="c">ibling_map);</span>


<span class="w">c</span><span class="pc">pum</span><span class="c">ask_t</span> <span class="w">cpu_core_map[N</span><span class="c">R_CPUS</span><span class="pc">]</span> <span class="w">_</span><span class="pc">_r</span><span class="c">ead_mostly</span><span class="pc">;</span>
<span class="w">E</span><span class="c">XPORT_SYMBOL(</span><span class="w">c</span><span class="pc">pu_c</span><span class="c">ore_map);</span>


<span class="pc">c</span><span class="c">pumask_t</span> <span class="w">cpu_foreign_map</span> <span class="w">_</span><span class="pc">_re</span><span class="c">ad_mostly;</span>
<span class="w">E</span><span class="c">XPORT_SYMBOL(</span><span class="w">c</span><span class="pc">pu_f</span><span class="c">oreign_map);</span>


<span class="c">static</span> <span class="w">c</span><span class="pc">p</span><span class="c">umask_t</span> <span class="w">cpu_sibling_setup_map</span><span class="pc">;</span>


<span class="pc">sta</span><span class="c">tic</span> <span class="w">cp</span><span class="pc">um</span><span class="c">ask_t</span> <span class="w">cpu_core_setup_map;</span>

<span class="w">c</span><span class="pc">pum</span><span class="c">ask_t</span> <span class="w">cpu_coherent_mask</span><span class="pc">;</span>

<span class="c">static</span> <span class="c">inline</span> <span class="c">void</span> <span class="w">set_cpu_sibling_map</span><span class="c">(</span><span class="w">i</span><span class="c">nt</span> <span class="c">cpu)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">i</span><span class="c">;</span>

	<span class="w">cpumask_set_cpu</span><span class="pc">(</span><span class="w">cpu,</span><span class="pc"> &amp;cpu_s</span><span class="c">ibling_setup_map);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">smp_num_siblings</span> <span class="w">&gt;</span> <span class="pc">1) </span><span class="c">{</span>
		<span class="w">for_each_cpu</span><span class="c">(</span><span class="w">i,</span><span class="pc"> &amp;</span><span class="w">c</span><span class="pc">pu_s</span><span class="c">ibling_setup_map</span><span class="w">) </span><span class="pc">{</span>
			<span class="c">if</span> <span class="c">(</span><span class="w">cpu_data[cpu</span><span class="pc">].</span><span class="w">package</span> <span class="c">==</span> <span class="pc">c</span><span class="c">pu_data</span><span class="w">[</span><span class="pc">i</span><span class="c">].</span><span class="pc">p</span><span class="c">ackage</span> <span class="w">&amp;</span><span class="pc">&amp;</span>
				    <span class="c">cpu_data</span><span class="pc">[</span><span class="w">cp</span><span class="pc">u</span><span class="c">].</span><span class="w">cor</span><span class="c">e</span> <span class="c">==</span> <span class="c">cpu_data[i].</span><span class="w">cor</span><span class="c">e</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
				<span class="w">cpumask_set_cpu</span><span class="pc">(</span><span class="w">i</span><span class="pc">, &amp;</span><span class="w">cpu_sibling_map</span><span class="c">[</span><span class="w">cpu</span><span class="pc">])</span><span class="c">;</span>
				<span class="w">c</span><span class="pc">pum</span><span class="c">ask_set_cpu(</span><span class="w">cp</span><span class="pc">u, </span><span class="c">&amp;</span><span class="pc">cpu_s</span><span class="c">ibling_map[i]);</span>
			<span class="c">}</span>
		<span class="pc">}</span>
	<span class="pc">}</span> <span class="w">e</span><span class="c">lse</span>
		<span class="w">c</span><span class="pc">pum</span><span class="c">ask_set_cpu(</span><span class="w">cp</span><span class="pc">u, &amp;cpu_</span><span class="c">sibling_map[</span><span class="w">cp</span><span class="pc">u</span><span class="c">]);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">inline</span> <span class="c">void</span> <span class="w">set_cpu_core_map</span><span class="c">(</span><span class="pc">i</span><span class="c">nt</span> <span class="pc">cpu</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">i;</span>

	<span class="w">c</span><span class="pc">pum</span><span class="c">ask_set_cpu</span><span class="pc">(</span><span class="w">c</span><span class="pc">pu</span><span class="w">,</span><span class="pc"> &amp;</span><span class="w">cpu_core_setup_map</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">for_each_cpu</span><span class="c">(</span><span class="w">i</span><span class="pc">, </span><span class="c">&amp;cpu_core_setup_map</span><span class="w">) </span><span class="pc">{</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">cpu_data[cp</span><span class="pc">u</span><span class="c">].</span><span class="w">package</span> <span class="pc">=</span><span class="c">=</span> <span class="w">c</span><span class="pc">pu_d</span><span class="c">ata</span><span class="w">[</span><span class="pc">i</span><span class="c">].</span><span class="pc">p</span><span class="c">ackage</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
			<span class="w">c</span><span class="pc">pum</span><span class="c">ask_set_cpu(</span><span class="w">i,</span><span class="pc"> &amp;</span><span class="w">cpu_core_map</span><span class="pc">[</span><span class="w">cp</span><span class="pc">u])</span><span class="c">;</span>
			<span class="w">c</span><span class="pc">pum</span><span class="c">ask_set_cpu(</span><span class="w">c</span><span class="pc">pu, </span><span class="c">&amp;</span><span class="pc">cpu_core_m</span><span class="c">ap</span><span class="pc">[</span><span class="c">i]);</span>
		<span class="c">}</span>
	<span class="pc">}</span>
<span class="pc">}</span>


<span class="c">static</span> <span class="pc">inl</span><span class="c">ine</span> <span class="c">void</span> <span class="w">calculate_cpu_foreign_map</span><span class="c">(</span><span class="pc">v</span><span class="c">oid</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">i</span><span class="pc">,</span> <span class="w">k</span><span class="pc">,</span> <span class="w">core_present;</span>
	<span class="w">cpumask_t</span> <span class="w">temp_foreign_map</span><span class="pc">;</span>

	
	<span class="w">for_each_online_cpu</span><span class="c">(</span><span class="w">i)</span><span class="pc"> {</span>
		<span class="w">co</span><span class="c">re_present</span> <span class="pc">=</span> <span class="c">0;</span>
		<span class="w">for_each_cpu</span><span class="c">(</span><span class="w">k</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">t</span><span class="c">emp_foreign_map</span><span class="w">)</span>
			<span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="w">cpu_data[</span><span class="pc">i].</span><span class="w">package</span> <span class="pc">==</span> <span class="pc">cp</span><span class="c">u_data</span><span class="w">[k</span><span class="c">].</span><span class="pc">p</span><span class="c">ackage</span> <span class="w">&amp;</span><span class="pc">&amp;</span>
			    <span class="c">cpu_data[i].</span><span class="w">cor</span><span class="pc">e</span> <span class="c">==</span> <span class="c">cpu_data[</span><span class="w">k</span><span class="c">].</span><span class="w">cor</span><span class="pc">e</span><span class="w">)</span>
				<span class="w">c</span><span class="pc">or</span><span class="c">e_present</span> <span class="w">=</span> <span class="w">1</span><span class="c">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!co</span><span class="c">re_present</span><span class="pc">)</span>
			<span class="w">cpumask_set_cpu</span><span class="c">(</span><span class="w">i</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">t</span><span class="c">emp_foreign_map</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">}</span>

	<span class="w">cpumask_copy</span><span class="pc">(&amp;</span><span class="w">cpu_foreign_map</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">t</span><span class="c">emp_foreign_map);</span>
<span class="pc">}</span>

<span class="w">s</span><span class="pc">tr</span><span class="c">uct</span> <span class="w">plat_smp_ops</span> <span class="pc">*</span><span class="w">mp_ops</span><span class="c">;</span>
<span class="w">E</span><span class="pc">XPORT_SYMBOL</span><span class="c">(</span><span class="pc">m</span><span class="c">p_ops);</span>

<span class="c">void</span> <span class="w">register_smp_ops</span><span class="c">(struct</span> <span class="c">plat_smp_ops</span> <span class="c">*</span><span class="w">op</span><span class="pc">s</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">if</span> <span class="pc">(</span><span class="c">mp_ops</span><span class="pc">)</span>
		<span class="w">p</span><span class="pc">r</span><span class="c">intk(</span><span class="pc">KERN_W</span><span class="c">ARNING</span> <span class="c">"</span><span class="w">Overriding</span> <span class="w">previously</span> <span class="w">se</span><span class="pc">t</span> <span class="w">SMP</span> <span class="w">op</span><span class="pc">s\</span><span class="c">n");</span>

	<span class="w">m</span><span class="c">p_ops</span> <span class="pc">=</span> <span class="w">o</span><span class="c">ps</span><span class="pc">;</span>
<span class="c">}</span>


<span class="w">asm</span><span class="c">linkage</span> <span class="w">v</span><span class="c">oid</span> <span class="w">start_secondary</span><span class="c">(</span><span class="pc">v</span><span class="c">oid)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">c</span><span class="pc">p</span><span class="c">u;</span>

	<span class="w">cpu_probe</span><span class="c">();</span>
	<span class="w">per_cpu_trap_init</span><span class="pc">(</span><span class="w">fa</span><span class="c">lse);</span>
	<span class="w">mips_clockevent_init</span><span class="pc">()</span><span class="c">;</span>
	<span class="w">m</span><span class="c">p_ops</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">init_secondary(</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">cpu_report</span><span class="pc">()</span><span class="c">;</span>

	

	<span class="w">calibrate_delay</span><span class="pc">()</span><span class="c">;</span>
	<span class="w">preempt_disable</span><span class="c">();</span>
	<span class="w">cp</span><span class="pc">u</span> <span class="pc">=</span> <span class="w">smp_processor_id</span><span class="c">();</span>
	<span class="w">cpu_data[c</span><span class="pc">pu</span><span class="w">]</span><span class="pc">.</span><span class="w">udelay_val</span> <span class="pc">=</span> <span class="w">loops_per_jiffy</span><span class="c">;</span>

	<span class="w">cpumask_set_cpu</span><span class="pc">(</span><span class="w">c</span><span class="pc">pu, </span><span class="c">&amp;</span><span class="w">cpu_coherent_mask</span><span class="c">);</span>
	<span class="w">notify_cpu_starting</span><span class="pc">(</span><span class="w">c</span><span class="pc">pu</span><span class="c">);</span>

	<span class="w">set_cpu_online</span><span class="c">(</span><span class="w">c</span><span class="pc">pu,</span> <span class="w">t</span><span class="pc">r</span><span class="c">ue);</span>

	<span class="w">set_cpu_sibling_map</span><span class="c">(</span><span class="pc">c</span><span class="c">pu);</span>
	<span class="w">set_cpu_core_map</span><span class="c">(</span><span class="pc">c</span><span class="c">pu);</span>

	<span class="w">calculate_cpu_foreign_map</span><span class="pc">()</span><span class="c">;</span>

	<span class="w">c</span><span class="pc">pum</span><span class="c">ask_set_cpu(</span><span class="pc">cpu, </span><span class="c">&amp;</span><span class="w">cpu_callin_map</span><span class="c">);</span>

	<span class="w">synchronise_count_slave</span><span class="c">(</span><span class="w">c</span><span class="pc">pu</span><span class="c">);</span>

	
	<span class="w">WARN_ON_ONCE(!irqs_disabled(</span><span class="pc">))</span><span class="c">;</span>
	<span class="w">mp_ops-</span><span class="c">&gt;</span><span class="w">smp_finish</span><span class="pc">(</span><span class="c">);</span>

	<span class="w">cpu_startup_entry</span><span class="c">(</span><span class="w">CPUHP_ONLINE</span><span class="c">);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">void</span> <span class="w">stop_this_cpu</span><span class="c">(</span><span class="pc">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">du</span><span class="c">mmy)</span>
<span class="c">{</span>
	

	<span class="w">cpumask_copy</span><span class="pc">(&amp;</span><span class="w">cpu_foreign_map</span><span class="pc">,</span> <span class="w">cpu_online_mask</span><span class="c">);</span>

	
	<span class="w">smp_mb</span><span class="c">();</span>

	<span class="w">set_cpu_online</span><span class="c">(</span><span class="w">smp_processor_id()</span><span class="pc">,</span> <span class="w">f</span><span class="pc">a</span><span class="c">lse);</span>
	<span class="w">calculate_cpu_foreign_map</span><span class="pc">()</span><span class="c">;</span>
	<span class="w">local_irq_disable</span><span class="c">();</span>
	<span class="w">w</span><span class="c">hile</span> <span class="c">(</span><span class="w">1</span><span class="pc">);</span>
<span class="c">}</span>

<span class="pc">v</span><span class="c">oid</span> <span class="w">smp_send_stop</span><span class="c">(</span><span class="pc">v</span><span class="c">oid)</span>
<span class="c">{</span>
	<span class="w">smp_call_function</span><span class="pc">(</span><span class="w">st</span><span class="pc">o</span><span class="c">p_this_cpu</span><span class="pc">,</span> <span class="w">N</span><span class="c">ULL</span><span class="pc">,</span> <span class="c">0);</span>
<span class="c">}</span>

<span class="pc">v</span><span class="c">oid</span> <span class="pc">__i</span><span class="c">nit</span> <span class="w">smp_cpus_done</span><span class="c">(</span><span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">max_cpus</span><span class="pc">)</span>
<span class="c">{</span>
<span class="w">}</span>


<span class="pc">v</span><span class="c">oid</span> <span class="pc">__in</span><span class="c">it</span> <span class="w">smp_prepare_cpus</span><span class="c">(</span><span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">m</span><span class="c">ax_cpus</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">init_new_context</span><span class="c">(</span><span class="w">cu</span><span class="c">rrent</span><span class="pc">, &amp;</span><span class="w">init_mm</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">current_thread_info()-&gt;cp</span><span class="c">u</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="w">mp_ops-</span><span class="c">&gt;</span><span class="w">prepare_cpus</span><span class="pc">(m</span><span class="c">ax_cpus</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">set_cpu_sibling_map</span><span class="c">(</span><span class="w">0</span><span class="c">);</span>
	<span class="w">set_cpu_core_map</span><span class="c">(</span><span class="w">0</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">calculate_cpu_foreign_map</span><span class="pc">()</span><span class="c">;</span>
<span class="w">#i</span><span class="pc">fn</span><span class="c">def</span> <span class="w">CONFIG_HOTPLUG_CPU</span>
	<span class="w">init_cpu_present</span><span class="c">(</span><span class="w">cpu_possible_mask</span><span class="pc">)</span><span class="c">;</span>
<span class="c">#endif</span>
	<span class="w">cpumask_copy</span><span class="pc">(&amp;</span><span class="w">cpu_coherent_mask</span><span class="pc">,</span> <span class="w">c</span><span class="pc">p</span><span class="c">u_possible_mask);</span>
<span class="c">}</span>


<span class="pc">v</span><span class="c">oid</span> <span class="w">smp_prepare_boot_cpu</span><span class="c">(</span><span class="pc">v</span><span class="c">oid</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">set_cpu_possible</span><span class="c">(</span><span class="w">0</span><span class="pc">,</span> <span class="w">t</span><span class="pc">r</span><span class="c">ue);</span>
	<span class="w">set_cpu_online</span><span class="c">(</span><span class="w">0</span><span class="pc">,</span> <span class="w">t</span><span class="pc">r</span><span class="c">ue);</span>
	<span class="w">cpumask_set_cpu</span><span class="c">(</span><span class="w">0</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">cpu_callin_map</span><span class="c">);</span>
<span class="c">}</span>

<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">__cpu_up</span><span class="c">(</span><span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="c">int</span> <span class="w">c</span><span class="pc">pu</span><span class="c">,</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">t</span><span class="c">ask_struct</span> <span class="c">*</span><span class="w">tidle</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">mp_ops-</span><span class="c">&gt;</span><span class="w">boot_secondary</span><span class="pc">(</span><span class="w">c</span><span class="pc">pu,</span> <span class="c">tidle</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="w">w</span><span class="c">hile</span> <span class="pc">(!</span><span class="w">cpumask_test_cpu</span><span class="c">(</span><span class="w">cp</span><span class="pc">u</span><span class="w">,</span><span class="pc"> </span><span class="c">&amp;</span><span class="w">c</span><span class="pc">pu_</span><span class="c">callin_map</span><span class="w">)</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">ud</span><span class="c">elay(100);</span>
		<span class="w">schedule</span><span class="pc">()</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">synchronise_count_master</span><span class="c">(</span><span class="w">cp</span><span class="pc">u</span><span class="c">);</span>
	<span class="w">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>


<span class="w">i</span><span class="c">nt</span> <span class="w">setup_profiling_timer</span><span class="c">(</span><span class="w">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">multiplier</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">flush_tlb_all_ipi</span><span class="c">(</span><span class="pc">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">in</span><span class="pc">f</span><span class="c">o)</span>
<span class="c">{</span>
	<span class="w">local_flush_tlb_all</span><span class="pc">()</span><span class="c">;</span>
<span class="w">}</span>

<span class="w">v</span><span class="c">oid</span> <span class="w">flush_tlb_all</span><span class="c">(</span><span class="pc">v</span><span class="c">oid</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">on_each_cpu</span><span class="pc">(</span><span class="w">f</span><span class="c">lush_tlb_all_ipi</span><span class="pc">,</span> <span class="pc">N</span><span class="c">ULL</span><span class="pc">,</span> <span class="pc">1</span><span class="c">);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">void</span> <span class="w">flush_tlb_mm_ipi</span><span class="c">(</span><span class="pc">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">mm</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">local_flush_tlb_mm(</span><span class="pc">(s</span><span class="c">truct</span> <span class="w">m</span><span class="c">m_struct</span> <span class="pc">*)</span><span class="w">m</span><span class="c">m</span><span class="pc">);</span>
<span class="pc">}</span>


<span class="c">static</span> <span class="c">inline</span> <span class="c">void</span> <span class="w">smp_on_other_tlbs</span><span class="c">(</span><span class="pc">v</span><span class="c">oid</span> <span class="w">(</span><span class="pc">*</span><span class="w">f</span><span class="pc">u</span><span class="c">nc</span><span class="pc">) </span><span class="c">(</span><span class="pc">v</span><span class="c">oid</span> <span class="pc">*</span><span class="w">inf</span><span class="c">o</span><span class="pc">),</span> <span class="pc">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">inf</span><span class="c">o)</span>
<span class="c">{</span>
	<span class="w">smp_call_function</span><span class="c">(</span><span class="w">f</span><span class="pc">u</span><span class="c">nc,</span> <span class="w">i</span><span class="pc">nf</span><span class="c">o</span><span class="pc">,</span> <span class="w">1</span><span class="c">);</span>
<span class="c">}</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="c">inline</span> <span class="c">void</span> <span class="w">smp_on_each_tlb</span><span class="c">(</span><span class="pc">v</span><span class="c">oid</span> <span class="pc">(</span><span class="c">*</span><span class="w">f</span><span class="pc">unc) </span><span class="c">(</span><span class="pc">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">i</span><span class="pc">nf</span><span class="c">o</span><span class="pc">),</span> <span class="pc">v</span><span class="c">oid</span> <span class="pc">*</span><span class="w">i</span><span class="c">nfo)</span>
<span class="c">{</span>
	<span class="w">preempt_disable</span><span class="pc">()</span><span class="c">;</span>

	<span class="w">smp_on_other_tlbs</span><span class="c">(</span><span class="w">f</span><span class="pc">u</span><span class="c">nc,</span> <span class="pc">i</span><span class="c">nfo);</span>
	<span class="w">f</span><span class="pc">u</span><span class="c">nc</span><span class="pc">(</span><span class="c">info);</span>

	<span class="w">preempt_enable</span><span class="pc">()</span><span class="c">;</span>
<span class="c">}</span>



<span class="pc">v</span><span class="c">oid</span> <span class="w">flush_tlb_mm</span><span class="c">(struct</span> <span class="w">mm</span><span class="c">_struct</span> <span class="c">*</span><span class="w">m</span><span class="c">m</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">p</span><span class="c">reempt_disable</span><span class="pc">()</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">((</span><span class="w">a</span><span class="pc">to</span><span class="c">mic_read(&amp;</span><span class="w">m</span><span class="c">m-&gt;</span><span class="w">mm_users</span><span class="pc">) !</span><span class="c">=</span> <span class="pc">1</span><span class="w">) </span><span class="pc">|| </span><span class="c">(</span><span class="w">cu</span><span class="c">rrent</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">m</span><span class="pc">m</span> <span class="w">!</span><span class="c">=</span> <span class="w">m</span><span class="pc">m))</span><span class="c"> {</span>
		<span class="w">sm</span><span class="c">p_on_other_tlbs(</span><span class="w">flush_tlb_mm_ipi</span><span class="pc">,</span> <span class="w">mm</span><span class="c">);</span>
	<span class="c">}</span> <span class="c">else</span> <span class="c">{</span>
		<span class="w">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">c</span><span class="pc">p</span><span class="c">u;</span>

		<span class="w">for_each_online_cpu</span><span class="c">(</span><span class="w">c</span><span class="pc">pu</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">c</span><span class="pc">p</span><span class="c">u</span> <span class="w">!</span><span class="c">=</span> <span class="w">smp_processor_id() &amp;&amp;</span> <span class="w">cpu_context</span><span class="pc">(</span><span class="w">c</span><span class="pc">p</span><span class="c">u</span><span class="pc">,</span> <span class="w">m</span><span class="pc">m))</span>
				<span class="w">c</span><span class="pc">p</span><span class="c">u_context(</span><span class="w">c</span><span class="c">pu</span><span class="pc">,</span> <span class="w">m</span><span class="c">m</span><span class="pc">) </span><span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
		<span class="c">}</span>
	<span class="pc">}</span>
	<span class="w">local_flush_tlb_mm</span><span class="c">(</span><span class="w">m</span><span class="pc">m)</span><span class="c">;</span>

	<span class="w">preempt_enable</span><span class="pc">()</span><span class="c">;</span>
<span class="c">}</span>

<span class="pc">str</span><span class="c">uct</span> <span class="w">flush_tlb_data</span> <span class="c">{</span>
	<span class="c">struct</span> <span class="w">v</span><span class="c">m_area_struct</span> <span class="c">*vma;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="w">addr1</span><span class="c">;</span>
	<span class="c">unsigned</span> <span class="c">long</span> <span class="w">addr2</span><span class="c">;</span>
<span class="w">}</span><span class="c">;</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">flush_tlb_range_ipi</span><span class="c">(</span><span class="pc">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">in</span><span class="pc">f</span><span class="c">o</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="pc">f</span><span class="c">lush_tlb_data</span> <span class="c">*</span><span class="w">fd</span> <span class="pc">=</span> <span class="w">i</span><span class="c">nfo</span><span class="pc">;</span>

	<span class="w">local_flush_tlb_range</span><span class="c">(</span><span class="w">fd</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">vm</span><span class="c">a</span><span class="pc">,</span> <span class="w">fd</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">addr1,</span> <span class="w">fd</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">a</span><span class="c">ddr2);</span>
<span class="c">}</span>

<span class="pc">v</span><span class="c">oid</span> <span class="w">flush_tlb_range</span><span class="c">(struct</span> <span class="w">v</span><span class="c">m_area_struct</span> <span class="c">*vma,</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="c">start,</span> <span class="c">unsigned</span> <span class="c">long</span> <span class="c">end)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">mm</span><span class="c">_struct</span> <span class="c">*</span><span class="pc">m</span><span class="c">m</span> <span class="pc">=</span> <span class="w">v</span><span class="pc">ma</span><span class="c">-&gt;</span><span class="w">vm_mm</span><span class="c">;</span>

	<span class="w">preempt_disable()</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">((</span><span class="w">a</span><span class="pc">t</span><span class="c">omic_read(&amp;</span><span class="w">m</span><span class="c">m-&gt;</span><span class="w">mm_users</span><span class="pc">) !</span><span class="c">=</span> <span class="pc">1</span><span class="w">) |</span><span class="pc">| </span><span class="c">(</span><span class="w">cu</span><span class="c">rrent</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">mm</span> <span class="pc">!</span><span class="c">=</span> <span class="w">m</span><span class="pc">m</span><span class="w">))</span><span class="pc"> </span><span class="c">{</span>
		<span class="w">st</span><span class="pc">r</span><span class="c">uct</span> <span class="w">flush_tlb_data</span> <span class="w">fd</span> <span class="pc">= </span><span class="c">{</span>
			<span class="c">.</span><span class="w">vm</span><span class="pc">a</span> <span class="c">=</span> <span class="w">v</span><span class="pc">ma</span><span class="c">,</span>
			<span class="c">.</span><span class="w">addr1</span> <span class="c">=</span> <span class="w">s</span><span class="pc">t</span><span class="c">art,</span>
			<span class="c">.</span><span class="w">addr2</span> <span class="c">=</span> <span class="w">e</span><span class="c">nd,</span>
		<span class="pc">}</span><span class="c">;</span>

		<span class="w">smp_on_other_tlbs</span><span class="pc">(</span><span class="w">flush_tlb_range_ipi</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">fd</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">}</span> <span class="w">e</span><span class="c">lse</span> <span class="c">{</span>
		<span class="w">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">c</span><span class="pc">p</span><span class="c">u;</span>

		<span class="w">for_each_online_cpu</span><span class="pc">(</span><span class="w">cp</span><span class="pc">u</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
			<span class="c">if</span> <span class="c">(</span><span class="w">c</span><span class="c">pu</span> <span class="w">!</span><span class="c">=</span> <span class="w">smp_processor_id() &amp;&amp;</span> <span class="w">cpu_context</span><span class="pc">(</span><span class="w">c</span><span class="c">pu</span><span class="pc">,</span> <span class="w">m</span><span class="pc">m))</span>
				<span class="w">c</span><span class="pc">p</span><span class="c">u_context(</span><span class="w">c</span><span class="pc">pu,</span> <span class="w">m</span><span class="c">m</span><span class="w">) </span><span class="pc">=</span> <span class="pc">0</span><span class="c">;</span>
		<span class="c">}</span>
	<span class="w">}</span>
	<span class="w">local_flush_tlb_range</span><span class="c">(</span><span class="w">v</span><span class="pc">m</span><span class="c">a,</span> <span class="w">s</span><span class="pc">ta</span><span class="c">rt,</span> <span class="w">e</span><span class="c">nd);</span>
	<span class="w">preempt_enable</span><span class="pc">()</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">flush_tlb_kernel_range_ipi</span><span class="c">(</span><span class="pc">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">in</span><span class="pc">f</span><span class="c">o</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">flush_tlb_data</span> <span class="c">*</span><span class="w">fd</span> <span class="pc">=</span> <span class="w">i</span><span class="c">nfo</span><span class="pc">;</span>

	<span class="w">local_flush_tlb_kernel_range</span><span class="pc">(</span><span class="w">fd</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">addr1</span><span class="c">,</span> <span class="w">fd</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">addr2</span><span class="c">);</span>
<span class="c">}</span>

<span class="pc">v</span><span class="c">oid</span> <span class="w">flush_tlb_kernel_range</span><span class="c">(</span><span class="w">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="w">s</span><span class="pc">t</span><span class="c">art,</span> <span class="c">unsigned</span> <span class="c">long</span> <span class="w">e</span><span class="c">nd</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">f</span><span class="pc">lush_tlb_d</span><span class="c">ata</span> <span class="w">fd</span> <span class="pc">= </span><span class="c">{</span>
		<span class="c">.</span><span class="w">a</span><span class="pc">ddr1</span> <span class="c">=</span> <span class="w">sta</span><span class="pc">r</span><span class="c">t,</span>
		<span class="c">.</span><span class="w">a</span><span class="pc">ddr2</span> <span class="c">=</span> <span class="w">en</span><span class="pc">d</span><span class="c">,</span>
	<span class="pc">}</span><span class="c">;</span>

	<span class="w">on_each_cpu</span><span class="c">(</span><span class="w">flush_tlb_kernel_range_ipi</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">fd</span><span class="pc">,</span> <span class="w">1</span><span class="pc">)</span><span class="c">;</span>
<span class="pc">}</span>

<span class="c">static</span> <span class="c">void</span> <span class="w">flush_tlb_page_ipi</span><span class="c">(</span><span class="pc">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">inf</span><span class="c">o</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">f</span><span class="pc">lush_tlb_d</span><span class="c">ata</span> <span class="c">*</span><span class="w">fd</span> <span class="pc">=</span> <span class="w">i</span><span class="c">nfo</span><span class="pc">;</span>

	<span class="w">local_flush_tlb_page</span><span class="c">(</span><span class="w">fd</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">vm</span><span class="c">a,</span> <span class="w">fd</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">addr1</span><span class="pc">)</span><span class="c">;</span>
<span class="pc">}</span>

<span class="pc">v</span><span class="c">oid</span> <span class="w">flush_tlb_page</span><span class="c">(struct</span> <span class="w">v</span><span class="c">m_area_struct</span> <span class="c">*vma</span><span class="pc">,</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="w">pa</span><span class="pc">ge)</span>
<span class="c">{</span>
	<span class="w">preempt_disable</span><span class="pc">()</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">((</span><span class="w">a</span><span class="pc">t</span><span class="c">omic_read(&amp;</span><span class="w">v</span><span class="pc">m</span><span class="c">a-&gt;</span><span class="w">vm_mm-</span><span class="c">&gt;</span><span class="w">mm_users) </span><span class="pc">!</span><span class="c">=</span> <span class="w">1) |</span><span class="pc">| </span><span class="c">(</span><span class="w">cu</span><span class="c">rrent-&gt;</span><span class="w">m</span><span class="pc">m</span> <span class="w">!</span><span class="c">=</span> <span class="w">v</span><span class="pc">ma</span><span class="c">-&gt;</span><span class="pc">vm_</span><span class="c">mm</span><span class="w">))</span><span class="pc"> </span><span class="c">{</span>
		<span class="w">st</span><span class="c">ruct</span> <span class="w">flush_tlb_data</span> <span class="w">fd</span> <span class="w">=</span><span class="pc"> </span><span class="c">{</span>
			<span class="c">.</span><span class="w">v</span><span class="c">ma</span> <span class="c">=</span> <span class="c">vma</span><span class="pc">,</span>
			<span class="c">.</span><span class="w">addr1</span> <span class="c">=</span> <span class="w">p</span><span class="pc">a</span><span class="c">ge,</span>
		<span class="w">}</span><span class="pc">;</span>

		<span class="w">smp_on_other_tlbs</span><span class="c">(</span><span class="w">flush_tlb_page_ipi</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">fd</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">}</span> <span class="w">e</span><span class="c">lse</span> <span class="c">{</span>
		<span class="w">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">c</span><span class="pc">p</span><span class="c">u;</span>

		<span class="w">for_each_online_cpu</span><span class="pc">(</span><span class="w">cp</span><span class="c">u</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">c</span><span class="c">pu</span> <span class="pc">!</span><span class="c">=</span> <span class="w">smp_processor_id() &amp;&amp;</span> <span class="w">cpu_context</span><span class="pc">(</span><span class="w">c</span><span class="c">pu</span><span class="pc">,</span> <span class="w">v</span><span class="pc">m</span><span class="c">a</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">vm_mm</span><span class="pc">))</span>
				<span class="w">c</span><span class="pc">p</span><span class="c">u_context(</span><span class="w">c</span><span class="c">pu</span><span class="pc">,</span> <span class="w">v</span><span class="pc">ma</span><span class="c">-&gt;</span><span class="pc">v</span><span class="c">m_mm</span><span class="w">) =</span> <span class="pc">0</span><span class="c">;</span>
		<span class="c">}</span>
	<span class="w">}</span>
	<span class="w">local_flush_tlb_page</span><span class="c">(</span><span class="w">v</span><span class="pc">ma,</span> <span class="w">p</span><span class="pc">a</span><span class="c">ge</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">preempt_enable</span><span class="pc">()</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">flush_tlb_one_ipi</span><span class="c">(</span><span class="pc">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">inf</span><span class="c">o</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="c">long</span> <span class="w">v</span><span class="pc">ad</span><span class="c">dr</span> <span class="pc">= </span><span class="c">(</span><span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span><span class="pc">)</span> <span class="w">in</span><span class="pc">f</span><span class="c">o</span><span class="w">;</span>

	<span class="w">local_flush_tlb_one</span><span class="pc">(</span><span class="w">va</span><span class="pc">d</span><span class="c">dr</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="pc">v</span><span class="c">oid</span> <span class="w">flush_tlb_one</span><span class="c">(</span><span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="w">v</span><span class="pc">ad</span><span class="c">dr</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">smp_on_each_tlb</span><span class="c">(</span><span class="w">f</span><span class="pc">lush_tlb_one_</span><span class="c">ipi</span><span class="w">,</span><span class="pc"> (v</span><span class="c">oid</span> <span class="c">*)</span> <span class="w">va</span><span class="pc">d</span><span class="c">dr);</span>
<span class="c">}</span>

<span class="w">E</span><span class="pc">XPORT_SYMBOL</span><span class="c">(</span><span class="w">flush_tlb_page</span><span class="c">);</span>
<span class="w">E</span><span class="c">XPORT_SYMBOL(</span><span class="w">f</span><span class="pc">lush_tlb_one</span><span class="c">);</span>

<span class="pc">#if</span> <span class="c">defined(</span><span class="w">CONFIG_KEXEC</span><span class="c">)</span>
<span class="w">v</span><span class="pc">o</span><span class="c">id</span> <span class="pc">(</span><span class="c">*</span><span class="w">dump_ipi_function_ptr</span><span class="c">)(</span><span class="pc">v</span><span class="c">oid</span> <span class="w">*) =</span> <span class="w">N</span><span class="c">ULL</span><span class="w">;</span>
<span class="pc">v</span><span class="c">oid</span> <span class="w">dump_send_ipi</span><span class="c">(void</span> <span class="w">(</span><span class="c">*</span><span class="w">dump_ipi_callback</span><span class="c">)(void</span> <span class="w">*))</span>
<span class="w">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">i;</span>
	<span class="c">int</span> <span class="w">c</span><span class="pc">p</span><span class="c">u</span> <span class="pc">=</span> <span class="w">smp_processor_id</span><span class="pc">()</span><span class="c">;</span>

	<span class="w">d</span><span class="c">ump_ipi_function_ptr</span> <span class="w">=</span> <span class="w">d</span><span class="c">ump_ipi_callback;</span>
	<span class="w">smp_mb</span><span class="pc">()</span><span class="c">;</span>
	<span class="w">for_each_online_cpu</span><span class="pc">(</span><span class="w">i)</span>
		<span class="w">i</span><span class="pc">f</span> <span class="c">(</span><span class="w">i</span> <span class="w">!</span><span class="c">=</span> <span class="w">c</span><span class="pc">p</span><span class="c">u</span><span class="pc">)</span>
			<span class="w">mp_ops-</span><span class="c">&gt;</span><span class="w">send_ipi_single</span><span class="pc">(i,</span> <span class="w">SMP_DUMP</span><span class="c">);</span>

<span class="pc">}</span>
<span class="w">E</span><span class="pc">XPORT_SYMBOL</span><span class="c">(</span><span class="w">dump_send_ipi</span><span class="c">);</span>
<span class="pc">#en</span><span class="c">dif</span>

<span class="pc">#</span><span class="c">ifdef</span> <span class="w">CONFIG_GENERIC_CLOCKEVENTS_BROADCAST</span>

<span class="c">static</span> <span class="w">DEFINE_PER_CPU</span><span class="c">(</span><span class="w">at</span><span class="pc">omic_t</span><span class="c">,</span> <span class="w">tick_broadcast_count</span><span class="pc">);</span>
<span class="c">static</span> <span class="w">D</span><span class="pc">EF</span><span class="c">INE_PER_CPU</span><span class="pc">(</span><span class="c">struct</span> <span class="w">call_single_data,</span> <span class="w">tick_broadcast_csd</span><span class="pc">);</span>

<span class="w">v</span><span class="c">oid</span> <span class="w">tick_broadcast</span><span class="c">(</span><span class="w">c</span><span class="pc">o</span><span class="c">nst</span> <span class="c">struct</span> <span class="w">cpumask</span> <span class="c">*</span><span class="w">m</span><span class="pc">as</span><span class="c">k</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">at</span><span class="pc">omic_t</span> <span class="pc">*</span><span class="w">c</span><span class="pc">o</span><span class="c">unt;</span>
	<span class="w">s</span><span class="c">truct</span> <span class="pc">ca</span><span class="c">ll_single_data</span> <span class="c">*</span><span class="w">csd</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">cp</span><span class="pc">u</span><span class="c">;</span>

	<span class="w">for_each_cpu</span><span class="c">(</span><span class="w">c</span><span class="pc">pu,</span> <span class="w">m</span><span class="pc">as</span><span class="c">k</span><span class="w">) {</span>
		<span class="w">c</span><span class="pc">ou</span><span class="c">nt</span> <span class="w">=</span><span class="pc"> &amp;</span><span class="w">per_cpu</span><span class="pc">(</span><span class="w">tick_broadcast_count</span><span class="pc">,</span> <span class="w">cp</span><span class="pc">u</span><span class="c">);</span>
		<span class="w">c</span><span class="pc">s</span><span class="c">d</span> <span class="w">=</span><span class="pc"> </span><span class="c">&amp;</span><span class="pc">p</span><span class="c">er_cpu</span><span class="pc">(</span><span class="w">tick_broadcast_csd</span><span class="pc">,</span> <span class="w">cp</span><span class="pc">u</span><span class="c">);</span>

		<span class="c">if</span> <span class="c">(</span><span class="w">atomic_inc_return</span><span class="c">(</span><span class="w">c</span><span class="pc">o</span><span class="c">unt</span><span class="w">) </span><span class="pc">=</span><span class="c">=</span> <span class="pc">1)</span>
			<span class="w">smp_call_function_single_async</span><span class="c">(</span><span class="w">cp</span><span class="c">u</span><span class="pc">,</span> <span class="pc">c</span><span class="c">sd</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">}</span>
<span class="w">}</span>

<span class="c">static</span> <span class="c">void</span> <span class="w">tick_broadcast_callee</span><span class="c">(</span><span class="pc">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">in</span><span class="pc">f</span><span class="c">o)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">c</span><span class="c">pu</span> <span class="pc">=</span> <span class="w">smp_processor_id</span><span class="pc">()</span><span class="c">;</span>
	<span class="w">tick_receive_broadcast</span><span class="pc">()</span><span class="c">;</span>
	<span class="w">at</span><span class="pc">omic_s</span><span class="c">et(&amp;</span><span class="pc">p</span><span class="c">er_cpu</span><span class="pc">(</span><span class="w">tick_broadcast_count</span><span class="c">,</span> <span class="w">c</span><span class="pc">p</span><span class="c">u</span><span class="w">)</span><span class="pc">,</span> <span class="w">0</span><span class="c">);</span>
<span class="pc">}</span>

<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="c">__init</span> <span class="w">tick_broadcast_init</span><span class="c">(void)</span>
<span class="c">{</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">call_single_data</span> <span class="c">*</span><span class="w">csd</span><span class="pc">;</span>
	<span class="c">int</span> <span class="w">c</span><span class="pc">p</span><span class="c">u;</span>

	<span class="w">f</span><span class="c">or</span> <span class="c">(</span><span class="w">cp</span><span class="c">u</span> <span class="c">=</span> <span class="c">0;</span> <span class="w">c</span><span class="pc">p</span><span class="c">u</span> <span class="c">&lt;</span> <span class="w">NR_CPUS</span><span class="c">;</span> <span class="w">c</span><span class="pc">p</span><span class="c">u++) {</span>
		<span class="w">c</span><span class="c">sd</span> <span class="w">=</span><span class="pc"> &amp;</span><span class="w">p</span><span class="pc">e</span><span class="c">r_cpu</span><span class="w">(tick_broadcast_csd</span><span class="pc">,</span> <span class="w">c</span><span class="pc">p</span><span class="c">u);</span>
		<span class="pc">c</span><span class="c">sd</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">f</span><span class="pc">u</span><span class="c">nc</span> <span class="c">=</span> <span class="w">tick_broadcast_callee</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>
<span class="w">early_initcall</span><span class="pc">(</span><span class="w">tick_broadcast_init</span><span class="pc">)</span><span class="c">;</span>

<span class="w">#</span><span class="pc">e</span><span class="c">ndif</span> 

</pre>
</body>
</html>

