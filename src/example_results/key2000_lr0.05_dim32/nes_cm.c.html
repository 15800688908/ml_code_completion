<!DOCTYPE html>
<html>
<head>
<style>
span.c {
    background-color: #CCFFCC;
}
span.pc {
    background-color: #FFEEBB;
}
span.w {
    background-color: #FFCCCC;
}
</style>
</head>
<body>
<pre>



<span class="w">#define</span> <span class="w">TCPOPT_TIMESTAMP</span> <span class="w">8</span>

<span class="w">#include</span> <span class="w">&lt;linux/atomic.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/skbuff.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/ip.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/tcp.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="pc">i</span><span class="c">nit.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">if_arp</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">if_vlan</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">notifier</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">n</span><span class="pc">e</span><span class="c">t.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">t</span><span class="c">ypes.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">t</span><span class="pc">i</span><span class="c">mer.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">t</span><span class="pc">ime</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="pc">d</span><span class="c">elay.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">etherdevice</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">netdevice</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">random</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">l</span><span class="c">ist.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">threads</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">highmem</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="pc">s</span><span class="c">lab.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;</span><span class="pc">n</span><span class="c">et/</span><span class="w">arp</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;net/</span><span class="w">neighbour</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;net/</span><span class="w">route</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;net/</span><span class="w">ip_fib</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;net/</span><span class="w">tcp</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;</span><span class="pc">l</span><span class="c">inux/</span><span class="w">fcntl</span><span class="c">.h&gt;</span>

<span class="c">#include</span> <span class="pc">"</span><span class="w">nes</span><span class="c">.h"</span>

<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">cm_packets_sent</span><span class="pc">;</span>
<span class="pc">u</span><span class="c">32</span> <span class="w">cm_packets_bounced</span><span class="c">;</span>
<span class="c">u32</span> <span class="w">cm_packets_dropped</span><span class="c">;</span>
<span class="c">u32</span> <span class="w">cm_packets_retrans</span><span class="c">;</span>
<span class="c">u32</span> <span class="w">cm_packets_created</span><span class="c">;</span>
<span class="c">u32</span> <span class="w">cm_packets_received</span><span class="c">;</span>
<span class="w">a</span><span class="c">tomic_t</span> <span class="w">cm_listens_created</span><span class="c">;</span>
<span class="w">a</span><span class="pc">t</span><span class="c">omic_t</span> <span class="w">cm_listens_destroyed</span><span class="c">;</span>
<span class="pc">u</span><span class="c">32</span> <span class="w">cm_backlog_drops</span><span class="c">;</span>
<span class="w">a</span><span class="pc">t</span><span class="c">omic_t</span> <span class="w">cm_loopbacks</span><span class="c">;</span>
<span class="w">a</span><span class="pc">t</span><span class="c">omic_t</span> <span class="w">cm_nodes_created</span><span class="c">;</span>
<span class="w">a</span><span class="pc">t</span><span class="c">omic_t</span> <span class="w">cm_nodes_destroyed</span><span class="c">;</span>
<span class="w">a</span><span class="pc">t</span><span class="c">omic_t</span> <span class="w">cm_accel_dropped_pkts</span><span class="c">;</span>
<span class="w">a</span><span class="pc">t</span><span class="c">omic_t</span> <span class="w">cm_resets_recvd</span><span class="c">;</span>

<span class="w">st</span><span class="pc">ati</span><span class="c">c</span> <span class="c">inline</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">mini_cm_accelerated</span><span class="c">(struct</span> <span class="w">nes_cm_core</span> <span class="w">*</span><span class="pc">,</span> <span class="c">struct</span> <span class="w">nes_cm_node</span> <span class="pc">*)</span><span class="c">;</span>
<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">nes_cm_listener</span> <span class="c">*</span><span class="w">mini_cm_listen</span><span class="c">(struct</span> <span class="pc">nes_cm_c</span><span class="c">ore</span> <span class="pc">*,</span> <span class="c">struct</span> <span class="w">nes_vnic</span> <span class="pc">*,</span> <span class="c">struct</span> <span class="w">nes_cm_info</span> <span class="pc">*)</span><span class="c">;</span>
<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="pc">int</span> <span class="w">mini_cm_del_listen</span><span class="c">(struct</span> <span class="pc">nes_cm_c</span><span class="c">ore</span> <span class="c">*,</span> <span class="c">struct</span> <span class="w">n</span><span class="pc">es_cm_l</span><span class="c">istener</span> <span class="pc">*)</span><span class="c">;</span>
<span class="pc">s</span><span class="c">tatic</span> <span class="pc">s</span><span class="c">truct</span> <span class="pc">nes_cm_n</span><span class="c">ode</span> <span class="c">*</span><span class="w">mini_cm_connect</span><span class="c">(struct</span> <span class="c">nes_cm_core</span> <span class="pc">*,</span> <span class="c">struct</span> <span class="pc">nes_v</span><span class="c">nic</span> <span class="c">*,</span> <span class="w">u</span><span class="pc">1</span><span class="c">6,</span> <span class="w">v</span><span class="c">oid</span> <span class="pc">*,</span> <span class="c">struct</span> <span class="c">nes_cm_info</span> <span class="c">*);</span>
<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="pc">int</span> <span class="w">mini_cm_close</span><span class="c">(struct</span> <span class="c">nes_cm_core</span> <span class="pc">*,</span> <span class="c">struct</span> <span class="pc">nes_cm_n</span><span class="c">ode</span> <span class="c">*);</span>
<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="c">int</span> <span class="w">mini_cm_accept</span><span class="c">(struct</span> <span class="pc">nes_cm_c</span><span class="c">ore</span> <span class="c">*,</span> <span class="c">struct</span> <span class="pc">nes_cm_n</span><span class="c">ode</span> <span class="c">*);</span>
<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="c">int</span> <span class="w">mini_cm_reject</span><span class="c">(struct</span> <span class="c">nes_cm_core</span> <span class="c">*,</span> <span class="c">struct</span> <span class="c">nes_cm_node</span> <span class="pc">*)</span><span class="c">;</span>
<span class="pc">s</span><span class="c">tatic</span> <span class="c">int</span> <span class="w">mini_cm_recv_pkt</span><span class="c">(struct</span> <span class="pc">nes_cm_c</span><span class="c">ore</span> <span class="c">*,</span> <span class="c">struct</span> <span class="w">nes_vnic</span> <span class="pc">*,</span> <span class="c">struct</span> <span class="w">s</span><span class="c">k_buff</span> <span class="c">*);</span>
<span class="c">static</span> <span class="pc">int</span> <span class="w">mini_cm_dealloc_core</span><span class="c">(struct</span> <span class="pc">nes_cm_c</span><span class="c">ore</span> <span class="c">*);</span>
<span class="c">static</span> <span class="c">int</span> <span class="w">mini_cm_get</span><span class="c">(struct</span> <span class="c">nes_cm_core</span> <span class="pc">*)</span><span class="c">;</span>
<span class="c">static</span> <span class="c">int</span> <span class="w">mini_cm_set</span><span class="c">(struct</span> <span class="pc">ne</span><span class="c">s_cm_core</span> <span class="c">*,</span> <span class="pc">u</span><span class="c">32,</span> <span class="c">u32</span><span class="w">)</span><span class="pc">;</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">form_cm_frame</span><span class="c">(struct</span> <span class="w">s</span><span class="c">k_buff</span> <span class="pc">*,</span> <span class="c">struct</span> <span class="w">nes_cm_node</span> <span class="pc">*,</span> <span class="pc">v</span><span class="c">oid</span> <span class="pc">*,</span> <span class="pc">u</span><span class="c">32</span><span class="pc">,</span> <span class="w">v</span><span class="c">oid</span> <span class="pc">*,</span> <span class="pc">u</span><span class="c">32,</span> <span class="w">u</span><span class="pc">8)</span><span class="c">;</span>
<span class="w">s</span><span class="c">tatic</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">add_ref_cm_node</span><span class="c">(struct</span> <span class="pc">nes_cm_n</span><span class="c">ode</span> <span class="pc">*)</span><span class="c">;</span>
<span class="pc">s</span><span class="c">tatic</span> <span class="c">int</span> <span class="w">rem_ref_cm_node</span><span class="c">(struct</span> <span class="c">nes_cm_core</span> <span class="c">*,</span> <span class="pc">s</span><span class="c">truct</span> <span class="c">nes_cm_node</span> <span class="c">*);</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="pc">int</span> <span class="w">nes_cm_disconn_true</span><span class="c">(struct</span> <span class="w">nes_qp</span> <span class="pc">*)</span><span class="c">;</span>
<span class="pc">s</span><span class="c">tatic</span> <span class="pc">int</span> <span class="w">nes_cm_post_event</span><span class="c">(struct</span> <span class="w">nes_cm_event</span> <span class="pc">*</span><span class="w">ev</span><span class="c">ent</span><span class="pc">);</span>
<span class="c">static</span> <span class="c">int</span> <span class="w">nes_disconnect</span><span class="c">(struct</span> <span class="pc">nes_q</span><span class="c">p</span> <span class="c">*</span><span class="w">nesqp</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">abrupt</span><span class="pc">);</span>
<span class="pc">s</span><span class="c">tatic</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">nes_disconnect_worker</span><span class="c">(struct</span> <span class="w">w</span><span class="c">ork_struct</span> <span class="c">*work</span><span class="pc">);</span>

<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">send_mpa_request</span><span class="c">(struct</span> <span class="w">nes_cm_node</span> <span class="pc">*,</span> <span class="c">struct</span> <span class="w">s</span><span class="c">k_buff</span> <span class="pc">*)</span><span class="c">;</span>
<span class="pc">s</span><span class="c">tatic</span> <span class="c">int</span> <span class="w">send_mpa_reject</span><span class="c">(struct</span> <span class="w">nes</span><span class="pc">_cm_n</span><span class="c">ode</span> <span class="pc">*)</span><span class="c">;</span>
<span class="c">static</span> <span class="c">int</span> <span class="w">send_syn</span><span class="c">(struct</span> <span class="c">nes_cm_node</span> <span class="pc">*,</span> <span class="pc">u3</span><span class="c">2,</span> <span class="c">struct</span> <span class="w">s</span><span class="pc">k</span><span class="c">_buff</span> <span class="pc">*)</span><span class="c">;</span>
<span class="pc">s</span><span class="c">tatic</span> <span class="pc">int</span> <span class="w">send_reset</span><span class="c">(struct</span> <span class="c">nes_cm_node</span> <span class="pc">*,</span> <span class="c">struct</span> <span class="pc">sk</span><span class="c">_buff</span> <span class="c">*);</span>
<span class="pc">s</span><span class="c">tatic</span> <span class="pc">int</span> <span class="w">send_ack</span><span class="c">(struct</span> <span class="c">nes_cm_node</span> <span class="pc">*</span><span class="w">cm_node</span><span class="c">,</span> <span class="c">struct</span> <span class="w">s</span><span class="pc">k</span><span class="c">_buff</span> <span class="c">*skb</span><span class="pc">);</span>
<span class="c">static</span> <span class="pc">int</span> <span class="w">send_fin</span><span class="c">(struct</span> <span class="c">nes_cm_node</span> <span class="c">*</span><span class="pc">c</span><span class="c">m_node,</span> <span class="pc">s</span><span class="c">truct</span> <span class="c">sk_buff</span> <span class="c">*skb</span><span class="pc">)</span><span class="c">;</span>
<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">process_packet</span><span class="c">(struct</span> <span class="c">nes_cm_node</span> <span class="pc">*,</span> <span class="c">struct</span> <span class="pc">s</span><span class="c">k_buff</span> <span class="pc">*,</span> <span class="c">struct</span> <span class="w">nes_cm_core</span> <span class="c">*);</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">active_open_err</span><span class="c">(struct</span> <span class="c">nes_cm_node</span> <span class="pc">*,</span> <span class="c">struct</span> <span class="pc">s</span><span class="c">k_buff</span> <span class="pc">*,</span> <span class="pc">i</span><span class="c">nt);</span>
<span class="pc">s</span><span class="c">tatic</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">passive_open_err</span><span class="c">(struct</span> <span class="pc">nes</span><span class="c">_cm_node</span> <span class="pc">*,</span> <span class="c">struct</span> <span class="c">sk_buff</span> <span class="pc">*,</span> <span class="pc">i</span><span class="c">nt</span><span class="pc">)</span><span class="c">;</span>
<span class="pc">s</span><span class="c">tatic</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">cleanup_retrans_entry</span><span class="c">(struct</span> <span class="c">nes_cm_node</span> <span class="pc">*)</span><span class="c">;</span>
<span class="pc">s</span><span class="c">tatic</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">handle_rcv_mpa</span><span class="c">(struct</span> <span class="pc">nes_cm_n</span><span class="c">ode</span> <span class="pc">*,</span> <span class="c">struct</span> <span class="w">s</span><span class="c">k_buff</span> <span class="c">*);</span>
<span class="pc">s</span><span class="c">tatic</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">free_retrans_entry</span><span class="c">(struct</span> <span class="c">nes_cm_node</span> <span class="pc">*</span><span class="w">cm_node</span><span class="pc">);</span>
<span class="c">static</span> <span class="pc">int</span> <span class="w">handle_tcp_options</span><span class="c">(struct</span> <span class="c">nes_cm_node</span> <span class="c">*cm_node,</span> <span class="c">struct</span> <span class="w">tcphdr</span> <span class="c">*</span><span class="w">tcph</span><span class="c">,</span> <span class="c">struct</span> <span class="pc">s</span><span class="c">k_buff</span> <span class="c">*skb,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">optionsize</span><span class="c">,</span> <span class="c">int</span> <span class="w">passive</span><span class="c">);</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">cm_event_connected</span><span class="c">(struct</span> <span class="w">nes_cm_event</span> <span class="pc">*)</span><span class="c">;</span>
<span class="pc">s</span><span class="c">tatic</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">cm_event_connect_error</span><span class="c">(struct</span> <span class="w">n</span><span class="pc">es_cm_e</span><span class="c">vent</span> <span class="pc">*)</span><span class="c">;</span>
<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">cm_event_reset</span><span class="c">(struct</span> <span class="c">nes_cm_event</span> <span class="pc">*)</span><span class="c">;</span>
<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">cm_event_mpa_req</span><span class="c">(struct</span> <span class="pc">nes</span><span class="c">_cm_event</span> <span class="pc">*)</span><span class="c">;</span>
<span class="c">static</span> <span class="c">void</span> <span class="w">cm_event_mpa_reject</span><span class="c">(struct</span> <span class="c">nes_cm_event</span> <span class="c">*);</span>
<span class="c">static</span> <span class="c">void</span> <span class="w">handle_recv_entry</span><span class="c">(struct</span> <span class="w">nes_cm_node</span> <span class="pc">*</span><span class="w">cm_node</span><span class="c">,</span> <span class="pc">u</span><span class="c">32</span> <span class="w">rem_node</span><span class="pc">);</span>


<span class="c">static</span> <span class="pc">int</span> <span class="w">cm_build_mpa_frame</span><span class="c">(struct</span> <span class="pc">nes_cm_n</span><span class="c">ode</span> <span class="pc">*,</span> <span class="w">u</span><span class="pc">8</span> <span class="w">**,</span> <span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="w">*</span><span class="pc">,</span> <span class="pc">u8</span> <span class="pc">*,</span> <span class="c">u8</span><span class="pc">)</span><span class="c">;</span>
<span class="c">static</span> <span class="c">void</span> <span class="w">build_mpa_v2</span><span class="c">(struct</span> <span class="pc">n</span><span class="c">es_cm_node</span> <span class="pc">*,</span> <span class="pc">v</span><span class="c">oid</span> <span class="pc">*</span><span class="c">,</span> <span class="pc">u8)</span><span class="c">;</span>
<span class="c">static</span> <span class="c">void</span> <span class="w">build_mpa_v1</span><span class="c">(struct</span> <span class="c">nes_cm_node</span> <span class="pc">*,</span> <span class="w">v</span><span class="c">oid</span> <span class="pc">*,</span> <span class="pc">u8)</span><span class="c">;</span>
<span class="pc">s</span><span class="c">tatic</span> <span class="c">void</span> <span class="w">build_rdma0_msg</span><span class="c">(struct</span> <span class="c">nes_cm_node</span> <span class="pc">*,</span> <span class="c">struct</span> <span class="w">nes_qp</span> <span class="w">**);</span>

<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">print_core</span><span class="c">(struct</span> <span class="w">nes_cm_core</span> <span class="pc">*</span><span class="w">co</span><span class="pc">r</span><span class="c">e</span><span class="pc">)</span><span class="c">;</span>
<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">record_ird_ord</span><span class="c">(struct</span> <span class="pc">nes_cm_n</span><span class="c">ode</span> <span class="pc">*,</span> <span class="w">u</span><span class="pc">1</span><span class="c">6,</span> <span class="w">u</span><span class="pc">1</span><span class="c">6</span><span class="pc">)</span><span class="c">;</span>




<span class="pc">s</span><span class="c">tatic</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">nes_cm_ops</span> <span class="w">nes_cm_api</span> <span class="c">= {</span>
	<span class="w">mini_cm_accelerated</span><span class="pc">,</span>
	<span class="w">mini_cm_listen</span><span class="c">,</span>
	<span class="w">mini_cm_del_listen</span><span class="c">,</span>
	<span class="w">mini_cm_connect</span><span class="c">,</span>
	<span class="w">mini_cm_close</span><span class="c">,</span>
	<span class="w">mini_cm_accept</span><span class="c">,</span>
	<span class="w">mini_cm_reject</span><span class="c">,</span>
	<span class="w">mini_cm_recv_pkt</span><span class="c">,</span>
	<span class="w">mini_cm_dealloc_core</span><span class="c">,</span>
	<span class="w">mini_cm_get</span><span class="c">,</span>
	<span class="w">mini_cm_set</span>
<span class="pc">}</span><span class="c">;</span>

<span class="c">static</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">nes_cm_core</span> <span class="c">*</span><span class="w">g_cm_core;</span>

<span class="w">a</span><span class="pc">t</span><span class="c">omic_t</span> <span class="w">cm_connects</span><span class="c">;</span>
<span class="w">a</span><span class="c">tomic_t</span> <span class="w">cm_accepts</span><span class="c">;</span>
<span class="w">a</span><span class="c">tomic_t</span> <span class="w">cm_disconnects</span><span class="c">;</span>
<span class="w">a</span><span class="c">tomic_t</span> <span class="w">cm_closes</span><span class="c">;</span>
<span class="w">a</span><span class="c">tomic_t</span> <span class="w">cm_connecteds</span><span class="c">;</span>
<span class="w">a</span><span class="c">tomic_t</span> <span class="w">cm_connect_reqs</span><span class="c">;</span>
<span class="w">a</span><span class="c">tomic_t</span> <span class="w">cm_rejects</span><span class="c">;</span>

<span class="w">i</span><span class="c">nt</span> <span class="w">nes_add_ref_cm_node</span><span class="pc">(</span><span class="c">struct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="w">cm_node</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">r</span><span class="c">eturn</span> <span class="w">add_ref_cm_node</span><span class="pc">(</span><span class="c">cm_node);</span>
<span class="pc">}</span>

<span class="pc">i</span><span class="c">nt</span> <span class="w">nes_rem_ref_cm_node</span><span class="c">(struct</span> <span class="pc">n</span><span class="c">es_cm_node</span> <span class="c">*cm_node</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">rem_ref_cm_node</span><span class="pc">(</span><span class="c">cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">cm_core</span><span class="pc">,</span> <span class="pc">cm_n</span><span class="c">ode);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">nes_cm_event</span> <span class="c">*</span><span class="w">create_event</span><span class="c">(struct</span> <span class="pc">nes_cm_n</span><span class="c">ode</span> <span class="c">*</span>	<span class="c">cm_node,</span>
					 <span class="w">e</span><span class="c">num</span> <span class="w">nes_cm_event_type</span> <span class="c">type)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="pc">nes_cm_e</span><span class="c">vent</span> <span class="c">*</span><span class="w">ev</span><span class="c">ent</span><span class="pc">;</span>

	<span class="w">i</span><span class="pc">f</span> <span class="pc">(!c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">cm_id</span><span class="c">)</span>
		<span class="c">return</span> <span class="pc">N</span><span class="c">ULL;</span>

	
	<span class="w">e</span><span class="pc">v</span><span class="c">ent</span> <span class="pc">=</span> <span class="pc">k</span><span class="c">zalloc(sizeof(*</span><span class="w">e</span><span class="pc">ve</span><span class="c">nt),</span> <span class="pc">GFP_A</span><span class="c">TOMIC);</span>

	<span class="c">if</span> <span class="c">(!</span><span class="w">e</span><span class="pc">v</span><span class="c">ent)</span>
		<span class="c">return</span> <span class="pc">N</span><span class="c">ULL;</span>

	<span class="w">ev</span><span class="c">ent</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">t</span><span class="c">ype</span> <span class="c">=</span> <span class="w">t</span><span class="pc">y</span><span class="c">pe;</span>
	<span class="w">e</span><span class="pc">v</span><span class="c">ent-&gt;</span><span class="pc">c</span><span class="c">m_node</span> <span class="c">=</span> <span class="pc">cm_n</span><span class="c">ode</span><span class="pc">;</span>
	<span class="w">e</span><span class="pc">v</span><span class="c">ent-&gt;</span><span class="w">cm_info</span><span class="pc">.</span><span class="w">rem_addr</span> <span class="c">=</span> <span class="pc">c</span><span class="c">m_node-&gt;rem_addr;</span>
	<span class="w">e</span><span class="pc">v</span><span class="c">ent-&gt;</span><span class="pc">c</span><span class="c">m_info</span><span class="pc">.</span><span class="w">loc_addr</span> <span class="c">=</span> <span class="c">cm_node-&gt;loc_addr;</span>
	<span class="w">e</span><span class="pc">v</span><span class="c">ent-&gt;cm_info</span><span class="pc">.</span><span class="w">rem_port</span> <span class="c">=</span> <span class="c">cm_node-&gt;rem_port;</span>
	<span class="w">ev</span><span class="pc">e</span><span class="c">nt-&gt;cm_info.</span><span class="w">loc_port</span> <span class="c">=</span> <span class="c">cm_node-&gt;loc_port;</span>
	<span class="w">ev</span><span class="pc">e</span><span class="c">nt-&gt;cm_info.</span><span class="w">cm_id</span> <span class="c">=</span> <span class="c">cm_node-&gt;cm_id;</span>

	<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM,</span><span class="pc"> "cm_n</span><span class="c">ode</span><span class="w">=</span><span class="c">%</span><span class="pc">p</span> <span class="w">Created</span> <span class="w">e</span><span class="pc">v</span><span class="c">ent</span><span class="pc">=</span><span class="c">%</span><span class="pc">p,</span> <span class="w">t</span><span class="pc">y</span><span class="c">pe=%</span><span class="pc">u</span><span class="w">, </span><span class="pc">"</span>
		  <span class="w">"dst_addr</span><span class="c">=%</span><span class="w">0</span><span class="pc">8</span><span class="c">x</span><span class="w">[</span><span class="c">%</span><span class="w">x]</span><span class="pc">,</span> <span class="w">src_addr</span><span class="c">=%</span><span class="w">0</span><span class="pc">8</span><span class="c">x</span><span class="w">[</span><span class="c">%</span><span class="w">x</span><span class="pc">]</span><span class="c">\n",</span>
		  <span class="pc">c</span><span class="c">m_node</span><span class="pc">,</span> <span class="w">e</span><span class="pc">v</span><span class="c">ent,</span> <span class="w">t</span><span class="pc">y</span><span class="c">pe,</span> <span class="w">e</span><span class="pc">v</span><span class="c">ent</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">cm_info</span><span class="pc">.</span><span class="w">loc_addr</span><span class="pc">,</span>
		  <span class="w">e</span><span class="pc">ve</span><span class="c">nt</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">c</span><span class="c">m_info</span><span class="pc">.</span><span class="w">loc_port</span><span class="pc">,</span> <span class="w">e</span><span class="pc">v</span><span class="c">ent</span><span class="pc">-</span><span class="c">&gt;cm_info.</span><span class="w">rem_addr</span><span class="pc">,</span>
		  <span class="w">ev</span><span class="pc">e</span><span class="c">nt</span><span class="pc">-</span><span class="c">&gt;cm_info.</span><span class="w">rem_port</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">nes_cm_post_event</span><span class="c">(</span><span class="w">ev</span><span class="c">ent</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">ev</span><span class="c">ent;</span>
<span class="c">}</span>



<span class="c">static</span> <span class="c">int</span> <span class="w">send_mpa_request</span><span class="c">(struct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="w">cm_node</span><span class="c">,</span> <span class="c">struct</span> <span class="c">sk_buff</span> <span class="c">*skb</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="pc">8</span> <span class="w">start_addr</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="w">u</span><span class="c">8</span> <span class="c">*</span><span class="w">start_ptr</span> <span class="w">=</span><span class="pc"> &amp;</span><span class="w">s</span><span class="c">tart_addr;</span>
	<span class="w">u</span><span class="pc">8</span> <span class="w">*</span><span class="pc">*</span><span class="w">start_buff</span> <span class="w">=</span><span class="pc"> &amp;start_p</span><span class="c">tr</span><span class="pc">;</span>
	<span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="w">buff_len</span> <span class="pc">=</span> <span class="pc">0</span><span class="c">;</span>

	<span class="pc">if</span> <span class="pc">(!</span><span class="w">s</span><span class="pc">k</span><span class="c">b</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">nes_debug</span><span class="pc">(</span><span class="w">NES_DBG_CM</span><span class="pc">, "</span><span class="w">sk</span><span class="c">b</span> <span class="w">se</span><span class="c">t</span> <span class="w">t</span><span class="pc">o</span> <span class="w">N</span><span class="pc">U</span><span class="c">LL</span><span class="w">\</span><span class="c">n");</span>
		<span class="c">return</span> <span class="c">-</span><span class="pc">1</span><span class="c">;</span>
	<span class="c">}</span>

	
	<span class="w">cm_build_mpa_frame</span><span class="pc">(</span><span class="w">cm_node</span><span class="c">,</span> <span class="pc">start_b</span><span class="c">uff</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">b</span><span class="c">uff_len</span><span class="pc">,</span> <span class="pc">N</span><span class="c">ULL</span><span class="pc">,</span> <span class="w">MPA_KEY_REQUEST</span><span class="c">);</span>
	<span class="w">form_cm_frame</span><span class="c">(</span><span class="w">s</span><span class="c">kb,</span> <span class="w">c</span><span class="pc">m_n</span><span class="c">ode,</span> <span class="pc">N</span><span class="c">ULL,</span> <span class="pc">0</span><span class="w">, *s</span><span class="c">tart_buff</span><span class="pc">,</span> <span class="pc">b</span><span class="c">uff_len,</span> <span class="w">SET_ACK</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">schedule_nes_timer</span><span class="c">(</span><span class="pc">c</span><span class="c">m_node,</span> <span class="w">sk</span><span class="c">b,</span> <span class="w">NES_TIMER_TYPE_SEND</span><span class="c">,</span> <span class="w">1</span><span class="c">,</span> <span class="c">0</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>



<span class="c">static</span> <span class="c">int</span> <span class="w">send_mpa_reject</span><span class="c">(struct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="w">c</span><span class="c">m_node</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">s</span><span class="pc">k</span><span class="c">_buff</span> <span class="c">*skb</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="w">u</span><span class="pc">8</span> <span class="w">start_addr</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="w">u</span><span class="c">8</span> <span class="c">*</span><span class="w">start_ptr</span> <span class="w">=</span><span class="pc"> &amp;s</span><span class="c">tart_addr;</span>
	<span class="pc">u</span><span class="c">8</span> <span class="w">*</span><span class="pc">*</span><span class="w">start_buff</span> <span class="w">=</span><span class="pc"> &amp;start_p</span><span class="c">tr;</span>
	<span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="w">buff_len</span> <span class="pc">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="w">s</span><span class="c">truct</span> <span class="w">ietf_mpa_v1</span> <span class="c">*</span><span class="w">mpa_frame</span><span class="pc">;</span>

	<span class="w">sk</span><span class="c">b</span> <span class="c">=</span> <span class="w">dev_alloc_skb</span><span class="pc">(</span><span class="w">MAX_CM_BUFFER</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">sk</span><span class="c">b</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, "F</span><span class="c">ailed</span> <span class="c">to</span> <span class="pc">g</span><span class="c">et</span> <span class="w">a</span> <span class="w">Free</span> <span class="w">pk</span><span class="c">t\n");</span>
		<span class="c">return</span> <span class="c">-</span><span class="pc">EN</span><span class="c">OMEM;</span>
	<span class="c">}</span>

	
	<span class="w">cm_build_mpa_frame</span><span class="c">(</span><span class="w">cm_node</span><span class="c">,</span> <span class="w">start_buff</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">buff_len</span><span class="pc">,</span> <span class="pc">N</span><span class="c">ULL</span><span class="pc">,</span> <span class="w">MPA_KEY_REPLY</span><span class="c">);</span>
	<span class="w">mpa_frame</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="pc">s</span><span class="c">truct</span> <span class="w">ietf_mpa_v1</span> <span class="w">*)*s</span><span class="pc">tar</span><span class="c">t_buff</span><span class="pc">;</span>
	<span class="pc">m</span><span class="c">pa_frame</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">f</span><span class="c">lags</span> <span class="pc">|</span><span class="c">=</span> <span class="w">IETF_MPA_FLAGS_REJECT</span><span class="c">;</span>
	<span class="w">form_cm_frame</span><span class="c">(</span><span class="w">s</span><span class="pc">k</span><span class="c">b,</span> <span class="w">c</span><span class="c">m_node,</span> <span class="w">N</span><span class="c">ULL</span><span class="pc">,</span> <span class="c">0</span><span class="w">, *s</span><span class="c">tart_buff</span><span class="pc">,</span> <span class="pc">b</span><span class="c">uff_len,</span> <span class="w">SET_ACK</span> <span class="w">|</span> <span class="w">SET_FIN</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">s</span><span class="c">tate</span> <span class="c">=</span> <span class="w">NES_CM_STATE_FIN_WAIT1</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">schedule_nes_timer</span><span class="pc">(</span><span class="w">c</span><span class="c">m_node,</span> <span class="w">sk</span><span class="c">b,</span> <span class="w">NES_TIMER_TYPE_SEND</span><span class="pc">,</span> <span class="w">1</span><span class="pc">,</span> <span class="c">0</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>



<span class="c">static</span> <span class="c">int</span> <span class="w">parse_mpa</span><span class="c">(struct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="pc">c</span><span class="c">m_node,</span> <span class="w">u</span><span class="pc">8</span> <span class="c">*</span><span class="w">b</span><span class="pc">uff</span><span class="c">er,</span> <span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="pc">*</span><span class="w">t</span><span class="c">ype,</span>
		     <span class="pc">u</span><span class="c">32</span> <span class="w">l</span><span class="c">en</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">ietf_mpa_v1</span> <span class="c">*</span><span class="w">mpa_frame</span><span class="pc">;</span>
	<span class="c">struct</span> <span class="w">ietf_mpa_v2</span> <span class="c">*</span><span class="w">mpa_v2_frame</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">ietf_rtr_msg</span> <span class="c">*</span><span class="w">rtr_msg</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">mpa_hdr_len</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">priv_data_len</span><span class="c">;</span>

	<span class="w">*</span><span class="c">type</span> <span class="pc">=</span> <span class="w">NES_MPA_REQUEST_ACCEPT</span><span class="c">;</span>

	
	<span class="pc">if</span> <span class="c">(</span><span class="w">l</span><span class="c">en</span> <span class="c">&lt;</span> <span class="pc">s</span><span class="c">izeof(struct</span> <span class="w">i</span><span class="pc">etf_mpa_v1</span><span class="w">))</span><span class="pc"> </span><span class="c">{</span>
		<span class="w">nes_debug</span><span class="pc">(</span><span class="w">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">The</span> <span class="w">received</span> <span class="w">ietf</span> <span class="w">b</span><span class="c">uffer</span> <span class="w">was</span> <span class="w">to</span><span class="pc">o</span> <span class="w">small</span> <span class="w">(</span><span class="pc">%x</span><span class="c">)\n",</span> <span class="w">l</span><span class="c">en);</span>
		<span class="c">return</span> <span class="c">-EINVAL;</span>
	<span class="c">}</span>

	
	<span class="w">mpa_frame</span> <span class="pc">= </span><span class="c">(struct</span> <span class="pc">i</span><span class="c">etf_mpa_v1</span> <span class="c">*)</span><span class="w">b</span><span class="c">uffer;</span>
	<span class="w">mpa_hdr_len</span> <span class="pc">=</span> <span class="w">s</span><span class="c">izeof(</span><span class="pc">s</span><span class="c">truct</span> <span class="c">ietf_mpa_v1</span><span class="w">);</span>
	<span class="w">priv_data_len</span> <span class="c">=</span> <span class="w">n</span><span class="pc">t</span><span class="c">ohs(</span><span class="pc">m</span><span class="c">pa_frame-&gt;priv_data_len</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="c">if</span> <span class="c">(priv_data_len</span> <span class="pc">&gt;</span> <span class="w">IETF_MAX_PRIV_DATA_LEN</span><span class="c">) {</span>
		<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">The</span> <span class="w">received</span> <span class="w">Length</span> <span class="w">o</span><span class="pc">f</span> <span class="w">Private"</span>
			  <span class="pc">"</span> <span class="w">Data</span> <span class="w">fie</span><span class="c">ld</span> <span class="w">exceeds</span> <span class="w">5</span><span class="pc">1</span><span class="c">2</span> <span class="w">octets</span><span class="pc">\</span><span class="c">n");</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="c">-EINVAL;</span>
	<span class="c">}</span>
	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">m</span><span class="c">pa_frame-&gt;</span><span class="w">rev</span> <span class="pc">!</span><span class="c">=</span> <span class="w">IETF_MPA_V1</span> <span class="pc">&amp;</span><span class="c">&amp;</span> <span class="c">mpa_frame-&gt;</span><span class="w">rev</span> <span class="pc">!</span><span class="c">=</span> <span class="w">IETF_MPA_V2</span><span class="c">) {</span>
		<span class="w">n</span><span class="c">es_debug</span><span class="pc">(</span><span class="c">NES_DBG_CM</span><span class="pc">,</span><span class="c"> "</span><span class="pc">T</span><span class="c">he</span> <span class="w">r</span><span class="pc">ec</span><span class="c">eived</span> <span class="w">mpa</span> <span class="w">v</span><span class="pc">e</span><span class="c">rsion</span><span class="pc">"</span>
			  <span class="pc">"</span> <span class="w">i</span><span class="pc">s</span> <span class="pc">n</span><span class="c">ot</span> <span class="pc">s</span><span class="c">upported\n");</span>
		<span class="c">return</span> <span class="c">-EINVAL;</span>
	<span class="c">}</span>
	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(mpa_frame-&gt;</span><span class="w">rev</span> <span class="w">&gt;</span> <span class="w">cm_node-</span><span class="c">&gt;</span><span class="w">mpa_frame_rev)</span><span class="pc"> </span><span class="c">{</span>
		<span class="w">n</span><span class="c">es_debug</span><span class="pc">(</span><span class="c">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="pc">T</span><span class="c">he</span> <span class="w">r</span><span class="c">eceived</span> <span class="pc">mpa</span> <span class="w">ve</span><span class="c">rsion</span><span class="w">"</span>
			<span class="w">"</span> <span class="w">ca</span><span class="c">n</span> <span class="w">n</span><span class="pc">o</span><span class="c">t</span> <span class="w">b</span><span class="c">e</span> <span class="w">interoperated</span><span class="c">\n");</span>
		<span class="c">return</span> <span class="c">-EINVAL;</span>
	<span class="c">}</span> <span class="w">e</span><span class="c">lse</span> <span class="pc">{</span>
		<span class="w">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;mpa_frame_rev</span> <span class="c">=</span> <span class="w">m</span><span class="pc">pa_frame</span><span class="c">-&gt;</span><span class="w">r</span><span class="pc">ev</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">s</span><span class="c">tate</span> <span class="w">!</span><span class="c">=</span> <span class="w">NES_CM_STATE_MPAREQ_SENT</span><span class="pc">) </span><span class="c">{</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">me</span><span class="pc">mc</span><span class="c">mp(</span><span class="w">m</span><span class="pc">pa_frame-</span><span class="c">&gt;</span><span class="w">k</span><span class="c">ey</span><span class="pc">,</span> <span class="w">IEFT_MPA_KEY_REQ</span><span class="pc">,</span> <span class="w">IETF_MPA_KEY_SIZE</span><span class="pc">)) </span><span class="c">{</span>
			<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM,</span><span class="pc"> "</span><span class="w">Unexpected</span> <span class="w">MPA</span> <span class="w">Key</span> <span class="w">received</span> <span class="c">\n");</span>
			<span class="c">return</span> <span class="c">-EINVAL;</span>
		<span class="c">}</span>
	<span class="c">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">m</span><span class="pc">e</span><span class="c">mcmp(mpa_frame</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">k</span><span class="c">ey,</span> <span class="w">IEFT_MPA_KEY_REP</span><span class="pc">,</span> <span class="w">I</span><span class="c">ETF_MPA_KEY_SIZE</span><span class="pc">))</span><span class="c"> {</span>
			<span class="w">n</span><span class="c">es_debug</span><span class="pc">(</span><span class="c">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="pc">U</span><span class="c">nexpected</span> <span class="w">M</span><span class="c">PA</span> <span class="pc">K</span><span class="c">ey</span> <span class="c">received</span> <span class="pc">\</span><span class="c">n");</span>
			<span class="c">return</span> <span class="c">-EINVAL;</span>
		<span class="c">}</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">priv_data_len</span> <span class="w">+</span> <span class="w">mpa_hdr_len</span> <span class="w">!</span><span class="c">=</span> <span class="w">l</span><span class="pc">e</span><span class="c">n</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">n</span><span class="c">es_debug</span><span class="pc">(N</span><span class="c">ES_DBG_CM</span><span class="w">,</span><span class="pc"> "</span><span class="w">The</span> <span class="w">r</span><span class="c">eceived</span> <span class="w">ietf</span> <span class="w">b</span><span class="c">uffer</span> <span class="w">was</span> <span class="w">n</span><span class="pc">o</span><span class="c">t</span> <span class="w">ri</span><span class="pc">g</span><span class="c">ht</span><span class="w">"</span>
			<span class="w">"</span> <span class="w">com</span><span class="pc">p</span><span class="c">lete</span> <span class="w">(</span><span class="c">%</span><span class="w">x</span> <span class="w">+ %x</span> <span class="w">!= %x)\</span><span class="c">n",</span>
			<span class="c">priv_data_len</span><span class="pc">,</span> <span class="pc">m</span><span class="c">pa_hdr_len,</span> <span class="w">l</span><span class="c">en</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="pc">-</span><span class="c">EINVAL;</span>
	<span class="c">}</span>
	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">l</span><span class="c">en</span> <span class="pc">&gt;</span> <span class="w">MAX_CM_BUFFER</span><span class="c">) {</span>
		<span class="w">n</span><span class="c">es_debug(</span><span class="pc">N</span><span class="c">ES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">T</span><span class="c">he</span> <span class="w">r</span><span class="c">eceived</span> <span class="w">i</span><span class="pc">e</span><span class="c">tf</span> <span class="w">b</span><span class="pc">uff</span><span class="c">er</span> <span class="w">w</span><span class="pc">a</span><span class="c">s</span> <span class="w">to</span><span class="pc">o</span> <span class="w">large"</span>
			<span class="w">" (%x</span> <span class="w">+</span><span class="c"> %</span><span class="w">x</span> <span class="pc">!</span><span class="c">= %</span><span class="w">x)</span><span class="pc">\</span><span class="c">n",</span>
			<span class="pc">p</span><span class="c">riv_data_len,</span> <span class="c">mpa_hdr_len,</span> <span class="w">l</span><span class="pc">e</span><span class="c">n);</span>
		<span class="w">r</span><span class="c">eturn</span> <span class="pc">-</span><span class="c">EINVAL;</span>
	<span class="c">}</span>

	<span class="w">cm_node-</span><span class="c">&gt;</span><span class="w">mpa_frame_size</span> <span class="c">=</span> <span class="w">p</span><span class="c">riv_data_len;</span>

	<span class="w">s</span><span class="pc">w</span><span class="c">itch</span> <span class="c">(</span><span class="w">mpa_frame</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">r</span><span class="pc">ev</span><span class="c">) {</span>
	<span class="c">case</span> <span class="w">IETF_MPA_V2: {</span>
		<span class="w">u1</span><span class="c">6</span> <span class="w">ird_size</span><span class="pc">;</span>
		<span class="pc">u</span><span class="c">16</span> <span class="w">ord_size</span><span class="c">;</span>
		<span class="c">u16</span> <span class="w">rtr_ctrl_ird</span><span class="c">;</span>
		<span class="c">u16</span> <span class="w">rtr_ctrl_ord</span><span class="c">;</span>

		<span class="w">mpa_v2_frame</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="w">s</span><span class="c">truct</span> <span class="w">ietf_mpa_v2</span> <span class="c">*)</span><span class="w">bu</span><span class="pc">ff</span><span class="c">er;</span>
		<span class="w">mpa_hdr_len</span> <span class="w">+</span><span class="c">=</span> <span class="w">IETF_RTR_MSG_SIZE</span><span class="c">;</span>
		<span class="pc">c</span><span class="c">m_node-&gt;</span><span class="pc">m</span><span class="c">pa_frame_size</span> <span class="w">-</span><span class="pc">=</span> <span class="w">I</span><span class="c">ETF_RTR_MSG_SIZE;</span>
		<span class="w">rtr_msg</span> <span class="w">=</span><span class="pc"> &amp;</span><span class="w">m</span><span class="pc">pa_v</span><span class="c">2_frame-&gt;</span><span class="pc">r</span><span class="c">tr_msg;</span>

		
		<span class="w">r</span><span class="pc">tr_ctrl_i</span><span class="c">rd</span> <span class="pc">=</span> <span class="w">nt</span><span class="c">ohs(</span><span class="pc">r</span><span class="c">tr_msg-&gt;</span><span class="w">ctrl_ird</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">r</span><span class="pc">tr_c</span><span class="c">trl_ord</span> <span class="pc">=</span> <span class="w">n</span><span class="pc">t</span><span class="c">ohs(</span><span class="pc">r</span><span class="c">tr_msg-&gt;</span><span class="w">ctrl_ord</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">ird_size</span> <span class="c">=</span> <span class="w">r</span><span class="pc">tr_ctrl_i</span><span class="c">rd</span> <span class="w">&amp;</span> <span class="w">IETF_NO_IRD_ORD</span><span class="c">;</span>
		<span class="w">ord_size</span> <span class="c">=</span> <span class="pc">r</span><span class="c">tr_ctrl_ord</span> <span class="w">&amp;</span> <span class="pc">I</span><span class="c">ETF_NO_IRD_ORD;</span>

		<span class="c">if</span> <span class="pc">(!(rtr_c</span><span class="c">trl_ird</span> <span class="c">&amp;</span> <span class="w">IETF_PEER_TO_PEER</span><span class="pc">))</span><span class="c"> {</span>
			
			<span class="w">r</span><span class="pc">etu</span><span class="c">rn</span> <span class="c">-EINVAL;</span>
		<span class="c">}</span>
		<span class="c">if</span> <span class="c">(</span><span class="pc">i</span><span class="c">rd_size</span> <span class="pc">=</span><span class="c">=</span> <span class="w">I</span><span class="c">ETF_NO_IRD_ORD</span> <span class="pc">|</span><span class="c">|</span> <span class="c">ord_size</span> <span class="pc">=</span><span class="c">=</span> <span class="w">I</span><span class="pc">ETF_N</span><span class="c">O_IRD_ORD</span><span class="pc">)</span>
			<span class="w">cm_node-</span><span class="pc">&gt;</span><span class="w">mpav2_ird_ord</span> <span class="c">=</span> <span class="w">I</span><span class="pc">ETF_N</span><span class="c">O_IRD_ORD;</span>

		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">c</span><span class="c">m_node-&gt;</span><span class="pc">m</span><span class="c">pav2_ird_ord</span> <span class="w">!</span><span class="c">=</span> <span class="pc">I</span><span class="c">ETF_NO_IRD_ORD</span><span class="pc">) </span><span class="c">{</span>
			
			<span class="c">if</span> <span class="c">(cm_node-&gt;</span><span class="w">s</span><span class="pc">tate</span> <span class="pc">!</span><span class="c">=</span> <span class="w">NES_CM_STATE_MPAREQ_SENT</span><span class="pc">) </span><span class="c">{</span>
				
				<span class="c">if</span> <span class="c">(</span><span class="pc">o</span><span class="c">rd_size</span> <span class="pc">&gt;</span> <span class="w">NES_MAX_IRD</span><span class="pc">)</span><span class="c"> {</span>
					<span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">i</span><span class="c">rd_size</span> <span class="c">=</span> <span class="w">N</span><span class="c">ES_MAX_IRD;</span>
				<span class="c">}</span> <span class="c">else</span> <span class="pc">{</span>
					<span class="pc">c</span><span class="c">m_node-&gt;ird_size</span> <span class="c">=</span> <span class="pc">o</span><span class="c">rd_size;</span>
					<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">o</span><span class="c">rd_size</span> <span class="pc">=</span><span class="c">=</span> <span class="pc">0</span> <span class="pc">&amp;</span><span class="c">&amp;</span>
					<span class="w">(rtr_ctrl_ord</span> <span class="pc">&amp;</span> <span class="w">IETF_RDMA0_READ</span><span class="c">)) {</span>
						<span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">i</span><span class="c">rd_size</span> <span class="c">=</span> <span class="w">1</span><span class="c">;</span>
						<span class="w">nes_debug</span><span class="pc">(</span><span class="w">NES_DBG_CM</span><span class="c">,</span>
						<span class="w">"</span><span class="pc">%</span><span class="c">s:</span> <span class="w">Remote</span> <span class="w">pe</span><span class="c">er</span> <span class="w">doesn'</span><span class="c">t</span> <span class="w">s</span><span class="c">upport</span> <span class="w">RDMA0_READ</span> <span class="w">(ord=</span><span class="c">%</span><span class="pc">u</span><span class="c">)\n",</span>
							<span class="c">__func__,</span> <span class="w">o</span><span class="c">rd_size</span><span class="pc">)</span><span class="c">;</span>
					<span class="pc">}</span>
				<span class="pc">}</span>
				<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">i</span><span class="pc">r</span><span class="c">d_size</span> <span class="w">&gt;</span> <span class="w">NES_MAX_ORD</span><span class="pc">)</span>
					<span class="pc">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">o</span><span class="c">rd_size</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ES_MAX_ORD;</span>
				<span class="pc">e</span><span class="c">lse</span>
					<span class="pc">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">o</span><span class="c">rd_size</span> <span class="c">=</span> <span class="w">i</span><span class="c">rd_size;</span>
			<span class="c">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="pc">{</span> 
				<span class="c">if</span> <span class="c">(</span><span class="pc">o</span><span class="c">rd_size</span> <span class="pc">&gt;</span> <span class="w">NES_MAX_IRD</span><span class="c">) {</span>
					<span class="w">nes_debug</span><span class="pc">(</span><span class="w">NES_DBG_CM</span><span class="c">,</span>
					<span class="w">"</span><span class="pc">%</span><span class="c">s:</span> <span class="w">U</span><span class="c">nable</span> <span class="c">to</span> <span class="w">su</span><span class="pc">pport</span> <span class="w">t</span><span class="pc">h</span><span class="c">e</span> <span class="w">requested</span> <span class="w">(ord</span> <span class="w">=</span><span class="c">%</span><span class="pc">u)</span><span class="c">\n",</span>
							<span class="c">__func__,</span> <span class="w">o</span><span class="pc">rd_</span><span class="c">size</span><span class="pc">)</span><span class="c">;</span>
					<span class="pc">r</span><span class="c">eturn</span> <span class="c">-EINVAL;</span>
				<span class="c">}</span>
				<span class="w">cm_node-</span><span class="c">&gt;</span><span class="w">ird_size</span> <span class="c">=</span> <span class="w">o</span><span class="c">rd_size</span><span class="pc">;</span>

				<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">i</span><span class="c">rd_size</span> <span class="pc">&gt;</span> <span class="w">NES_MAX_ORD</span><span class="pc">) </span><span class="c">{</span>
					<span class="pc">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">o</span><span class="c">rd_size</span> <span class="c">=</span> <span class="w">N</span><span class="pc">E</span><span class="c">S_MAX_ORD;</span>
				<span class="c">}</span> <span class="c">else</span> <span class="pc">{</span>
					<span class="c">if</span> <span class="c">(</span><span class="pc">i</span><span class="c">rd_size</span> <span class="pc">=</span><span class="c">=</span> <span class="c">0</span> <span class="pc">&amp;</span><span class="c">&amp;</span>
					<span class="w">(rtr_ctrl_ord</span> <span class="pc">&amp;</span> <span class="w">IETF_RDMA0_READ</span><span class="pc">))</span><span class="c"> {</span>
						<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="c">,</span>
						<span class="w">"</span><span class="pc">%</span><span class="c">s:</span> <span class="w">Remote</span> <span class="w">pe</span><span class="c">er</span> <span class="w">doesn'</span><span class="c">t</span> <span class="w">s</span><span class="c">upport</span> <span class="w">RDMA0_READ</span> <span class="pc">(</span><span class="w">ird=</span><span class="c">%</span><span class="pc">u)</span><span class="c">\n",</span>
							<span class="c">__func__,</span> <span class="w">i</span><span class="pc">rd_</span><span class="c">size</span><span class="pc">)</span><span class="c">;</span>
						<span class="c">return</span> <span class="pc">-</span><span class="c">EINVAL;</span>
					<span class="c">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="pc">{</span>
						<span class="w">cm_node-</span><span class="c">&gt;</span><span class="w">ord_size</span> <span class="c">=</span> <span class="w">i</span><span class="pc">rd_</span><span class="c">size;</span>
					<span class="c">}</span>
				<span class="pc">}</span>
			<span class="w">}</span>
		<span class="w">}</span>

		<span class="pc">if</span> <span class="c">(</span><span class="w">rtr_ctrl_ord</span> <span class="w">&amp;</span> <span class="w">IETF_RDMA0_READ</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">send_rdma0_op</span> <span class="c">=</span> <span class="w">SEND_RDMA_READ_ZERO</span><span class="c">;</span>

		<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">r</span><span class="c">tr_ctrl_ord</span> <span class="pc">&amp;</span> <span class="w">IETF_RDMA0_WRITE</span><span class="c">) {</span>
			<span class="pc">c</span><span class="c">m_node-&gt;send_rdma0_op</span> <span class="c">=</span> <span class="w">SEND_RDMA_WRITE_ZERO</span><span class="c">;</span>
		<span class="c">}</span> <span class="c">else</span> <span class="pc">{</span>        
			<span class="w">r</span><span class="pc">e</span><span class="c">turn</span> <span class="pc">-</span><span class="c">EINVAL;</span>
		<span class="c">}</span>
		<span class="w">b</span><span class="c">reak;</span>
	<span class="c">}</span>
	<span class="w">ca</span><span class="c">se</span> <span class="w">IETF_MPA_V1</span><span class="c">:</span>
	<span class="w">d</span><span class="pc">e</span><span class="c">fault:</span>
		<span class="w">b</span><span class="c">reak;</span>
	<span class="c">}</span>

	
	<span class="w">m</span><span class="c">emcpy(cm_node-&gt;</span><span class="w">mpa_frame_buf</span><span class="c">,</span> <span class="w">b</span><span class="pc">u</span><span class="c">ffer</span> <span class="pc">+</span> <span class="w">mpa_hdr_len</span><span class="pc">,</span> <span class="c">cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">mpa_frame_size</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">mpa_frame</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">f</span><span class="c">lags</span> <span class="c">&amp;</span> <span class="w">IETF_MPA_FLAGS_REJECT</span><span class="c">)</span>
		<span class="w">*t</span><span class="pc">y</span><span class="c">pe</span> <span class="c">=</span> <span class="w">NES_MPA_REQUEST_REJECT</span><span class="pc">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>



<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">form_cm_frame</span><span class="c">(struct</span> <span class="w">s</span><span class="c">k_buff</span> <span class="c">*skb,</span>
			  <span class="c">struct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="pc">cm</span><span class="c">_node</span><span class="pc">,</span> <span class="pc">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">op</span><span class="pc">ti</span><span class="c">ons</span><span class="pc">,</span> <span class="pc">u</span><span class="c">32</span> <span class="w">optionsize</span><span class="c">,</span>
			  <span class="pc">v</span><span class="c">oid</span> <span class="c">*data,</span> <span class="w">u</span><span class="c">32</span> <span class="w">datasize</span><span class="c">,</span> <span class="pc">u8</span> <span class="w">f</span><span class="pc">l</span><span class="c">ags</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">tcphdr</span> <span class="c">*</span><span class="w">tcph</span><span class="pc">;</span>
	<span class="c">struct</span> <span class="w">iphdr</span> <span class="c">*</span><span class="w">ip</span><span class="pc">h</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">ethhdr</span> <span class="c">*</span><span class="w">ethh</span><span class="c">;</span>
	<span class="w">u</span><span class="pc">8</span> <span class="c">*buf;</span>
	<span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="w">packetsize</span> <span class="pc">=</span> <span class="w">s</span><span class="pc">i</span><span class="c">zeof</span><span class="pc">(*</span><span class="w">ip</span><span class="pc">h</span><span class="w">)</span><span class="pc">;</span>

	<span class="w">p</span><span class="c">acketsize</span> <span class="w">+</span><span class="pc">=</span> <span class="pc">s</span><span class="c">izeof</span><span class="pc">(*t</span><span class="c">cph</span><span class="pc">);</span>
	<span class="w">p</span><span class="c">acketsize</span> <span class="w">+</span><span class="pc">=</span> <span class="w">optionsize</span> <span class="w">+</span> <span class="w">datasize</span><span class="c">;</span>

	<span class="w">skb_trim</span><span class="pc">(s</span><span class="c">kb,</span> <span class="w">0</span><span class="c">);</span>
	<span class="w">m</span><span class="pc">ems</span><span class="c">et</span><span class="pc">(</span><span class="w">s</span><span class="pc">kb-</span><span class="c">&gt;</span><span class="pc">d</span><span class="c">ata,</span> <span class="w">0</span><span class="pc">x0</span><span class="c">0,</span> <span class="w">ETH_HLEN</span> <span class="w">+</span> <span class="w">s</span><span class="c">izeof(*</span><span class="w">ip</span><span class="c">h</span><span class="pc">) </span><span class="c">+</span> <span class="c">sizeof(*</span><span class="w">t</span><span class="pc">c</span><span class="c">ph));</span>

	<span class="w">b</span><span class="pc">uf</span> <span class="c">=</span> <span class="w">sk</span><span class="pc">b_p</span><span class="c">ut(skb,</span> <span class="w">p</span><span class="pc">a</span><span class="c">cketsize</span> <span class="pc">+</span> <span class="pc">E</span><span class="c">TH_HLEN);</span>

	<span class="w">ethh</span> <span class="pc">= </span><span class="c">(</span><span class="w">st</span><span class="c">ruct</span> <span class="w">ethhdr</span> <span class="c">*)</span><span class="w">bu</span><span class="pc">f</span><span class="c">;</span>
	<span class="w">b</span><span class="pc">u</span><span class="c">f</span> <span class="pc">+</span><span class="c">=</span> <span class="pc">E</span><span class="c">TH_HLEN;</span>

	<span class="w">ip</span><span class="c">h</span> <span class="pc">=</span><span class="c"> (</span><span class="w">s</span><span class="pc">t</span><span class="c">ruct</span> <span class="w">iphdr</span> <span class="c">*)</span><span class="w">b</span><span class="pc">uf;</span>
	<span class="w">b</span><span class="pc">u</span><span class="c">f</span> <span class="w">+</span><span class="c">=</span> <span class="pc">sizeo</span><span class="c">f</span><span class="pc">(*</span><span class="w">i</span><span class="c">ph</span><span class="w">);</span>
	<span class="w">t</span><span class="pc">c</span><span class="c">ph</span> <span class="pc">= </span><span class="c">(</span><span class="w">s</span><span class="pc">t</span><span class="c">ruct</span> <span class="w">tcphdr</span> <span class="c">*)</span><span class="pc">b</span><span class="c">uf;</span>
	<span class="w">skb_reset_mac_header</span><span class="pc">(</span><span class="c">skb</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">skb_set_network_header</span><span class="c">(skb,</span> <span class="w">E</span><span class="c">TH_HLEN);</span>
	<span class="w">skb_set_transport_header</span><span class="c">(skb,</span> <span class="w">E</span><span class="c">TH_HLEN</span> <span class="pc">+</span> <span class="w">s</span><span class="pc">izeo</span><span class="c">f</span><span class="pc">(*</span><span class="w">i</span><span class="pc">ph));</span>
	<span class="w">b</span><span class="pc">u</span><span class="c">f</span> <span class="c">+=</span> <span class="c">sizeof</span><span class="pc">(*tcph</span><span class="w">);</span>

	<span class="w">sk</span><span class="pc">b</span><span class="c">-&gt;</span><span class="w">ip_summed</span> <span class="c">=</span> <span class="w">CHECKSUM_PARTIAL</span><span class="c">;</span>
	<span class="w">i</span><span class="c">f</span> <span class="pc">(!(</span><span class="w">cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ne</span><span class="pc">td</span><span class="c">ev-&gt;</span><span class="w">fe</span><span class="c">atures</span> <span class="pc">&amp;</span> <span class="w">NETIF_F_IP_CSUM))</span>
		<span class="w">s</span><span class="pc">kb</span><span class="c">-&gt;</span><span class="w">i</span><span class="c">p_summed</span> <span class="c">=</span> <span class="w">CHECKSUM_NONE</span><span class="pc">;</span>
	<span class="w">s</span><span class="c">kb-&gt;</span><span class="w">p</span><span class="c">rotocol</span> <span class="c">=</span> <span class="c">htons(</span><span class="w">0x8</span><span class="c">00);</span>
	<span class="pc">s</span><span class="c">kb-&gt;</span><span class="w">da</span><span class="pc">ta_</span><span class="c">len</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">kb-&gt;</span><span class="w">mac_len</span> <span class="c">=</span> <span class="w">ETH_HLEN</span><span class="c">;</span>

	<span class="w">m</span><span class="pc">e</span><span class="c">mcpy(</span><span class="w">ethh</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">h_dest</span><span class="c">,</span> <span class="pc">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">rem_mac</span><span class="c">,</span> <span class="w">E</span><span class="pc">TH_A</span><span class="c">LEN);</span>
	<span class="w">m</span><span class="c">emcpy(</span><span class="w">e</span><span class="c">thh-&gt;</span><span class="w">h_source</span><span class="c">,</span> <span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">loc_mac</span><span class="c">,</span> <span class="w">E</span><span class="c">TH_ALEN);</span>
	<span class="pc">e</span><span class="c">thh-&gt;</span><span class="w">h_proto</span> <span class="c">=</span> <span class="w">h</span><span class="pc">t</span><span class="c">ons(</span><span class="w">0x08</span><span class="c">00</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">ip</span><span class="c">h-&gt;</span><span class="w">v</span><span class="c">ersion</span> <span class="c">=</span> <span class="w">IPVERSION</span><span class="c">;</span>
	<span class="w">ip</span><span class="c">h-&gt;</span><span class="w">ihl</span> <span class="c">=</span> <span class="w">5</span><span class="c">;</span>           
	<span class="w">i</span><span class="pc">p</span><span class="c">h-&gt;</span><span class="w">tos</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="w">ip</span><span class="c">h-&gt;</span><span class="w">tot_len</span> <span class="c">=</span> <span class="w">h</span><span class="c">tons(</span><span class="w">packetsize</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">ip</span><span class="c">h-&gt;</span><span class="w">i</span><span class="pc">d</span> <span class="c">=</span> <span class="c">htons</span><span class="w">(++cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">tcp_cntxt</span><span class="pc">.</span><span class="w">loc_id</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">ip</span><span class="c">h-&gt;</span><span class="w">frag_off</span> <span class="c">=</span> <span class="c">htons(</span><span class="w">0x4</span><span class="pc">00</span><span class="c">0</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">i</span><span class="pc">p</span><span class="c">h-&gt;</span><span class="w">ttl</span> <span class="c">=</span> <span class="w">0</span><span class="pc">x4</span><span class="c">0;</span>
	<span class="w">i</span><span class="pc">p</span><span class="c">h-&gt;</span><span class="w">p</span><span class="c">rotocol</span> <span class="c">=</span> <span class="w">0x06</span><span class="c">;</span>   

	<span class="pc">i</span><span class="c">ph-&gt;</span><span class="pc">s</span><span class="c">addr</span> <span class="c">=</span> <span class="w">h</span><span class="pc">tonl</span><span class="c">(</span><span class="w">c</span><span class="c">m_node-&gt;</span><span class="w">mapped_loc_addr</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">ip</span><span class="c">h-&gt;</span><span class="pc">d</span><span class="c">addr</span> <span class="c">=</span> <span class="w">h</span><span class="pc">tonl</span><span class="c">(</span><span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">mapped_rem_addr</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">tcph</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">so</span><span class="pc">u</span><span class="c">rce</span> <span class="c">=</span> <span class="w">h</span><span class="c">tons(</span><span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">mapped_loc_port</span><span class="c">);</span>
	<span class="pc">t</span><span class="c">cph-&gt;</span><span class="w">de</span><span class="pc">st</span> <span class="c">=</span> <span class="pc">h</span><span class="c">tons(</span><span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">mapped_rem_port</span><span class="c">);</span>
	<span class="c">tcph-&gt;</span><span class="w">seq</span> <span class="c">=</span> <span class="w">h</span><span class="pc">tonl</span><span class="c">(cm_node-&gt;</span><span class="w">tcp_cntxt.loc_seq_num</span><span class="pc">)</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">f</span><span class="pc">l</span><span class="c">ags</span> <span class="c">&amp;</span> <span class="w">SET_ACK</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">c</span><span class="c">m_node-&gt;</span><span class="pc">tcp_</span><span class="c">cntxt</span><span class="pc">.</span><span class="w">loc_ack_num</span> <span class="c">=</span> <span class="c">cm_node-&gt;</span><span class="w">t</span><span class="pc">cp_</span><span class="c">cntxt.</span><span class="w">rcv_nxt</span><span class="pc">;</span>
		<span class="pc">t</span><span class="c">cph-&gt;</span><span class="w">ack_seq</span> <span class="c">=</span> <span class="w">h</span><span class="pc">tonl</span><span class="c">(cm_node-&gt;tcp_cntxt.</span><span class="w">l</span><span class="pc">oc_a</span><span class="c">ck_num</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">t</span><span class="c">cph-&gt;</span><span class="w">ack</span> <span class="c">=</span> <span class="w">1</span><span class="c">;</span>
	<span class="c">}</span> <span class="c">else</span> <span class="c">{</span>
		<span class="w">t</span><span class="pc">cph-</span><span class="c">&gt;ack_seq</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">f</span><span class="pc">l</span><span class="c">ags</span> <span class="c">&amp;</span> <span class="w">SET_SYN</span><span class="c">) {</span>
		<span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">t</span><span class="pc">cp_</span><span class="c">cntxt.</span><span class="w">loc_seq_num</span><span class="pc">+</span><span class="c">+;</span>
		<span class="pc">t</span><span class="c">cph-&gt;</span><span class="w">syn</span> <span class="c">=</span> <span class="pc">1</span><span class="c">;</span>
	<span class="c">}</span> <span class="c">else</span> <span class="c">{</span>
		<span class="pc">c</span><span class="c">m_node-&gt;</span><span class="pc">t</span><span class="c">cp_cntxt</span><span class="pc">.l</span><span class="c">oc_seq_num</span> <span class="w">+</span><span class="pc">=</span> <span class="w">datasize</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">fl</span><span class="c">ags</span> <span class="c">&amp;</span> <span class="w">SET_FIN</span><span class="pc">) </span><span class="c">{</span>
		<span class="c">cm_node-&gt;tcp_cntxt.loc_seq_num</span><span class="w">+</span><span class="pc">+</span><span class="c">;</span>
		<span class="pc">t</span><span class="c">cph-&gt;</span><span class="w">fin</span> <span class="pc">=</span> <span class="pc">1</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">f</span><span class="pc">l</span><span class="c">ags</span> <span class="c">&amp;</span> <span class="w">SET_RST</span><span class="c">)</span>
		<span class="w">t</span><span class="c">cph-&gt;</span><span class="w">rst</span> <span class="c">=</span> <span class="w">1</span><span class="c">;</span>

	<span class="pc">t</span><span class="c">cph-&gt;</span><span class="w">doff</span> <span class="w">=</span><span class="pc"> (</span><span class="w">u</span><span class="pc">1</span><span class="c">6</span><span class="w">)((s</span><span class="pc">i</span><span class="c">zeof</span><span class="pc">(*t</span><span class="c">cph</span><span class="pc">) +</span> <span class="w">optionsize</span> <span class="w">+</span> <span class="w">3) &gt;</span><span class="c">&gt;</span> <span class="w">2</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">t</span><span class="c">cph</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">w</span><span class="pc">in</span><span class="c">dow</span> <span class="c">=</span> <span class="w">h</span><span class="c">tons(</span><span class="w">cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">tcp_cntxt.rcv_wnd</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">t</span><span class="c">cph-&gt;</span><span class="w">urg_ptr</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">o</span><span class="c">ptionsize</span><span class="w">)</span>
		<span class="w">m</span><span class="pc">e</span><span class="c">mcpy(</span><span class="w">b</span><span class="c">uf</span><span class="pc">,</span> <span class="w">opt</span><span class="pc">ions</span><span class="c">,</span> <span class="w">o</span><span class="c">ptionsize);</span>
	<span class="w">b</span><span class="pc">u</span><span class="c">f</span> <span class="pc">+</span><span class="c">=</span> <span class="w">o</span><span class="c">ptionsize</span><span class="pc">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">datasize</span><span class="pc">)</span>
		<span class="w">m</span><span class="c">emcpy(</span><span class="pc">b</span><span class="c">uf,</span> <span class="w">d</span><span class="pc">ata</span><span class="c">,</span> <span class="w">d</span><span class="pc">atas</span><span class="c">ize);</span>

	<span class="w">skb_shinfo</span><span class="c">(</span><span class="w">s</span><span class="pc">k</span><span class="c">b</span><span class="w">)</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">nr_frags</span> <span class="pc">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="w">cm_packets_created+</span><span class="pc">+</span><span class="c">;</span>
<span class="pc">}</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">nes_create_sockaddr</span><span class="c">(</span><span class="w">_</span><span class="pc">_b</span><span class="c">e32</span> <span class="w">ip_addr</span><span class="c">,</span> <span class="w">_</span><span class="c">_be16</span> <span class="w">p</span><span class="c">ort,</span>
				<span class="pc">s</span><span class="c">truct</span> <span class="w">sockaddr_storage</span> <span class="c">*</span><span class="w">a</span><span class="pc">d</span><span class="c">dr</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">sockaddr_in</span> <span class="c">*</span><span class="w">nes_sockaddr</span> <span class="pc">= </span><span class="c">(struct</span> <span class="c">sockaddr_in</span> <span class="c">*)</span><span class="w">a</span><span class="pc">dd</span><span class="c">r;</span>
	<span class="w">n</span><span class="c">es_sockaddr</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sin_family</span> <span class="c">=</span> <span class="w">AF_INET</span><span class="c">;</span>
	<span class="w">m</span><span class="pc">e</span><span class="c">mcpy</span><span class="pc">(&amp;</span><span class="c">nes_sockaddr-&gt;</span><span class="w">sin_addr</span><span class="pc">.</span><span class="w">s_addr,</span><span class="pc"> &amp;i</span><span class="c">p_addr</span><span class="pc">,</span> <span class="c">sizeof(</span><span class="w">_</span><span class="pc">_b</span><span class="c">e32));</span>
	<span class="w">n</span><span class="c">es_sockaddr-&gt;</span><span class="w">sin_port</span> <span class="c">=</span> <span class="w">po</span><span class="pc">rt;</span>
<span class="pc">}</span>


<span class="c">static</span> <span class="pc">int</span> <span class="w">nes_create_mapinfo</span><span class="c">(struct</span> <span class="w">nes_cm_info</span> <span class="c">*</span><span class="w">cm_info</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">sockaddr_storage</span> <span class="w">local_sockaddr</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="pc">s</span><span class="c">ockaddr_storage</span> <span class="w">mapped_sockaddr</span><span class="c">;</span>

	<span class="w">nes_create_sockaddr</span><span class="pc">(</span><span class="w">ht</span><span class="pc">onl</span><span class="c">(</span><span class="pc">c</span><span class="c">m_info</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">loc_addr</span><span class="pc">),</span> <span class="w">ht</span><span class="pc">ons</span><span class="c">(cm_info</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">loc_port)</span><span class="pc">,</span>
				<span class="pc">&amp;l</span><span class="c">ocal_sockaddr</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">n</span><span class="pc">es_cr</span><span class="c">eate_sockaddr(</span><span class="w">ht</span><span class="pc">onl</span><span class="c">(cm_info-&gt;</span><span class="w">mapped_loc_addr</span><span class="pc">),</span>
			<span class="w">ht</span><span class="pc">ons</span><span class="c">(cm_info</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">mapped_loc_port),</span><span class="pc"> </span><span class="c">&amp;</span><span class="w">m</span><span class="pc">apped_s</span><span class="c">ockaddr</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">r</span><span class="c">eturn</span> <span class="w">iwpm_create_mapinfo</span><span class="pc">(&amp;</span><span class="w">l</span><span class="pc">oca</span><span class="c">l_sockaddr</span><span class="pc">,</span>
				<span class="w">&amp;m</span><span class="pc">apped_s</span><span class="c">ockaddr</span><span class="pc">,</span> <span class="w">RDMA_NL_NES</span><span class="c">);</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">nes_remove_mapinfo</span><span class="c">(</span><span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">loc_addr</span><span class="c">,</span> <span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="w">l</span><span class="pc">oc_</span><span class="c">port,</span>
			<span class="pc">u3</span><span class="c">2</span> <span class="w">m</span><span class="pc">apped_loc_a</span><span class="c">ddr,</span> <span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="w">m</span><span class="pc">apped_loc_p</span><span class="c">ort</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">sockaddr_storage</span> <span class="w">l</span><span class="c">ocal_sockaddr;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">s</span><span class="c">ockaddr_storage</span> <span class="w">m</span><span class="pc">apped_s</span><span class="c">ockaddr;</span>

	<span class="w">nes_create_sockaddr</span><span class="pc">(</span><span class="w">ht</span><span class="pc">onl</span><span class="c">(</span><span class="pc">loc_a</span><span class="c">ddr</span><span class="pc">),</span> <span class="w">ht</span><span class="pc">ons</span><span class="c">(loc_port</span><span class="w">),</span><span class="pc"> &amp;</span><span class="w">l</span><span class="pc">oca</span><span class="c">l_sockaddr);</span>
	<span class="pc">n</span><span class="c">es_create_sockaddr(</span><span class="w">ht</span><span class="pc">onl</span><span class="c">(</span><span class="w">m</span><span class="pc">apped_loc_a</span><span class="c">ddr),</span> <span class="w">ht</span><span class="pc">ons</span><span class="c">(</span><span class="pc">m</span><span class="c">apped_loc_port</span><span class="pc">),</span>
				<span class="w">&amp;m</span><span class="pc">apped_s</span><span class="c">ockaddr</span><span class="pc">);</span>

	<span class="w">iwpm_remove_mapinfo</span><span class="pc">(&amp;</span><span class="w">l</span><span class="pc">oca</span><span class="c">l_sockaddr</span><span class="w">,</span><span class="pc"> </span><span class="c">&amp;</span><span class="w">m</span><span class="pc">apped_s</span><span class="c">ockaddr</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">iwpm_remove_mapping</span><span class="pc">(&amp;l</span><span class="c">ocal_sockaddr</span><span class="pc">,</span> <span class="w">RDMA_NL_NES</span><span class="c">);</span>
<span class="c">}</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="c">void</span> <span class="w">nes_form_pm_msg</span><span class="c">(struct</span> <span class="w">nes_cm_info</span> <span class="c">*</span><span class="w">cm_info</span><span class="pc">,</span>
				<span class="c">struct</span> <span class="w">iwpm_sa_data</span> <span class="c">*</span><span class="w">pm_msg</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">nes_create_sockaddr</span><span class="c">(</span><span class="w">ht</span><span class="c">onl(</span><span class="pc">c</span><span class="c">m_info</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">loc_addr</span><span class="pc">),</span> <span class="w">ht</span><span class="pc">ons</span><span class="c">(</span><span class="pc">c</span><span class="c">m_info</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">loc_port</span><span class="pc">),</span>
				<span class="pc">&amp;</span><span class="c">pm_msg-&gt;</span><span class="pc">l</span><span class="c">oc_addr</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">n</span><span class="pc">es_cr</span><span class="c">eate_sockaddr(</span><span class="w">ht</span><span class="pc">onl</span><span class="c">(</span><span class="pc">c</span><span class="c">m_info-&gt;</span><span class="w">rem_addr</span><span class="pc">),</span> <span class="w">h</span><span class="pc">t</span><span class="c">ons(</span><span class="pc">c</span><span class="c">m_info-&gt;</span><span class="w">rem_port</span><span class="pc">)</span><span class="c">,</span>
				<span class="w">&amp;</span><span class="pc">p</span><span class="c">m_msg-&gt;</span><span class="w">r</span><span class="pc">em_a</span><span class="c">ddr</span><span class="w">)</span><span class="pc">;</span>
<span class="pc">}</span>


<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">nes_form_reg_msg</span><span class="c">(struct</span> <span class="w">nes_vnic</span> <span class="c">*</span><span class="w">nesvnic</span><span class="c">,</span>
			<span class="c">struct</span> <span class="w">iwpm_dev_data</span> <span class="c">*pm_msg)</span>
<span class="c">{</span>
	<span class="w">m</span><span class="pc">e</span><span class="c">mcpy(</span><span class="w">p</span><span class="c">m_msg</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">de</span><span class="pc">v_</span><span class="c">name,</span> <span class="pc">n</span><span class="c">esvnic-&gt;</span><span class="w">nesibdev</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ibdev</span><span class="pc">.</span><span class="c">name</span><span class="pc">,</span>
				<span class="w">IWPM_DEVNAME_SIZE</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">m</span><span class="pc">emc</span><span class="c">py(</span><span class="pc">p</span><span class="c">m_msg-&gt;</span><span class="w">if_name</span><span class="c">,</span> <span class="pc">n</span><span class="c">esvnic-&gt;</span><span class="w">net</span><span class="c">dev-&gt;</span><span class="w">n</span><span class="pc">a</span><span class="c">me</span><span class="pc">,</span> <span class="w">IWPM_IFNAME_SIZE</span><span class="pc">)</span><span class="c">;</span>
<span class="pc">}</span>

<span class="c">static</span> <span class="c">void</span> <span class="w">record_sockaddr_info</span><span class="c">(struct</span> <span class="w">sockaddr_storage</span> <span class="c">*</span><span class="w">addr_info</span><span class="c">,</span>
					<span class="w">nes_addr_t</span> <span class="c">*</span><span class="w">ip_addr</span><span class="c">,</span> <span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="c">*</span><span class="w">port_num</span><span class="c">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">sockaddr_in</span> <span class="c">*</span><span class="w">in_addr</span> <span class="pc">= </span><span class="c">(struct</span> <span class="c">sockaddr_in</span> <span class="c">*)addr_info;</span>

	<span class="pc">if</span> <span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">_addr-&gt;</span><span class="w">sin_family</span> <span class="c">==</span> <span class="w">AF_INET</span><span class="c">) {</span>
		<span class="w">*i</span><span class="pc">p</span><span class="c">_addr</span> <span class="c">=</span> <span class="w">ntohl</span><span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">_addr</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sin_addr</span><span class="pc">.</span><span class="w">s_addr</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">*</span><span class="pc">p</span><span class="c">ort_num</span> <span class="c">=</span> <span class="w">nt</span><span class="pc">ohs</span><span class="c">(in_addr-&gt;</span><span class="w">sin_port</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">}</span>
<span class="w">}</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">nes_record_pm_msg</span><span class="c">(struct</span> <span class="w">nes_cm_info</span> <span class="c">*</span><span class="w">cm_info</span><span class="pc">,</span>
			<span class="c">struct</span> <span class="w">iwpm_sa_data</span> <span class="c">*</span><span class="w">pm_msg</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">record_sockaddr_info</span><span class="pc">(&amp;</span><span class="c">pm_msg-&gt;</span><span class="w">mapped_loc_addr</span><span class="pc">,</span>
		<span class="w">&amp;</span><span class="c">cm_info-&gt;</span><span class="w">m</span><span class="c">apped_loc_addr</span><span class="w">,</span><span class="pc"> </span><span class="c">&amp;</span><span class="pc">c</span><span class="c">m_info-&gt;</span><span class="w">mapped_loc_port</span><span class="c">);</span>

	<span class="w">r</span><span class="pc">ec</span><span class="c">ord_sockaddr_info</span><span class="pc">(&amp;p</span><span class="c">m_msg-&gt;</span><span class="w">mapped_rem_addr</span><span class="pc">,</span>
		<span class="pc">&amp;</span><span class="c">cm_info-&gt;</span><span class="w">m</span><span class="pc">apped_r</span><span class="c">em_addr</span><span class="w">,</span><span class="pc"> </span><span class="c">&amp;cm_info-&gt;</span><span class="w">mapped_rem_port</span><span class="pc">)</span><span class="c">;</span>
<span class="pc">}</span>


<span class="c">static</span> <span class="pc">int</span> <span class="w">nes_get_remote_addr</span><span class="c">(struct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="w">cm_node</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">sockaddr_storage</span> <span class="w">m</span><span class="c">apped_loc_addr</span><span class="w">,</span> <span class="w">m</span><span class="c">apped_rem_addr</span><span class="pc">;</span>
	<span class="w">s</span><span class="pc">t</span><span class="c">ruct</span> <span class="w">s</span><span class="c">ockaddr_storage</span> <span class="w">remote_addr</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">r</span><span class="c">et;</span>

	<span class="w">nes_create_sockaddr</span><span class="c">(</span><span class="w">ht</span><span class="c">onl(cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">m</span><span class="c">apped_loc_addr</span><span class="w">),</span>
			<span class="w">ht</span><span class="pc">ons</span><span class="c">(cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">mapped_loc_port),</span><span class="pc"> &amp;m</span><span class="c">apped_loc_addr</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">n</span><span class="c">es_create_sockaddr(</span><span class="w">ht</span><span class="pc">onl</span><span class="c">(cm_node-&gt;</span><span class="pc">m</span><span class="c">apped_rem_addr</span><span class="pc">),</span>
			<span class="w">ht</span><span class="c">ons(</span><span class="pc">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">mapped_rem_port),</span><span class="pc"> </span><span class="c">&amp;</span><span class="pc">m</span><span class="c">apped_rem_addr</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">iwpm_get_remote_info</span><span class="pc">(&amp;mapped_loc_a</span><span class="c">ddr</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">m</span><span class="c">apped_rem_addr</span><span class="pc">,</span>
				<span class="w">&amp;remote_addr</span><span class="c">,</span> <span class="w">RDMA_NL_NES</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(ret)</span>
		<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, "</span><span class="w">U</span><span class="c">nable</span> <span class="c">to</span> <span class="w">f</span><span class="pc">i</span><span class="c">nd</span> <span class="w">remote</span> <span class="w">pe</span><span class="pc">e</span><span class="c">r</span> <span class="w">a</span><span class="c">ddress</span> <span class="w">in</span><span class="pc">f</span><span class="c">o</span><span class="pc">\</span><span class="c">n");</span>
	<span class="w">e</span><span class="pc">l</span><span class="c">se</span>
		<span class="w">record_sockaddr_info</span><span class="pc">(&amp;</span><span class="w">r</span><span class="c">emote_addr</span><span class="w">,</span><span class="pc"> </span><span class="c">&amp;</span><span class="w">cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">rem_addr</span><span class="pc">,</span>
				<span class="w">&amp;c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">rem_port</span><span class="c">);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">r</span><span class="c">et;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">print_core</span><span class="c">(struct</span> <span class="w">nes_cm_core</span> <span class="c">*</span><span class="w">co</span><span class="pc">r</span><span class="c">e</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM, "---------------------------------------------\n</span><span class="pc">"</span><span class="c">);</span>
	<span class="w">n</span><span class="c">es_debug(</span><span class="pc">N</span><span class="c">ES_DBG_CM</span><span class="w">,</span><span class="pc"> "</span><span class="w">CM</span> <span class="w">Core</span>  <span class="w">-- (c</span><span class="pc">o</span><span class="c">re</span> <span class="w">= %p</span> <span class="w">)</span><span class="pc">\</span><span class="c">n",</span> <span class="w">co</span><span class="pc">r</span><span class="c">e</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">co</span><span class="pc">r</span><span class="c">e</span><span class="pc">)</span>
		<span class="c">return</span><span class="w">;</span>
	<span class="w">n</span><span class="pc">es_d</span><span class="c">ebug(</span><span class="pc">N</span><span class="c">ES_DBG_CM</span><span class="w">,</span><span class="pc"> "-</span><span class="c">--------------------------------------------\</span><span class="w">n"</span><span class="c">);</span>

	<span class="w">n</span><span class="pc">es_d</span><span class="c">ebug(</span><span class="pc">N</span><span class="c">ES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">State</span>         <span class="w">:</span><span class="pc"> </span><span class="c">%</span><span class="pc">u</span> <span class="c">\n",</span> <span class="w">cor</span><span class="c">e-&gt;</span><span class="pc">s</span><span class="c">tate</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">n</span><span class="c">es_debug(NES_DBG_CM</span><span class="w">,</span><span class="pc"> "</span><span class="w">Listen</span> <span class="w">Nodes</span>  <span class="pc">:</span><span class="c"> %</span><span class="pc">u</span> <span class="c">\n",</span> <span class="w">at</span><span class="pc">o</span><span class="c">mic_read(&amp;</span><span class="w">co</span><span class="pc">r</span><span class="c">e-&gt;</span><span class="w">listen_node_cnt</span><span class="pc">))</span><span class="c">;</span>
	<span class="w">n</span><span class="c">es_debug</span><span class="pc">(</span><span class="c">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">Active</span> <span class="w">N</span><span class="pc">o</span><span class="c">des</span>  <span class="pc">:</span><span class="c"> %u</span> <span class="c">\n",</span> <span class="w">at</span><span class="pc">o</span><span class="c">mic_read(&amp;</span><span class="w">co</span><span class="pc">r</span><span class="c">e-&gt;</span><span class="w">node_cnt</span><span class="pc">))</span><span class="c">;</span>

	<span class="c">nes_debug</span><span class="pc">(</span><span class="c">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">co</span><span class="pc">r</span><span class="c">e</span>          <span class="w">:</span><span class="c"> %</span><span class="w">p</span> <span class="c">\n",</span> <span class="w">co</span><span class="pc">r</span><span class="c">e</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">n</span><span class="pc">e</span><span class="c">s_debug</span><span class="pc">(</span><span class="c">NES_DBG_CM</span><span class="w">, "--------------</span> <span class="w">end</span> <span class="w">cor</span><span class="c">e</span> <span class="w">---------------\n</span><span class="c">");</span>
<span class="pc">}</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">record_ird_ord</span><span class="c">(struct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="w">cm_node</span><span class="pc">,</span>
					<span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="w">conn_ird</span><span class="c">,</span> <span class="c">u16</span> <span class="w">conn_ord</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">if</span> <span class="c">(</span><span class="pc">conn_i</span><span class="c">rd</span> <span class="w">&gt;</span> <span class="w">NES_MAX_IRD</span><span class="c">)</span>
		<span class="w">c</span><span class="pc">o</span><span class="c">nn_ird</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ES_MAX_IRD</span><span class="pc">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">conn_o</span><span class="c">rd</span> <span class="pc">&gt;</span> <span class="w">NES_MAX_ORD</span><span class="c">)</span>
		<span class="pc">conn_o</span><span class="c">rd</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ES_MAX_ORD</span><span class="pc">;</span>

	<span class="pc">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ird_size</span> <span class="c">=</span> <span class="w">c</span><span class="pc">onn_i</span><span class="c">rd;</span>
	<span class="pc">cm</span><span class="c">_node-&gt;</span><span class="w">ord_size</span> <span class="c">=</span> <span class="pc">conn_o</span><span class="c">rd;</span>
<span class="pc">}</span>


<span class="w">s</span><span class="c">tatic</span> <span class="pc">int</span> <span class="w">cm_build_mpa_frame</span><span class="c">(struct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="pc">c</span><span class="c">m_node,</span> <span class="pc">u8</span> <span class="w">*</span><span class="pc">*</span><span class="w">start_buff</span><span class="pc">,</span>
			      <span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="c">*</span><span class="w">buff_len</span><span class="pc">,</span> <span class="pc">u</span><span class="c">8</span> <span class="c">*</span><span class="w">pci_mem</span><span class="c">,</span> <span class="c">u8</span> <span class="w">mpa_key</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">ret</span> <span class="c">=</span> <span class="c">0;</span>

	<span class="w">*s</span><span class="pc">tar</span><span class="c">t_buff</span> <span class="pc">= </span><span class="c">(</span><span class="w">p</span><span class="c">ci_mem</span><span class="w">) </span><span class="pc">?</span> <span class="w">p</span><span class="c">ci_mem</span> <span class="w">: &amp;c</span><span class="pc">m_</span><span class="c">node-&gt;</span><span class="w">mpa_frame_buf</span><span class="c">[0];</span>

	<span class="w">s</span><span class="c">witch</span> <span class="c">(</span><span class="w">c</span><span class="pc">m_</span><span class="c">node-&gt;</span><span class="w">mpa_frame_rev</span><span class="c">) {</span>
	<span class="c">case</span> <span class="w">IETF_MPA_V1</span><span class="c">:</span>
		<span class="w">*s</span><span class="c">tart_buff</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="pc">u8</span> <span class="w">*)*s</span><span class="c">tart_buff</span> <span class="pc">+</span> <span class="w">s</span><span class="c">izeof</span><span class="pc">(</span><span class="c">struct</span> <span class="w">ietf_rtr_msg</span><span class="pc">);</span>
		<span class="w">*buff_len</span> <span class="pc">=</span> <span class="w">s</span><span class="pc">i</span><span class="c">zeof(struct</span> <span class="w">ietf_mpa_v1)</span><span class="pc"> </span><span class="c">+</span> <span class="pc">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">mpa_frame_size</span><span class="c">;</span>
		<span class="w">build_mpa_v1</span><span class="c">(cm_node</span><span class="w">,</span><span class="pc"> *</span><span class="c">start_buff</span><span class="pc">,</span> <span class="w">mpa_key</span><span class="c">);</span>
		<span class="w">b</span><span class="pc">r</span><span class="c">eak;</span>
	<span class="c">case</span> <span class="w">IETF_MPA_V2</span><span class="c">:</span>
		<span class="w">*</span><span class="pc">b</span><span class="c">uff_len</span> <span class="pc">=</span> <span class="w">s</span><span class="pc">i</span><span class="c">zeof(struct</span> <span class="w">ietf_mpa_v2</span><span class="pc">) </span><span class="c">+</span> <span class="pc">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">m</span><span class="c">pa_frame_size;</span>
		<span class="w">build_mpa_v2</span><span class="c">(</span><span class="pc">c</span><span class="c">m_node</span><span class="w">, </span><span class="pc">*</span><span class="c">start_buff,</span> <span class="pc">m</span><span class="c">pa_key</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">b</span><span class="pc">r</span><span class="c">eak;</span>
	<span class="pc">d</span><span class="c">efault:</span>
		<span class="w">r</span><span class="pc">et</span> <span class="pc">= </span><span class="c">-EINVAL;</span>
	<span class="pc">}</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">r</span><span class="c">et;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">b</span><span class="pc">ui</span><span class="c">ld_mpa_v2(struct</span> <span class="w">nes_cm_node</span> <span class="c">*cm_node</span><span class="pc">,</span>
			 <span class="pc">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">start_addr</span><span class="pc">,</span> <span class="w">u</span><span class="pc">8</span> <span class="w">m</span><span class="pc">pa_k</span><span class="c">ey)</span>
<span class="c">{</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">ietf_mpa_v2</span> <span class="c">*</span><span class="w">mpa_frame</span> <span class="pc">= </span><span class="c">(struct</span> <span class="c">ietf_mpa_v2</span> <span class="c">*)</span><span class="pc">s</span><span class="c">tart_addr;</span>
	<span class="pc">str</span><span class="c">uct</span> <span class="w">ietf_rtr_msg</span> <span class="c">*</span><span class="w">rtr_msg</span> <span class="pc">= &amp;mpa_f</span><span class="c">rame-&gt;rtr_msg;</span>
	<span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="w">ctrl_ird</span><span class="c">;</span>
	<span class="c">u16</span> <span class="w">ctrl_ord</span><span class="c">;</span>

	
	<span class="w">build_mpa_v1</span><span class="pc">(</span><span class="w">c</span><span class="pc">m</span><span class="c">_node,</span> <span class="pc">sta</span><span class="c">rt_addr,</span> <span class="w">m</span><span class="pc">pa_k</span><span class="c">ey);</span>
	<span class="w">m</span><span class="c">pa_frame-&gt;</span><span class="w">f</span><span class="c">lags</span> <span class="w">|</span><span class="c">=</span> <span class="w">IETF_MPA_V2_FLAG</span><span class="c">;</span> 
	<span class="c">mpa_frame-&gt;</span><span class="w">priv_data_len</span> <span class="w">+</span><span class="pc">=</span> <span class="w">h</span><span class="pc">t</span><span class="c">ons(</span><span class="w">IETF_RTR_MSG_SIZE</span><span class="c">);</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">mpav2_ird_ord</span> <span class="c">==</span> <span class="w">IETF_NO_IRD_ORD</span><span class="c">) {</span>
		<span class="w">c</span><span class="c">trl_ird</span> <span class="pc">=</span> <span class="w">I</span><span class="pc">ETF_N</span><span class="c">O_IRD_ORD;</span>
		<span class="w">c</span><span class="pc">trl_o</span><span class="c">rd</span> <span class="pc">=</span> <span class="c">IETF_NO_IRD_ORD</span><span class="pc">;</span>
	<span class="c">}</span> <span class="c">else</span> <span class="c">{</span>
		<span class="pc">c</span><span class="c">trl_ird</span> <span class="c">=</span> <span class="pc">cm</span><span class="c">_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ird_size</span> <span class="w">&amp;</span> <span class="w">I</span><span class="pc">ETF_N</span><span class="c">O_IRD_ORD;</span>
		<span class="pc">ctrl_o</span><span class="c">rd</span> <span class="pc">=</span> <span class="pc">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ord_size</span> <span class="w">&amp;</span> <span class="w">I</span><span class="c">ETF_NO_IRD_ORD</span><span class="pc">;</span>
	<span class="pc">}</span>
	<span class="w">c</span><span class="pc">trl_i</span><span class="c">rd</span> <span class="w">|</span><span class="c">=</span> <span class="w">IETF_PEER_TO_PEER</span><span class="c">;</span>
	<span class="w">c</span><span class="pc">trl_i</span><span class="c">rd</span> <span class="pc">|</span><span class="c">=</span> <span class="w">IETF_FLPDU_ZERO_LEN</span><span class="c">;</span>

	<span class="w">s</span><span class="c">witch</span> <span class="c">(</span><span class="w">mpa_key</span><span class="c">) {</span>
	<span class="c">case</span> <span class="w">MPA_KEY_REQUEST</span><span class="c">:</span>
		<span class="pc">ct</span><span class="c">rl_ord</span> <span class="pc">|</span><span class="c">=</span> <span class="w">IETF_RDMA0_WRITE</span><span class="c">;</span>
		<span class="w">c</span><span class="pc">trl_o</span><span class="c">rd</span> <span class="pc">|</span><span class="c">=</span> <span class="w">IETF_RDMA0_READ</span><span class="c">;</span>
		<span class="c">break;</span>
	<span class="c">case</span> <span class="w">MPA_KEY_REPLY</span><span class="c">:</span>
		<span class="w">s</span><span class="c">witch</span> <span class="c">(cm_node-&gt;</span><span class="w">send_rdma0_op</span><span class="c">) {</span>
		<span class="c">case</span> <span class="w">SEND_RDMA_WRITE_ZERO</span><span class="c">:</span>
			<span class="w">c</span><span class="pc">trl_o</span><span class="c">rd</span> <span class="pc">|</span><span class="c">=</span> <span class="c">IETF_RDMA0_WRITE;</span>
			<span class="c">break;</span>
		<span class="c">case</span> <span class="w">SEND_RDMA_READ_ZERO</span><span class="c">:</span>
			<span class="pc">ct</span><span class="c">rl_ord</span> <span class="c">|=</span> <span class="pc">IETF_RDMA0_R</span><span class="c">EAD;</span>
			<span class="c">break;</span>
		<span class="pc">}</span>
	<span class="c">}</span>
	<span class="w">rtr_msg-</span><span class="c">&gt;</span><span class="w">ctrl_ird</span> <span class="c">=</span> <span class="w">h</span><span class="pc">t</span><span class="c">ons(ctrl_ird);</span>
	<span class="pc">r</span><span class="c">tr_msg-&gt;</span><span class="pc">ctrl_o</span><span class="c">rd</span> <span class="c">=</span> <span class="w">h</span><span class="c">tons(</span><span class="pc">ctrl_o</span><span class="c">rd</span><span class="pc">)</span><span class="c">;</span>
<span class="pc">}</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">build_mpa_v1</span><span class="c">(struct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="w">cm_node</span><span class="pc">,</span> <span class="w">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">start_addr</span><span class="c">,</span> <span class="w">u</span><span class="pc">8</span> <span class="w">mpa_key</span><span class="c">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">ietf_mpa_v1</span> <span class="c">*</span><span class="w">mpa_frame</span> <span class="pc">= </span><span class="c">(struct</span> <span class="c">ietf_mpa_v1</span> <span class="c">*)</span><span class="w">s</span><span class="c">tart_addr;</span>

	<span class="w">sw</span><span class="c">itch</span> <span class="c">(</span><span class="pc">m</span><span class="c">pa_key</span><span class="pc">)</span><span class="c"> {</span>
	<span class="c">case</span> <span class="w">MPA_KEY_REQUEST</span><span class="c">:</span>
		<span class="w">m</span><span class="pc">e</span><span class="c">mcpy(</span><span class="w">m</span><span class="pc">pa_f</span><span class="c">rame</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">k</span><span class="pc">e</span><span class="c">y,</span> <span class="w">IEFT_MPA_KEY_REQ</span><span class="pc">,</span> <span class="w">IETF_MPA_KEY_SIZE</span><span class="c">);</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="c">case</span> <span class="w">MPA_KEY_REPLY</span><span class="c">:</span>
		<span class="w">m</span><span class="pc">e</span><span class="c">mcpy(mpa_frame</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">k</span><span class="c">ey,</span> <span class="w">IEFT_MPA_KEY_REP</span><span class="pc">,</span> <span class="w">I</span><span class="pc">ET</span><span class="c">F_MPA_KEY_SIZE);</span>
		<span class="c">break;</span>
	<span class="pc">}</span>
	<span class="pc">m</span><span class="c">pa_frame</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">f</span><span class="pc">l</span><span class="c">ags</span> <span class="c">=</span> <span class="w">IETF_MPA_FLAGS_CRC</span><span class="pc">;</span>
	<span class="pc">m</span><span class="c">pa_frame-&gt;</span><span class="w">rev</span> <span class="c">=</span> <span class="w">cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">mpa_frame_rev</span><span class="c">;</span>
	<span class="c">mpa_frame-&gt;</span><span class="w">priv_data_len</span> <span class="c">=</span> <span class="w">h</span><span class="c">tons(</span><span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">mpa_frame_size</span><span class="c">);</span>
<span class="pc">}</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">build_rdma0_msg</span><span class="c">(struct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="w">c</span><span class="c">m_node</span><span class="pc">,</span> <span class="c">struct</span> <span class="w">nes_qp</span> <span class="pc">**</span><span class="w">nesqp_addr</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">u6</span><span class="c">4</span> <span class="w">u64temp</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">n</span><span class="pc">es_q</span><span class="c">p</span> <span class="c">*</span><span class="w">nesqp</span> <span class="w">=</span><span class="pc"> *</span><span class="c">nesqp_addr;</span>
	<span class="c">struct</span> <span class="w">nes_hw_qp_wqe</span> <span class="c">*</span><span class="w">wqe</span> <span class="w">=</span><span class="pc"> &amp;nesqp</span><span class="c">-&gt;</span><span class="w">hwqp</span><span class="pc">.</span><span class="w">sq_vbase</span><span class="pc">[</span><span class="c">0];</span>

	<span class="w">u6</span><span class="pc">4t</span><span class="c">emp</span> <span class="w">=</span><span class="pc"> (</span><span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="c">long</span><span class="w">)</span><span class="pc">n</span><span class="c">esqp-&gt;</span><span class="w">nesuqp_addr</span><span class="pc">;</span>
	<span class="pc">u</span><span class="c">64temp</span> <span class="w">|</span><span class="c">=</span> <span class="w">NES_SW_CONTEXT_ALIGN</span> <span class="w">&gt;</span><span class="pc">&gt;</span> <span class="c">1;</span>
	<span class="w">set_wqe_64bit_value</span><span class="c">(</span><span class="pc">w</span><span class="c">qe</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">wqe_words</span><span class="c">,</span> <span class="w">NES_IWARP_SQ_WQE_COMP_CTX_LOW_IDX</span><span class="c">,</span> <span class="w">u</span><span class="pc">6</span><span class="c">4temp</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">w</span><span class="pc">qe</span><span class="c">-&gt;</span><span class="pc">w</span><span class="c">qe_words</span><span class="pc">[</span><span class="w">NES_IWARP_SQ_WQE_FRAG0_LOW_IDX</span><span class="pc">] </span><span class="c">=</span> <span class="w">0</span><span class="c">;</span>
	<span class="pc">w</span><span class="c">qe-&gt;wqe_words</span><span class="pc">[</span><span class="w">NES_IWARP_SQ_WQE_FRAG0_HIGH_IDX</span><span class="c">] =</span> <span class="w">0</span><span class="c">;</span>

	<span class="w">s</span><span class="pc">w</span><span class="c">itch</span> <span class="c">(</span><span class="w">cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">send_rdma0_op</span><span class="c">) {</span>
	<span class="c">case</span> <span class="w">SEND_RDMA_WRITE_ZERO</span><span class="c">:</span>
		<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">Sending</span> <span class="w">fir</span><span class="pc">s</span><span class="c">t</span> <span class="w">wr</span><span class="c">ite</span><span class="w">.</span><span class="c">\n");</span>
		<span class="w">w</span><span class="c">qe-&gt;</span><span class="pc">wqe_</span><span class="c">words[</span><span class="w">NES_IWARP_SQ_WQE_MISC_IDX</span><span class="c">] =</span>
			<span class="w">cp</span><span class="c">u_to_le32(</span><span class="w">NES_IWARP_SQ_OP_RDMAW</span><span class="c">);</span>
		<span class="pc">w</span><span class="c">qe-&gt;</span><span class="pc">wqe_</span><span class="c">words</span><span class="pc">[</span><span class="w">NES_IWARP_SQ_WQE_TOTAL_PAYLOAD_IDX</span><span class="c">] =</span> <span class="w">0</span><span class="c">;</span>
		<span class="pc">wqe</span><span class="c">-&gt;wqe_words[</span><span class="w">NES_IWARP_SQ_WQE_LENGTH0_IDX</span><span class="c">] =</span> <span class="w">0</span><span class="c">;</span>
		<span class="pc">w</span><span class="c">qe-&gt;wqe_words[</span><span class="w">NES_IWARP_SQ_WQE_STAG0_IDX</span><span class="c">] =</span> <span class="w">0</span><span class="c">;</span>
		<span class="pc">b</span><span class="c">reak;</span>

	<span class="c">case</span> <span class="w">SEND_RDMA_READ_ZERO</span><span class="c">:</span>
	<span class="w">d</span><span class="pc">ef</span><span class="c">ault:</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">send_rdma0_op</span> <span class="w">!</span><span class="c">=</span> <span class="w">S</span><span class="c">END_RDMA_READ_ZERO</span><span class="pc">)</span>
			<span class="w">WARN</span><span class="c">(</span><span class="w">1</span><span class="pc">, </span><span class="c">"</span><span class="w">Unsupported</span> <span class="w">RDMA0</span> <span class="w">l</span><span class="c">en</span> <span class="w">operation=</span><span class="pc">%u\</span><span class="c">n",</span>
			     <span class="w">c</span><span class="c">m_node-&gt;</span><span class="pc">s</span><span class="c">end_rdma0_op);</span>
		<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">Sending</span> <span class="w">fi</span><span class="pc">rs</span><span class="c">t</span> <span class="w">rdma</span> <span class="w">o</span><span class="pc">p</span><span class="c">eration</span><span class="w">.</span><span class="c">\n");</span>
		<span class="w">wqe-</span><span class="c">&gt;</span><span class="w">wqe_words</span><span class="pc">[</span><span class="w">NES_IWARP_SQ_WQE_MISC_IDX</span><span class="pc">] </span><span class="c">=</span>
			<span class="w">c</span><span class="pc">p</span><span class="c">u_to_le32(</span><span class="w">NES_IWARP_SQ_OP_RDMAR</span><span class="c">);</span>
		<span class="pc">wqe-</span><span class="c">&gt;</span><span class="pc">wqe_</span><span class="c">words</span><span class="pc">[</span><span class="w">NES_IWARP_SQ_WQE_RDMA_TO_LOW_IDX</span><span class="c">] =</span> <span class="w">1</span><span class="c">;</span>
		<span class="c">wqe-&gt;wqe_words[</span><span class="w">NES_IWARP_SQ_WQE_RDMA_TO_HIGH_IDX</span><span class="c">] =</span> <span class="w">0</span><span class="c">;</span>
		<span class="c">wqe-&gt;wqe_words[</span><span class="w">NES_IWARP_SQ_WQE_RDMA_LENGTH_IDX</span><span class="c">] =</span> <span class="pc">0</span><span class="c">;</span>
		<span class="pc">w</span><span class="c">qe-&gt;</span><span class="pc">wqe_</span><span class="c">words[</span><span class="w">NES_IWARP_SQ_WQE_RDMA_STAG_IDX</span><span class="c">] =</span> <span class="w">1</span><span class="c">;</span>
		<span class="c">wqe-&gt;wqe_words[</span><span class="w">NES_IWARP_SQ_WQE_STAG0_IDX</span><span class="c">] =</span> <span class="pc">1</span><span class="c">;</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">nesqp-</span><span class="c">&gt;</span><span class="w">sq_kmapped</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">n</span><span class="c">esqp</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">s</span><span class="c">q_kmapped</span> <span class="pc">=</span> <span class="pc">0</span><span class="c">;</span>
		<span class="w">kunmap</span><span class="c">(nesqp</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">pag</span><span class="pc">e)</span><span class="c">;</span>
	<span class="pc">}</span>

	
	<span class="w">n</span><span class="c">esqp</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">nesqp_context-</span><span class="c">&gt;</span><span class="w">ird_ord_sizes</span> <span class="w">&amp;=</span> <span class="w">c</span><span class="pc">p</span><span class="c">u_to_le32</span><span class="w">(~(NES_QPCONTEXT_ORDIRD_LSMM_PRESENT</span> <span class="w">|</span>
							     <span class="w">NES_QPCONTEXT_ORDIRD_WRPDU</span> <span class="c">|</span>
							     <span class="w">NES_QPCONTEXT_ORDIRD_ALSMM)</span><span class="pc">);</span>
	<span class="pc">n</span><span class="c">esqp-&gt;</span><span class="w">skip_lsmm</span> <span class="c">=</span> <span class="w">1</span><span class="c">;</span>
	<span class="c">nesqp-&gt;</span><span class="w">hwqp</span><span class="pc">.</span><span class="w">sq_tail</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
<span class="c">}</span>


<span class="pc">in</span><span class="c">t</span> <span class="w">schedule_nes_timer</span><span class="pc">(</span><span class="c">struct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="w">cm_node</span><span class="c">,</span> <span class="c">struct</span> <span class="pc">s</span><span class="c">k_buff</span> <span class="c">*skb,</span>
		       <span class="w">e</span><span class="c">num</span> <span class="w">nes_timer_type</span> <span class="pc">t</span><span class="c">ype</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">send_retrans</span><span class="c">,</span>
		       <span class="c">int</span> <span class="w">close_when_complete</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="c">flags;</span>
	<span class="pc">st</span><span class="c">ruct</span> <span class="w">nes_cm_core</span> <span class="c">*</span><span class="w">cm_core</span> <span class="pc">=</span> <span class="pc">cm</span><span class="c">_node</span><span class="pc">-</span><span class="c">&gt;cm_core;</span>
	<span class="c">struct</span> <span class="w">nes_timer_entry</span> <span class="c">*</span><span class="w">new_send</span><span class="pc">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">r</span><span class="c">et</span> <span class="pc">=</span> <span class="c">0;</span>

	<span class="w">n</span><span class="pc">ew</span><span class="c">_send</span> <span class="pc">=</span> <span class="pc">k</span><span class="c">zalloc(sizeof(*new_send),</span> <span class="pc">GFP_A</span><span class="c">TOMIC);</span>
	<span class="c">if</span> <span class="c">(!new_send</span><span class="pc">)</span>
		<span class="c">return</span> <span class="c">-ENOMEM;</span>

	
	<span class="w">n</span><span class="pc">ew</span><span class="c">_send-&gt;</span><span class="w">retrycount</span> <span class="c">=</span> <span class="w">NES_DEFAULT_RETRYS</span><span class="c">;</span>
	<span class="c">new_send-&gt;</span><span class="w">retranscount</span> <span class="c">=</span> <span class="w">NES_DEFAULT_RETRANS</span><span class="c">;</span>
	<span class="c">new_send-&gt;</span><span class="w">sk</span><span class="pc">b</span> <span class="c">=</span> <span class="w">s</span><span class="pc">k</span><span class="c">b;</span>
	<span class="c">new_send-&gt;</span><span class="w">timetosend</span> <span class="c">=</span> <span class="w">j</span><span class="c">iffies;</span>
	<span class="c">new_send-&gt;</span><span class="w">t</span><span class="pc">y</span><span class="c">pe</span> <span class="c">=</span> <span class="w">t</span><span class="pc">y</span><span class="c">pe;</span>
	<span class="c">new_send-&gt;</span><span class="w">ne</span><span class="pc">t</span><span class="c">dev</span> <span class="c">=</span> <span class="w">cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">n</span><span class="pc">et</span><span class="c">dev;</span>
	<span class="c">new_send-&gt;</span><span class="w">send_retrans</span> <span class="c">=</span> <span class="w">s</span><span class="c">end_retrans;</span>
	<span class="c">new_send-&gt;</span><span class="w">close_when_complete</span> <span class="c">=</span> <span class="pc">c</span><span class="c">lose_when_complete;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">t</span><span class="pc">y</span><span class="c">pe</span> <span class="pc">=</span><span class="c">=</span> <span class="w">NES_TIMER_TYPE_CLOSE</span><span class="c">) {</span>
		<span class="pc">n</span><span class="c">ew_send-&gt;</span><span class="pc">t</span><span class="c">imetosend</span> <span class="w">+=</span><span class="pc"> </span><span class="c">(</span><span class="w">H</span><span class="c">Z</span> <span class="pc">/</span> <span class="w">1</span><span class="pc">0</span><span class="c">);</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">recv_entry</span><span class="pc">)</span><span class="c"> {</span>
			<span class="w">k</span><span class="c">free(new_send);</span>
			<span class="w">W</span><span class="pc">A</span><span class="c">RN_ON(</span><span class="w">1</span><span class="c">);</span>
			<span class="pc">r</span><span class="c">eturn</span> <span class="pc">-E</span><span class="c">INVAL;</span>
		<span class="c">}</span>
		<span class="w">c</span><span class="pc">m</span><span class="c">_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">r</span><span class="c">ecv_entry</span> <span class="c">=</span> <span class="pc">n</span><span class="c">ew_send</span><span class="pc">;</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">t</span><span class="pc">y</span><span class="c">pe</span> <span class="pc">=</span><span class="c">=</span> <span class="w">NES_TIMER_TYPE_SEND</span><span class="c">) {</span>
		<span class="pc">n</span><span class="c">ew_send-&gt;</span><span class="w">seq_num</span> <span class="c">=</span> <span class="w">ntohl</span><span class="pc">(</span><span class="w">tcp_hdr</span><span class="pc">(</span><span class="w">s</span><span class="pc">k</span><span class="c">b</span><span class="w">)</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">se</span><span class="pc">q</span><span class="c">);</span>
		<span class="w">a</span><span class="pc">to</span><span class="c">mic_inc(&amp;new_send-&gt;</span><span class="w">sk</span><span class="pc">b-</span><span class="c">&gt;</span><span class="w">users</span><span class="c">);</span>
		<span class="w">sp</span><span class="pc">in_lock_i</span><span class="c">rqsave(&amp;</span><span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">retrans_list_lock</span><span class="c">,</span> <span class="c">flags);</span>
		<span class="w">c</span><span class="c">m_node-&gt;</span><span class="w">send_entry</span> <span class="c">=</span> <span class="pc">n</span><span class="c">ew_send</span><span class="pc">;</span>
		<span class="w">add_ref_cm_node</span><span class="c">(cm_node</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">s</span><span class="c">pin_unlock_irqrestore(&amp;</span><span class="pc">c</span><span class="c">m_node-&gt;</span><span class="pc">r</span><span class="c">etrans_list_lock,</span> <span class="c">flags);</span>
		<span class="w">n</span><span class="c">ew_send-&gt;</span><span class="w">timetosend</span> <span class="c">=</span> <span class="w">j</span><span class="c">iffies</span> <span class="pc">+</span> <span class="w">NES_RETRY_TIMEOUT</span><span class="c">;</span>

		<span class="w">r</span><span class="c">et</span> <span class="c">=</span> <span class="w">nes_nic_cm_xmit</span><span class="c">(</span><span class="w">n</span><span class="c">ew_send</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sk</span><span class="c">b,</span> <span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">ne</span><span class="pc">t</span><span class="c">dev</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(ret</span> <span class="pc">!</span><span class="c">=</span> <span class="w">NETDEV_TX_OK</span><span class="c">) {</span>
			<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">E</span><span class="c">rror</span> <span class="w">sending</span> <span class="w">p</span><span class="c">acket</span> <span class="pc">%</span><span class="w">p</span> <span class="w">"</span>
				  <span class="w">"</span><span class="pc">(</span><span class="w">j</span><span class="pc">i</span><span class="c">ffies</span> <span class="w">=</span><span class="pc"> </span><span class="c">%</span><span class="pc">lu)</span><span class="c">\n",</span> <span class="c">new_send</span><span class="pc">,</span> <span class="w">j</span><span class="pc">i</span><span class="c">ffies</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">n</span><span class="c">ew_send-&gt;</span><span class="w">timetosend</span> <span class="c">=</span> <span class="w">j</span><span class="c">iffies;</span>
			<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">N</span><span class="c">ETDEV_TX_OK</span><span class="pc">;</span>
		<span class="c">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="pc">{</span>
			<span class="w">cm_packets_sent+</span><span class="pc">+</span><span class="c">;</span>
			<span class="c">if</span> <span class="pc">(!</span><span class="w">send_retrans</span><span class="c">) {</span>
				<span class="w">cleanup_retrans_entry</span><span class="pc">(</span><span class="w">cm_node</span><span class="pc">)</span><span class="c">;</span>
				<span class="c">if</span> <span class="c">(</span><span class="w">close_when_complete</span><span class="pc">)</span>
					<span class="w">rem_ref_cm_node</span><span class="c">(</span><span class="w">cm_core</span><span class="c">,</span> <span class="pc">cm</span><span class="c">_node</span><span class="pc">)</span><span class="c">;</span>
				<span class="w">r</span><span class="pc">et</span><span class="c">urn</span> <span class="pc">ret</span><span class="c">;</span>
			<span class="c">}</span>
		<span class="pc">}</span>
	<span class="pc">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">timer_pending</span><span class="pc">(&amp;cm_c</span><span class="c">ore-&gt;</span><span class="w">tcp_timer)</span><span class="pc">)</span>
		<span class="w">mod_timer</span><span class="pc">(&amp;cm_c</span><span class="c">ore-&gt;tcp_timer</span><span class="pc">,</span> <span class="w">new_send</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">timetosend</span><span class="c">);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">r</span><span class="c">et;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">nes_retrans_expired</span><span class="c">(struct</span> <span class="w">nes_cm_node</span> <span class="c">*cm_node)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">iw_cm_id</span> <span class="c">*</span><span class="w">cm_id</span> <span class="c">=</span> <span class="c">cm_node-&gt;cm_id;</span>
	<span class="w">e</span><span class="c">num</span> <span class="w">nes_cm_node_state</span> <span class="w">s</span><span class="c">tate</span> <span class="pc">=</span> <span class="c">cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s</span><span class="c">tate;</span>
	<span class="pc">c</span><span class="c">m_node-&gt;</span><span class="pc">s</span><span class="c">tate</span> <span class="c">=</span> <span class="w">NES_CM_STATE_CLOSED</span><span class="c">;</span>

	<span class="w">s</span><span class="pc">w</span><span class="c">itch</span> <span class="c">(state</span><span class="pc">)</span><span class="c"> {</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_SYN_RCVD</span><span class="c">:</span>
	<span class="pc">ca</span><span class="c">se</span> <span class="w">NES_CM_STATE_CLOSING</span><span class="c">:</span>
		<span class="w">rem_ref_cm_node</span><span class="c">(</span><span class="pc">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">cm_core</span><span class="c">,</span> <span class="w">c</span><span class="pc">m_n</span><span class="c">ode);</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_LAST_ACK</span><span class="c">:</span>
	<span class="pc">ca</span><span class="c">se</span> <span class="w">NES_CM_STATE_FIN_WAIT1</span><span class="c">:</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(cm_node-&gt;</span><span class="w">cm_id</span><span class="pc">)</span>
			<span class="w">cm</span><span class="pc">_i</span><span class="c">d</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">rem_ref</span><span class="pc">(</span><span class="c">cm_id);</span>
		<span class="w">send_reset</span><span class="c">(</span><span class="pc">cm_n</span><span class="c">ode</span><span class="pc">,</span> <span class="w">N</span><span class="pc">U</span><span class="c">LL);</span>
		<span class="c">break;</span>
	<span class="pc">d</span><span class="c">efault:</span>
		<span class="w">add_ref_cm_node</span><span class="c">(cm_node);</span>
		<span class="w">s</span><span class="c">end_reset(</span><span class="pc">cm_n</span><span class="c">ode</span><span class="pc">,</span> <span class="pc">N</span><span class="c">ULL);</span>
		<span class="w">create_event</span><span class="c">(cm_node</span><span class="pc">,</span> <span class="w">NES_CM_EVENT_ABORTED</span><span class="c">);</span>
	<span class="c">}</span>
<span class="pc">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">handle_recv_entry</span><span class="c">(struct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="w">c</span><span class="pc">m_n</span><span class="c">ode,</span> <span class="pc">u3</span><span class="c">2</span> <span class="w">rem_node</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">nes_timer_entry</span> <span class="c">*</span><span class="w">recv_entry</span> <span class="c">=</span> <span class="pc">cm</span><span class="c">_node</span><span class="pc">-</span><span class="c">&gt;recv_entry;</span>
	<span class="c">struct</span> <span class="w">iw_cm_id</span> <span class="c">*</span><span class="w">cm_id</span> <span class="c">=</span> <span class="pc">cm</span><span class="c">_node-&gt;cm_id;</span>
	<span class="c">struct</span> <span class="w">nes_qp</span> <span class="c">*</span><span class="w">nesqp</span><span class="c">;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="w">qplockflags</span><span class="c">;</span>

	<span class="w">i</span><span class="pc">f</span> <span class="pc">(!r</span><span class="c">ecv_entry</span><span class="pc">)</span>
		<span class="c">return</span><span class="pc">;</span>
	<span class="w">n</span><span class="pc">esq</span><span class="c">p</span> <span class="pc">= </span><span class="c">(struct</span> <span class="w">n</span><span class="pc">es_q</span><span class="c">p</span> <span class="c">*)</span><span class="pc">r</span><span class="c">ecv_entry-&gt;</span><span class="w">sk</span><span class="c">b;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">n</span><span class="c">esqp</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">sp</span><span class="c">in_lock_irqsave(&amp;nesqp-&gt;lock,</span> <span class="pc">q</span><span class="c">plockflags);</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(nesqp-&gt;</span><span class="w">cm_id</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">QP</span><span class="c">%</span><span class="pc">u</span><span class="w">:</span> <span class="w">c</span><span class="c">m_id</span> <span class="w">=</span><span class="pc"> </span><span class="c">%</span><span class="pc">p</span><span class="w">, </span><span class="pc">"</span>
				  <span class="w">"refcount</span> <span class="w">=</span><span class="pc"> </span><span class="c">%d</span><span class="w">:</span> <span class="w">HIT</span> <span class="w">A</span> <span class="w">"</span>
				  <span class="c">"</span><span class="w">NES_TIMER_TYPE_CLOSE</span> <span class="w">w</span><span class="c">ith</span> <span class="w">something</span> <span class="pc">"</span>
				  <span class="c">"</span><span class="w">t</span><span class="c">o</span> <span class="w">do!!!\n</span><span class="c">",</span> <span class="pc">n</span><span class="c">esqp-&gt;</span><span class="w">hwqp</span><span class="pc">.</span><span class="w">qp_id</span><span class="pc">,</span> <span class="pc">c</span><span class="c">m_id</span><span class="pc">,</span>
				  <span class="w">at</span><span class="c">omic_read(&amp;nesqp-&gt;</span><span class="w">r</span><span class="c">efcount</span><span class="pc">)</span><span class="c">);</span>
			<span class="pc">n</span><span class="c">esqp-&gt;</span><span class="w">hw_tcp_state</span> <span class="pc">=</span> <span class="w">NES_AEQE_TCP_STATE_CLOSED</span><span class="c">;</span>
			<span class="c">nesqp-&gt;</span><span class="w">last_aeq</span> <span class="c">=</span> <span class="w">NES_AEQE_AEID_RESET_SENT</span><span class="c">;</span>
			<span class="pc">n</span><span class="c">esqp-&gt;</span><span class="w">ibqp_state</span> <span class="c">=</span> <span class="w">IB_QPS_ERR</span><span class="c">;</span>
			<span class="w">sp</span><span class="c">in_unlock_irqrestore(&amp;nesqp-&gt;lock,</span> <span class="w">qplockflags</span><span class="c">);</span>
			<span class="w">nes_cm_disconn</span><span class="c">(nesqp);</span>
		<span class="c">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
			<span class="w">sp</span><span class="pc">in_u</span><span class="c">nlock_irqrestore(&amp;nesqp-&gt;lock,</span> <span class="w">q</span><span class="c">plockflags);</span>
			<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">QP%</span><span class="pc">u</span><span class="w">:</span> <span class="w">cm_id</span> <span class="w">=</span><span class="pc"> </span><span class="c">%</span><span class="w">p,</span><span class="pc"> "</span>
				  <span class="w">"refcount</span> <span class="w">=</span><span class="pc"> </span><span class="c">%d</span><span class="w">:</span> <span class="w">HIT</span> <span class="w">A</span> <span class="w">"</span>
				  <span class="c">"</span><span class="w">NES_TIMER_TYPE_CLOSE</span> <span class="w">w</span><span class="c">ith</span> <span class="w">nothing</span> <span class="pc">"</span>
				  <span class="c">"</span><span class="w">t</span><span class="c">o</span> <span class="w">do!!!\n</span><span class="c">",</span> <span class="pc">n</span><span class="c">esqp-&gt;</span><span class="w">hwqp</span><span class="pc">.</span><span class="w">qp_id</span><span class="pc">,</span> <span class="w">c</span><span class="c">m_id</span><span class="pc">,</span>
				  <span class="w">at</span><span class="c">omic_read(&amp;nesqp-&gt;</span><span class="w">r</span><span class="c">efcount</span><span class="pc">)</span><span class="c">);</span>
		<span class="pc">}</span>
	<span class="w">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rem_node)</span><span class="pc"> </span><span class="c">{</span>
		
		<span class="w">rem_ref_cm_node</span><span class="c">(</span><span class="w">cm_node-</span><span class="c">&gt;</span><span class="w">cm_core</span><span class="c">,</span> <span class="w">c</span><span class="pc">m_n</span><span class="c">ode</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">c</span><span class="pc">m_n</span><span class="c">ode-&gt;</span><span class="w">c</span><span class="pc">m_i</span><span class="c">d</span><span class="pc">)</span>
		<span class="w">c</span><span class="pc">m_i</span><span class="c">d-&gt;</span><span class="w">rem_ref</span><span class="pc">(cm_i</span><span class="c">d);</span>
	<span class="w">k</span><span class="c">free(</span><span class="w">recv_entry</span><span class="c">);</span>
	<span class="w">c</span><span class="pc">m_n</span><span class="c">ode-&gt;</span><span class="pc">r</span><span class="c">ecv_entry</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>
<span class="c">}</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="c">void</span> <span class="w">nes_cm_timer_tick</span><span class="c">(</span><span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="w">pass</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="c">flags;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="w">nexttimeout</span> <span class="pc">=</span> <span class="w">j</span><span class="c">iffies</span> <span class="pc">+</span> <span class="w">NES_LONG_TIME</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="pc">cm_n</span><span class="c">ode;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">nes_timer_entry</span> <span class="c">*</span><span class="w">send_entry,</span><span class="pc"> </span><span class="c">*</span><span class="w">r</span><span class="c">ecv_entry;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="pc">l</span><span class="c">ist_head</span> <span class="c">*</span><span class="w">list_core_temp</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="pc">l</span><span class="c">ist_head</span> <span class="c">*</span><span class="w">list_node</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">nes_cm_core</span> <span class="c">*</span><span class="w">cm_core</span> <span class="pc">=</span> <span class="w">g_cm_core</span><span class="c">;</span>
	<span class="pc">u</span><span class="c">32</span> <span class="w">settimer</span> <span class="pc">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="pc">l</span><span class="c">ong</span> <span class="w">timetosend</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">r</span><span class="c">et</span> <span class="pc">=</span> <span class="w">NETDEV_TX_OK</span><span class="c">;</span>

	<span class="pc">s</span><span class="c">truct</span> <span class="w">l</span><span class="pc">ist_h</span><span class="c">ead</span> <span class="w">timer_list</span><span class="c">;</span>

	<span class="w">I</span><span class="c">NIT_LIST_HEAD(&amp;</span><span class="w">t</span><span class="pc">imer</span><span class="c">_list</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">sp</span><span class="pc">in_</span><span class="c">lock_irqsave(&amp;</span><span class="pc">c</span><span class="c">m_core-&gt;</span><span class="w">ht_lock</span><span class="c">,</span> <span class="c">flags);</span>

	<span class="w">list_for_each_safe</span><span class="c">(</span><span class="w">list_node</span><span class="pc">,</span> <span class="w">list_core_temp</span><span class="c">,</span>
			   <span class="w">&amp;</span><span class="pc">c</span><span class="c">m_core</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">connected_nodes)</span><span class="pc"> </span><span class="c">{</span>
		<span class="w">cm_node</span> <span class="pc">=</span> <span class="w">co</span><span class="pc">nt</span><span class="c">ainer_of(</span><span class="pc">l</span><span class="c">ist_node,</span> <span class="c">struct</span> <span class="w">nes_cm_node</span><span class="c">,</span> <span class="pc">l</span><span class="c">ist);</span>
		<span class="c">if</span> <span class="pc">((cm_n</span><span class="c">ode-&gt;</span><span class="w">recv_entry) |</span><span class="pc">| </span><span class="c">(</span><span class="pc">cm_n</span><span class="c">ode</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">send_entry</span><span class="pc">))</span><span class="c"> {</span>
			<span class="w">add_ref_cm_node</span><span class="c">(cm_node</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">list_a</span><span class="pc">dd</span><span class="c">(&amp;cm_node-&gt;</span><span class="w">timer_entry</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">timer_list</span><span class="c">);</span>
		<span class="c">}</span>
	<span class="c">}</span>
	<span class="w">s</span><span class="pc">p</span><span class="c">in_unlock_irqrestore(&amp;</span><span class="w">cm_core</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ht_lock</span><span class="pc">,</span> <span class="c">flags);</span>

	<span class="w">list_for_each_safe</span><span class="pc">(</span><span class="w">list_node</span><span class="c">,</span> <span class="w">list_core_temp</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">t</span><span class="pc">imer_l</span><span class="c">ist</span><span class="w">) </span><span class="c">{</span>
		<span class="pc">c</span><span class="c">m_node</span> <span class="pc">=</span> <span class="w">c</span><span class="pc">o</span><span class="c">ntainer_of(</span><span class="pc">l</span><span class="c">ist_node,</span> <span class="c">struct</span> <span class="w">nes_cm_node</span><span class="c">,</span>
				       <span class="w">t</span><span class="pc">imer_e</span><span class="c">ntry);</span>
		<span class="w">recv_entry</span> <span class="pc">=</span> <span class="pc">cm_n</span><span class="c">ode</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">r</span><span class="c">ecv_entry;</span>

		<span class="w">i</span><span class="pc">f</span> <span class="c">(recv_entry</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="w">time_after</span><span class="c">(recv_entry</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">timetosend</span><span class="c">,</span> <span class="w">j</span><span class="c">iffies</span><span class="pc">)) </span><span class="c">{</span>
				<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">nexttimeout</span> <span class="w">&gt;</span> <span class="pc">r</span><span class="c">ecv_entry-&gt;</span><span class="w">t</span><span class="pc">imet</span><span class="c">osend</span> <span class="w">|</span><span class="pc">|</span>
				    <span class="w">!settimer)</span><span class="pc"> </span><span class="c">{</span>
					<span class="w">n</span><span class="pc">ex</span><span class="c">ttimeout</span> <span class="pc">=</span> <span class="pc">r</span><span class="c">ecv_entry-&gt;</span><span class="w">t</span><span class="pc">imet</span><span class="c">osend;</span>
					<span class="w">s</span><span class="c">ettimer</span> <span class="pc">=</span> <span class="w">1</span><span class="c">;</span>
				<span class="c">}</span>
			<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
				<span class="w">handle_recv_entry</span><span class="c">(</span><span class="w">cm_node</span><span class="c">,</span> <span class="pc">1)</span><span class="c">;</span>
			<span class="c">}</span>
		<span class="pc">}</span>

		<span class="w">sp</span><span class="pc">in_l</span><span class="c">ock_irqsave(&amp;</span><span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">retrans_list_lock</span><span class="c">,</span> <span class="c">flags);</span>
		<span class="w">d</span><span class="c">o</span> <span class="c">{</span>
			<span class="w">send_entry</span> <span class="c">=</span> <span class="w">c</span><span class="c">m_node-&gt;send_entry;</span>
			<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="c">send_entry)</span>
				<span class="w">b</span><span class="c">reak;</span>
			<span class="c">if</span> <span class="c">(</span><span class="w">time_after</span><span class="pc">(</span><span class="c">send_entry</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">timetosend</span><span class="pc">,</span> <span class="w">j</span><span class="c">iffies</span><span class="pc">))</span><span class="c"> {</span>
				<span class="c">if</span> <span class="c">(</span><span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">s</span><span class="pc">tate</span> <span class="pc">!</span><span class="c">=</span> <span class="w">NES_CM_STATE_TSA</span><span class="pc">) </span><span class="c">{</span>
					<span class="w">i</span><span class="c">f</span> <span class="pc">((</span><span class="w">nexttimeout</span> <span class="w">&gt;</span>
					     <span class="pc">s</span><span class="c">end_entry-&gt;</span><span class="pc">timet</span><span class="c">osend</span><span class="w">) |</span><span class="c">|</span>
					    <span class="w">!settimer)</span><span class="pc"> </span><span class="c">{</span>
						<span class="pc">n</span><span class="c">exttimeout</span> <span class="pc">=</span>
							<span class="pc">s</span><span class="c">end_entry-&gt;</span><span class="w">t</span><span class="pc">imet</span><span class="c">osend</span><span class="pc">;</span>
						<span class="w">s</span><span class="pc">et</span><span class="c">timer</span> <span class="pc">=</span> <span class="w">1</span><span class="c">;</span>
					<span class="c">}</span>
				<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
					<span class="w">free_retrans_entry</span><span class="c">(cm_node</span><span class="pc">)</span><span class="c">;</span>
				<span class="pc">}</span>
				<span class="w">b</span><span class="pc">r</span><span class="c">eak;</span>
			<span class="pc">}</span>

			<span class="pc">i</span><span class="c">f</span> <span class="pc">((</span><span class="w">c</span><span class="c">m_node-&gt;</span><span class="w">s</span><span class="pc">t</span><span class="c">ate</span> <span class="c">==</span> <span class="w">NES_CM_STATE_TSA) |</span><span class="pc">|</span>
			    <span class="pc">(</span><span class="c">cm_node-&gt;</span><span class="w">s</span><span class="pc">t</span><span class="c">ate</span> <span class="c">==</span> <span class="w">NES_CM_STATE_CLOSED</span><span class="pc">))</span><span class="c"> {</span>
				<span class="w">f</span><span class="c">ree_retrans_entry</span><span class="pc">(c</span><span class="c">m_node</span><span class="pc">)</span><span class="c">;</span>
				<span class="pc">b</span><span class="c">reak;</span>
			<span class="c">}</span>

			<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">send_entry</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">retranscount</span> <span class="w">|</span><span class="c">|</span>
			    <span class="pc">!</span><span class="w">s</span><span class="pc">e</span><span class="c">nd_entry-&gt;</span><span class="w">retrycount)</span><span class="pc"> </span><span class="c">{</span>
				<span class="w">cm_packets_dropped+</span><span class="c">+;</span>
				<span class="w">f</span><span class="pc">r</span><span class="c">ee_retrans_entry</span><span class="pc">(</span><span class="c">cm_node</span><span class="pc">)</span><span class="c">;</span>

				<span class="w">s</span><span class="pc">p</span><span class="c">in_unlock_irqrestore</span><span class="pc">(</span>
					<span class="w">&amp;</span><span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">retrans_list_lock</span><span class="c">,</span> <span class="w">f</span><span class="pc">l</span><span class="c">ags);</span>
				<span class="w">nes_retrans_expired</span><span class="c">(</span><span class="pc">cm_n</span><span class="c">ode</span><span class="pc">)</span><span class="c">;</span>
				<span class="w">c</span><span class="c">m_node-&gt;</span><span class="w">s</span><span class="pc">tate</span> <span class="c">=</span> <span class="w">NES_CM_STATE_CLOSED</span><span class="c">;</span>
				<span class="w">spin_l</span><span class="pc">ock_irqs</span><span class="c">ave(&amp;</span><span class="pc">cm_n</span><span class="c">ode-&gt;</span><span class="pc">r</span><span class="c">etrans_list_lock,</span>
						  <span class="c">flags);</span>
				<span class="w">b</span><span class="c">reak;</span>
			<span class="c">}</span>
			<span class="w">at</span><span class="pc">omic_i</span><span class="c">nc(&amp;</span><span class="w">send_entry</span><span class="c">-&gt;</span><span class="w">sk</span><span class="pc">b-</span><span class="c">&gt;</span><span class="w">users</span><span class="c">);</span>
			<span class="w">cm_packets_retrans+</span><span class="c">+;</span>
			<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, "</span><span class="w">Retransmitting</span> <span class="w">s</span><span class="c">end_entry</span> <span class="c">%</span><span class="pc">p</span> <span class="w">"</span>
				  <span class="w">"f</span><span class="c">or</span> <span class="w">no</span><span class="pc">d</span><span class="c">e</span> <span class="c">%</span><span class="pc">p</span><span class="w">,</span> <span class="w">j</span><span class="pc">i</span><span class="c">ffies</span> <span class="w">=</span><span class="pc"> </span><span class="c">%</span><span class="w">l</span><span class="c">u</span><span class="pc">,</span> <span class="w">ti</span><span class="pc">me</span> <span class="w">t</span><span class="c">o</span> <span class="w">sen</span><span class="pc">d</span> <span class="w">= "</span>
				  <span class="w">"%l</span><span class="pc">u</span><span class="w">,</span> <span class="w">retranscount</span> <span class="w">=</span><span class="pc"> </span><span class="c">%</span><span class="pc">u,</span> <span class="pc">s</span><span class="c">end_entry-&gt;</span><span class="w">seq_num</span> <span class="w">= "</span>
				  <span class="w">"0</span><span class="c">x%</span><span class="w">0</span><span class="pc">8X</span><span class="c">,</span> <span class="w">cm_node-</span><span class="pc">&gt;</span><span class="w">tcp_cntxt</span><span class="pc">.</span><span class="w">rem_ack_num</span> <span class="w">= "</span>
				  <span class="w">"0</span><span class="pc">x</span><span class="c">%</span><span class="w">0</span><span class="pc">8X\</span><span class="c">n",</span> <span class="pc">s</span><span class="c">end_entry</span><span class="pc">,</span> <span class="pc">c</span><span class="c">m_node</span><span class="pc">,</span> <span class="w">j</span><span class="pc">i</span><span class="c">ffies,</span>
				  <span class="c">send_entry-&gt;</span><span class="w">timetosend</span><span class="c">,</span>
				  <span class="c">send_entry-&gt;</span><span class="pc">r</span><span class="c">etranscount,</span>
				  <span class="c">send_entry-&gt;</span><span class="pc">seq</span><span class="c">_num,</span>
				  <span class="pc">c</span><span class="c">m_node-&gt;</span><span class="pc">tc</span><span class="c">p_cntxt</span><span class="pc">.r</span><span class="c">em_ack_num</span><span class="pc">)</span><span class="c">;</span>

			<span class="w">s</span><span class="pc">p</span><span class="c">in_unlock_irqrestore(&amp;cm_node-&gt;</span><span class="w">retrans_list_lock</span><span class="c">,</span>
					       <span class="c">flags);</span>
			<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">nes_nic_cm_xmit</span><span class="c">(send_entry</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sk</span><span class="c">b,</span> <span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">n</span><span class="pc">et</span><span class="c">dev</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">sp</span><span class="pc">in_lock_</span><span class="c">irqsave(&amp;</span><span class="pc">c</span><span class="c">m_node-&gt;</span><span class="pc">r</span><span class="c">etrans_list_lock,</span> <span class="c">flags);</span>
			<span class="c">if</span> <span class="c">(</span><span class="pc">r</span><span class="c">et</span> <span class="pc">!</span><span class="c">=</span> <span class="w">NETDEV_TX_OK</span><span class="pc">) </span><span class="c">{</span>
				<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">rexmit</span> <span class="w">f</span><span class="c">ailed</span> <span class="w">f</span><span class="pc">o</span><span class="c">r</span> <span class="w">"</span>
					  <span class="w">"no</span><span class="pc">d</span><span class="c">e</span><span class="w">=</span><span class="pc">%</span><span class="w">p</span><span class="c">\n",</span> <span class="w">c</span><span class="c">m_node</span><span class="pc">)</span><span class="c">;</span>
				<span class="w">cm_packets_bounced+</span><span class="c">+;</span>
				<span class="w">send_entry-</span><span class="c">&gt;</span><span class="w">retrycount-</span><span class="pc">-</span><span class="c">;</span>
				<span class="w">nexttimeout</span> <span class="pc">=</span> <span class="w">j</span><span class="c">iffies</span> <span class="pc">+</span> <span class="w">NES_SHORT_TIME</span><span class="c">;</span>
				<span class="w">settimer</span> <span class="pc">=</span> <span class="w">1</span><span class="c">;</span>
				<span class="w">b</span><span class="c">reak;</span>
			<span class="c">}</span> <span class="w">e</span><span class="c">lse</span> <span class="c">{</span>
				<span class="w">cm_packets_sent+</span><span class="c">+;</span>
			<span class="c">}</span>
			<span class="w">nes_debug</span><span class="pc">(</span><span class="w">NES_DBG_CM,</span><span class="pc"> "</span><span class="w">Packet</span> <span class="w">Sent</span><span class="c">:</span> <span class="w">retrans</span> <span class="w">cou</span><span class="c">nt</span> <span class="w">=</span><span class="pc"> </span><span class="c">"</span>
				  <span class="w">"%</span><span class="pc">u</span><span class="w">,</span> <span class="w">retr</span><span class="pc">y</span> <span class="w">co</span><span class="pc">u</span><span class="c">nt</span> <span class="w">=</span><span class="pc"> </span><span class="c">%</span><span class="pc">u</span><span class="w">.</span><span class="pc">\</span><span class="c">n",</span>
				  <span class="w">send_entry</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">retranscount</span><span class="pc">,</span>
				  <span class="pc">s</span><span class="c">end_entry</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">retrycount</span><span class="pc">)</span><span class="c">;</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(send_entry-&gt;</span><span class="w">send_retrans</span><span class="pc">)</span><span class="c"> {</span>
				<span class="pc">s</span><span class="c">end_entry</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">r</span><span class="c">etranscount</span><span class="w">-</span><span class="pc">-</span><span class="c">;</span>
				<span class="w">timetosend</span> <span class="w">=</span><span class="pc"> (</span><span class="w">NES_RETRY_TIMEOUT</span> <span class="w">&lt;</span><span class="c">&lt;</span>
					      <span class="w">(NES_DEFAULT_RETRANS</span> <span class="w">-</span> <span class="w">s</span><span class="pc">end_e</span><span class="c">ntry</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">r</span><span class="c">etranscount</span><span class="w">)</span><span class="pc">)</span><span class="c">;</span>

				<span class="w">s</span><span class="c">end_entry-&gt;</span><span class="pc">t</span><span class="c">imetosend</span> <span class="c">=</span> <span class="w">j</span><span class="c">iffies</span> <span class="pc">+</span>
							 <span class="w">mi</span><span class="pc">n(t</span><span class="c">imetosend</span><span class="pc">,</span> <span class="w">NES_MAX_TIMEOUT</span><span class="c">);</span>
				<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">nexttimeout</span> <span class="w">&gt;</span> <span class="c">send_entry-&gt;</span><span class="pc">t</span><span class="c">imetosend</span> <span class="w">|</span><span class="pc">|</span>
				    <span class="w">!settimer)</span><span class="pc"> </span><span class="c">{</span>
					<span class="w">n</span><span class="c">exttimeout</span> <span class="c">=</span> <span class="c">send_entry-&gt;</span><span class="pc">t</span><span class="c">imetosend</span><span class="pc">;</span>
					<span class="w">s</span><span class="pc">et</span><span class="c">timer</span> <span class="pc">=</span> <span class="w">1</span><span class="c">;</span>
				<span class="c">}</span>
			<span class="w">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
				<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">close_when_complete</span><span class="c">;</span>
				<span class="w">c</span><span class="c">lose_when_complete</span> <span class="c">=</span>
					<span class="pc">sen</span><span class="c">d_entry</span><span class="pc">-</span><span class="c">&gt;close_when_complete;</span>
				<span class="w">nes_debug</span><span class="pc">(</span><span class="w">NES_DBG_CM</span><span class="pc">, "</span><span class="w">cm_node=</span><span class="pc">%</span><span class="w">p</span> <span class="w">st</span><span class="pc">ate=</span><span class="c">%</span><span class="pc">d\</span><span class="c">n",</span>
					  <span class="w">c</span><span class="pc">m_</span><span class="c">node</span><span class="pc">,</span> <span class="w">c</span><span class="pc">m</span><span class="c">_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">st</span><span class="c">ate);</span>
				<span class="w">free_retrans_entry</span><span class="c">(</span><span class="w">c</span><span class="pc">m</span><span class="c">_node);</span>
				<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">c</span><span class="c">lose_when_complete</span><span class="pc">)</span>
					<span class="w">rem_ref_cm_node</span><span class="c">(</span><span class="pc">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">cm_core</span><span class="c">,</span>
							<span class="pc">cm</span><span class="c">_node);</span>
			<span class="pc">}</span>
		<span class="w">}</span> <span class="w">w</span><span class="c">hile</span> <span class="c">(0</span><span class="pc">);</span>

		<span class="w">s</span><span class="pc">p</span><span class="c">in_unlock_irqrestore(&amp;cm_node-&gt;</span><span class="w">retrans_list_lock</span><span class="c">,</span> <span class="c">flags);</span>
		<span class="w">r</span><span class="pc">em</span><span class="c">_ref_cm_node(cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">cm_c</span><span class="c">ore,</span> <span class="w">c</span><span class="pc">m_n</span><span class="c">ode);</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">settimer</span><span class="pc">)</span><span class="c"> {</span>
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">timer_pending(</span><span class="pc">&amp;cm_c</span><span class="c">ore-&gt;</span><span class="w">tcp_timer</span><span class="pc">))</span>
			<span class="w">mod_timer</span><span class="pc">(&amp;cm_c</span><span class="c">ore-&gt;tcp_timer</span><span class="pc">,</span> <span class="w">nexttimeout</span><span class="c">);</span>
	<span class="c">}</span>
<span class="w">}</span>



<span class="pc">s</span><span class="c">tatic</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">send_syn</span><span class="c">(struct</span> <span class="w">nes_cm_node</span> <span class="c">*cm_node</span><span class="pc">,</span> <span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">sendack</span><span class="c">,</span>
		    <span class="pc">s</span><span class="c">truct</span> <span class="pc">s</span><span class="c">k_buff</span> <span class="c">*skb)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">ret;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">f</span><span class="c">lags</span> <span class="pc">=</span> <span class="w">SET_SYN</span><span class="c">;</span>
	<span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="w">optionsbuffer</span><span class="c">[</span><span class="w">s</span><span class="pc">i</span><span class="c">zeof(struct</span> <span class="w">option_mss</span><span class="pc">) </span><span class="c">+</span>
			   <span class="pc">si</span><span class="c">zeof(struct</span> <span class="w">option_windowscale</span><span class="pc">) </span><span class="c">+</span> <span class="c">sizeof(struct</span> <span class="w">option_base) </span><span class="c">+</span>
			   <span class="w">TCP_OPTIONS_PADDING]</span><span class="pc">;</span>

	<span class="c">int</span> <span class="w">optionssize</span> <span class="pc">=</span> <span class="pc">0</span><span class="c">;</span>
	
	<span class="w">un</span><span class="pc">i</span><span class="c">on</span> <span class="w">all_known_options</span> <span class="c">*</span><span class="w">options</span><span class="pc">;</span>

	<span class="pc">if</span> <span class="pc">(!</span><span class="w">cm_node</span><span class="c">)</span>
		<span class="c">return</span> <span class="pc">-</span><span class="c">EINVAL;</span>

	<span class="w">options</span> <span class="pc">= </span><span class="c">(</span><span class="w">u</span><span class="pc">ni</span><span class="c">on</span> <span class="w">a</span><span class="pc">l</span><span class="c">l_known_options</span> <span class="w">*</span><span class="pc">)&amp;</span><span class="w">optionsbuffer[o</span><span class="pc">ptions</span><span class="c">size];</span>
	<span class="w">opti</span><span class="pc">ons-</span><span class="c">&gt;</span><span class="w">as_mss</span><span class="pc">.</span><span class="w">optionnum</span> <span class="c">=</span> <span class="w">OPTION_NUMBER_MSS</span><span class="c">;</span>
	<span class="w">opti</span><span class="pc">ons-</span><span class="c">&gt;as_mss.</span><span class="w">l</span><span class="pc">eng</span><span class="c">th</span> <span class="c">=</span> <span class="pc">s</span><span class="c">izeof(struct</span> <span class="w">option_mss);</span>
	<span class="w">opti</span><span class="pc">ons</span><span class="w">-</span><span class="c">&gt;</span><span class="w">a</span><span class="pc">s</span><span class="c">_mss</span><span class="pc">.</span><span class="w">mss</span> <span class="pc">=</span> <span class="w">h</span><span class="c">tons(</span><span class="w">cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">tcp_cntxt</span><span class="c">.</span><span class="w">m</span><span class="c">ss</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">o</span><span class="pc">ptionss</span><span class="c">ize</span> <span class="w">+</span><span class="c">=</span> <span class="w">s</span><span class="c">izeof(struct</span> <span class="pc">o</span><span class="c">ption_mss</span><span class="w">)</span><span class="pc">;</span>

	<span class="w">opti</span><span class="pc">ons</span> <span class="pc">= </span><span class="c">(</span><span class="w">u</span><span class="pc">ni</span><span class="c">on</span> <span class="w">all_known_options</span> <span class="w">*</span><span class="pc">)&amp;</span><span class="w">optionsbuffer[</span><span class="c">optionssize</span><span class="pc">];</span>
	<span class="w">opti</span><span class="pc">ons-</span><span class="c">&gt;</span><span class="w">as_windowscale</span><span class="pc">.</span><span class="w">optionnum</span> <span class="c">=</span> <span class="w">OPTION_NUMBER_WINDOW_SCALE</span><span class="c">;</span>
	<span class="w">opti</span><span class="pc">ons-</span><span class="c">&gt;as_windowscale.</span><span class="w">l</span><span class="pc">eng</span><span class="c">th</span> <span class="c">=</span> <span class="pc">s</span><span class="c">izeof(struct</span> <span class="w">option_windowscale)</span><span class="pc">;</span>
	<span class="w">options-</span><span class="c">&gt;</span><span class="w">a</span><span class="pc">s</span><span class="c">_windowscale</span><span class="pc">.</span><span class="w">shiftcount</span> <span class="pc">=</span> <span class="w">cm_node-</span><span class="c">&gt;</span><span class="w">tcp_cntxt</span><span class="pc">.</span><span class="w">rcv_wscale</span><span class="pc">;</span>
	<span class="w">o</span><span class="pc">ptionss</span><span class="c">ize</span> <span class="w">+</span><span class="c">=</span> <span class="w">s</span><span class="pc">i</span><span class="c">zeof(struct</span> <span class="w">o</span><span class="pc">ption_</span><span class="c">windowscale</span><span class="w">);</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">sendack</span> <span class="w">&amp;&amp; !(NES_DRV_OPT_SUPRESS_OPTION_BC</span> <span class="w">&amp;</span> <span class="w">nes_drv_opt</span><span class="pc">))</span><span class="c"> {</span>
		<span class="w">opti</span><span class="pc">ons</span> <span class="w">=</span><span class="pc"> (</span><span class="w">un</span><span class="pc">i</span><span class="c">on</span> <span class="w">all_known_options</span> <span class="c">*)&amp;</span><span class="w">optionsbuffer</span><span class="pc">[</span><span class="w">o</span><span class="c">ptionssize</span><span class="pc">];</span>
		<span class="w">opti</span><span class="pc">ons-</span><span class="c">&gt;</span><span class="w">as_base</span><span class="pc">.</span><span class="w">optionnum</span> <span class="c">=</span> <span class="w">OPTION_NUMBER_WRITE0</span><span class="c">;</span>
		<span class="w">options</span><span class="pc">-</span><span class="c">&gt;as_base.</span><span class="w">l</span><span class="pc">eng</span><span class="c">th</span> <span class="c">=</span> <span class="pc">s</span><span class="c">izeof(struct</span> <span class="w">option_base);</span>
		<span class="w">o</span><span class="pc">ptionss</span><span class="c">ize</span> <span class="w">+</span><span class="c">=</span> <span class="c">sizeof(struct</span> <span class="w">o</span><span class="pc">ption_</span><span class="c">base</span><span class="w">);</span>
		
		<span class="w">opti</span><span class="pc">ons</span> <span class="pc">= </span><span class="c">(</span><span class="w">u</span><span class="pc">ni</span><span class="c">on</span> <span class="c">all_known_options</span> <span class="w">*</span><span class="pc">)&amp;</span><span class="c">optionsbuffer</span><span class="pc">[o</span><span class="c">ptionssize</span><span class="pc">];</span>
		<span class="w">options</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">as_end</span> <span class="c">=</span> <span class="pc">1</span><span class="c">;</span>
		<span class="w">o</span><span class="c">ptionssize</span> <span class="w">+</span><span class="pc">=</span> <span class="w">1</span><span class="c">;</span>
		<span class="w">opti</span><span class="pc">ons</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="w">u</span><span class="pc">ni</span><span class="c">on</span> <span class="w">a</span><span class="pc">l</span><span class="c">l_known_options</span> <span class="w">*</span><span class="pc">)&amp;</span><span class="c">optionsbuffer</span><span class="pc">[</span><span class="c">optionssize];</span>
		<span class="w">opti</span><span class="pc">ons</span><span class="c">-&gt;</span><span class="pc">as</span><span class="c">_end</span> <span class="c">=</span> <span class="pc">1</span><span class="c">;</span>
		<span class="pc">optionss</span><span class="c">ize</span> <span class="w">+</span><span class="pc">=</span> <span class="pc">1</span><span class="c">;</span>
	<span class="pc">}</span>

	<span class="w">op</span><span class="pc">tions</span> <span class="pc">= </span><span class="c">(</span><span class="w">u</span><span class="pc">n</span><span class="c">ion</span> <span class="pc">al</span><span class="c">l_known_options</span> <span class="w">*</span><span class="pc">)&amp;optionsb</span><span class="c">uffer</span><span class="pc">[</span><span class="w">o</span><span class="pc">ptionss</span><span class="c">ize];</span>
	<span class="w">op</span><span class="pc">tions</span><span class="w">-</span><span class="c">&gt;</span><span class="w">a</span><span class="pc">s</span><span class="c">_end</span> <span class="c">=</span> <span class="w">OPTION_NUMBER_END</span><span class="c">;</span>
	<span class="pc">o</span><span class="c">ptionssize</span> <span class="w">+</span><span class="c">=</span> <span class="pc">1</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">s</span><span class="pc">k</span><span class="c">b</span><span class="pc">)</span>
		<span class="w">s</span><span class="pc">k</span><span class="c">b</span> <span class="pc">=</span> <span class="w">dev_alloc_skb</span><span class="pc">(</span><span class="w">MAX_CM_BUFFER</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!s</span><span class="c">kb</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="pc">g</span><span class="c">et</span> <span class="w">a</span> <span class="w">Free</span> <span class="w">pk</span><span class="c">t\n");</span>
		<span class="c">return</span> <span class="c">-</span><span class="pc">1</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">sendack</span><span class="pc">)</span>
		<span class="w">f</span><span class="c">lags</span> <span class="pc">|</span><span class="c">=</span> <span class="w">SET_ACK</span><span class="c">;</span>

	<span class="w">form_cm_frame</span><span class="c">(</span><span class="pc">s</span><span class="c">kb,</span> <span class="w">cm_node</span><span class="pc">,</span> <span class="w">optionsbuffer</span><span class="c">,</span> <span class="w">optionssize</span><span class="c">,</span> <span class="w">N</span><span class="pc">U</span><span class="c">LL,</span> <span class="c">0</span><span class="pc">,</span> <span class="w">f</span><span class="pc">l</span><span class="c">ags);</span>
	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">schedule_nes_timer</span><span class="c">(</span><span class="pc">c</span><span class="c">m_node,</span> <span class="w">s</span><span class="pc">k</span><span class="c">b,</span> <span class="w">NES_TIMER_TYPE_SEND</span><span class="c">,</span> <span class="w">1</span><span class="c">,</span> <span class="c">0</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">r</span><span class="pc">etu</span><span class="c">rn</span> <span class="pc">r</span><span class="c">et;</span>
<span class="c">}</span>



<span class="c">static</span> <span class="c">int</span> <span class="w">send_reset</span><span class="c">(struct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="pc">c</span><span class="c">m_node,</span> <span class="c">struct</span> <span class="c">sk_buff</span> <span class="c">*skb</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">ret</span><span class="pc">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">f</span><span class="c">lags</span> <span class="pc">=</span> <span class="w">SET_RST</span> <span class="w">|</span> <span class="w">SET_ACK</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">s</span><span class="pc">k</span><span class="c">b</span><span class="pc">)</span>
		<span class="w">s</span><span class="pc">k</span><span class="c">b</span> <span class="c">=</span> <span class="w">dev_alloc_skb</span><span class="c">(</span><span class="w">MAX_CM_BUFFER</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">s</span><span class="c">kb</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="pc">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="w">g</span><span class="c">et</span> <span class="w">a</span> <span class="w">Free</span> <span class="w">pk</span><span class="c">t\n");</span>
		<span class="c">return</span> <span class="c">-</span><span class="pc">EN</span><span class="c">OMEM;</span>
	<span class="c">}</span>

	<span class="w">form_cm_frame</span><span class="c">(</span><span class="w">s</span><span class="pc">k</span><span class="c">b,</span> <span class="w">cm_node</span><span class="pc">,</span> <span class="w">N</span><span class="pc">U</span><span class="c">LL</span><span class="pc">,</span> <span class="c">0</span><span class="pc">,</span> <span class="c">NULL</span><span class="pc">,</span> <span class="pc">0,</span> <span class="w">f</span><span class="pc">l</span><span class="c">ags);</span>
	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">schedule_nes_timer</span><span class="c">(</span><span class="pc">cm</span><span class="c">_node,</span> <span class="w">sk</span><span class="c">b,</span> <span class="w">NES_TIMER_TYPE_SEND</span><span class="c">,</span> <span class="c">0,</span> <span class="pc">1)</span><span class="c">;</span>

	<span class="pc">retu</span><span class="c">rn</span> <span class="pc">r</span><span class="c">et;</span>
<span class="c">}</span>



<span class="c">static</span> <span class="c">int</span> <span class="w">send_ack</span><span class="c">(struct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="w">c</span><span class="c">m_node,</span> <span class="c">struct</span> <span class="c">sk_buff</span> <span class="c">*skb</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">ret</span><span class="pc">;</span>

	<span class="pc">if</span> <span class="pc">(!</span><span class="w">s</span><span class="pc">k</span><span class="c">b</span><span class="pc">)</span>
		<span class="pc">sk</span><span class="c">b</span> <span class="c">=</span> <span class="w">dev_alloc_skb</span><span class="c">(</span><span class="w">MAX_CM_BUFFER</span><span class="pc">)</span><span class="c">;</span>

	<span class="c">if</span> <span class="pc">(!s</span><span class="c">kb</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, "</span><span class="w">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="w">g</span><span class="c">et</span> <span class="w">a</span> <span class="w">Free</span> <span class="w">pk</span><span class="c">t\n");</span>
		<span class="c">return</span> <span class="c">-</span><span class="pc">1</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">form_cm_frame</span><span class="c">(</span><span class="pc">sk</span><span class="c">b,</span> <span class="w">cm_node</span><span class="pc">,</span> <span class="w">N</span><span class="pc">U</span><span class="c">LL</span><span class="pc">,</span> <span class="c">0</span><span class="pc">,</span> <span class="c">NULL</span><span class="pc">,</span> <span class="pc">0,</span> <span class="w">SET_ACK</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">schedule_nes_timer</span><span class="c">(</span><span class="w">c</span><span class="pc">m</span><span class="c">_node,</span> <span class="w">s</span><span class="pc">k</span><span class="c">b,</span> <span class="w">NES_TIMER_TYPE_SEND</span><span class="c">,</span> <span class="c">0,</span> <span class="c">0</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">r</span><span class="c">et;</span>
<span class="c">}</span>



<span class="c">static</span> <span class="c">int</span> <span class="w">send_fin</span><span class="c">(struct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="w">c</span><span class="c">m_node,</span> <span class="pc">s</span><span class="c">truct</span> <span class="c">sk_buff</span> <span class="c">*skb</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">ret</span><span class="pc">;</span>

	
	<span class="pc">if</span> <span class="pc">(!</span><span class="w">s</span><span class="pc">k</span><span class="c">b</span><span class="pc">)</span>
		<span class="pc">sk</span><span class="c">b</span> <span class="c">=</span> <span class="w">dev_alloc_skb</span><span class="c">(</span><span class="w">MAX_CM_BUFFER</span><span class="pc">)</span><span class="c">;</span>

	<span class="c">if</span> <span class="pc">(!s</span><span class="c">kb</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, "</span><span class="w">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="w">g</span><span class="c">et</span> <span class="w">a</span> <span class="w">Free</span> <span class="w">pk</span><span class="c">t\n");</span>
		<span class="c">return</span> <span class="c">-</span><span class="pc">1</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">form_cm_frame</span><span class="c">(</span><span class="pc">sk</span><span class="c">b,</span> <span class="w">cm_node</span><span class="pc">,</span> <span class="w">N</span><span class="pc">U</span><span class="c">LL</span><span class="pc">,</span> <span class="c">0</span><span class="pc">,</span> <span class="c">NULL</span><span class="pc">,</span> <span class="pc">0,</span> <span class="w">SET_ACK</span> <span class="w">|</span> <span class="w">SET_FIN</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">schedule_nes_timer</span><span class="c">(</span><span class="w">c</span><span class="c">m_node,</span> <span class="w">s</span><span class="pc">k</span><span class="c">b,</span> <span class="w">NES_TIMER_TYPE_SEND</span><span class="c">,</span> <span class="w">1</span><span class="c">,</span> <span class="c">0</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">r</span><span class="c">et;</span>
<span class="c">}</span>



<span class="c">static</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="w">find_node</span><span class="c">(struct</span> <span class="w">nes_cm_core</span> <span class="c">*</span><span class="w">cm_core</span><span class="c">,</span>
				     <span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="w">rem_port</span><span class="c">,</span> <span class="w">nes_addr_t</span> <span class="w">rem_addr</span><span class="c">,</span> <span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="w">loc_port</span><span class="c">,</span> <span class="w">n</span><span class="pc">es_a</span><span class="c">ddr_t</span> <span class="w">loc_addr)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="c">long</span> <span class="c">flags;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">l</span><span class="c">ist_head</span> <span class="c">*</span><span class="w">hte</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">n</span><span class="pc">es_cm_n</span><span class="c">ode</span> <span class="c">*</span><span class="w">cm_node</span><span class="c">;</span>

	
	<span class="w">h</span><span class="c">te</span> <span class="w">=</span><span class="pc"> </span><span class="c">&amp;cm_core</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">connected_nodes</span><span class="c">;</span>

	
	<span class="w">s</span><span class="pc">pin_</span><span class="c">lock_irqsave(&amp;cm_core-&gt;</span><span class="w">ht_lock</span><span class="c">,</span> <span class="c">flags);</span>
	<span class="w">l</span><span class="pc">ist_for_each_entry</span><span class="c">(</span><span class="w">c</span><span class="pc">m_n</span><span class="c">ode</span><span class="pc">,</span> <span class="c">hte</span><span class="pc">,</span> <span class="pc">l</span><span class="c">ist</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
		
		<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">finding</span> <span class="w">n</span><span class="pc">od</span><span class="c">e</span> <span class="w">%x:</span><span class="c">%</span><span class="w">x</span> <span class="w">=? %x:</span><span class="c">%x</span> <span class="w">^ %</span><span class="c">x</span><span class="pc">:</span><span class="c">%x</span> <span class="w">=</span><span class="pc">?</span><span class="c"> %x</span><span class="w">:</span><span class="c">%x\</span><span class="pc">n</span><span class="c">",</span>
			  <span class="w">c</span><span class="pc">m_n</span><span class="c">ode</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">loc_addr</span><span class="pc">,</span> <span class="pc">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">loc_port</span><span class="c">,</span>
			  <span class="pc">l</span><span class="c">oc_addr</span><span class="pc">,</span> <span class="w">l</span><span class="c">oc_port,</span>
			  <span class="c">cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">rem_addr</span><span class="c">,</span> <span class="c">cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">rem_port</span><span class="c">,</span>
			  <span class="pc">r</span><span class="c">em_addr,</span> <span class="w">r</span><span class="c">em_port</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="pc">((</span><span class="c">cm_node-&gt;</span><span class="w">mapped_loc_addr</span> <span class="pc">=</span><span class="c">=</span> <span class="w">l</span><span class="pc">oc_a</span><span class="c">ddr</span><span class="pc">) &amp;</span><span class="c">&amp;</span>
			<span class="pc">(</span><span class="c">cm_node-&gt;</span><span class="w">mapped_loc_port</span> <span class="c">==</span> <span class="w">l</span><span class="pc">oc_p</span><span class="c">ort</span><span class="w">) </span><span class="pc">&amp;</span><span class="c">&amp;</span>
			<span class="c">(cm_node-&gt;</span><span class="w">mapped_rem_addr</span> <span class="c">==</span> <span class="w">r</span><span class="c">em_addr</span><span class="w">) </span><span class="pc">&amp;</span><span class="c">&amp;</span>
			<span class="c">(cm_node-&gt;</span><span class="w">mapped_rem_port</span> <span class="c">==</span> <span class="w">r</span><span class="pc">em_p</span><span class="c">ort</span><span class="pc">))</span><span class="c"> {</span>

			<span class="w">add_ref_cm_node</span><span class="c">(cm_node</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">s</span><span class="pc">p</span><span class="c">in_unlock_irqrestore(&amp;</span><span class="w">cm_core</span><span class="c">-&gt;</span><span class="w">ht_lock</span><span class="c">,</span> <span class="c">flags);</span>
			<span class="pc">r</span><span class="c">eturn</span> <span class="w">c</span><span class="pc">m_n</span><span class="c">ode;</span>
		<span class="c">}</span>
	<span class="pc">}</span>
	<span class="w">sp</span><span class="pc">in_unlock_</span><span class="c">irqrestore(&amp;</span><span class="pc">cm_c</span><span class="c">ore-&gt;</span><span class="pc">h</span><span class="c">t_lock,</span> <span class="c">flags);</span>

	
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">N</span><span class="c">ULL;</span>
<span class="c">}</span>



<span class="c">static</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">nes_cm_listener</span> <span class="c">*</span><span class="w">find_listener</span><span class="c">(struct</span> <span class="w">nes_cm_core</span> <span class="c">*cm_core</span><span class="pc">,</span>
					<span class="w">nes_addr_t</span> <span class="w">dst_addr</span><span class="c">,</span> <span class="w">u1</span><span class="c">6</span> <span class="w">dst_port</span><span class="c">,</span>
					<span class="w">e</span><span class="c">num</span> <span class="w">nes_cm_listener_state</span> <span class="w">listener_state</span><span class="c">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">lo</span><span class="pc">ca</span><span class="c">l</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="pc">l</span><span class="c">ong</span> <span class="c">flags;</span>
	<span class="c">struct</span> <span class="c">nes_cm_listener</span> <span class="c">*</span><span class="w">listen_node</span><span class="c">;</span>
	<span class="w">n</span><span class="pc">es_a</span><span class="c">ddr_t</span> <span class="w">listen_addr</span><span class="c">;</span>
	<span class="w">u1</span><span class="c">6</span> <span class="w">listen_port</span><span class="c">;</span>

	
	<span class="w">sp</span><span class="pc">in_</span><span class="c">lock_irqsave(&amp;</span><span class="pc">c</span><span class="c">m_core-&gt;</span><span class="w">listen_list_lock</span><span class="c">,</span> <span class="c">flags);</span>
	<span class="w">list_</span><span class="pc">f</span><span class="c">or_each_entry(</span><span class="w">l</span><span class="pc">isten_n</span><span class="c">ode, &amp;cm_core-&gt;</span><span class="w">listen_list</span><span class="pc">.</span><span class="c">list</span><span class="pc">,</span> <span class="w">list)</span><span class="pc"> </span><span class="c">{</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">lo</span><span class="c">cal</span><span class="pc">)</span><span class="c"> {</span>
			<span class="w">l</span><span class="pc">isten_a</span><span class="c">ddr</span> <span class="pc">=</span> <span class="pc">listen_n</span><span class="c">ode-&gt;</span><span class="w">loc_addr</span><span class="c">;</span>
			<span class="w">l</span><span class="pc">isten_p</span><span class="c">ort</span> <span class="pc">=</span> <span class="pc">listen_n</span><span class="c">ode-&gt;</span><span class="w">loc_port</span><span class="c">;</span>
		<span class="c">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
			<span class="w">l</span><span class="pc">isten_a</span><span class="c">ddr</span> <span class="c">=</span> <span class="pc">listen_n</span><span class="c">ode-&gt;</span><span class="w">mapped_loc_addr</span><span class="c">;</span>
			<span class="w">l</span><span class="pc">isten_p</span><span class="c">ort</span> <span class="pc">=</span> <span class="w">l</span><span class="pc">isten_n</span><span class="c">ode-&gt;</span><span class="w">mapped_loc_port</span><span class="c">;</span>
		<span class="c">}</span>
		
		<span class="pc">i</span><span class="c">f</span> <span class="w">((</span><span class="pc">(</span><span class="c">listen_addr</span> <span class="pc">=</span><span class="c">=</span> <span class="w">dst_addr) </span><span class="pc">||</span>
		     <span class="pc">listen_a</span><span class="c">ddr</span> <span class="pc">=</span><span class="c">=</span> <span class="w">0x00</span><span class="pc">000</span><span class="c">000</span><span class="pc">) &amp;</span><span class="c">&amp;</span>
		    <span class="c">(</span><span class="pc">listen_p</span><span class="c">ort</span> <span class="pc">=</span><span class="c">=</span> <span class="w">dst_port)</span><span class="pc"> &amp;</span><span class="c">&amp;</span>
		    <span class="c">(</span><span class="w">listener_state</span> <span class="pc">&amp;</span> <span class="pc">l</span><span class="c">isten_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">listene</span><span class="c">r_state)) {</span>
			<span class="w">a</span><span class="pc">t</span><span class="c">omic_inc(&amp;</span><span class="pc">listen_n</span><span class="c">ode-&gt;</span><span class="w">ref_count</span><span class="c">);</span>
			<span class="w">s</span><span class="pc">p</span><span class="c">in_unlock_irqrestore(&amp;</span><span class="w">cm_core</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">listen_list_lock</span><span class="c">,</span> <span class="c">flags);</span>
			<span class="pc">r</span><span class="c">eturn</span> <span class="w">l</span><span class="pc">isten_n</span><span class="c">ode;</span>
		<span class="c">}</span>
	<span class="c">}</span>
	<span class="w">sp</span><span class="pc">in_unlock_i</span><span class="c">rqrestore(&amp;cm_core-&gt;</span><span class="pc">li</span><span class="c">sten_list_lock,</span> <span class="c">flags);</span>

	
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">N</span><span class="c">ULL;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">add_hte_node</span><span class="c">(struct</span> <span class="w">nes_cm_core</span> <span class="c">*</span><span class="pc">cm</span><span class="c">_core</span><span class="pc">,</span> <span class="c">struct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="w">cm_node</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="c">flags;</span>
	<span class="pc">st</span><span class="c">ruct</span> <span class="pc">l</span><span class="c">ist_head</span> <span class="c">*</span><span class="w">hte</span><span class="c">;</span>

	<span class="w">i</span><span class="pc">f</span> <span class="pc">(!</span><span class="c">cm_node</span> <span class="pc">|</span><span class="c">| !cm_core</span><span class="pc">)</span>
		<span class="c">return</span> <span class="c">-EINVAL;</span>

	<span class="w">nes_debug</span><span class="pc">(</span><span class="w">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">Adding</span> <span class="w">Node</span> <span class="w">%</span><span class="pc">p</span> <span class="w">t</span><span class="c">o</span> <span class="w">Active</span> <span class="w">Connection</span> <span class="w">HT</span><span class="c">\n",</span>
		  <span class="pc">c</span><span class="c">m_node);</span>

	<span class="w">s</span><span class="c">pin_lock_irqsave(&amp;</span><span class="w">c</span><span class="pc">m_c</span><span class="c">ore-&gt;</span><span class="w">ht_lock</span><span class="c">,</span> <span class="c">flags);</span>

	
	<span class="pc">h</span><span class="c">te</span> <span class="w">=</span><span class="pc"> &amp;</span><span class="c">cm_core-&gt;</span><span class="w">connected_nodes</span><span class="c">;</span>
	<span class="w">li</span><span class="pc">st_a</span><span class="c">dd_tail(&amp;</span><span class="w">c</span><span class="pc">m_n</span><span class="c">ode-&gt;</span><span class="pc">l</span><span class="c">ist</span><span class="pc">,</span> <span class="pc">h</span><span class="c">te);</span>
	<span class="w">a</span><span class="c">tomic_inc(&amp;cm_core-&gt;</span><span class="w">ht_node_cnt</span><span class="c">);</span>

	<span class="w">s</span><span class="c">pin_unlock_irqrestore(&amp;</span><span class="pc">c</span><span class="c">m_core-&gt;</span><span class="pc">h</span><span class="c">t_lock,</span> <span class="c">flags);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>



<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">mini_cm_dec_refcnt_listen</span><span class="c">(struct</span> <span class="w">nes_cm_core</span> <span class="c">*cm_core,</span>
				     <span class="c">struct</span> <span class="w">nes_cm_listener</span> <span class="c">*</span><span class="w">listener</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">free_hanging_nodes</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">r</span><span class="c">et</span> <span class="pc">= </span><span class="c">-EINVAL;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="pc">e</span><span class="c">rr</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="w">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="pc">f</span><span class="c">lags</span><span class="pc">;</span>
	<span class="pc">st</span><span class="c">ruct</span> <span class="w">l</span><span class="pc">ist_</span><span class="c">head</span> <span class="c">*</span><span class="w">list_pos</span> <span class="pc">=</span> <span class="w">N</span><span class="c">ULL;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">l</span><span class="pc">ist_h</span><span class="c">ead</span> <span class="c">*</span><span class="w">list_temp</span> <span class="pc">=</span> <span class="w">N</span><span class="c">ULL;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="w">cm_node</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="pc">list_h</span><span class="c">ead</span> <span class="w">reset_list</span><span class="c">;</span>

	<span class="w">nes_debug</span><span class="pc">(</span><span class="w">NES_DBG_CM</span><span class="pc">, "</span><span class="w">attempting</span> <span class="w">listener=</span><span class="pc"> </span><span class="c">%</span><span class="pc">p</span> <span class="w">free_nodes=</span><span class="pc"> </span><span class="c">%d</span><span class="w">,</span><span class="pc"> "</span>
		  <span class="w">"refcnt=</span><span class="pc">%</span><span class="c">d\n",</span> <span class="w">l</span><span class="pc">iste</span><span class="c">ner</span><span class="pc">,</span> <span class="w">free_hanging_nodes</span><span class="pc">,</span>
		  <span class="w">at</span><span class="pc">o</span><span class="c">mic_read(&amp;</span><span class="pc">liste</span><span class="c">ner-&gt;</span><span class="w">ref_count</span><span class="pc">))</span><span class="c">;</span>
	
	<span class="w">I</span><span class="c">NIT_LIST_HEAD(&amp;</span><span class="w">r</span><span class="pc">es</span><span class="c">et_list</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">f</span><span class="c">ree_hanging_nodes</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">sp</span><span class="pc">in_lock_</span><span class="c">irqsave(&amp;</span><span class="w">cm_core</span><span class="c">-&gt;</span><span class="w">ht_lock</span><span class="c">,</span> <span class="c">flags);</span>
		<span class="w">list_for_each_safe</span><span class="c">(</span><span class="w">list_pos</span><span class="pc">,</span> <span class="w">list_temp</span><span class="c">,</span>
				   <span class="w">&amp;g_cm_core-</span><span class="c">&gt;</span><span class="w">connected_nodes)</span><span class="pc"> </span><span class="c">{</span>
			<span class="w">cm_node</span> <span class="pc">=</span> <span class="w">co</span><span class="pc">nt</span><span class="c">ainer_of(</span><span class="pc">list_</span><span class="c">pos,</span> <span class="c">struct</span> <span class="w">nes_cm_node</span><span class="c">,</span>
					       <span class="w">l</span><span class="pc">ist</span><span class="c">);</span>
			<span class="c">if</span> <span class="pc">((cm_n</span><span class="c">ode</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">listener</span> <span class="pc">=</span><span class="c">=</span> <span class="w">l</span><span class="pc">iste</span><span class="c">ner</span><span class="pc">) &amp;</span><span class="c">&amp;</span>
			    <span class="w">(</span><span class="pc">!cm_n</span><span class="c">ode-&gt;</span><span class="w">accelerated)</span><span class="pc">) </span><span class="c">{</span>
				<span class="w">add_ref_cm_node</span><span class="c">(cm_node</span><span class="pc">)</span><span class="c">;</span>
				<span class="w">list_a</span><span class="pc">dd</span><span class="c">(&amp;</span><span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">reset_entry</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">reset_list</span><span class="c">);</span>
			<span class="c">}</span>
		<span class="c">}</span>
		<span class="w">s</span><span class="pc">pin_unlock_</span><span class="c">irqrestore(&amp;</span><span class="w">cm_core</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ht_lock</span><span class="c">,</span> <span class="c">flags);</span>
	<span class="c">}</span>

	<span class="w">list_for_each_safe</span><span class="c">(</span><span class="w">list_pos</span><span class="pc">,</span> <span class="w">list_temp</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">r</span><span class="c">eset_list</span><span class="w">) </span><span class="c">{</span>
		<span class="pc">c</span><span class="c">m_node</span> <span class="w">=</span> <span class="w">co</span><span class="pc">nt</span><span class="c">ainer_of(</span><span class="pc">l</span><span class="c">ist_pos,</span> <span class="c">struct</span> <span class="w">nes_cm_node</span><span class="c">,</span>
				       <span class="w">r</span><span class="pc">eset_e</span><span class="c">ntry);</span>
		<span class="w">{</span>
			<span class="c">struct</span> <span class="w">n</span><span class="c">es_cm_node</span> <span class="c">*</span><span class="w">loopback</span> <span class="pc">=</span> <span class="pc">cm_n</span><span class="c">ode</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">loopbackpartner</span><span class="c">;</span>
			<span class="w">e</span><span class="c">num</span> <span class="w">nes_cm_node_state</span> <span class="w">old_state</span><span class="c">;</span>
			<span class="w">i</span><span class="pc">f</span> <span class="c">(</span><span class="w">NES_CM_STATE_FIN_WAIT1</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="w">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s</span><span class="pc">tate</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
				<span class="w">rem_ref_cm_node</span><span class="pc">(c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">cm_core</span><span class="pc">,</span> <span class="pc">c</span><span class="c">m_node);</span>
			<span class="c">}</span> <span class="c">else</span> <span class="c">{</span>
				<span class="c">if</span> <span class="pc">(!l</span><span class="c">oopback</span><span class="pc">)</span><span class="c"> {</span>
					<span class="w">cleanup_retrans_entry</span><span class="c">(cm_node</span><span class="pc">)</span><span class="c">;</span>
					<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="w">send_reset</span><span class="c">(cm_node,</span> <span class="w">N</span><span class="pc">U</span><span class="c">LL);</span>
					<span class="c">if</span> <span class="c">(</span><span class="pc">e</span><span class="c">rr</span><span class="pc">) </span><span class="c">{</span>
						<span class="w">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s</span><span class="pc">t</span><span class="c">ate</span> <span class="pc">=</span>
							<span class="w">NES_CM_STATE_CLOSED</span><span class="c">;</span>
						<span class="w">W</span><span class="c">ARN_ON(</span><span class="w">1</span><span class="c">);</span>
					<span class="pc">}</span> <span class="c">else</span> <span class="c">{</span>
						<span class="w">old_state</span> <span class="pc">=</span> <span class="c">cm_node-&gt;</span><span class="w">s</span><span class="c">tate;</span>
						<span class="pc">c</span><span class="c">m_node-&gt;</span><span class="pc">s</span><span class="c">tate</span> <span class="c">=</span> <span class="w">NES_CM_STATE_LISTENER_DESTROYED</span><span class="c">;</span>
						<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">o</span><span class="c">ld_state</span> <span class="w">!</span><span class="c">=</span> <span class="w">NES_CM_STATE_MPAREQ_RCVD</span><span class="c">)</span>
							<span class="w">rem_ref_cm_node</span><span class="c">(</span>
								<span class="c">cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">cm_core</span><span class="c">,</span>
								<span class="c">cm_node</span><span class="pc">)</span><span class="c">;</span>
					<span class="pc">}</span>
				<span class="w">}</span> <span class="c">else</span> <span class="c">{</span>
					<span class="c">struct</span> <span class="w">nes_cm_event</span> <span class="w">e</span><span class="c">vent;</span>

					<span class="w">ev</span><span class="c">ent</span><span class="w">.</span><span class="pc">c</span><span class="c">m_node</span> <span class="c">=</span> <span class="w">loopback</span><span class="c">;</span>
					<span class="w">ev</span><span class="pc">e</span><span class="c">nt</span><span class="pc">.</span><span class="w">cm_info</span><span class="pc">.</span><span class="w">rem_addr</span> <span class="c">=</span>
							<span class="pc">l</span><span class="c">oopback</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">r</span><span class="c">em_addr;</span>
					<span class="w">ev</span><span class="c">ent.</span><span class="pc">c</span><span class="c">m_info</span><span class="pc">.</span><span class="w">loc_addr</span> <span class="c">=</span>
							<span class="w">l</span><span class="c">oopback</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">l</span><span class="c">oc_addr;</span>
					<span class="w">ev</span><span class="c">ent.</span><span class="pc">c</span><span class="c">m_info</span><span class="pc">.</span><span class="w">rem_port</span> <span class="c">=</span>
							<span class="pc">l</span><span class="c">oopback</span><span class="pc">-</span><span class="c">&gt;rem_port</span><span class="pc">;</span>
					<span class="w">ev</span><span class="pc">e</span><span class="c">nt.</span><span class="pc">c</span><span class="c">m_info</span><span class="pc">.</span><span class="w">loc_port</span> <span class="c">=</span>
							 <span class="pc">l</span><span class="c">oopback-&gt;loc_port;</span>
					<span class="w">ev</span><span class="pc">e</span><span class="c">nt.cm_info.</span><span class="w">cm_id</span> <span class="c">=</span> <span class="c">loopback-&gt;cm_id;</span>
					<span class="w">add_ref_cm_node</span><span class="pc">(l</span><span class="c">oopback</span><span class="pc">)</span><span class="c">;</span>
					<span class="w">l</span><span class="pc">oo</span><span class="c">pback-&gt;</span><span class="w">st</span><span class="pc">ate</span> <span class="pc">=</span> <span class="w">NES_CM_STATE_CLOSED</span><span class="c">;</span>
					<span class="w">cm_event_connect_error</span><span class="pc">(&amp;</span><span class="w">ev</span><span class="pc">e</span><span class="c">nt</span><span class="pc">)</span><span class="c">;</span>
					<span class="w">cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s</span><span class="pc">tate</span> <span class="c">=</span> <span class="w">NES_CM_STATE_LISTENER_DESTROYED</span><span class="c">;</span>

					<span class="w">rem_ref_cm_node</span><span class="c">(cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">cm_core</span><span class="pc">,</span>
							 <span class="pc">c</span><span class="c">m_node);</span>

				<span class="pc">}</span>
			<span class="w">}</span>
		<span class="w">}</span>
	<span class="w">}</span>

	<span class="w">sp</span><span class="pc">in_lock_</span><span class="c">irqsave(&amp;</span><span class="w">c</span><span class="pc">m_c</span><span class="c">ore-&gt;</span><span class="w">listen_list_lock</span><span class="c">,</span> <span class="c">flags);</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">atomic_dec_return</span><span class="pc">(&amp;</span><span class="w">listener</span><span class="c">-&gt;</span><span class="w">ref_count</span><span class="c">)) {</span>
		<span class="w">l</span><span class="pc">ist_</span><span class="c">del(&amp;</span><span class="pc">l</span><span class="c">istener-&gt;</span><span class="pc">l</span><span class="c">ist);</span>

		
		<span class="w">atomic_dec</span><span class="c">(&amp;</span><span class="w">c</span><span class="pc">m_c</span><span class="c">ore-&gt;</span><span class="w">listen_node_cnt</span><span class="c">);</span>

		<span class="w">s</span><span class="pc">pin_unlock_</span><span class="c">irqrestore(&amp;</span><span class="w">c</span><span class="pc">m_c</span><span class="c">ore-&gt;</span><span class="w">l</span><span class="pc">isten_</span><span class="c">list_lock,</span> <span class="c">flags);</span>

		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">l</span><span class="c">istener-&gt;</span><span class="w">nesvnic</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">nes_manage_apbvt</span><span class="pc">(</span><span class="c">listener-&gt;nesvnic</span><span class="pc">,</span>
				<span class="pc">l</span><span class="c">istener-&gt;</span><span class="w">mapped_loc_port</span><span class="pc">,</span>
				<span class="w">PCI_FUNC</span><span class="pc">(</span><span class="c">listener</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">n</span><span class="c">esvnic</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">nes</span><span class="pc">d</span><span class="c">ev</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">pc</span><span class="pc">id</span><span class="c">ev-&gt;</span><span class="w">devf</span><span class="c">n</span><span class="w">)</span><span class="pc">,</span>
				<span class="w">NES_MANAGE_APBVT_DEL</span><span class="pc">)</span><span class="c">;</span>

			<span class="w">nes_remove_mapinfo</span><span class="c">(listener-&gt;</span><span class="w">loc_addr</span><span class="c">,</span>
					<span class="c">listener-&gt;</span><span class="w">loc_port</span><span class="c">,</span>
					<span class="c">listener-&gt;</span><span class="w">mapped_loc_addr</span><span class="c">,</span>
					<span class="c">listener-&gt;</span><span class="w">m</span><span class="pc">apped_loc_p</span><span class="c">ort</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_NLMSG</span><span class="c">,</span>
					<span class="w">"Delete</span> <span class="w">APBVT</span> <span class="w">m</span><span class="pc">apped_loc_p</span><span class="c">ort</span> <span class="w">=</span><span class="pc"> %</span><span class="w">04X</span><span class="pc">\</span><span class="c">n",</span>
					<span class="c">listener-&gt;</span><span class="pc">m</span><span class="c">apped_loc_port</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">}</span>

		<span class="w">n</span><span class="c">es_debug(</span><span class="w">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">destroying</span> <span class="pc">l</span><span class="c">istener</span> <span class="w">(</span><span class="pc">%</span><span class="w">p)</span><span class="pc">\</span><span class="c">n",</span> <span class="c">listener</span><span class="pc">)</span><span class="c">;</span>

		<span class="w">k</span><span class="c">free(listener);</span>
		<span class="pc">l</span><span class="c">istener</span> <span class="pc">=</span> <span class="w">N</span><span class="pc">U</span><span class="c">LL;</span>
		<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
		<span class="w">at</span><span class="pc">omic_i</span><span class="c">nc(&amp;</span><span class="w">cm_listens_destroyed</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
		<span class="w">sp</span><span class="pc">in_u</span><span class="c">nlock_irqrestore(&amp;</span><span class="w">cm_core</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">listen_list_lock</span><span class="c">,</span> <span class="c">flags);</span>
	<span class="pc">}</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(listener</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">at</span><span class="pc">o</span><span class="c">mic_read(&amp;</span><span class="pc">l</span><span class="c">istener-&gt;</span><span class="w">pend_accepts_cnt) &gt;</span> <span class="c">0</span><span class="pc">)</span>
			<span class="w">nes_debug</span><span class="pc">(</span><span class="w">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">destroying</span> <span class="w">l</span><span class="pc">istene</span><span class="c">r</span> <span class="w">(</span><span class="pc">%p</span><span class="w">)"</span>
				  <span class="w">"</span> <span class="w">wi</span><span class="pc">t</span><span class="c">h</span> <span class="w">non-zero</span> <span class="w">pe</span><span class="pc">ndi</span><span class="c">ng</span> <span class="w">accepts=</span><span class="pc">%</span><span class="c">u\n",</span>
				  <span class="pc">l</span><span class="c">istener</span><span class="pc">,</span> <span class="w">at</span><span class="c">omic_read(&amp;listener-&gt;</span><span class="w">p</span><span class="c">end_accepts_cnt</span><span class="pc">))</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">r</span><span class="c">eturn</span> <span class="pc">r</span><span class="c">et;</span>
<span class="c">}</span>



<span class="c">static</span> <span class="c">int</span> <span class="w">mini_cm_del_listen</span><span class="c">(struct</span> <span class="w">nes_cm_core</span> <span class="c">*</span><span class="w">cm_core</span><span class="c">,</span>
			      <span class="c">struct</span> <span class="w">nes_cm_listener</span> <span class="c">*</span><span class="w">l</span><span class="c">istener)</span>
<span class="c">{</span>
	<span class="w">l</span><span class="c">istener-&gt;</span><span class="w">listener_state</span> <span class="c">=</span> <span class="w">NES_CM_LISTENER_PASSIVE_STATE</span><span class="c">;</span>
	<span class="w">l</span><span class="c">istener-&gt;</span><span class="w">cm_id</span> <span class="c">=</span> <span class="c">NULL;</span> 
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">mini_cm_dec_refcnt_listen</span><span class="pc">(c</span><span class="c">m_core,</span> <span class="pc">listener</span><span class="c">,</span> <span class="w">1</span><span class="c">);</span>
<span class="c">}</span>



<span class="c">static</span> <span class="pc">inl</span><span class="c">ine</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">mini_cm_accelerated</span><span class="c">(struct</span> <span class="pc">nes_cm_c</span><span class="c">ore</span> <span class="c">*cm_core,</span>
				      <span class="c">struct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="w">cm_node</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">c</span><span class="pc">m_n</span><span class="c">ode</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">accelerated</span> <span class="c">=</span> <span class="w">1</span><span class="c">;</span>

	<span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">cm_n</span><span class="c">ode-&gt;</span><span class="w">accept_pend</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">B</span><span class="c">UG_ON</span><span class="pc">(!</span><span class="c">cm_node-&gt;</span><span class="w">l</span><span class="c">istener</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">atomic_dec</span><span class="pc">(&amp;c</span><span class="c">m_node-&gt;</span><span class="pc">l</span><span class="c">istener</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">pend_accepts_cnt</span><span class="c">);</span>
		<span class="pc">c</span><span class="c">m_node-&gt;</span><span class="pc">a</span><span class="c">ccept_pend</span> <span class="pc">=</span> <span class="pc">0</span><span class="c">;</span>
		<span class="w">B</span><span class="c">UG_ON(</span><span class="w">at</span><span class="pc">omic_r</span><span class="c">ead(&amp;cm_node-&gt;</span><span class="w">l</span><span class="pc">i</span><span class="c">stener</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">p</span><span class="c">end_accepts_cnt</span><span class="w">) &lt;</span> <span class="c">0</span><span class="pc">);</span>
	<span class="c">}</span>

	<span class="w">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">timer_pending</span><span class="pc">(&amp;</span><span class="w">cm_core</span><span class="c">-&gt;</span><span class="w">tcp_timer)</span><span class="pc">)</span>
		<span class="w">mod_timer</span><span class="pc">(&amp;cm_c</span><span class="c">ore-&gt;tcp_timer</span><span class="w">,</span><span class="pc"> (</span><span class="w">j</span><span class="c">iffies</span> <span class="c">+</span> <span class="w">NES_SHORT_TIME)</span><span class="pc">);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>



<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">nes_addr_resolve_neigh</span><span class="c">(struct</span> <span class="w">nes_vnic</span> <span class="c">*</span><span class="w">nesvnic</span><span class="pc">,</span> <span class="pc">u3</span><span class="c">2</span> <span class="w">dst_ip</span><span class="c">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">arpindex</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">rtable</span> <span class="c">*</span><span class="w">rt</span><span class="pc">;</span>
	<span class="c">struct</span> <span class="w">neighbour</span> <span class="c">*</span><span class="w">neigh</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">r</span><span class="pc">c</span> <span class="pc">=</span> <span class="w">a</span><span class="c">rpindex;</span>
	<span class="w">s</span><span class="c">truct</span> <span class="w">net</span><span class="c">_device</span> <span class="c">*netdev;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">nes_adapter</span> <span class="c">*</span><span class="w">nesadapter</span> <span class="pc">=</span> <span class="w">nes</span><span class="pc">v</span><span class="c">nic-&gt;</span><span class="w">nes</span><span class="pc">d</span><span class="c">ev</span><span class="w">-</span><span class="c">&gt;nesadapter;</span>
	<span class="w">_</span><span class="pc">_be3</span><span class="c">2</span> <span class="w">dst_ipaddr</span> <span class="pc">=</span> <span class="w">ht</span><span class="pc">onl</span><span class="c">(</span><span class="w">dst_ip</span><span class="c">);</span>

	<span class="w">rt</span> <span class="pc">=</span> <span class="w">ip_route_output</span><span class="pc">(&amp;</span><span class="w">init_net</span><span class="c">,</span> <span class="w">d</span><span class="pc">s</span><span class="c">t_ipaddr</span><span class="pc">,</span> <span class="w">n</span><span class="pc">esv</span><span class="c">nic</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">local_ipaddr</span><span class="pc">,</span> <span class="pc">0,</span> <span class="c">0);</span>
	<span class="c">if</span> <span class="pc">(I</span><span class="c">S_ERR(</span><span class="w">rt</span><span class="pc">)</span><span class="c">) {</span>
		<span class="w">p</span><span class="c">rintk(KERN_ERR</span> <span class="pc">"%</span><span class="c">s:</span> <span class="w">ip_route_output_key</span> <span class="c">failed</span> <span class="w">f</span><span class="pc">or</span> <span class="w">0</span><span class="c">x%</span><span class="w">0</span><span class="pc">8X</span><span class="c">\n",</span>
		       <span class="pc">_</span><span class="c">_func__</span><span class="pc">,</span> <span class="w">dst_ip</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">return</span> <span class="w">r</span><span class="pc">c</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">i</span><span class="pc">f</span> <span class="c">(</span><span class="w">netif_is_bond_slave</span><span class="c">(</span><span class="w">nesvnic-</span><span class="c">&gt;</span><span class="w">n</span><span class="pc">etd</span><span class="c">ev</span><span class="w">))</span>
		<span class="w">n</span><span class="pc">etd</span><span class="c">ev</span> <span class="pc">=</span> <span class="w">netdev_master_upper_dev_get</span><span class="c">(</span><span class="pc">n</span><span class="c">esvnic</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ne</span><span class="pc">tdev</span><span class="c">);</span>
	<span class="pc">e</span><span class="c">lse</span>
		<span class="w">n</span><span class="pc">etdev</span> <span class="pc">=</span> <span class="w">n</span><span class="pc">es</span><span class="c">vnic-&gt;</span><span class="w">net</span><span class="pc">dev</span><span class="c">;</span>

	<span class="w">neigh</span> <span class="pc">=</span> <span class="w">dst_neigh_lookup</span><span class="pc">(&amp;</span><span class="w">r</span><span class="pc">t</span><span class="c">-&gt;</span><span class="w">ds</span><span class="pc">t, </span><span class="c">&amp;</span><span class="w">dst_ipaddr</span><span class="c">);</span>

	<span class="w">rc</span><span class="pc">u_read_l</span><span class="c">ock();</span>
	<span class="c">if</span> <span class="c">(neigh</span><span class="pc">)</span><span class="c"> {</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">nei</span><span class="c">gh-&gt;</span><span class="w">nud_state</span> <span class="w">&amp;</span> <span class="w">NUD_VALID</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">Neighbor</span> <span class="w">MAC</span> <span class="w">a</span><span class="pc">dd</span><span class="c">ress</span> <span class="w">f</span><span class="pc">or</span> <span class="w">0</span><span class="c">x%</span><span class="w">0</span><span class="pc">8X</span><span class="w">"</span>
				  <span class="w">"</span> <span class="w">is</span> <span class="c">%</span><span class="w">p</span><span class="pc">M</span><span class="w">,</span> <span class="w">Gateway</span> <span class="w">i</span><span class="c">s</span> <span class="pc">0</span><span class="c">x%</span><span class="pc">08X</span> <span class="pc">\</span><span class="c">n",</span> <span class="w">dst_ip</span><span class="c">,</span>
				  <span class="w">n</span><span class="pc">e</span><span class="c">igh-&gt;</span><span class="w">ha</span><span class="c">,</span> <span class="w">ntohl</span><span class="pc">(</span><span class="w">rt</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">rt_gateway</span><span class="pc">)</span><span class="c">);</span>

			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">arpindex</span> <span class="w">&gt;</span><span class="c">=</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
				<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">ether_addr_equal</span><span class="c">(</span><span class="w">nesadapter-</span><span class="c">&gt;</span><span class="w">arp_table</span><span class="pc">[</span><span class="w">a</span><span class="c">rpindex].</span><span class="w">mac</span><span class="pc">_</span><span class="c">addr,</span> <span class="pc">nei</span><span class="c">gh-&gt;</span><span class="w">h</span><span class="pc">a</span><span class="w">)</span><span class="pc">)</span><span class="c"> {</span>
					
					<span class="w">g</span><span class="c">oto</span> <span class="c">out;</span>
				<span class="c">}</span>

				<span class="w">nes_manage_arp_cache</span><span class="pc">(</span><span class="w">nesvnic</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ne</span><span class="pc">t</span><span class="c">dev</span><span class="pc">,</span>
						     <span class="w">n</span><span class="c">esadapter-&gt;arp_table</span><span class="w">[a</span><span class="c">rpindex</span><span class="pc">]</span><span class="c">.</span><span class="w">mac</span><span class="pc">_</span><span class="c">addr,</span>
						     <span class="w">dst_ip</span><span class="pc">,</span> <span class="w">NES_ARP_DELETE</span><span class="c">);</span>
			<span class="pc">}</span>

			<span class="w">n</span><span class="pc">es_</span><span class="c">manage_arp_cache</span><span class="pc">(nesv</span><span class="c">nic</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">net</span><span class="c">dev,</span> <span class="pc">nei</span><span class="c">gh-&gt;</span><span class="w">h</span><span class="pc">a,</span>
					     <span class="w">d</span><span class="c">st_ip</span><span class="pc">,</span> <span class="w">NES_ARP_ADD</span><span class="c">);</span>
			<span class="w">r</span><span class="pc">c</span> <span class="c">=</span> <span class="w">nes_arp_table</span><span class="c">(</span><span class="pc">n</span><span class="c">esvnic</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">nes</span><span class="pc">d</span><span class="c">ev,</span> <span class="w">d</span><span class="c">st_ip</span><span class="pc">,</span> <span class="w">N</span><span class="pc">U</span><span class="c">LL,</span>
					   <span class="w">NES_ARP_RESOLVE</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
			<span class="w">neigh_event_send</span><span class="c">(</span><span class="pc">nei</span><span class="c">gh,</span> <span class="w">N</span><span class="pc">U</span><span class="c">LL</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">}</span>
	<span class="pc">}</span>
<span class="w">o</span><span class="c">ut:</span>
	<span class="w">rc</span><span class="pc">u</span><span class="c">_read_unlock();</span>

	<span class="c">if</span> <span class="c">(</span><span class="pc">nei</span><span class="c">gh)</span>
		<span class="w">neigh_release</span><span class="c">(</span><span class="pc">nei</span><span class="c">gh</span><span class="pc">);</span>

	<span class="w">ip_rt_put</span><span class="c">(</span><span class="w">rt</span><span class="c">);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">r</span><span class="c">c;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="w">make_cm_node</span><span class="c">(struct</span> <span class="w">nes_cm_core</span> <span class="c">*</span><span class="w">cm_core</span><span class="pc">,</span>
					<span class="c">struct</span> <span class="w">nes_vnic</span> <span class="c">*</span><span class="w">nesvnic</span><span class="pc">,</span> <span class="c">struct</span> <span class="w">nes_cm_info</span> <span class="c">*</span><span class="w">cm_info</span><span class="pc">,</span>
					<span class="c">struct</span> <span class="w">nes_cm_listener</span> <span class="c">*</span><span class="w">listener</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">nes_</span><span class="pc">cm_n</span><span class="c">ode</span> <span class="c">*</span><span class="w">cm_node</span><span class="pc">;</span>
	<span class="c">struct</span> <span class="w">timespec</span> <span class="w">ts</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">oldarpindex</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="c">int</span> <span class="w">arpindex</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">nes_device</span> <span class="c">*</span><span class="w">nesd</span><span class="c">ev</span><span class="pc">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">nes_adapter</span> <span class="c">*</span><span class="w">nesadapter</span><span class="c">;</span>

	
	<span class="w">c</span><span class="pc">m</span><span class="c">_node</span> <span class="pc">=</span> <span class="pc">k</span><span class="c">zalloc(sizeof(*</span><span class="pc">c</span><span class="c">m_node),</span> <span class="pc">GFP_A</span><span class="c">TOMIC);</span>
	<span class="c">if</span> <span class="c">(!</span><span class="w">c</span><span class="c">m_node</span><span class="pc">)</span>
		<span class="c">return</span> <span class="pc">N</span><span class="c">ULL;</span>

	
	<span class="c">if</span> <span class="pc">(</span><span class="w">listener</span><span class="pc">)</span><span class="c"> {</span>
		<span class="pc">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">loc_addr</span> <span class="c">=</span> <span class="pc">l</span><span class="c">istener</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">l</span><span class="c">oc_addr;</span>
		<span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">loc_port</span> <span class="c">=</span> <span class="pc">li</span><span class="c">stener</span><span class="pc">-</span><span class="c">&gt;loc_port;</span>
	<span class="pc">}</span> <span class="c">else</span> <span class="pc">{</span>
		<span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">l</span><span class="pc">o</span><span class="c">c_addr</span> <span class="c">=</span> <span class="w">cm_info</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">loc_a</span><span class="c">ddr;</span>
		<span class="pc">c</span><span class="c">m_node-&gt;loc_port</span> <span class="c">=</span> <span class="w">c</span><span class="pc">m_i</span><span class="c">nfo</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">loc_p</span><span class="c">ort;</span>
	<span class="c">}</span>
	<span class="c">cm_node-&gt;</span><span class="w">rem_addr</span> <span class="c">=</span> <span class="w">c</span><span class="pc">m_i</span><span class="c">nfo</span><span class="pc">-</span><span class="c">&gt;rem_addr;</span>
	<span class="w">c</span><span class="c">m_node-&gt;</span><span class="w">rem_port</span> <span class="c">=</span> <span class="w">c</span><span class="pc">m_i</span><span class="c">nfo-&gt;rem_port;</span>

	<span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">mapped_loc_addr</span> <span class="c">=</span> <span class="pc">cm_i</span><span class="c">nfo-&gt;mapped_loc_addr;</span>
	<span class="pc">cm_n</span><span class="c">ode-&gt;</span><span class="w">mapped_rem_addr</span> <span class="c">=</span> <span class="pc">cm_i</span><span class="c">nfo-&gt;mapped_rem_addr;</span>
	<span class="c">cm_node-&gt;</span><span class="w">mapped_loc_port</span> <span class="c">=</span> <span class="c">cm_info-&gt;mapped_loc_port;</span>
	<span class="c">cm_node-&gt;</span><span class="w">mapped_rem_port</span> <span class="c">=</span> <span class="c">cm_info-&gt;mapped_rem_port;</span>

	<span class="c">cm_node-&gt;</span><span class="w">mpa_frame_rev</span> <span class="c">=</span> <span class="w">mpa_version</span><span class="c">;</span>
	<span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">send_rdma0_op</span> <span class="c">=</span> <span class="w">SEND_RDMA_READ_ZERO</span><span class="c">;</span>
	<span class="pc">cm_n</span><span class="c">ode-&gt;</span><span class="w">mpav2_ird_ord</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">ird_size</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="c">cm_node-&gt;</span><span class="w">ord_size</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>

	<span class="w">nes_debug</span><span class="pc">(</span><span class="w">NES_DBG_CM,</span><span class="pc"> "</span><span class="w">Make</span> <span class="w">no</span><span class="pc">d</span><span class="c">e</span> <span class="w">addresses</span> <span class="w">:</span> <span class="w">loc</span> <span class="w">= </span><span class="pc">%</span><span class="w">pI4:</span><span class="pc">%</span><span class="w">x</span><span class="pc">,</span> <span class="w">rem</span> <span class="w">=</span><span class="pc"> </span><span class="c">%</span><span class="w">p</span><span class="pc">I</span><span class="c">4</span><span class="w">:</span><span class="pc">%x</span><span class="c">\n",</span>
		  <span class="w">&amp;</span><span class="c">cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">loc_addr</span><span class="c">,</span> <span class="c">cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">loc_port</span><span class="c">,</span>
		  <span class="pc">&amp;</span><span class="c">cm_node-&gt;</span><span class="w">rem_addr</span><span class="c">,</span> <span class="w">c</span><span class="pc">m</span><span class="c">_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">rem_port</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">c</span><span class="c">m_node-&gt;</span><span class="w">listener</span> <span class="c">=</span> <span class="w">l</span><span class="pc">i</span><span class="c">stener;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">l</span><span class="c">istener</span><span class="w">)</span>
		<span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">tos</span> <span class="c">=</span> <span class="w">l</span><span class="pc">i</span><span class="c">stener-&gt;tos;</span>
	<span class="w">c</span><span class="c">m_node-&gt;</span><span class="w">n</span><span class="pc">et</span><span class="c">dev</span> <span class="c">=</span> <span class="w">nesvnic</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">n</span><span class="pc">e</span><span class="c">tdev</span><span class="pc">;</span>
	<span class="c">cm_node-&gt;</span><span class="w">cm_id</span> <span class="c">=</span> <span class="w">cm_info</span><span class="pc">-</span><span class="c">&gt;cm_id;</span>
	<span class="w">m</span><span class="c">emcpy(cm_node-&gt;</span><span class="w">loc_mac</span><span class="c">,</span> <span class="w">n</span><span class="c">esvnic-&gt;</span><span class="w">n</span><span class="pc">et</span><span class="c">dev-&gt;</span><span class="w">de</span><span class="pc">v_</span><span class="c">addr</span><span class="pc">,</span> <span class="w">E</span><span class="c">TH_ALEN);</span>

	<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM,</span><span class="pc"> "l</span><span class="c">istener</span><span class="w">=</span><span class="c">%</span><span class="pc">p,</span> <span class="pc">cm_i</span><span class="c">d</span><span class="pc">=</span><span class="c">%</span><span class="pc">p\</span><span class="c">n",</span> <span class="pc">cm_n</span><span class="c">ode-&gt;</span><span class="w">l</span><span class="c">istener,</span>
		  <span class="c">cm_node-&gt;</span><span class="pc">c</span><span class="c">m_id</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">spin_l</span><span class="pc">ock_in</span><span class="c">it(&amp;cm_node-&gt;</span><span class="w">retrans_list_lock</span><span class="c">);</span>

	<span class="c">cm_node-&gt;</span><span class="w">loopbackpartner</span> <span class="c">=</span> <span class="c">NULL;</span>
	<span class="w">a</span><span class="c">tomic_set(&amp;cm_node-&gt;</span><span class="w">ref_count</span><span class="c">,</span> <span class="w">1</span><span class="c">);</span>
	
	<span class="c">cm_node-&gt;</span><span class="w">cm_core</span> <span class="c">=</span> <span class="w">c</span><span class="pc">m_c</span><span class="c">ore;</span>
	<span class="c">cm_node-&gt;</span><span class="w">tcp_cntxt</span><span class="pc">.</span><span class="w">loc_id</span> <span class="c">=</span> <span class="w">NES_CM_DEF_LOCAL_ID</span><span class="c">;</span>
	<span class="c">cm_node-&gt;tcp_cntxt.</span><span class="w">rcv_wscale</span> <span class="c">=</span> <span class="w">NES_CM_DEFAULT_RCV_WND_SCALE</span><span class="c">;</span>
	<span class="c">cm_node-&gt;tcp_cntxt.</span><span class="w">rcv_wnd</span> <span class="c">=</span> <span class="w">NES_CM_DEFAULT_RCV_WND_SCALED</span> <span class="w">&gt;</span><span class="c">&gt;</span>
				     <span class="w">N</span><span class="c">ES_CM_DEFAULT_RCV_WND_SCALE</span><span class="pc">;</span>
	<span class="w">ts</span> <span class="pc">=</span> <span class="w">current_kernel_time(</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">c</span><span class="c">m_node-&gt;</span><span class="pc">t</span><span class="c">cp_cntxt</span><span class="pc">.</span><span class="w">loc_seq_num</span> <span class="c">=</span> <span class="w">ht</span><span class="pc">onl</span><span class="c">(</span><span class="w">ts</span><span class="pc">.</span><span class="w">tv_nsec</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;tcp_cntxt.</span><span class="w">mss</span> <span class="c">=</span> <span class="w">nesvnic-</span><span class="c">&gt;</span><span class="w">max_frame_size</span> <span class="w">-</span> <span class="w">s</span><span class="c">izeof</span><span class="pc">(</span><span class="c">struct</span> <span class="w">iphdr) </span><span class="pc">-</span>
				 <span class="c">sizeof(struct</span> <span class="w">tcphdr) </span><span class="c">-</span> <span class="w">ETH_HLEN</span> <span class="w">-</span> <span class="w">VLAN_HLEN</span><span class="c">;</span>
	<span class="pc">c</span><span class="c">m_node-&gt;tcp_cntxt.</span><span class="w">rcv_nxt</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	
	<span class="w">a</span><span class="pc">t</span><span class="c">omic_inc(&amp;</span><span class="w">cm_core</span><span class="c">-&gt;</span><span class="w">node_cnt</span><span class="c">);</span>
	<span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">conn_type</span> <span class="c">=</span> <span class="w">cm_info</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">c</span><span class="c">onn_type;</span>
	<span class="w">c</span><span class="pc">m_n</span><span class="c">ode-&gt;</span><span class="w">apbvt_set</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">accept_pend</span> <span class="c">=</span> <span class="c">0;</span>

	<span class="pc">cm_n</span><span class="c">ode-&gt;</span><span class="w">nesvnic</span> <span class="c">=</span> <span class="w">n</span><span class="c">esvnic;</span>
	
	<span class="w">nes</span><span class="pc">d</span><span class="c">ev</span> <span class="pc">=</span> <span class="w">n</span><span class="pc">e</span><span class="c">svnic-&gt;</span><span class="w">nes</span><span class="pc">d</span><span class="c">ev;</span>
	<span class="w">nesadapter</span> <span class="c">=</span> <span class="w">nes</span><span class="pc">d</span><span class="c">ev-&gt;nesadapter;</span>

	<span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">loopbackpartner</span> <span class="c">=</span> <span class="w">N</span><span class="c">ULL;</span>

	
	<span class="w">oldarpindex</span> <span class="c">=</span> <span class="w">nes_arp_table</span><span class="pc">(</span><span class="w">nes</span><span class="pc">d</span><span class="c">ev,</span> <span class="c">cm_node-&gt;</span><span class="w">mapped_rem_addr</span><span class="c">,</span>
				<span class="w">N</span><span class="c">ULL</span><span class="pc">,</span> <span class="w">NES_ARP_RESOLVE</span><span class="c">);</span>
	<span class="w">arpindex</span> <span class="pc">=</span> <span class="w">nes_addr_resolve_neigh</span><span class="c">(</span><span class="pc">n</span><span class="c">esvnic,</span>
				<span class="c">cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">m</span><span class="c">apped_rem_addr,</span> <span class="c">oldarpindex</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(arpindex</span> <span class="pc">&lt;</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">k</span><span class="c">free(</span><span class="pc">c</span><span class="c">m_node);</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">N</span><span class="c">ULL;</span>
	<span class="c">}</span>

	
	<span class="w">m</span><span class="pc">e</span><span class="c">mcpy(</span><span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">rem_mac</span><span class="c">,</span> <span class="w">nesadapter</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">arp_table[a</span><span class="c">rpindex</span><span class="pc">].</span><span class="w">mac</span><span class="pc">_</span><span class="c">addr,</span> <span class="w">E</span><span class="c">TH_ALEN);</span>
	<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM,</span><span class="pc"> "</span><span class="w">Remote</span> <span class="w">ma</span><span class="pc">c</span> <span class="w">ad</span><span class="pc">dr</span> <span class="w">f</span><span class="pc">r</span><span class="c">om</span> <span class="w">arp</span> <span class="w">ta</span><span class="c">ble</span><span class="w">:</span><span class="c"> %</span><span class="w">p</span><span class="pc">M\</span><span class="c">n",</span>
		  <span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">r</span><span class="c">em_mac);</span>

	<span class="w">add_hte_node</span><span class="c">(</span><span class="w">cm_core</span><span class="c">,</span> <span class="pc">c</span><span class="c">m_node</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">at</span><span class="pc">omic_i</span><span class="c">nc(&amp;</span><span class="w">cm_nodes_created</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">ret</span><span class="c">urn</span> <span class="w">c</span><span class="pc">m_n</span><span class="c">ode;</span>
<span class="c">}</span>



<span class="c">static</span> <span class="c">int</span> <span class="w">add_ref_cm_node</span><span class="c">(struct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="pc">cm_n</span><span class="c">ode)</span>
<span class="c">{</span>
	<span class="w">at</span><span class="pc">omic_i</span><span class="c">nc(&amp;cm_node-&gt;</span><span class="w">ref_count</span><span class="c">);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>



<span class="c">static</span> <span class="c">int</span> <span class="w">rem_ref_cm_node</span><span class="c">(struct</span> <span class="w">nes_cm_core</span> <span class="c">*</span><span class="pc">c</span><span class="c">m_core</span><span class="pc">,</span>
			   <span class="c">struct</span> <span class="pc">n</span><span class="c">es_cm_node</span> <span class="c">*</span><span class="w">c</span><span class="pc">m_node</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="c">long</span> <span class="c">flags;</span>
	<span class="pc">st</span><span class="c">ruct</span> <span class="w">nes_qp</span> <span class="c">*</span><span class="w">nesqp</span><span class="c">;</span>

	<span class="w">i</span><span class="pc">f</span> <span class="pc">(!c</span><span class="c">m_node)</span>
		<span class="c">return</span> <span class="c">-EINVAL;</span>

	<span class="w">s</span><span class="pc">p</span><span class="c">in_lock_irqsave(&amp;cm_node-&gt;</span><span class="w">c</span><span class="c">m_core</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ht_lock</span><span class="c">,</span> <span class="pc">f</span><span class="c">lags);</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">atomic_dec_return</span><span class="pc">(&amp;cm_n</span><span class="c">ode-&gt;</span><span class="w">ref_count)</span><span class="pc">) </span><span class="c">{</span>
		<span class="pc">s</span><span class="c">pin_unlock_irqrestore(&amp;</span><span class="pc">c</span><span class="c">m_node-&gt;</span><span class="pc">c</span><span class="c">m_core</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">h</span><span class="c">t_lock</span><span class="pc">,</span> <span class="c">flags);</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
	<span class="c">}</span>
	<span class="w">li</span><span class="pc">st_d</span><span class="c">el(&amp;cm_node-&gt;</span><span class="pc">li</span><span class="c">st);</span>
	<span class="w">atomic_dec</span><span class="pc">(&amp;cm_c</span><span class="c">ore-&gt;</span><span class="w">ht_node_cnt</span><span class="c">);</span>
	<span class="w">s</span><span class="pc">pin_u</span><span class="c">nlock_irqrestore(&amp;cm_node-&gt;</span><span class="pc">c</span><span class="c">m_core</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">h</span><span class="c">t_lock</span><span class="pc">,</span> <span class="pc">f</span><span class="c">lags);</span>

	
	<span class="w">i</span><span class="c">f</span> <span class="pc">(!</span><span class="c">cm_node-&gt;</span><span class="w">accelerated</span> <span class="w">&amp;</span><span class="c">&amp;</span> <span class="pc">cm_n</span><span class="c">ode-&gt;</span><span class="w">accept_pend</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">B</span><span class="pc">UG_</span><span class="c">ON</span><span class="pc">(!</span><span class="c">cm_node-&gt;</span><span class="w">listener</span><span class="c">);</span>
		<span class="w">a</span><span class="c">tomic_dec</span><span class="w">(</span><span class="pc">&amp;cm_n</span><span class="c">ode-&gt;</span><span class="w">l</span><span class="pc">i</span><span class="c">stener</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">pend_accepts_cnt</span><span class="c">);</span>
		<span class="w">B</span><span class="c">UG_ON(</span><span class="w">a</span><span class="pc">tomic_r</span><span class="c">ead(&amp;cm_node-&gt;listener</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">p</span><span class="c">end_accepts_cnt</span><span class="w">) &lt;</span> <span class="c">0</span><span class="w">)</span><span class="pc">;</span>
	<span class="c">}</span>
	<span class="w">W</span><span class="c">ARN_ON(cm_node-&gt;</span><span class="w">send_entry)</span><span class="pc">;</span>
	<span class="c">if</span> <span class="c">(cm_node-&gt;</span><span class="w">recv_entry</span><span class="pc">)</span>
		<span class="w">handle_recv_entry</span><span class="c">(cm_node</span><span class="pc">,</span> <span class="pc">0)</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(cm_node-&gt;</span><span class="pc">l</span><span class="c">istener</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">mini_cm_dec_refcnt_listen</span><span class="c">(</span><span class="w">cm_core</span><span class="c">,</span> <span class="c">cm_node-&gt;listener</span><span class="pc">,</span> <span class="w">0</span><span class="c">);</span>
	<span class="c">}</span> <span class="c">else</span> <span class="c">{</span>
		<span class="c">if</span> <span class="c">(cm_node-&gt;</span><span class="w">apbvt_set</span> <span class="w">&amp;</span><span class="pc">&amp;</span> <span class="c">cm_node-&gt;</span><span class="w">nesvnic</span><span class="c">) {</span>
			<span class="w">nes_manage_apbvt</span><span class="c">(cm_node-&gt;</span><span class="pc">n</span><span class="c">esvnic</span><span class="pc">,</span> <span class="c">cm_node-&gt;</span><span class="w">mapped_loc_port</span><span class="pc">,</span>
					 <span class="w">PCI_FUNC</span><span class="pc">(</span><span class="c">cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">n</span><span class="c">esvnic</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">nes</span><span class="pc">d</span><span class="c">ev</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">pc</span><span class="pc">id</span><span class="c">ev-&gt;</span><span class="w">dev</span><span class="pc">f</span><span class="c">n</span><span class="w">)</span><span class="pc">,</span>
					 <span class="w">NES_MANAGE_APBVT_DEL</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">}</span>
		<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_NLMSG,</span><span class="pc"> "</span><span class="w">Delete</span> <span class="w">APBVT</span> <span class="w">m</span><span class="c">apped_loc_port</span> <span class="w">=</span><span class="pc"> </span><span class="c">%</span><span class="w">04X</span><span class="c">\n",</span>
					<span class="c">cm_node-&gt;</span><span class="w">m</span><span class="c">apped_loc_port</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">nes_remove_mapinfo</span><span class="c">(cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">loc_addr</span><span class="c">,</span> <span class="c">cm_node-&gt;</span><span class="w">loc_port</span><span class="pc">,</span>
			<span class="c">cm_node-&gt;</span><span class="w">mapped_loc_addr</span><span class="c">,</span> <span class="c">cm_node-&gt;</span><span class="w">m</span><span class="pc">apped_loc_p</span><span class="c">ort</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">atomic_dec</span><span class="pc">(&amp;</span><span class="w">cm_core</span><span class="c">-&gt;</span><span class="w">node_cnt</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">a</span><span class="pc">tomic_i</span><span class="c">nc(&amp;</span><span class="w">cm_nodes_destroyed</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">nesqp</span> <span class="pc">=</span> <span class="c">cm_node-&gt;nesqp;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">n</span><span class="c">esqp</span><span class="pc">) </span><span class="c">{</span>
		<span class="pc">n</span><span class="c">esqp-&gt;</span><span class="pc">c</span><span class="c">m_node</span> <span class="pc">=</span> <span class="w">N</span><span class="c">ULL;</span>
		<span class="w">nes_rem_ref</span><span class="pc">(&amp;n</span><span class="c">esqp-&gt;</span><span class="w">ibqp</span><span class="c">);</span>
		<span class="pc">c</span><span class="c">m_node-&gt;nesqp</span> <span class="c">=</span> <span class="c">NULL;</span>
	<span class="c">}</span>

	<span class="w">k</span><span class="c">free(cm_node);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">int</span> <span class="w">process_options</span><span class="c">(struct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="w">c</span><span class="c">m_node</span><span class="pc">,</span> <span class="w">u</span><span class="pc">8</span> <span class="c">*</span><span class="w">optionsloc</span><span class="pc">,</span>
			   <span class="pc">u3</span><span class="c">2</span> <span class="w">optionsize</span><span class="c">,</span> <span class="c">u32</span> <span class="w">syn_packet</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">u</span><span class="c">32</span> <span class="w">t</span><span class="c">mp</span><span class="pc">;</span>
	<span class="c">u32</span> <span class="w">o</span><span class="c">ffset</span> <span class="pc">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="w">un</span><span class="pc">i</span><span class="c">on</span> <span class="w">all_known_options</span> <span class="c">*</span><span class="w">all_options</span><span class="c">;</span>
	<span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="w">got_mss_option</span> <span class="pc">=</span> <span class="c">0;</span>

	<span class="w">w</span><span class="c">hile</span> <span class="c">(</span><span class="w">o</span><span class="pc">f</span><span class="c">fset</span> <span class="w">&lt;</span> <span class="w">o</span><span class="pc">ptionsi</span><span class="c">ze</span><span class="pc">) </span><span class="c">{</span>
		<span class="pc">a</span><span class="c">ll_options</span> <span class="pc">= </span><span class="c">(</span><span class="w">un</span><span class="pc">i</span><span class="c">on</span> <span class="w">a</span><span class="pc">ll_k</span><span class="c">nown_options</span> <span class="w">*</span><span class="pc">)(</span><span class="c">optionsloc</span> <span class="pc">+</span> <span class="w">o</span><span class="pc">f</span><span class="c">fset</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">sw</span><span class="c">itch</span> <span class="c">(all_options</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">as_base.optionnum</span><span class="pc">)</span><span class="c"> {</span>
		<span class="c">case</span> <span class="w">OPTION_NUMBER_END</span><span class="c">:</span>
			<span class="w">o</span><span class="pc">f</span><span class="c">fset</span> <span class="c">=</span> <span class="w">o</span><span class="pc">ptionsi</span><span class="c">ze;</span>
			<span class="c">break;</span>
		<span class="c">case</span> <span class="w">OPTION_NUMBER_NONE</span><span class="c">:</span>
			<span class="w">o</span><span class="pc">f</span><span class="c">fset</span> <span class="w">+</span><span class="pc">=</span> <span class="pc">1</span><span class="c">;</span>
			<span class="w">con</span><span class="pc">ti</span><span class="c">nue;</span>
		<span class="pc">c</span><span class="c">ase</span> <span class="w">OPTION_NUMBER_MSS</span><span class="c">:</span>
			<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM, </span><span class="pc">"%</span><span class="c">s:</span> <span class="w">MSS</span> <span class="w">Length:</span><span class="pc"> </span><span class="c">%</span><span class="pc">d</span> <span class="w">Offset:</span><span class="pc"> </span><span class="c">%d</span> <span class="w">"</span>
				  <span class="pc">"</span><span class="w">Size:</span><span class="pc"> </span><span class="c">%d\n",</span> <span class="c">__func__,</span>
				  <span class="w">all_options</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">as_mss.l</span><span class="pc">eng</span><span class="c">th</span><span class="pc">,</span> <span class="w">o</span><span class="c">ffset,</span> <span class="w">optionsize</span><span class="c">);</span>
			<span class="w">got_mss_option</span> <span class="pc">=</span> <span class="w">1</span><span class="c">;</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">a</span><span class="pc">l</span><span class="c">l_options-&gt;as_mss.</span><span class="w">l</span><span class="pc">eng</span><span class="c">th</span> <span class="w">!</span><span class="c">=</span> <span class="w">4</span><span class="c">) {</span>
				<span class="w">r</span><span class="pc">etu</span><span class="c">rn</span> <span class="pc">1</span><span class="c">;</span>
			<span class="c">}</span> <span class="w">e</span><span class="c">lse</span> <span class="c">{</span>
				<span class="w">t</span><span class="c">mp</span> <span class="c">=</span> <span class="w">nt</span><span class="c">ohs(</span><span class="pc">al</span><span class="c">l_options-&gt;as_mss.</span><span class="w">mss</span><span class="pc">)</span><span class="c">;</span>
				<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">t</span><span class="c">mp</span> <span class="w">&gt;</span> <span class="c">0</span> <span class="pc">&amp;</span><span class="c">&amp;</span> <span class="w">t</span><span class="c">mp</span> <span class="pc">&lt;</span>
				    <span class="w">cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">tcp_cntxt</span><span class="c">.</span><span class="pc">m</span><span class="c">ss</span><span class="w">)</span>
					<span class="w">c</span><span class="pc">m</span><span class="c">_node-&gt;tcp_cntxt.</span><span class="w">m</span><span class="c">ss</span> <span class="pc">=</span> <span class="w">t</span><span class="pc">m</span><span class="c">p;</span>
			<span class="pc">}</span>
			<span class="w">b</span><span class="c">reak;</span>
		<span class="pc">c</span><span class="c">ase</span> <span class="w">OPTION_NUMBER_WINDOW_SCALE</span><span class="c">:</span>
			<span class="pc">c</span><span class="c">m_node-&gt;tcp_cntxt.</span><span class="w">snd_wscale</span> <span class="c">=</span>
				<span class="pc">a</span><span class="c">ll_options</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">as_windowscale</span><span class="pc">.</span><span class="w">shiftcount</span><span class="c">;</span>
			<span class="w">b</span><span class="c">reak;</span>
		<span class="pc">d</span><span class="c">efault:</span>
			<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM,</span><span class="pc"> "</span><span class="w">TCP</span> <span class="w">Option</span> <span class="w">n</span><span class="pc">o</span><span class="c">t</span> <span class="w">understood:</span><span class="pc"> </span><span class="c">%</span><span class="pc">x</span><span class="c">\n",</span>
				  <span class="pc">a</span><span class="c">ll_options-&gt;</span><span class="w">as_base</span><span class="pc">.</span><span class="w">optionnum</span><span class="c">);</span>
			<span class="pc">b</span><span class="c">reak;</span>
		<span class="c">}</span>
		<span class="w">of</span><span class="pc">fs</span><span class="c">et</span> <span class="pc">+</span><span class="c">=</span> <span class="pc">al</span><span class="c">l_options-&gt;as_base.</span><span class="w">l</span><span class="pc">eng</span><span class="c">th;</span>
	<span class="c">}</span>
	<span class="w">i</span><span class="pc">f</span> <span class="w">((!got_mss_option) &amp;</span><span class="pc">&amp;</span><span class="c"> (</span><span class="w">syn_packet))</span>
		<span class="w">cm_node-</span><span class="c">&gt;</span><span class="w">tcp_cntxt</span><span class="c">.</span><span class="w">mss</span> <span class="c">=</span> <span class="w">NES_CM_DEFAULT_MSS</span><span class="c">;</span>
	<span class="w">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">drop_packet</span><span class="c">(struct</span> <span class="w">s</span><span class="pc">k</span><span class="c">_buff</span> <span class="c">*skb</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">a</span><span class="pc">t</span><span class="c">omic_inc(&amp;</span><span class="w">cm_accel_dropped_pkts</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">dev_kfree_skb_any</span><span class="c">(</span><span class="pc">sk</span><span class="c">b</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">handle_fin_pkt</span><span class="c">(struct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="pc">c</span><span class="c">m_node)</span>
<span class="c">{</span>
	<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM,</span><span class="pc"> "</span><span class="w">Received</span> <span class="w">FIN,</span> <span class="pc">c</span><span class="c">m_node</span> <span class="w">= %</span><span class="pc">p</span><span class="c">,</span> <span class="w">st</span><span class="pc">ate</span> <span class="w">=</span><span class="pc"> </span><span class="c">%</span><span class="pc">u</span><span class="w">. "</span>
		  <span class="w">"refcnt=</span><span class="c">%d\n",</span> <span class="c">cm_node,</span> <span class="c">cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s</span><span class="c">tate,</span>
		  <span class="w">a</span><span class="pc">t</span><span class="c">omic_read(&amp;</span><span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">ref_count</span><span class="pc">))</span><span class="c">;</span>
	<span class="w">s</span><span class="pc">w</span><span class="c">itch</span> <span class="c">(cm_node-&gt;</span><span class="w">s</span><span class="c">tate) {</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_SYN_RCVD</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_SYN_SENT</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_ESTABLISHED</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_MPAREJ_RCVD</span><span class="c">:</span>
		<span class="w">c</span><span class="pc">m</span><span class="c">_node-&gt;</span><span class="w">tcp_cntxt</span><span class="pc">.</span><span class="w">rcv_nxt+</span><span class="pc">+</span><span class="c">;</span>
		<span class="w">cleanup_retrans_entry</span><span class="c">(cm_node</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">c</span><span class="c">m_node-&gt;</span><span class="w">s</span><span class="pc">tate</span> <span class="c">=</span> <span class="w">NES_CM_STATE_LAST_ACK</span><span class="c">;</span>
		<span class="w">send_fin</span><span class="c">(cm_node</span><span class="pc">,</span> <span class="w">NU</span><span class="c">LL);</span>
		<span class="c">break;</span>
	<span class="pc">c</span><span class="c">ase</span> <span class="w">NES_CM_STATE_MPAREQ_SENT</span><span class="c">:</span>
		<span class="w">create_event</span><span class="c">(cm_node</span><span class="pc">,</span> <span class="w">NES_CM_EVENT_ABORTED</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">c</span><span class="c">m_node-&gt;</span><span class="pc">t</span><span class="c">cp_cntxt.</span><span class="pc">r</span><span class="c">cv_nxt</span><span class="w">+</span><span class="c">+;</span>
		<span class="w">c</span><span class="pc">l</span><span class="c">eanup_retrans_entry</span><span class="pc">(</span><span class="c">cm_node</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s</span><span class="pc">t</span><span class="c">ate</span> <span class="c">=</span> <span class="w">NES_CM_STATE_CLOSED</span><span class="c">;</span>
		<span class="w">add_ref_cm_node</span><span class="c">(cm_node);</span>
		<span class="w">send_reset</span><span class="c">(cm_node</span><span class="pc">,</span> <span class="w">N</span><span class="pc">U</span><span class="c">LL);</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_FIN_WAIT1</span><span class="c">:</span>
		<span class="c">cm_node</span><span class="pc">-</span><span class="c">&gt;tcp_cntxt.</span><span class="pc">r</span><span class="c">cv_nxt</span><span class="w">+</span><span class="c">+;</span>
		<span class="w">c</span><span class="pc">l</span><span class="c">eanup_retrans_entry</span><span class="pc">(</span><span class="c">cm_node);</span>
		<span class="w">c</span><span class="pc">m</span><span class="c">_node-&gt;</span><span class="w">s</span><span class="pc">t</span><span class="c">ate</span> <span class="pc">=</span> <span class="w">NES_CM_STATE_CLOSING</span><span class="c">;</span>
		<span class="w">send_ack</span><span class="c">(cm_node,</span> <span class="w">N</span><span class="pc">U</span><span class="c">LL);</span>
		
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_FIN_WAIT2</span><span class="c">:</span>
		<span class="c">cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">t</span><span class="c">cp_cntxt.rcv_nxt</span><span class="w">+</span><span class="c">+;</span>
		<span class="pc">cl</span><span class="c">eanup_retrans_entry</span><span class="pc">(</span><span class="c">cm_node</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">s</span><span class="pc">t</span><span class="c">ate</span> <span class="c">=</span> <span class="w">NES_CM_STATE_TIME_WAIT</span><span class="c">;</span>
		<span class="pc">s</span><span class="c">end_ack</span><span class="pc">(</span><span class="c">cm_node,</span> <span class="pc">NU</span><span class="c">LL);</span>
		<span class="w">schedule_nes_timer</span><span class="c">(cm_node</span><span class="pc">,</span> <span class="pc">NU</span><span class="c">LL</span><span class="pc">,</span>  <span class="w">NES_TIMER_TYPE_CLOSE</span><span class="pc">,</span> <span class="w">1</span><span class="pc">,</span> <span class="c">0);</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="pc">c</span><span class="c">ase</span> <span class="w">N</span><span class="c">ES_CM_STATE_TIME_WAIT:</span>
		<span class="c">cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">t</span><span class="c">cp_cntxt.</span><span class="w">r</span><span class="c">cv_nxt</span><span class="w">+</span><span class="pc">+</span><span class="c">;</span>
		<span class="w">c</span><span class="pc">l</span><span class="c">eanup_retrans_entry</span><span class="pc">(</span><span class="c">cm_node</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">c</span><span class="c">m_node-&gt;</span><span class="pc">s</span><span class="c">tate</span> <span class="c">=</span> <span class="w">NES_CM_STATE_CLOSED</span><span class="c">;</span>
		<span class="w">rem_ref_cm_node</span><span class="c">(cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">cm_core</span><span class="pc">,</span> <span class="pc">c</span><span class="c">m_node</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_TSA</span><span class="c">:</span>
	<span class="w">d</span><span class="pc">e</span><span class="c">fault:</span>
		<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">E</span><span class="c">rror</span> <span class="w">Rcvd</span> <span class="w">FIN</span> <span class="w">f</span><span class="c">or</span> <span class="w">no</span><span class="pc">d</span><span class="c">e</span><span class="w">-</span><span class="pc">%</span><span class="w">p</span> <span class="w">sta</span><span class="pc">te</span> <span class="w">=</span><span class="pc"> %</span><span class="c">d\n",</span>
			<span class="c">cm_node</span><span class="pc">,</span> <span class="c">cm_node-&gt;state</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">b</span><span class="c">reak;</span>
	<span class="pc">}</span>
<span class="c">}</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">handle_rst_pkt</span><span class="c">(struct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="w">c</span><span class="pc">m</span><span class="c">_node,</span> <span class="c">struct</span> <span class="pc">s</span><span class="c">k_buff</span> <span class="c">*skb,</span>
	<span class="c">struct</span> <span class="w">tcphdr</span> <span class="c">*</span><span class="w">tcph</span><span class="c">)</span>
<span class="c">{</span>

	<span class="pc">i</span><span class="c">nt</span>	<span class="w">rese</span><span class="pc">t</span> <span class="pc">=</span> <span class="c">0;</span>	
	<span class="w">a</span><span class="pc">t</span><span class="c">omic_inc(&amp;</span><span class="w">cm_resets_recvd</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, "</span><span class="w">Received</span> <span class="w">Reset</span><span class="pc">,</span> <span class="w">c</span><span class="c">m_node</span> <span class="w">= </span><span class="pc">%p</span><span class="c">,</span> <span class="w">st</span><span class="pc">ate</span> <span class="pc">= </span><span class="c">%</span><span class="pc">u</span><span class="w">."</span>
			<span class="w">"</span> <span class="w">refcnt</span><span class="pc">=</span><span class="c">%d\n",</span> <span class="w">c</span><span class="pc">m_n</span><span class="c">ode,</span> <span class="w">c</span><span class="pc">m_n</span><span class="c">ode</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s</span><span class="c">tate,</span>
			<span class="w">a</span><span class="pc">t</span><span class="c">omic_read(&amp;</span><span class="pc">cm_n</span><span class="c">ode-&gt;</span><span class="w">ref_count</span><span class="pc">))</span><span class="c">;</span>
	<span class="w">cleanup_retrans_entry</span><span class="c">(cm_node</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">sw</span><span class="c">itch</span> <span class="c">(</span><span class="w">c</span><span class="pc">m</span><span class="c">_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s</span><span class="c">tate) {</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_SYN_SENT</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_MPAREQ_SENT</span><span class="c">:</span>
		<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM,</span><span class="pc"> "%</span><span class="c">s</span><span class="w">[</span><span class="c">%</span><span class="pc">u</span><span class="w">]</span> <span class="w">cr</span><span class="c">eate</span> <span class="w">abort</span> <span class="w">f</span><span class="pc">o</span><span class="c">r</span> <span class="pc">c</span><span class="c">m_node</span><span class="w">=</span><span class="c">%</span><span class="w">p</span> <span class="w">"</span>
			<span class="w">"listener=</span><span class="c">%</span><span class="pc">p</span> <span class="w">sta</span><span class="pc">te=</span><span class="c">%d</span><span class="pc">\</span><span class="c">n",</span> <span class="c">__func__,</span> <span class="w">_</span><span class="pc">_L</span><span class="c">INE__</span><span class="pc">,</span> <span class="c">cm_node</span><span class="pc">,</span>
			<span class="w">c</span><span class="pc">m_</span><span class="c">node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">l</span><span class="pc">i</span><span class="c">stener,</span> <span class="w">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s</span><span class="pc">t</span><span class="c">ate</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">s</span><span class="c">witch</span> <span class="c">(</span><span class="pc">cm</span><span class="c">_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">mpa_frame_rev</span><span class="c">) {</span>
		<span class="c">case</span> <span class="w">IETF_MPA_V2</span><span class="c">:</span>
			<span class="w">c</span><span class="pc">m</span><span class="c">_node-&gt;</span><span class="pc">m</span><span class="c">pa_frame_rev</span> <span class="c">=</span> <span class="w">IETF_MPA_V1</span><span class="c">;</span>
			
			<span class="pc">c</span><span class="c">m_node-&gt;</span><span class="pc">s</span><span class="c">tate</span> <span class="c">=</span> <span class="w">NES_CM_STATE_SYN_SENT</span><span class="c">;</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">send_syn</span><span class="c">(cm_node,</span> <span class="pc">0</span><span class="c">,</span> <span class="w">N</span><span class="pc">U</span><span class="c">LL</span><span class="pc">))</span><span class="c"> {</span>
				<span class="w">active_open_err</span><span class="c">(cm_node,</span> <span class="w">s</span><span class="pc">k</span><span class="c">b,</span> <span class="w">res</span><span class="pc">et</span><span class="c">);</span>
			<span class="c">}</span>
			<span class="pc">b</span><span class="c">reak;</span>
		<span class="c">case</span> <span class="w">I</span><span class="c">ETF_MPA_V1:</span>
		<span class="w">d</span><span class="pc">ef</span><span class="c">ault:</span>
			<span class="w">a</span><span class="c">ctive_open_err(cm_node</span><span class="pc">,</span> <span class="w">s</span><span class="pc">k</span><span class="c">b,</span> <span class="w">rese</span><span class="pc">t</span><span class="c">);</span>
			<span class="pc">b</span><span class="c">reak;</span>
		<span class="pc">}</span>
		<span class="w">b</span><span class="c">reak;</span>
	<span class="pc">c</span><span class="c">ase</span> <span class="w">NES_CM_STATE_MPAREQ_RCVD</span><span class="c">:</span>
		<span class="w">at</span><span class="pc">omic_i</span><span class="c">nc(&amp;cm_node-&gt;</span><span class="w">passive_state</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">dev_kfree_skb_any</span><span class="c">(</span><span class="w">s</span><span class="pc">kb)</span><span class="c">;</span>
		<span class="c">break;</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_ESTABLISHED</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_SYN_RCVD</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_LISTENING</span><span class="c">:</span>
		<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM,</span><span class="pc"> "</span><span class="w">Bad</span> <span class="w">s</span><span class="pc">t</span><span class="c">ate</span> <span class="c">%</span><span class="pc">s</span><span class="w">[</span><span class="pc">%u</span><span class="w">]</span><span class="c">\n",</span> <span class="w">_</span><span class="c">_func__</span><span class="pc">,</span> <span class="w">_</span><span class="c">_LINE__);</span>
		<span class="w">passive_open_err</span><span class="c">(cm_node,</span> <span class="w">s</span><span class="c">kb,</span> <span class="w">res</span><span class="pc">et</span><span class="c">);</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_TSA</span><span class="c">:</span>
		<span class="w">active_open_err</span><span class="c">(</span><span class="w">c</span><span class="c">m_node,</span> <span class="w">s</span><span class="c">kb,</span> <span class="w">res</span><span class="pc">e</span><span class="c">t);</span>
		<span class="c">break;</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_CLOSED</span><span class="c">:</span>
		<span class="w">drop_packet</span><span class="c">(skb</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">break;</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_FIN_WAIT2</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_FIN_WAIT1</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_LAST_ACK</span><span class="c">:</span>
		<span class="pc">cm</span><span class="c">_node-&gt;</span><span class="w">cm_id-</span><span class="pc">&gt;</span><span class="w">rem_ref(</span><span class="pc">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;cm_id);</span>
	<span class="pc">c</span><span class="c">ase</span> <span class="w">NES_CM_STATE_TIME_WAIT</span><span class="c">:</span>
		<span class="pc">cm</span><span class="c">_node-&gt;</span><span class="w">s</span><span class="pc">tate</span> <span class="c">=</span> <span class="w">N</span><span class="c">ES_CM_STATE_CLOSED;</span>
		<span class="w">rem_ref_cm_node</span><span class="c">(cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">cm_core</span><span class="pc">,</span> <span class="pc">c</span><span class="c">m_node</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">drop_packet</span><span class="c">(</span><span class="w">s</span><span class="c">kb);</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="pc">d</span><span class="c">efault:</span>
		<span class="w">d</span><span class="c">rop_packet(</span><span class="pc">s</span><span class="c">kb);</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="c">}</span>
<span class="c">}</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">handle_rcv_mpa</span><span class="c">(struct</span> <span class="w">nes_cm_node</span> <span class="c">*cm_node</span><span class="pc">,</span> <span class="c">struct</span> <span class="c">sk_buff</span> <span class="c">*skb)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">ret</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">datasize</span> <span class="pc">=</span> <span class="w">s</span><span class="c">kb</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">l</span><span class="c">en;</span>
	<span class="w">u</span><span class="c">8</span> <span class="c">*</span><span class="w">dataloc</span> <span class="pc">=</span> <span class="w">s</span><span class="c">kb-&gt;</span><span class="pc">data</span><span class="c">;</span>

	<span class="w">e</span><span class="pc">n</span><span class="c">um</span> <span class="w">nes_cm_event_type</span> <span class="c">type</span> <span class="pc">=</span> <span class="w">NES_CM_EVENT_UNKNOWN</span><span class="pc">;</span>
	<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">res_type</span><span class="pc">;</span>

	<span class="w">r</span><span class="c">et</span> <span class="c">=</span> <span class="w">parse_mpa</span><span class="c">(</span><span class="w">cm_node</span><span class="c">,</span> <span class="w">d</span><span class="pc">atal</span><span class="c">oc</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">r</span><span class="pc">es</span><span class="c">_type</span><span class="pc">,</span> <span class="w">d</span><span class="pc">atas</span><span class="c">ize);</span>
	<span class="c">if</span> <span class="c">(ret</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, "</span><span class="w">didn</span><span class="pc">'</span><span class="c">t</span> <span class="w">like</span> <span class="w">MPA</span> <span class="w">Request</span><span class="c">\n");</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">s</span><span class="pc">tate</span> <span class="pc">=</span><span class="c">=</span> <span class="w">NES_CM_STATE_MPAREQ_SENT</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">n</span><span class="c">es_debug(NES_DBG_CM</span><span class="w">,</span><span class="pc"> "%</span><span class="c">s</span><span class="w">[</span><span class="pc">%u]</span> <span class="w">cr</span><span class="c">eate</span> <span class="w">abort</span> <span class="w">f</span><span class="pc">o</span><span class="c">r</span> <span class="w">"</span>
				  <span class="w">"c</span><span class="pc">m</span><span class="c">_node</span><span class="w">=</span><span class="pc">%p</span> <span class="w">listener</span><span class="pc">=</span><span class="c">%</span><span class="w">p</span> <span class="w">st</span><span class="pc">ate=</span><span class="c">%</span><span class="pc">d</span><span class="c">\n",</span> <span class="w">_</span><span class="pc">_f</span><span class="c">unc__,</span>
				  <span class="w">_</span><span class="c">_LINE__,</span> <span class="c">cm_node</span><span class="pc">,</span> <span class="c">cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">l</span><span class="c">istener,</span>
				  <span class="pc">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">s</span><span class="c">tate</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">active_open_err</span><span class="c">(cm_node,</span> <span class="w">sk</span><span class="c">b,</span> <span class="pc">1</span><span class="c">);</span>
		<span class="c">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
			<span class="w">passive_open_err</span><span class="c">(</span><span class="pc">c</span><span class="c">m_node,</span> <span class="w">s</span><span class="pc">k</span><span class="c">b,</span> <span class="w">1</span><span class="c">);</span>
		<span class="c">}</span>
		<span class="w">r</span><span class="c">eturn</span><span class="w">;</span>
	<span class="c">}</span>

	<span class="w">sw</span><span class="c">itch</span> <span class="c">(cm_node-&gt;</span><span class="pc">s</span><span class="c">tate) {</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_ESTABLISHED</span><span class="c">:</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">res_type</span> <span class="pc">=</span><span class="c">=</span> <span class="w">NES_MPA_REQUEST_REJECT</span><span class="c">)</span>
			
			<span class="w">W</span><span class="c">ARN_ON(</span><span class="w">1</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">s</span><span class="c">tate</span> <span class="c">=</span> <span class="w">NES_CM_STATE_MPAREQ_RCVD</span><span class="c">;</span>
		<span class="w">ty</span><span class="c">pe</span> <span class="pc">=</span> <span class="w">NES_CM_EVENT_MPA_REQ</span><span class="c">;</span>
		<span class="w">at</span><span class="pc">omic_s</span><span class="c">et(&amp;cm_node-&gt;</span><span class="w">passive_state</span><span class="c">,</span>
			   <span class="w">NES_PASSIVE_STATE_INDICATED</span><span class="c">);</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="pc">c</span><span class="c">ase</span> <span class="w">NES_CM_STATE_MPAREQ_SENT</span><span class="c">:</span>
		<span class="w">cleanup_retrans_entry</span><span class="c">(cm_node</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">r</span><span class="c">es_type</span> <span class="pc">=</span><span class="c">=</span> <span class="w">N</span><span class="pc">ES_M</span><span class="c">PA_REQUEST_REJECT) {</span>
			<span class="w">t</span><span class="pc">y</span><span class="c">pe</span> <span class="c">=</span> <span class="w">NES_CM_EVENT_MPA_REJECT</span><span class="c">;</span>
			<span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">s</span><span class="c">tate</span> <span class="c">=</span> <span class="w">NES_CM_STATE_MPAREJ_RCVD</span><span class="c">;</span>
		<span class="pc">}</span> <span class="c">else</span> <span class="c">{</span>
			<span class="w">t</span><span class="pc">y</span><span class="c">pe</span> <span class="c">=</span> <span class="w">NES_CM_EVENT_CONNECTED</span><span class="c">;</span>
			<span class="pc">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s</span><span class="pc">tate</span> <span class="c">=</span> <span class="w">NES_CM_STATE_TSA</span><span class="c">;</span>
		<span class="pc">}</span>

		<span class="w">b</span><span class="c">reak;</span>
	<span class="pc">d</span><span class="c">efault:</span>
		<span class="w">W</span><span class="c">ARN_ON(</span><span class="pc">1</span><span class="c">);</span>
		<span class="w">b</span><span class="c">reak;</span>
	<span class="c">}</span>
	<span class="w">dev_kfree_skb_any</span><span class="pc">(</span><span class="w">s</span><span class="pc">kb</span><span class="c">);</span>
	<span class="w">create_event</span><span class="c">(cm_node,</span> <span class="w">t</span><span class="pc">y</span><span class="c">pe</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">indicate_pkt_err</span><span class="c">(struct</span> <span class="w">nes_cm_node</span> <span class="c">*cm_node</span><span class="pc">,</span> <span class="c">struct</span> <span class="c">sk_buff</span> <span class="c">*skb)</span>
<span class="c">{</span>
	<span class="w">s</span><span class="pc">w</span><span class="c">itch</span> <span class="c">(</span><span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">s</span><span class="c">tate) {</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_SYN_SENT</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_MPAREQ_SENT</span><span class="c">:</span>
		<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM,</span><span class="pc"> "%</span><span class="c">s</span><span class="w">[</span><span class="pc">%u</span><span class="w">]</span> <span class="w">cr</span><span class="c">eate</span> <span class="w">abort</span> <span class="w">f</span><span class="c">or</span> <span class="w">c</span><span class="c">m_node</span><span class="w">=</span><span class="c">%</span><span class="w">p</span> <span class="w">"</span>
			  <span class="w">"listener=</span><span class="c">%</span><span class="w">p</span> <span class="w">sta</span><span class="pc">te=</span><span class="c">%</span><span class="pc">d\</span><span class="c">n",</span> <span class="pc">_</span><span class="c">_func__,</span> <span class="w">_</span><span class="pc">_L</span><span class="c">INE__</span><span class="pc">,</span> <span class="c">cm_node</span><span class="pc">,</span>
			  <span class="w">c</span><span class="pc">m_</span><span class="c">node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">l</span><span class="pc">i</span><span class="c">stener,</span> <span class="w">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s</span><span class="pc">t</span><span class="c">ate</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">active_open_err</span><span class="c">(</span><span class="w">c</span><span class="pc">m</span><span class="c">_node,</span> <span class="w">sk</span><span class="c">b,</span> <span class="pc">1</span><span class="c">);</span>
		<span class="w">b</span><span class="c">reak;</span>
	<span class="pc">c</span><span class="c">ase</span> <span class="w">NES_CM_STATE_ESTABLISHED</span><span class="c">:</span>
	<span class="pc">c</span><span class="c">ase</span> <span class="w">NES_CM_STATE_SYN_RCVD</span><span class="c">:</span>
		<span class="w">passive_open_err</span><span class="c">(</span><span class="w">c</span><span class="c">m_node,</span> <span class="w">s</span><span class="pc">k</span><span class="c">b,</span> <span class="pc">1</span><span class="c">);</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_TSA</span><span class="c">:</span>
	<span class="w">d</span><span class="c">efault:</span>
		<span class="w">drop_packet</span><span class="c">(</span><span class="pc">s</span><span class="c">kb);</span>
	<span class="pc">}</span>
<span class="w">}</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="c">int</span> <span class="w">check_syn</span><span class="c">(struct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="w">c</span><span class="c">m_node</span><span class="pc">,</span> <span class="c">struct</span> <span class="w">tcphdr</span> <span class="c">*</span><span class="w">tcph</span><span class="pc">,</span>
		     <span class="c">struct</span> <span class="c">sk_buff</span> <span class="c">*skb</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">e</span><span class="c">rr;</span>

	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="w">=</span><span class="pc"> ((</span><span class="w">ntohl</span><span class="c">(</span><span class="pc">t</span><span class="c">cph</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ack_seq) =</span><span class="c">=</span> <span class="w">c</span><span class="c">m_node-&gt;</span><span class="w">tcp_cntxt.loc_seq_num)) ?</span> <span class="pc">0</span> <span class="w">:</span> <span class="pc">1</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">e</span><span class="c">rr)</span>
		<span class="w">active_open_err</span><span class="c">(cm_node,</span> <span class="w">s</span><span class="pc">k</span><span class="c">b</span><span class="pc">,</span> <span class="w">1</span><span class="c">);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">check_seq</span><span class="c">(struct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="pc">c</span><span class="c">m_node,</span> <span class="c">struct</span> <span class="w">tcphdr</span> <span class="c">*</span><span class="w">tcph</span><span class="pc">,</span>
		     <span class="c">struct</span> <span class="pc">s</span><span class="c">k_buff</span> <span class="c">*skb</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">e</span><span class="c">rr</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">se</span><span class="pc">q;</span>
	<span class="pc">u</span><span class="c">32</span> <span class="w">ack_seq</span><span class="c">;</span>
	<span class="c">u32</span> <span class="w">loc_seq_num</span> <span class="pc">=</span> <span class="pc">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">tcp_cntxt.</span><span class="pc">l</span><span class="c">oc_seq_num;</span>
	<span class="pc">u</span><span class="c">32</span> <span class="w">rcv_nxt</span> <span class="pc">=</span> <span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">t</span><span class="c">cp_cntxt</span><span class="pc">.r</span><span class="c">cv_nxt;</span>
	<span class="pc">u</span><span class="c">32</span> <span class="w">rcv_wnd</span><span class="c">;</span>

	<span class="w">seq</span> <span class="c">=</span> <span class="w">ntohl</span><span class="c">(</span><span class="w">tcph-</span><span class="c">&gt;</span><span class="w">se</span><span class="pc">q</span><span class="c">);</span>
	<span class="w">a</span><span class="c">ck_seq</span> <span class="pc">=</span> <span class="w">n</span><span class="c">tohl(tcph</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">a</span><span class="c">ck_seq);</span>
	<span class="w">r</span><span class="pc">c</span><span class="c">v_wnd</span> <span class="pc">=</span> <span class="w">c</span><span class="c">m_node-&gt;</span><span class="pc">tcp_</span><span class="c">cntxt</span><span class="pc">.</span><span class="c">rcv_wnd</span><span class="pc">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">a</span><span class="c">ck_seq</span> <span class="w">!</span><span class="c">=</span> <span class="w">loc_seq_num</span><span class="c">)</span>
		<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">1</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">lse</span> <span class="c">if</span> <span class="pc">(!</span><span class="w">between</span><span class="c">(</span><span class="w">seq</span><span class="pc">,</span> <span class="w">rcv_nxt,</span><span class="pc"> (</span><span class="w">r</span><span class="pc">cv_n</span><span class="c">xt</span> <span class="w">+</span> <span class="pc">r</span><span class="c">cv_wnd</span><span class="pc">))</span><span class="c">)</span>
		<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="w">1</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">e</span><span class="c">rr</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM,</span><span class="pc"> "%</span><span class="c">s</span><span class="w">[</span><span class="pc">%u</span><span class="w">]</span> <span class="w">cr</span><span class="c">eate</span> <span class="w">abort</span> <span class="w">f</span><span class="pc">o</span><span class="c">r</span> <span class="w">cm_node=</span><span class="c">%</span><span class="w">p</span> <span class="w">"</span>
			  <span class="w">"listener</span><span class="pc">=</span><span class="c">%</span><span class="w">p</span> <span class="w">sta</span><span class="pc">te=</span><span class="c">%d</span><span class="pc">\</span><span class="c">n",</span> <span class="c">__func__,</span> <span class="w">_</span><span class="pc">_L</span><span class="c">INE__</span><span class="pc">,</span> <span class="w">c</span><span class="pc">m</span><span class="c">_node</span><span class="pc">,</span>
			  <span class="w">c</span><span class="pc">m_</span><span class="c">node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">l</span><span class="pc">i</span><span class="c">stener,</span> <span class="w">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s</span><span class="c">tate</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">indicate_pkt_err</span><span class="c">(</span><span class="w">c</span><span class="pc">m</span><span class="c">_node,</span> <span class="w">sk</span><span class="c">b</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM,</span><span class="pc"> "</span><span class="w">seq</span> <span class="w">E</span><span class="pc">R</span><span class="c">ROR</span> <span class="pc">c</span><span class="c">m_node</span> <span class="w">=</span><span class="c">%</span><span class="pc">p</span> <span class="w">se</span><span class="c">q</span><span class="w">=</span><span class="c">0x%</span><span class="w">0</span><span class="pc">8X</span> <span class="w">"</span>
			  <span class="w">"rcv_nxt=</span><span class="c">0x%</span><span class="w">0</span><span class="pc">8X</span> <span class="w">rcv_wnd=</span><span class="c">0x%x</span><span class="pc">\</span><span class="c">n",</span> <span class="c">cm_node</span><span class="pc">,</span> <span class="w">se</span><span class="pc">q</span><span class="c">,</span> <span class="pc">r</span><span class="c">cv_nxt,</span>
			  <span class="pc">r</span><span class="c">cv_wnd</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="w">r</span><span class="c">eturn</span> <span class="w">e</span><span class="c">rr;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">handle_syn_pkt</span><span class="c">(struct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="w">c</span><span class="c">m_node,</span> <span class="c">struct</span> <span class="w">s</span><span class="pc">k</span><span class="c">_buff</span> <span class="c">*skb,</span>
			   <span class="c">struct</span> <span class="w">tcphdr</span> <span class="c">*</span><span class="w">tcph</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">r</span><span class="c">et;</span>
	<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">inc_sequence</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">optionsize</span><span class="c">;</span>

	<span class="w">o</span><span class="c">ptionsize</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="w">t</span><span class="c">cph-&gt;</span><span class="w">doff</span> <span class="w">&lt;</span><span class="c">&lt;</span> <span class="w">2) -</span> <span class="pc">s</span><span class="c">izeof(struct</span> <span class="pc">tcphd</span><span class="c">r</span><span class="w">)</span><span class="pc">;</span>
	<span class="w">skb_trim</span><span class="c">(</span><span class="w">s</span><span class="pc">k</span><span class="c">b</span><span class="pc">,</span> <span class="w">0</span><span class="c">);</span>
	<span class="w">i</span><span class="pc">nc</span><span class="c">_sequence</span> <span class="pc">=</span> <span class="w">ntohl</span><span class="c">(tcph</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">se</span><span class="pc">q</span><span class="c">);</span>

	<span class="w">sw</span><span class="c">itch</span> <span class="c">(</span><span class="w">cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s</span><span class="pc">tate</span><span class="c">) {</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_SYN_SENT</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_MPAREQ_SENT</span><span class="c">:</span>
		
		<span class="w">active_open_err</span><span class="c">(</span><span class="w">c</span><span class="c">m_node</span><span class="pc">,</span> <span class="w">sk</span><span class="pc">b,</span> <span class="w">1</span><span class="c">);</span>
		<span class="c">break;</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_LISTENING</span><span class="c">:</span>
		
		<span class="w">i</span><span class="pc">f</span> <span class="c">(</span><span class="w">at</span><span class="pc">o</span><span class="c">mic_read(&amp;</span><span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">listener-</span><span class="c">&gt;</span><span class="w">pend_accepts_cnt) &gt;</span>
		    <span class="pc">c</span><span class="c">m_node-&gt;listener-&gt;</span><span class="w">backlog)</span><span class="pc"> </span><span class="c">{</span>
			<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">drop</span> <span class="w">syn</span> <span class="w">due</span> <span class="w">t</span><span class="c">o</span> <span class="w">b</span><span class="c">acklog</span> <span class="w">"</span>
				  <span class="pc">"</span><span class="w">pressure</span> <span class="w">\</span><span class="c">n");</span>
			<span class="w">cm_backlog_drops+</span><span class="c">+;</span>
			<span class="w">passive_open_err</span><span class="pc">(</span><span class="c">cm_node</span><span class="pc">,</span> <span class="w">sk</span><span class="c">b</span><span class="pc">,</span> <span class="w">0</span><span class="c">);</span>
			<span class="pc">b</span><span class="c">reak;</span>
		<span class="c">}</span>
		<span class="w">r</span><span class="pc">et</span> <span class="pc">=</span> <span class="w">handle_tcp_options</span><span class="c">(</span><span class="pc">c</span><span class="c">m_node,</span> <span class="w">tcph</span><span class="c">,</span> <span class="w">sk</span><span class="c">b,</span> <span class="w">optionsize</span><span class="pc">,</span>
					 <span class="w">1</span><span class="c">);</span>
		<span class="c">if</span> <span class="c">(ret</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">p</span><span class="pc">a</span><span class="c">ssive_open_err(cm_node,</span> <span class="w">s</span><span class="pc">k</span><span class="c">b,</span> <span class="pc">0)</span><span class="c">;</span>
			
			<span class="w">b</span><span class="c">reak;</span>
		<span class="pc">}</span>
		<span class="w">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">tcp_cntxt</span><span class="pc">.</span><span class="w">rcv_nxt</span> <span class="c">=</span> <span class="w">inc_sequence</span> <span class="w">+</span> <span class="pc">1</span><span class="c">;</span>
		<span class="w">B</span><span class="c">UG_ON(</span><span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">send_entry</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">accept_pend</span> <span class="c">=</span> <span class="w">1</span><span class="c">;</span>
		<span class="w">at</span><span class="c">omic_inc(&amp;</span><span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">listener-</span><span class="c">&gt;</span><span class="w">pend_accepts_cnt</span><span class="c">);</span>

		<span class="pc">c</span><span class="c">m_node-&gt;</span><span class="pc">s</span><span class="c">tate</span> <span class="c">=</span> <span class="w">NES_CM_STATE_SYN_RCVD</span><span class="c">;</span>
		<span class="w">send_syn</span><span class="c">(cm_node</span><span class="pc">,</span> <span class="w">1</span><span class="pc">,</span> <span class="w">sk</span><span class="c">b</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">b</span><span class="c">reak;</span>
	<span class="pc">c</span><span class="c">ase</span> <span class="w">NES_CM_STATE_CLOSED</span><span class="c">:</span>
		<span class="w">cleanup_retrans_entry</span><span class="c">(cm_node</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">add_ref_cm_node</span><span class="c">(cm_node);</span>
		<span class="w">send_reset</span><span class="c">(cm_node</span><span class="pc">,</span> <span class="w">sk</span><span class="c">b);</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_TSA</span><span class="c">:</span>
	<span class="pc">ca</span><span class="c">se</span> <span class="w">NES_CM_STATE_ESTABLISHED</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_FIN_WAIT1</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_FIN_WAIT2</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_MPAREQ_RCVD</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_LAST_ACK</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_CLOSING</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_UNKNOWN</span><span class="c">:</span>
	<span class="pc">d</span><span class="c">efault:</span>
		<span class="w">drop_packet</span><span class="c">(</span><span class="w">s</span><span class="pc">kb</span><span class="c">);</span>
		<span class="c">break;</span>
	<span class="pc">}</span>
<span class="c">}</span>

<span class="w">s</span><span class="c">tatic</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">handle_synack_pkt</span><span class="c">(struct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="w">cm_node</span><span class="pc">,</span> <span class="c">struct</span> <span class="c">sk_buff</span> <span class="c">*skb</span><span class="pc">,</span>
			      <span class="c">struct</span> <span class="w">tcphdr</span> <span class="c">*</span><span class="w">tcph</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">r</span><span class="c">et;</span>
	<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">inc_sequence</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">optionsize</span><span class="c">;</span>

	<span class="w">o</span><span class="c">ptionsize</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="pc">t</span><span class="c">cph-&gt;</span><span class="w">doff</span> <span class="w">&lt;</span><span class="c">&lt;</span> <span class="w">2) -</span> <span class="pc">s</span><span class="c">izeof(struct</span> <span class="pc">tcphd</span><span class="c">r</span><span class="w">)</span><span class="pc">;</span>
	<span class="w">skb_trim</span><span class="c">(</span><span class="w">s</span><span class="pc">k</span><span class="c">b</span><span class="pc">,</span> <span class="w">0</span><span class="c">);</span>
	<span class="w">i</span><span class="pc">nc</span><span class="c">_sequence</span> <span class="pc">=</span> <span class="w">ntohl</span><span class="c">(tcph</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">se</span><span class="pc">q</span><span class="c">);</span>
	<span class="w">sw</span><span class="c">itch</span> <span class="c">(</span><span class="w">cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s</span><span class="pc">tate</span><span class="c">) {</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_SYN_SENT</span><span class="c">:</span>
		<span class="w">cleanup_retrans_entry</span><span class="c">(</span><span class="w">c</span><span class="c">m_node);</span>
		
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">check_syn</span><span class="c">(</span><span class="pc">c</span><span class="c">m_node</span><span class="pc">,</span> <span class="c">tcph</span><span class="pc">,</span> <span class="w">s</span><span class="pc">kb))</span>
			<span class="c">return</span><span class="pc">;</span>
		<span class="pc">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">tcp_cntxt</span><span class="pc">.</span><span class="w">rem_ack_num</span> <span class="c">=</span> <span class="w">n</span><span class="c">tohl</span><span class="pc">(</span><span class="c">tcph</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ack_seq</span><span class="pc">)</span><span class="c">;</span>
		
		<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">handle_tcp_options</span><span class="c">(cm_node,</span> <span class="w">t</span><span class="pc">cph</span><span class="c">,</span> <span class="w">s</span><span class="c">kb</span><span class="pc">,</span> <span class="w">optionsize</span><span class="pc">,</span> <span class="pc">0</span><span class="c">);</span>
		<span class="c">if</span> <span class="c">(ret</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="pc">c</span><span class="c">m_node</span><span class="w">=</span><span class="pc">%</span><span class="w">p</span> <span class="w">tcp_options</span> <span class="w">f</span><span class="pc">a</span><span class="c">iled\n",</span>
				  <span class="pc">c</span><span class="c">m_node);</span>
			<span class="w">b</span><span class="c">reak;</span>
		<span class="c">}</span>
		<span class="w">cleanup_retrans_entry</span><span class="c">(cm_node</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">tcp_cntxt</span><span class="pc">.</span><span class="w">rcv_nxt</span> <span class="pc">=</span> <span class="w">inc_sequence</span> <span class="w">+</span> <span class="pc">1</span><span class="c">;</span>
		<span class="w">send_mpa_request</span><span class="c">(cm_node,</span> <span class="w">sk</span><span class="c">b</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s</span><span class="pc">t</span><span class="c">ate</span> <span class="c">=</span> <span class="w">NES_CM_STATE_MPAREQ_SENT</span><span class="c">;</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="pc">c</span><span class="c">ase</span> <span class="w">NES_CM_STATE_MPAREQ_RCVD</span><span class="c">:</span>
		
		<span class="w">passive_open_err</span><span class="c">(cm_node,</span> <span class="pc">s</span><span class="c">kb,</span> <span class="w">1</span><span class="c">);</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_LISTENING</span><span class="c">:</span>
		<span class="c">cm_node-&gt;</span><span class="pc">t</span><span class="c">cp_cntxt</span><span class="pc">.</span><span class="w">loc_seq_num</span> <span class="pc">=</span> <span class="w">ntohl</span><span class="pc">(</span><span class="w">tcph</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ack_seq</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">cleanup_retrans_entry</span><span class="c">(cm_node</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">c</span><span class="c">m_node-&gt;</span><span class="w">s</span><span class="c">tate</span> <span class="c">=</span> <span class="w">NES_CM_STATE_CLOSED</span><span class="c">;</span>
		<span class="w">send_reset</span><span class="c">(cm_node</span><span class="pc">,</span> <span class="w">s</span><span class="pc">k</span><span class="c">b);</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="c">case</span> <span class="w">N</span><span class="c">ES_CM_STATE_CLOSED:</span>
		<span class="c">cm_node-&gt;tcp_cntxt.</span><span class="pc">l</span><span class="c">oc_seq_num</span> <span class="pc">=</span> <span class="pc">n</span><span class="c">tohl</span><span class="pc">(</span><span class="c">tcph-&gt;ack_seq);</span>
		<span class="w">c</span><span class="c">leanup_retrans_entry</span><span class="pc">(</span><span class="c">cm_node</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">add_ref_cm_node</span><span class="c">(cm_node</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">s</span><span class="pc">e</span><span class="c">nd_reset</span><span class="pc">(</span><span class="c">cm_node</span><span class="pc">,</span> <span class="w">sk</span><span class="c">b);</span>
		<span class="w">b</span><span class="c">reak;</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_ESTABLISHED</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_FIN_WAIT1</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_FIN_WAIT2</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_LAST_ACK</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_TSA</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_CLOSING</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_UNKNOWN</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_MPAREQ_SENT</span><span class="c">:</span>
	<span class="pc">d</span><span class="c">efault:</span>
		<span class="w">drop_packet</span><span class="c">(</span><span class="w">s</span><span class="pc">kb</span><span class="c">);</span>
		<span class="c">break;</span>
	<span class="pc">}</span>
<span class="c">}</span>

<span class="w">s</span><span class="c">tatic</span> <span class="c">int</span> <span class="w">handle_ack_pkt</span><span class="c">(struct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="w">cm_node</span><span class="c">,</span> <span class="c">struct</span> <span class="c">sk_buff</span> <span class="c">*skb</span><span class="pc">,</span>
			  <span class="c">struct</span> <span class="w">tcphdr</span> <span class="c">*</span><span class="w">tcph</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">datasize</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">inc_sequence</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">r</span><span class="c">et</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">optionsize</span><span class="c">;</span>

	<span class="w">o</span><span class="c">ptionsize</span> <span class="pc">= </span><span class="c">(</span><span class="w">t</span><span class="c">cph</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">doff</span> <span class="w">&lt;</span><span class="c">&lt;</span> <span class="w">2) -</span> <span class="pc">s</span><span class="c">izeof(struct</span> <span class="c">tcphdr</span><span class="w">);</span>

	<span class="pc">if</span> <span class="c">(</span><span class="w">check_seq</span><span class="c">(</span><span class="w">cm_node</span><span class="c">,</span> <span class="pc">tcph,</span> <span class="w">s</span><span class="pc">k</span><span class="c">b</span><span class="pc">))</span>
		<span class="c">return</span> <span class="c">-</span><span class="pc">E</span><span class="c">INVAL;</span>

	<span class="w">skb_pull</span><span class="c">(</span><span class="pc">s</span><span class="c">kb,</span> <span class="pc">t</span><span class="c">cph</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">d</span><span class="c">off</span> <span class="w">&lt;</span><span class="c">&lt;</span> <span class="w">2</span><span class="c">);</span>
	<span class="w">inc_sequence</span> <span class="pc">=</span> <span class="w">ntohl</span><span class="c">(tcph</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">seq</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">datasize</span> <span class="pc">=</span> <span class="w">s</span><span class="pc">kb</span><span class="c">-&gt;</span><span class="w">l</span><span class="c">en;</span>
	<span class="w">s</span><span class="c">witch</span> <span class="c">(</span><span class="w">c</span><span class="c">m_node-&gt;</span><span class="w">s</span><span class="pc">t</span><span class="c">ate</span><span class="pc">)</span><span class="c"> {</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_SYN_RCVD</span><span class="c">:</span>
		
		<span class="w">cleanup_retrans_entry</span><span class="c">(</span><span class="w">c</span><span class="c">m_node);</span>
		<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">handle_tcp_options</span><span class="c">(</span><span class="pc">c</span><span class="c">m_node</span><span class="pc">,</span> <span class="c">tcph</span><span class="pc">,</span> <span class="w">sk</span><span class="pc">b,</span> <span class="w">optionsize</span><span class="pc">,</span> <span class="w">1</span><span class="c">);</span>
		<span class="c">if</span> <span class="c">(ret</span><span class="pc">)</span>
			<span class="pc">b</span><span class="c">reak;</span>
		<span class="w">c</span><span class="pc">m</span><span class="c">_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">tcp_cntxt.rem_ack_num</span> <span class="c">=</span> <span class="w">ntohl</span><span class="c">(</span><span class="w">t</span><span class="pc">cph</span><span class="c">-&gt;</span><span class="w">ack_seq</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s</span><span class="c">tate</span> <span class="c">=</span> <span class="w">NES_CM_STATE_ESTABLISHED</span><span class="c">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">datasize)</span><span class="pc"> </span><span class="c">{</span>
			<span class="pc">c</span><span class="c">m_node-&gt;</span><span class="pc">tcp_</span><span class="c">cntxt</span><span class="pc">.</span><span class="w">rcv_nxt</span> <span class="c">=</span> <span class="w">inc_sequence</span> <span class="w">+</span> <span class="pc">d</span><span class="c">atasize</span><span class="pc">;</span>
			<span class="w">nes_get_remote_addr</span><span class="c">(cm_node</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">handle_rcv_mpa</span><span class="c">(cm_node</span><span class="pc">,</span> <span class="w">s</span><span class="pc">k</span><span class="c">b);</span>
		<span class="c">}</span> <span class="c">else</span> <span class="c">{</span> 
			<span class="w">dev_kfree_skb_any</span><span class="c">(</span><span class="w">s</span><span class="c">kb</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">}</span>
		<span class="w">b</span><span class="c">reak;</span>
	<span class="c">case</span> <span class="w">N</span><span class="pc">E</span><span class="c">S_CM_STATE_ESTABLISHED:</span>
		
		<span class="w">cleanup_retrans_entry</span><span class="c">(cm_node</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">d</span><span class="c">atasize</span><span class="pc">)</span><span class="c"> {</span>
			<span class="pc">cm</span><span class="c">_node-&gt;</span><span class="w">tcp_cntxt</span><span class="pc">.</span><span class="w">rcv_nxt</span> <span class="c">=</span> <span class="w">inc_sequence</span> <span class="w">+</span> <span class="c">datasize</span><span class="pc">;</span>
			<span class="w">h</span><span class="c">andle_rcv_mpa</span><span class="pc">(</span><span class="c">cm_node,</span> <span class="w">s</span><span class="pc">k</span><span class="c">b</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">}</span> <span class="c">else</span> <span class="c">{</span>
			<span class="w">drop_packet</span><span class="c">(</span><span class="w">s</span><span class="c">kb</span><span class="pc">);</span>
		<span class="c">}</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_MPAREQ_SENT</span><span class="c">:</span>
		<span class="pc">c</span><span class="c">m_node-&gt;</span><span class="pc">t</span><span class="c">cp_cntxt</span><span class="pc">.</span><span class="w">rem_ack_num</span> <span class="pc">=</span> <span class="w">ntohl</span><span class="pc">(</span><span class="w">tcph</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ack_seq</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">d</span><span class="pc">a</span><span class="c">tasize</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">c</span><span class="pc">m</span><span class="c">_node-&gt;tcp_cntxt.</span><span class="w">rcv_nxt</span> <span class="c">=</span> <span class="w">inc_sequence</span> <span class="w">+</span> <span class="w">d</span><span class="c">atasize</span><span class="pc">;</span>
			<span class="w">handle_rcv_mpa</span><span class="c">(cm_node,</span> <span class="w">s</span><span class="pc">k</span><span class="c">b</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">}</span> <span class="c">else</span> <span class="c">{</span> 
			<span class="w">dev_kfree_skb_any</span><span class="c">(</span><span class="w">s</span><span class="c">kb</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">}</span>
		<span class="w">b</span><span class="c">reak;</span>
	<span class="pc">c</span><span class="c">ase</span> <span class="w">NES_CM_STATE_LISTENING</span><span class="c">:</span>
		<span class="w">cleanup_retrans_entry</span><span class="c">(</span><span class="pc">c</span><span class="c">m_node</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">c</span><span class="c">m_node-&gt;</span><span class="w">s</span><span class="pc">tate</span> <span class="c">=</span> <span class="w">NES_CM_STATE_CLOSED</span><span class="c">;</span>
		<span class="w">send_reset</span><span class="c">(</span><span class="pc">c</span><span class="c">m_node</span><span class="pc">,</span> <span class="w">s</span><span class="pc">k</span><span class="c">b);</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="pc">c</span><span class="c">ase</span> <span class="w">N</span><span class="pc">ES_CM_STATE_C</span><span class="c">LOSED:</span>
		<span class="w">c</span><span class="pc">l</span><span class="c">eanup_retrans_entry(</span><span class="pc">c</span><span class="c">m_node</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">add_ref_cm_node</span><span class="c">(</span><span class="pc">cm</span><span class="c">_node);</span>
		<span class="w">s</span><span class="c">end_reset(</span><span class="pc">c</span><span class="c">m_node</span><span class="pc">,</span> <span class="w">sk</span><span class="c">b);</span>
		<span class="c">break;</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_LAST_ACK</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_CLOSING</span><span class="c">:</span>
		<span class="w">c</span><span class="pc">l</span><span class="c">eanup_retrans_entry(cm_node);</span>
		<span class="w">c</span><span class="pc">m</span><span class="c">_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">s</span><span class="c">tate</span> <span class="c">=</span> <span class="w">N</span><span class="pc">ES_CM_STATE_C</span><span class="c">LOSED;</span>
		<span class="pc">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">cm_id-</span><span class="pc">&gt;</span><span class="w">rem_ref(</span><span class="pc">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">cm_i</span><span class="c">d);</span>
		<span class="w">rem_ref_cm_node</span><span class="c">(cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">cm_core</span><span class="pc">,</span> <span class="pc">c</span><span class="c">m_node);</span>
		<span class="w">drop_packet</span><span class="c">(</span><span class="w">s</span><span class="c">kb);</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_FIN_WAIT1</span><span class="c">:</span>
		<span class="w">c</span><span class="pc">l</span><span class="c">eanup_retrans_entry</span><span class="pc">(</span><span class="c">cm_node</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">d</span><span class="c">rop_packet</span><span class="pc">(s</span><span class="c">kb</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s</span><span class="c">tate</span> <span class="c">=</span> <span class="w">NES_CM_STATE_FIN_WAIT2</span><span class="c">;</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="pc">c</span><span class="c">ase</span> <span class="w">NES_CM_STATE_SYN_SENT</span><span class="c">:</span>
	<span class="pc">ca</span><span class="c">se</span> <span class="w">N</span><span class="pc">E</span><span class="c">S_CM_STATE_FIN_WAIT2:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_TSA</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_MPAREQ_RCVD</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_UNKNOWN</span><span class="c">:</span>
	<span class="pc">d</span><span class="c">efault:</span>
		<span class="w">c</span><span class="pc">l</span><span class="c">eanup_retrans_entry</span><span class="pc">(</span><span class="c">cm_node);</span>
		<span class="w">d</span><span class="pc">r</span><span class="c">op_packet(</span><span class="w">s</span><span class="pc">kb</span><span class="c">);</span>
		<span class="c">break;</span>
	<span class="pc">}</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">r</span><span class="c">et;</span>
<span class="c">}</span>



<span class="c">static</span> <span class="c">int</span> <span class="w">handle_tcp_options</span><span class="c">(struct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="w">c</span><span class="pc">m</span><span class="c">_node</span><span class="pc">,</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">tcphdr</span> <span class="c">*</span><span class="w">tcph</span><span class="pc">,</span>
			      <span class="c">struct</span> <span class="pc">s</span><span class="c">k_buff</span> <span class="c">*skb,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">optionsize</span><span class="c">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">passive</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="pc">8</span> <span class="c">*</span><span class="w">optionsloc</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="pc">u</span><span class="c">8</span> <span class="w">*</span><span class="pc">)&amp;tcph</span><span class="w">[</span><span class="pc">1];</span>

	<span class="pc">if</span> <span class="c">(</span><span class="w">o</span><span class="pc">ptionsi</span><span class="c">ze</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">process_options</span><span class="c">(</span><span class="pc">c</span><span class="c">m_node</span><span class="pc">,</span> <span class="c">optionsloc,</span> <span class="w">o</span><span class="c">ptionsize,</span>
				    <span class="w">(u</span><span class="pc">3</span><span class="c">2</span><span class="pc">)</span><span class="w">t</span><span class="c">cph</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">syn))</span><span class="pc"> </span><span class="c">{</span>
			<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM,</span><span class="pc"> "%</span><span class="c">s:</span> <span class="w">Node</span> <span class="pc">%</span><span class="w">p,</span> <span class="w">Sending</span> <span class="w">RESET</span><span class="c">\n",</span>
				  <span class="c">__func__,</span> <span class="pc">c</span><span class="c">m_node);</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">passive</span><span class="pc">)</span>
				<span class="w">passive_open_err</span><span class="c">(</span><span class="pc">c</span><span class="c">m_node,</span> <span class="w">s</span><span class="pc">k</span><span class="c">b,</span> <span class="w">1</span><span class="c">);</span>
			<span class="pc">e</span><span class="c">lse</span>
				<span class="w">active_open_err</span><span class="c">(</span><span class="pc">c</span><span class="c">m_node,</span> <span class="w">s</span><span class="pc">k</span><span class="c">b,</span> <span class="w">1</span><span class="c">);</span>
			<span class="pc">r</span><span class="c">eturn</span> <span class="w">1</span><span class="c">;</span>
		<span class="c">}</span>
	<span class="pc">}</span>

	<span class="w">c</span><span class="pc">m</span><span class="c">_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">tcp_cntxt</span><span class="pc">.</span><span class="w">snd_wnd</span> <span class="pc">=</span> <span class="w">n</span><span class="pc">t</span><span class="c">ohs(</span><span class="w">tcph</span><span class="c">-&gt;</span><span class="w">wi</span><span class="pc">n</span><span class="c">dow</span><span class="w">) &lt;</span><span class="pc">&lt;</span>
				     <span class="pc">c</span><span class="c">m_node-&gt;</span><span class="pc">tcp_</span><span class="c">cntxt.</span><span class="w">snd_wscale</span><span class="pc">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(cm_node-&gt;</span><span class="pc">tcp_</span><span class="c">cntxt.snd_wnd</span> <span class="pc">&gt;</span> <span class="pc">c</span><span class="c">m_node-&gt;</span><span class="pc">tcp_</span><span class="c">cntxt.</span><span class="w">max_snd_wnd)</span>
		<span class="c">cm_node-&gt;tcp_cntxt.</span><span class="pc">m</span><span class="c">ax_snd_wnd</span> <span class="c">=</span> <span class="c">cm_node-&gt;</span><span class="pc">t</span><span class="c">cp_cntxt.</span><span class="pc">s</span><span class="c">nd_wnd</span><span class="pc">;</span>
	<span class="w">r</span><span class="c">eturn</span> <span class="pc">0</span><span class="c">;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">active_open_err</span><span class="c">(struct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="pc">cm</span><span class="c">_node,</span> <span class="c">struct</span> <span class="pc">s</span><span class="c">k_buff</span> <span class="c">*skb</span><span class="pc">,</span>
			    <span class="pc">i</span><span class="c">nt</span> <span class="w">res</span><span class="pc">e</span><span class="c">t)</span>
<span class="c">{</span>
	<span class="w">cleanup_retrans_entry</span><span class="c">(</span><span class="pc">c</span><span class="c">m_node</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">res</span><span class="pc">et) </span><span class="c">{</span>
		<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">ER</span><span class="c">ROR</span> <span class="w">ac</span><span class="pc">tive</span> <span class="w">er</span><span class="pc">r</span> <span class="w">called</span> <span class="w">f</span><span class="pc">o</span><span class="c">r</span> <span class="w">c</span><span class="c">m_node</span><span class="w">=</span><span class="c">%</span><span class="w">p,</span><span class="pc"> </span><span class="c">"</span>
			  <span class="w">"s</span><span class="pc">t</span><span class="c">ate</span><span class="pc">=</span><span class="c">%d\n",</span> <span class="pc">cm</span><span class="c">_node</span><span class="pc">,</span> <span class="c">cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s</span><span class="c">tate</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">add_ref_cm_node</span><span class="c">(</span><span class="pc">c</span><span class="c">m_node</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">send_reset</span><span class="c">(</span><span class="pc">cm</span><span class="c">_node</span><span class="pc">,</span> <span class="w">s</span><span class="pc">k</span><span class="c">b);</span>
	<span class="c">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
		<span class="w">dev_kfree_skb_any</span><span class="c">(</span><span class="w">sk</span><span class="c">b</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">c</span><span class="pc">m</span><span class="c">_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">s</span><span class="c">tate</span> <span class="c">=</span> <span class="w">NES_CM_STATE_CLOSED</span><span class="c">;</span>
	<span class="w">create_event</span><span class="c">(</span><span class="pc">c</span><span class="c">m_node,</span> <span class="w">NES_CM_EVENT_ABORTED</span><span class="pc">)</span><span class="c">;</span>
<span class="pc">}</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">passive_open_err</span><span class="c">(struct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="pc">c</span><span class="c">m_node,</span> <span class="c">struct</span> <span class="c">sk_buff</span> <span class="c">*skb</span><span class="pc">,</span>
			     <span class="pc">i</span><span class="c">nt</span> <span class="w">res</span><span class="pc">e</span><span class="c">t)</span>
<span class="c">{</span>
	<span class="w">cleanup_retrans_entry</span><span class="c">(</span><span class="pc">cm</span><span class="c">_node</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s</span><span class="c">tate</span> <span class="c">=</span> <span class="w">N</span><span class="pc">ES_CM_S</span><span class="c">TATE_CLOSED;</span>
	<span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="w">res</span><span class="pc">e</span><span class="c">t</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
		<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">p</span><span class="c">assive_open_err</span> <span class="w">sending</span> <span class="w">RST</span> <span class="w">f</span><span class="c">or</span> <span class="w">"</span>
			  <span class="w">"</span><span class="pc">c</span><span class="c">m_node</span><span class="w">=</span><span class="pc">%p</span> <span class="w">st</span><span class="c">ate</span> <span class="pc">=</span><span class="c">%</span><span class="pc">d\</span><span class="c">n",</span> <span class="c">cm_node</span><span class="pc">,</span> <span class="c">cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">st</span><span class="c">ate</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">send_reset</span><span class="c">(cm_node,</span> <span class="w">s</span><span class="pc">k</span><span class="c">b</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
		<span class="w">dev_kfree_skb_any</span><span class="c">(</span><span class="w">s</span><span class="pc">k</span><span class="c">b</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">rem_ref_cm_node</span><span class="c">(</span><span class="w">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">cm_core</span><span class="c">,</span> <span class="c">cm_node);</span>
	<span class="c">}</span>
<span class="w">}</span>


<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">free_retrans_entry</span><span class="c">(struct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="pc">c</span><span class="c">m_node)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">nes_timer_entry</span> <span class="c">*</span><span class="w">send_entry</span><span class="pc">;</span>

	<span class="w">s</span><span class="pc">e</span><span class="c">nd_entry</span> <span class="c">=</span> <span class="pc">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;send_entry;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(send_entry</span><span class="pc">)</span><span class="c"> {</span>
		<span class="pc">c</span><span class="c">m_node-&gt;send_entry</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>
		<span class="w">dev_kfree_skb_any</span><span class="c">(send_entry</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sk</span><span class="c">b);</span>
		<span class="w">k</span><span class="c">free(send_entry);</span>
		<span class="w">rem_ref_cm_node</span><span class="c">(cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">cm_core</span><span class="pc">,</span> <span class="pc">c</span><span class="c">m_node);</span>
	<span class="c">}</span>
<span class="pc">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">cleanup_retrans_entry</span><span class="c">(struct</span> <span class="w">nes_cm_node</span> <span class="c">*cm_node</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="c">flags;</span>

	<span class="c">spin_lock_irqsave(&amp;</span><span class="pc">cm_n</span><span class="c">ode-&gt;</span><span class="w">retrans_list_lock</span><span class="c">,</span> <span class="c">flags);</span>
	<span class="w">free_retrans_entry</span><span class="c">(cm_node);</span>
	<span class="pc">sp</span><span class="c">in_unlock_irqrestore(&amp;cm_node-&gt;</span><span class="pc">r</span><span class="c">etrans_list_lock,</span> <span class="c">flags);</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">void</span> <span class="w">process_packet</span><span class="c">(struct</span> <span class="pc">n</span><span class="c">es_cm_node</span> <span class="c">*cm_node,</span> <span class="c">struct</span> <span class="w">s</span><span class="c">k_buff</span> <span class="c">*skb,</span>
			   <span class="c">struct</span> <span class="w">nes_cm_core</span> <span class="c">*</span><span class="w">cm_core</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">e</span><span class="c">num</span> <span class="w">nes_tcpip_pkt_type</span> <span class="w">pkt_type</span> <span class="pc">=</span> <span class="w">NES_PKT_TYPE_UNKNOWN</span><span class="pc">;</span>
	<span class="c">struct</span> <span class="w">tcphdr</span> <span class="c">*</span><span class="w">tcph</span> <span class="c">=</span> <span class="w">tcp_hdr</span><span class="c">(</span><span class="pc">sk</span><span class="c">b</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">fin_set</span> <span class="pc">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="c">int</span> <span class="c">ret</span> <span class="c">=</span> <span class="c">0;</span>

	<span class="w">skb_pull</span><span class="c">(</span><span class="pc">sk</span><span class="c">b,</span> <span class="w">ip_hdr</span><span class="pc">(s</span><span class="c">kb</span><span class="w">)</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ihl</span> <span class="w">&lt;</span><span class="pc">&lt;</span> <span class="w">2</span><span class="pc">);</span>

	<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">process_packet:</span> <span class="w">cm_node=</span><span class="pc">%</span><span class="w">p</span> <span class="w">st</span><span class="pc">a</span><span class="c">te</span> <span class="pc">=</span><span class="c">%d</span> <span class="w">syn</span><span class="c">=%d</span> <span class="w">"</span>
		  <span class="w">"ack</span><span class="pc">=</span><span class="c">%d</span> <span class="w">rst</span><span class="c">=%d</span> <span class="w">fin</span><span class="c">=%d\n",</span> <span class="w">c</span><span class="pc">m</span><span class="c">_node</span><span class="pc">,</span> <span class="pc">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">s</span><span class="c">tate,</span> <span class="w">tcph-</span><span class="c">&gt;</span><span class="pc">sy</span><span class="c">n,</span>
		  <span class="w">t</span><span class="c">cph</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">a</span><span class="c">ck</span><span class="pc">,</span> <span class="c">tcph-&gt;</span><span class="pc">r</span><span class="c">st,</span> <span class="pc">t</span><span class="c">cph-&gt;</span><span class="w">f</span><span class="c">in</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(tcph-&gt;</span><span class="w">r</span><span class="c">st</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">pkt_type</span> <span class="pc">=</span> <span class="w">NES_PKT_TYPE_RST</span><span class="pc">;</span>
	<span class="c">}</span> <span class="c">else</span> <span class="pc">i</span><span class="c">f</span> <span class="c">(tcph-&gt;</span><span class="pc">s</span><span class="c">yn</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
		<span class="pc">p</span><span class="c">kt_type</span> <span class="pc">=</span> <span class="w">NES_PKT_TYPE_SYN</span><span class="pc">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(tcph-&gt;</span><span class="w">a</span><span class="c">ck</span><span class="w">)</span>
			<span class="pc">p</span><span class="c">kt_type</span> <span class="pc">=</span> <span class="w">NES_PKT_TYPE_SYNACK</span><span class="pc">;</span>
	<span class="pc">}</span> <span class="c">else</span> <span class="c">if</span> <span class="c">(tcph-&gt;</span><span class="pc">a</span><span class="c">ck</span><span class="pc">) </span><span class="c">{</span>
		<span class="pc">p</span><span class="c">kt_type</span> <span class="c">=</span> <span class="w">NES_PKT_TYPE_ACK</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(tcph-&gt;</span><span class="w">fin</span><span class="pc">)</span>
		<span class="w">fin_set</span> <span class="c">=</span> <span class="pc">1</span><span class="c">;</span>

	<span class="w">s</span><span class="c">witch</span> <span class="c">(</span><span class="pc">p</span><span class="c">kt_type) {</span>
	<span class="c">case</span> <span class="w">N</span><span class="c">ES_PKT_TYPE_SYN:</span>
		<span class="w">handle_syn_pkt</span><span class="pc">(</span><span class="w">cm_node</span><span class="c">,</span> <span class="w">s</span><span class="pc">k</span><span class="c">b,</span> <span class="c">tcph);</span>
		<span class="c">break;</span>
	<span class="c">case</span> <span class="w">NES_PKT_TYPE_SYNACK</span><span class="c">:</span>
		<span class="w">handle_synack_pkt</span><span class="c">(</span><span class="w">c</span><span class="pc">m</span><span class="c">_node</span><span class="pc">,</span> <span class="w">s</span><span class="c">kb,</span> <span class="pc">t</span><span class="c">cph);</span>
		<span class="c">break;</span>
	<span class="c">case</span> <span class="w">NES_PKT_TYPE_ACK</span><span class="c">:</span>
		<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">handle_ack_pkt</span><span class="c">(</span><span class="w">c</span><span class="c">m_node,</span> <span class="w">s</span><span class="pc">k</span><span class="c">b,</span> <span class="w">t</span><span class="c">cph);</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">fin_set</span> <span class="w">&amp;&amp;</span><span class="pc"> !</span><span class="w">r</span><span class="pc">et)</span>
			<span class="w">handle_fin_pkt</span><span class="c">(</span><span class="pc">c</span><span class="c">m_node</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="c">case</span> <span class="w">NES_PKT_TYPE_RST</span><span class="c">:</span>
		<span class="w">handle_rst_pkt</span><span class="c">(</span><span class="pc">c</span><span class="c">m_node</span><span class="pc">,</span> <span class="pc">s</span><span class="c">kb</span><span class="pc">,</span> <span class="pc">t</span><span class="c">cph);</span>
		<span class="c">break;</span>
	<span class="pc">d</span><span class="c">efault:</span>
		<span class="w">i</span><span class="c">f</span> <span class="pc">((f</span><span class="c">in_set</span><span class="w">) &amp;&amp; (!check_seq</span><span class="c">(cm_node,</span> <span class="c">tcph,</span> <span class="w">s</span><span class="pc">k</span><span class="c">b</span><span class="w">)</span><span class="pc">))</span>
			<span class="pc">h</span><span class="c">andle_fin_pkt(cm_node</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">drop_packet</span><span class="c">(</span><span class="pc">s</span><span class="c">kb</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="pc">}</span>
<span class="c">}</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">nes_cm_listener</span> <span class="c">*</span><span class="w">mini_cm_listen</span><span class="c">(struct</span> <span class="w">nes_cm_core</span> <span class="c">*</span><span class="w">cm_core</span><span class="pc">,</span>
			<span class="c">struct</span> <span class="w">nes_vnic</span> <span class="c">*</span><span class="w">nesvnic</span><span class="pc">,</span> <span class="c">struct</span> <span class="w">nes_cm_info</span> <span class="c">*</span><span class="w">cm_info</span><span class="c">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="pc">nes_cm_l</span><span class="c">istener</span> <span class="c">*</span><span class="w">listener</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">iwpm_dev_data</span> <span class="w">pm_reg_msg</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">iwpm_sa_data</span> <span class="w">pm_msg</span><span class="c">;</span>
	<span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="c">long</span> <span class="c">flags;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">iwpm_err</span> <span class="pc">=</span> <span class="c">0;</span>

	<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">Search</span> <span class="w">f</span><span class="c">or</span> <span class="w">0</span><span class="pc">x</span><span class="c">%</span><span class="pc">0</span><span class="c">8x</span> <span class="w">:</span> <span class="c">0x%</span><span class="w">0</span><span class="pc">4</span><span class="c">x\n",</span>
		  <span class="w">cm_info</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">loc_addr</span><span class="c">,</span> <span class="pc">c</span><span class="c">m_info</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">loc_port</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="w">listener</span> <span class="pc">=</span> <span class="w">find_listener</span><span class="c">(</span><span class="w">cm_core</span><span class="c">,</span> <span class="pc">c</span><span class="c">m_info</span><span class="pc">-</span><span class="c">&gt;loc_addr,</span> <span class="w">c</span><span class="c">m_info</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">loc_p</span><span class="c">ort</span><span class="pc">,</span>
				<span class="w">NES_CM_LISTENER_EITHER_STATE</span><span class="pc">,</span> <span class="w">1</span><span class="c">);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">li</span><span class="c">stener</span> <span class="w">&amp;</span><span class="pc">&amp;</span> <span class="pc">li</span><span class="c">stener-&gt;</span><span class="w">listener_state</span> <span class="w">=</span><span class="c">=</span> <span class="w">NES_CM_LISTENER_ACTIVE_STATE</span><span class="pc">) </span><span class="c">{</span>
		
		<span class="w">atomic_dec</span><span class="pc">(&amp;l</span><span class="c">istener-&gt;</span><span class="w">ref_count</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">Not</span> <span class="w">creating</span> <span class="c">listener</span> <span class="w">since</span> <span class="w">it</span> <span class="w">a</span><span class="pc">l</span><span class="c">ready</span> <span class="w">exists</span><span class="c">\n");</span>
		<span class="c">return</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!l</span><span class="c">istener</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">nes_form_reg_msg</span><span class="c">(</span><span class="w">nesvnic</span><span class="pc">, &amp;</span><span class="w">pm_reg_msg</span><span class="c">);</span>
		<span class="w">iwpm_err</span> <span class="pc">=</span> <span class="w">iwpm_register_pid</span><span class="pc">(&amp;pm</span><span class="c">_reg_msg</span><span class="pc">,</span> <span class="w">RDMA_NL_NES</span><span class="c">);</span>
		<span class="c">if</span> <span class="c">(iwpm_err) {</span>
			<span class="w">n</span><span class="pc">es_d</span><span class="c">ebug(</span><span class="w">NES_DBG_NLMSG</span><span class="pc">,</span>
			<span class="w">"Port</span> <span class="w">Mapper</span> <span class="w">reg</span> <span class="w">pi</span><span class="pc">d</span> <span class="w">fa</span><span class="pc">il</span> <span class="w">(e</span><span class="pc">r</span><span class="c">r</span> <span class="w">=</span><span class="c"> %d</span><span class="w">).\</span><span class="c">n",</span> <span class="w">i</span><span class="c">wpm_err);</span>
		<span class="pc">}</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">iwpm_valid_pid() &amp;&amp; !i</span><span class="c">wpm_err</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">nes_form_pm_msg</span><span class="c">(</span><span class="w">cm_info,</span><span class="pc"> &amp;</span><span class="w">pm_msg</span><span class="c">);</span>
			<span class="pc">iw</span><span class="c">pm_err</span> <span class="pc">=</span> <span class="w">iwpm_add_mapping</span><span class="pc">(&amp;p</span><span class="c">m_msg</span><span class="pc">,</span> <span class="w">RDMA_NL_NES</span><span class="c">);</span>
			<span class="c">if</span> <span class="c">(</span><span class="pc">i</span><span class="c">wpm_err</span><span class="w">)</span>
				<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_NLMSG</span><span class="c">,</span>
				<span class="w">"Port</span> <span class="w">Mapper</span> <span class="w">query</span> <span class="w">fa</span><span class="pc">il</span> <span class="w">(e</span><span class="pc">rr</span> <span class="w">=</span><span class="pc"> %</span><span class="c">d</span><span class="w">).\</span><span class="pc">n</span><span class="c">",</span> <span class="c">iwpm_err</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">e</span><span class="c">lse</span>
				<span class="w">nes_record_pm_msg</span><span class="c">(cm_info</span><span class="w">,</span><span class="pc"> &amp;</span><span class="c">pm_msg</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">}</span>

		
		<span class="w">listener</span> <span class="pc">=</span> <span class="w">k</span><span class="c">zalloc(sizeof</span><span class="pc">(*</span><span class="c">listener),</span> <span class="w">G</span><span class="pc">FP_A</span><span class="c">TOMIC);</span>
		<span class="c">if</span> <span class="pc">(!</span><span class="c">listener</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">n</span><span class="c">es_debug(</span><span class="w">NES_DBG_CM</span><span class="c">, "</span><span class="w">Not</span> <span class="w">creating</span> <span class="pc">l</span><span class="c">istener</span> <span class="w">m</span><span class="c">emory</span> <span class="w">allocation</span> <span class="w">f</span><span class="pc">a</span><span class="c">iled\n");</span>
			<span class="pc">r</span><span class="c">eturn</span> <span class="pc">N</span><span class="c">ULL;</span>
		<span class="c">}</span>

		<span class="w">l</span><span class="c">istener-&gt;</span><span class="w">loc_addr</span> <span class="c">=</span> <span class="pc">c</span><span class="c">m_info</span><span class="w">-</span><span class="c">&gt;loc_addr;</span>
		<span class="c">listener-&gt;</span><span class="w">loc_port</span> <span class="c">=</span> <span class="w">c</span><span class="pc">m</span><span class="c">_info-&gt;loc_port;</span>
		<span class="pc">li</span><span class="c">stener-&gt;</span><span class="w">mapped_loc_addr</span> <span class="c">=</span> <span class="c">cm_info-&gt;mapped_loc_addr;</span>
		<span class="w">l</span><span class="pc">i</span><span class="c">stener-&gt;</span><span class="w">mapped_loc_port</span> <span class="c">=</span> <span class="c">cm_info-&gt;mapped_loc_port;</span>
		<span class="c">listener-&gt;</span><span class="w">reused_node</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>

		<span class="w">a</span><span class="pc">tomic_s</span><span class="c">et(&amp;listener-&gt;</span><span class="w">ref_count</span><span class="c">,</span> <span class="w">1</span><span class="c">);</span>
	<span class="pc">}</span>
	
	
	<span class="c">else</span> <span class="c">{</span>
		<span class="w">l</span><span class="c">istener-&gt;</span><span class="w">r</span><span class="pc">eu</span><span class="c">sed_node</span> <span class="c">=</span> <span class="pc">1</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="c">listener-&gt;</span><span class="w">cm_id</span> <span class="c">=</span> <span class="pc">c</span><span class="c">m_info-&gt;cm_id;</span>
	<span class="w">at</span><span class="pc">omic_s</span><span class="c">et(&amp;listener-&gt;</span><span class="w">pend_accepts_cnt</span><span class="c">,</span> <span class="pc">0</span><span class="c">);</span>
	<span class="pc">l</span><span class="c">istener-&gt;</span><span class="w">cm_core</span> <span class="c">=</span> <span class="w">cm</span><span class="pc">_c</span><span class="c">ore;</span>
	<span class="pc">l</span><span class="c">istener-&gt;</span><span class="w">nesvnic</span> <span class="c">=</span> <span class="pc">n</span><span class="c">esvnic;</span>
	<span class="w">a</span><span class="pc">t</span><span class="c">omic_inc(&amp;</span><span class="w">c</span><span class="pc">m_c</span><span class="c">ore-&gt;</span><span class="w">node_cnt</span><span class="c">);</span>

	<span class="pc">l</span><span class="c">istener-&gt;</span><span class="w">conn_type</span> <span class="c">=</span> <span class="pc">c</span><span class="c">m_info-&gt;</span><span class="pc">c</span><span class="c">onn_type;</span>
	<span class="c">listener-&gt;</span><span class="w">backlog</span> <span class="c">=</span> <span class="pc">cm</span><span class="c">_info-&gt;backlog;</span>
	<span class="c">listener-&gt;</span><span class="w">listener_state</span> <span class="c">=</span> <span class="w">NES_CM_LISTENER_ACTIVE_STATE</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="c">listener-&gt;</span><span class="w">reused_node</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">s</span><span class="pc">p</span><span class="c">in_lock_irqsave(&amp;</span><span class="pc">c</span><span class="c">m_core-&gt;</span><span class="w">listen_list_lock</span><span class="c">,</span> <span class="c">flags);</span>
		<span class="w">list_</span><span class="pc">add</span><span class="c">(&amp;</span><span class="pc">l</span><span class="c">istener-&gt;</span><span class="pc">l</span><span class="c">ist, &amp;cm_core-&gt;</span><span class="w">listen_list.</span><span class="pc">list</span><span class="c">);</span>
		<span class="pc">s</span><span class="c">pin_unlock_irqrestore(&amp;cm_core-&gt;</span><span class="pc">li</span><span class="c">sten_list_lock,</span> <span class="c">flags);</span>
		<span class="w">a</span><span class="pc">tomic_i</span><span class="c">nc(&amp;cm_core-&gt;</span><span class="w">listen_node_cnt</span><span class="c">);</span>
	<span class="pc">}</span>

	<span class="w">nes_debug</span><span class="pc">(</span><span class="w">NES_DBG_CM,</span><span class="pc"> "</span><span class="w">Api</span> <span class="w">-</span> <span class="w">listen():</span> <span class="w">ad</span><span class="pc">dr</span><span class="w">=</span><span class="c">0x%</span><span class="w">0</span><span class="pc">8X,</span> <span class="w">p</span><span class="pc">o</span><span class="c">rt</span><span class="pc">=</span><span class="c">0x%</span><span class="pc">0</span><span class="c">4x</span><span class="w">,</span><span class="pc">"</span>
		  <span class="w">"</span> <span class="w">listener</span> <span class="w">=</span><span class="pc"> </span><span class="c">%</span><span class="pc">p,</span> <span class="w">backlog</span> <span class="pc">= </span><span class="c">%d</span><span class="pc">,</span> <span class="w">cm_id</span> <span class="w">=</span><span class="pc"> </span><span class="c">%</span><span class="pc">p</span><span class="w">.</span><span class="c">\n",</span>
		  <span class="w">cm_info</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">loc_addr</span><span class="c">,</span> <span class="c">cm_info</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">loc_port</span><span class="c">,</span>
		  <span class="w">l</span><span class="pc">istene</span><span class="c">r</span><span class="pc">,</span> <span class="w">l</span><span class="pc">i</span><span class="c">stener</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">b</span><span class="c">acklog,</span> <span class="w">l</span><span class="pc">i</span><span class="c">stener-&gt;</span><span class="pc">cm_id)</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">l</span><span class="c">istener</span><span class="pc">;</span>
<span class="c">}</span>



<span class="pc">s</span><span class="c">tatic</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="w">mini_cm_connect</span><span class="c">(struct</span> <span class="w">nes_cm_core</span> <span class="c">*</span><span class="w">cm_core</span><span class="c">,</span>
					   <span class="c">struct</span> <span class="w">nes_vnic</span> <span class="c">*</span><span class="w">nesvnic</span><span class="c">,</span> <span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="w">private_data_len</span><span class="c">,</span>
					   <span class="w">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">pr</span><span class="pc">ivate_data</span><span class="c">,</span> <span class="c">struct</span> <span class="w">nes_cm_info</span> <span class="c">*</span><span class="w">cm_info</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">r</span><span class="c">et</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="pc">nes_cm_n</span><span class="c">ode</span> <span class="c">*</span><span class="w">cm_node</span><span class="pc">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">nes_cm_listener</span> <span class="c">*</span><span class="w">loopbackremotelistener</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">n</span><span class="pc">es_cm_n</span><span class="c">ode</span> <span class="c">*</span><span class="w">loopbackremotenode</span><span class="c">;</span>
	<span class="c">struct</span> <span class="pc">n</span><span class="c">es_cm_info</span> <span class="w">loopback_cm_info</span><span class="c">;</span>
	<span class="w">u</span><span class="pc">8</span> <span class="c">*</span><span class="w">start_buff</span><span class="c">;</span>

	
	<span class="w">c</span><span class="pc">m_n</span><span class="c">ode</span> <span class="pc">=</span> <span class="w">make_cm_node</span><span class="pc">(</span><span class="w">cm_core</span><span class="c">,</span> <span class="w">nesvnic</span><span class="pc">,</span> <span class="w">c</span><span class="pc">m_i</span><span class="c">nfo</span><span class="pc">,</span> <span class="w">N</span><span class="c">ULL);</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">c</span><span class="pc">m_n</span><span class="c">ode</span><span class="pc">)</span>
		<span class="c">return</span> <span class="pc">N</span><span class="c">ULL;</span>

	
	<span class="w">c</span><span class="pc">m_n</span><span class="c">ode</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">tcp_cntxt</span><span class="pc">.</span><span class="w">cl</span><span class="pc">i</span><span class="c">ent</span> <span class="c">=</span> <span class="w">1</span><span class="c">;</span>
	<span class="pc">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;tcp_cntxt.</span><span class="w">rcv_wscale</span> <span class="c">=</span> <span class="w">NES_CM_DEFAULT_RCV_WND_SCALE</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">cm_i</span><span class="c">nfo-&gt;</span><span class="w">loc_addr</span> <span class="pc">=</span><span class="c">=</span> <span class="w">c</span><span class="pc">m_i</span><span class="c">nfo</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">rem_addr</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">loopbackremotelistener</span> <span class="pc">=</span> <span class="w">find_listener</span><span class="pc">(</span><span class="w">cm_core</span><span class="c">,</span>
			<span class="pc">cm_n</span><span class="c">ode-&gt;</span><span class="w">mapped_loc_addr</span><span class="c">,</span> <span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">mapped_rem_port</span><span class="c">,</span>
			<span class="w">NES_CM_LISTENER_ACTIVE_STATE</span><span class="pc">,</span> <span class="pc">0</span><span class="c">);</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">l</span><span class="c">oopbackremotelistener</span> <span class="pc">=</span><span class="c">=</span> <span class="c">NULL</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">create_event</span><span class="c">(cm_node,</span> <span class="w">NES_CM_EVENT_ABORTED</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">}</span> <span class="c">else</span> <span class="c">{</span>
			<span class="w">loopback_cm_info</span> <span class="w">= *</span><span class="pc">cm_i</span><span class="c">nfo;</span>
			<span class="pc">l</span><span class="c">oopback_cm_info</span><span class="w">.loc_port</span> <span class="c">=</span> <span class="w">c</span><span class="pc">m_i</span><span class="c">nfo</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">rem_port</span><span class="c">;</span>
			<span class="pc">l</span><span class="c">oopback_cm_info</span><span class="pc">.r</span><span class="c">em_port</span> <span class="c">=</span> <span class="w">c</span><span class="pc">m_i</span><span class="c">nfo</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">loc</span><span class="c">_port</span><span class="pc">;</span>
			<span class="pc">l</span><span class="c">oopback_cm_info</span><span class="pc">.</span><span class="w">mapped_loc_port</span> <span class="c">=</span>
				<span class="w">c</span><span class="pc">m_i</span><span class="c">nfo</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">mapped_rem_port</span><span class="c">;</span>
			<span class="pc">l</span><span class="c">oopback_cm_info</span><span class="pc">.m</span><span class="c">apped_rem_port</span> <span class="c">=</span>
				<span class="c">cm_info-&gt;</span><span class="pc">mapped_l</span><span class="c">oc_port</span><span class="pc">;</span>
			<span class="c">loopback_cm_info</span><span class="pc">.</span><span class="w">cm_id</span> <span class="c">=</span> <span class="w">loopbackremotelistener</span><span class="pc">-</span><span class="c">&gt;cm_id;</span>
			<span class="w">loopbackremotenode</span> <span class="pc">=</span> <span class="w">make_cm_node</span><span class="pc">(</span><span class="w">cm_core</span><span class="c">,</span> <span class="w">nesvnic</span><span class="pc">,</span>
							  <span class="w">&amp;</span><span class="pc">l</span><span class="c">oopback_cm_info</span><span class="pc">,</span> <span class="w">l</span><span class="pc">oopbackremotel</span><span class="c">istener</span><span class="pc">)</span><span class="c">;</span>
			<span class="c">if</span> <span class="pc">(!loopbackr</span><span class="c">emotenode</span><span class="pc">) </span><span class="c">{</span>
				<span class="w">rem_ref_cm_node</span><span class="c">(</span><span class="w">cm_node-</span><span class="c">&gt;</span><span class="pc">c</span><span class="c">m_core,</span> <span class="w">c</span><span class="pc">m_n</span><span class="c">ode);</span>
				<span class="pc">r</span><span class="c">eturn</span> <span class="w">N</span><span class="c">ULL;</span>
			<span class="c">}</span>
			<span class="w">at</span><span class="pc">omic_i</span><span class="c">nc(&amp;</span><span class="w">cm_loopbacks</span><span class="c">);</span>
			<span class="pc">l</span><span class="c">oopbackremotenode-&gt;</span><span class="w">loopbackpartner</span> <span class="c">=</span> <span class="pc">cm_n</span><span class="c">ode;</span>
			<span class="pc">l</span><span class="c">oopbackremotenode-&gt;</span><span class="w">tcp_cntxt</span><span class="pc">.</span><span class="w">rcv_wscale</span> <span class="c">=</span>
				<span class="w">NES_CM_DEFAULT_RCV_WND_SCALE</span><span class="c">;</span>
			<span class="pc">c</span><span class="c">m_node-&gt;</span><span class="pc">loopbackp</span><span class="c">artner</span> <span class="pc">=</span> <span class="pc">l</span><span class="c">oopbackremotenode</span><span class="pc">;</span>
			<span class="w">m</span><span class="c">emcpy(</span><span class="pc">l</span><span class="c">oopbackremotenode-&gt;</span><span class="w">mpa_frame_buf</span><span class="c">,</span> <span class="w">pri</span><span class="pc">va</span><span class="c">te_data</span><span class="pc">,</span>
			       <span class="w">private_data_len</span><span class="c">);</span>
			<span class="c">loopbackremotenode-&gt;</span><span class="w">mpa_frame_size</span> <span class="c">=</span> <span class="w">p</span><span class="c">rivate_data_len</span><span class="pc">;</span>

			
			
			<span class="w">c</span><span class="pc">m_n</span><span class="c">ode-&gt;</span><span class="w">s</span><span class="pc">t</span><span class="c">ate</span> <span class="c">=</span> <span class="w">NES_CM_STATE_TSA</span><span class="c">;</span>
			<span class="w">c</span><span class="c">m_node-&gt;</span><span class="w">t</span><span class="c">cp_cntxt</span><span class="pc">.</span><span class="w">rcv_nxt</span> <span class="c">=</span>
				<span class="w">l</span><span class="c">oopbackremotenode-&gt;</span><span class="pc">t</span><span class="c">cp_cntxt</span><span class="pc">.</span><span class="w">loc_seq_num</span><span class="c">;</span>
			<span class="w">l</span><span class="c">oopbackremotenode-&gt;tcp_cntxt</span><span class="pc">.r</span><span class="c">cv_nxt</span> <span class="c">=</span>
				<span class="pc">c</span><span class="c">m_node-&gt;</span><span class="pc">t</span><span class="c">cp_cntxt</span><span class="pc">.</span><span class="w">l</span><span class="pc">oc</span><span class="c">_seq_num</span><span class="pc">;</span>
			<span class="pc">c</span><span class="c">m_node-&gt;tcp_cntxt.</span><span class="w">max_snd_wnd</span> <span class="c">=</span>
				<span class="c">loopbackremotenode-&gt;tcp_cntxt.</span><span class="w">rcv_wnd</span><span class="c">;</span>
			<span class="pc">l</span><span class="c">oopbackremotenode-&gt;tcp_cntxt.</span><span class="w">m</span><span class="c">ax_snd_wnd</span> <span class="c">=</span>
				<span class="pc">c</span><span class="c">m_node-&gt;tcp_cntxt.</span><span class="w">r</span><span class="pc">cv_w</span><span class="c">nd</span><span class="pc">;</span>
			<span class="pc">c</span><span class="c">m_node-&gt;tcp_cntxt.</span><span class="w">snd_wnd</span> <span class="c">=</span>
				<span class="pc">l</span><span class="c">oopbackremotenode-&gt;tcp_cntxt.</span><span class="pc">r</span><span class="c">cv_wnd</span><span class="pc">;</span>
			<span class="pc">l</span><span class="c">oopbackremotenode-&gt;tcp_cntxt.</span><span class="w">s</span><span class="c">nd_wnd</span> <span class="c">=</span>
				<span class="pc">c</span><span class="c">m_node-&gt;tcp_cntxt.rcv_wnd</span><span class="pc">;</span>
			<span class="pc">c</span><span class="c">m_node-&gt;tcp_cntxt.</span><span class="w">snd_wscale</span> <span class="c">=</span>
				<span class="pc">l</span><span class="c">oopbackremotenode-&gt;tcp_cntxt.</span><span class="w">rcv_wscale</span><span class="c">;</span>
			<span class="pc">l</span><span class="c">oopbackremotenode-&gt;tcp_cntxt.</span><span class="w">s</span><span class="pc">nd_ws</span><span class="c">cale</span> <span class="c">=</span>
				<span class="pc">c</span><span class="c">m_node-&gt;tcp_cntxt.</span><span class="w">r</span><span class="pc">cv_ws</span><span class="c">cale</span><span class="pc">;</span>
			<span class="c">loopbackremotenode-&gt;</span><span class="w">st</span><span class="pc">ate</span> <span class="pc">=</span> <span class="w">NES_CM_STATE_MPAREQ_RCVD</span><span class="c">;</span>
			<span class="w">create_event</span><span class="c">(</span><span class="pc">l</span><span class="c">oopbackremotenode</span><span class="pc">,</span> <span class="w">NES_CM_EVENT_MPA_REQ</span><span class="c">);</span>
		<span class="pc">}</span>
		<span class="w">r</span><span class="c">eturn</span> <span class="pc">c</span><span class="c">m_node;</span>
	<span class="c">}</span>

	<span class="w">start_buff</span> <span class="w">=</span><span class="pc"> &amp;</span><span class="w">c</span><span class="pc">m</span><span class="c">_node-&gt;</span><span class="w">mpa_frame_buf</span><span class="pc">[</span><span class="c">0</span><span class="w">] +</span> <span class="w">s</span><span class="pc">i</span><span class="c">zeof(struct</span> <span class="w">ietf_mpa_v2</span><span class="pc">);</span>
	<span class="w">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">mpa_frame_size</span> <span class="c">=</span> <span class="w">private_data_len</span><span class="c">;</span>

	<span class="w">m</span><span class="pc">e</span><span class="c">mcpy(</span><span class="pc">s</span><span class="c">tart_buff</span><span class="pc">,</span> <span class="w">priv</span><span class="pc">ate_data</span><span class="c">,</span> <span class="w">p</span><span class="c">rivate_data_len</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="w">c</span><span class="pc">m</span><span class="c">_node-&gt;</span><span class="w">s</span><span class="pc">tate</span> <span class="c">=</span> <span class="w">NES_CM_STATE_SYN_SENT</span><span class="c">;</span>
	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">send_syn</span><span class="c">(</span><span class="pc">c</span><span class="c">m_node,</span> <span class="w">0</span><span class="c">,</span> <span class="w">N</span><span class="c">ULL);</span>

	<span class="c">if</span> <span class="c">(ret</span><span class="pc">) </span><span class="c">{</span>
		
		<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">Api</span> <span class="w">-</span> <span class="w">connect(</span><span class="pc">)</span> <span class="w">FAILED:</span> <span class="w">des</span><span class="pc">t</span> <span class="w">"</span>
			  <span class="w">"ad</span><span class="pc">dr</span><span class="w">=</span><span class="c">0x%</span><span class="w">0</span><span class="pc">8X,</span> <span class="w">po</span><span class="c">rt</span><span class="w">=</span><span class="c">0x%</span><span class="pc">04</span><span class="c">x,</span> <span class="c">cm_node</span><span class="w">=</span><span class="pc">%p</span><span class="c">,</span> <span class="w">cm_id</span> <span class="pc">= </span><span class="c">%</span><span class="pc">p</span><span class="w">.</span><span class="pc">\</span><span class="c">n",</span>
			  <span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">rem_addr</span><span class="c">,</span> <span class="w">c</span><span class="pc">m</span><span class="c">_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">rem_port</span><span class="c">,</span> <span class="w">c</span><span class="pc">m_n</span><span class="c">ode</span><span class="pc">,</span>
			  <span class="c">cm_node-&gt;</span><span class="pc">c</span><span class="c">m_id</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">rem_ref_cm_node</span><span class="c">(</span><span class="pc">cm_n</span><span class="c">ode</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">cm_core</span><span class="c">,</span> <span class="c">cm_node</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">c</span><span class="c">m_node</span> <span class="pc">=</span> <span class="w">N</span><span class="c">ULL;</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(cm_node</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">Api</span> <span class="w">-</span> <span class="w">connect():</span> <span class="w">des</span><span class="pc">t</span> <span class="w">ad</span><span class="pc">dr</span><span class="w">=</span><span class="c">0x%</span><span class="w">0</span><span class="pc">8X</span><span class="w">,</span><span class="pc">"</span>
			  <span class="w">"p</span><span class="pc">o</span><span class="c">rt</span><span class="pc">=0x</span><span class="c">%</span><span class="pc">04</span><span class="c">x,</span> <span class="c">cm_node</span><span class="w">=</span><span class="c">%</span><span class="pc">p</span><span class="c">,</span> <span class="w">cm_id</span> <span class="w">=</span><span class="pc"> </span><span class="c">%</span><span class="pc">p</span><span class="w">.</span><span class="pc">\</span><span class="c">n",</span>
			  <span class="pc">cm_n</span><span class="c">ode-&gt;</span><span class="w">rem_addr</span><span class="c">,</span> <span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">rem_port</span><span class="c">,</span> <span class="w">c</span><span class="pc">m_n</span><span class="c">ode</span><span class="pc">,</span>
			  <span class="c">cm_node-&gt;</span><span class="pc">c</span><span class="c">m_id</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">}</span>

	<span class="w">r</span><span class="c">eturn</span> <span class="pc">c</span><span class="c">m_node</span><span class="pc">;</span>
<span class="c">}</span>



<span class="c">static</span> <span class="c">int</span> <span class="w">mini_cm_accept</span><span class="c">(struct</span> <span class="w">nes_cm_core</span> <span class="c">*</span><span class="w">cm_core</span><span class="c">,</span> <span class="c">struct</span> <span class="w">nes_cm_node</span> <span class="c">*cm_node</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">0</span><span class="c">;</span>
<span class="c">}</span>



<span class="c">static</span> <span class="c">int</span> <span class="w">mini_cm_reject</span><span class="c">(struct</span> <span class="pc">n</span><span class="c">es_cm_core</span> <span class="c">*cm_core</span><span class="pc">,</span> <span class="c">struct</span> <span class="pc">n</span><span class="c">es_cm_node</span> <span class="c">*cm_node)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">r</span><span class="c">et</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="pc">e</span><span class="c">rr</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">passive_state</span><span class="pc">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">nes_cm_event</span> <span class="w">e</span><span class="pc">vent</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">iw_cm_id</span> <span class="c">*</span><span class="w">cm_id</span> <span class="pc">=</span> <span class="w">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;cm_id;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="pc">nes_cm_n</span><span class="c">ode</span> <span class="c">*</span><span class="w">loopback</span> <span class="c">=</span> <span class="pc">cm_n</span><span class="c">ode-&gt;</span><span class="w">loopbackpartner</span><span class="c">;</span>

	<span class="w">nes_debug</span><span class="pc">(</span><span class="w">NES_DBG_CM,</span><span class="pc"> "%</span><span class="c">s</span> <span class="w">c</span><span class="pc">m_n</span><span class="c">ode</span><span class="pc">=</span><span class="c">%</span><span class="pc">p</span> <span class="w">ty</span><span class="c">pe=%d</span> <span class="w">st</span><span class="c">ate</span><span class="pc">=</span><span class="c">%d\n",</span>
		  <span class="c">__func__,</span> <span class="pc">c</span><span class="c">m_node</span><span class="pc">,</span> <span class="w">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">tcp_cntxt</span><span class="pc">.</span><span class="w">cli</span><span class="c">ent,</span> <span class="c">cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s</span><span class="c">tate</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(cm_node-&gt;</span><span class="pc">t</span><span class="c">cp_cntxt</span><span class="pc">.</span><span class="w">cl</span><span class="pc">i</span><span class="c">ent</span><span class="pc">)</span>
		<span class="c">return</span> <span class="w">r</span><span class="c">et;</span>
	<span class="w">cleanup_retrans_entry</span><span class="c">(</span><span class="pc">c</span><span class="c">m_node</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">loopback</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">passive_state</span> <span class="pc">=</span> <span class="w">atomic_add_return</span><span class="c">(</span><span class="w">1</span><span class="pc">, &amp;c</span><span class="c">m_node-&gt;passive_state);</span>
		<span class="c">if</span> <span class="c">(passive_state</span> <span class="pc">=</span><span class="c">=</span> <span class="w">NES_SEND_RESET_EVENT</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">c</span><span class="c">m_node-&gt;</span><span class="w">s</span><span class="c">tate</span> <span class="c">=</span> <span class="w">NES_CM_STATE_CLOSED</span><span class="c">;</span>
			<span class="w">rem_ref_cm_node</span><span class="c">(</span><span class="w">cm_core</span><span class="pc">,</span> <span class="pc">c</span><span class="c">m_node);</span>
		<span class="pc">}</span> <span class="c">else</span> <span class="c">{</span>
			<span class="c">if</span> <span class="c">(</span><span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">s</span><span class="pc">tate</span> <span class="c">==</span> <span class="w">NES_CM_STATE_LISTENER_DESTROYED</span><span class="c">) {</span>
				<span class="w">r</span><span class="pc">em</span><span class="c">_ref_cm_node</span><span class="pc">(cm_c</span><span class="c">ore</span><span class="pc">,</span> <span class="c">cm_node);</span>
			<span class="c">}</span> <span class="c">else</span> <span class="c">{</span>
				<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">send_mpa_reject</span><span class="c">(</span><span class="pc">c</span><span class="c">m_node</span><span class="pc">)</span><span class="c">;</span>
				<span class="c">if</span> <span class="c">(ret</span><span class="pc">) </span><span class="c">{</span>
					<span class="w">c</span><span class="pc">m_n</span><span class="c">ode</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">s</span><span class="c">tate</span> <span class="c">=</span> <span class="w">NES_CM_STATE_CLOSED</span><span class="c">;</span>
					<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="w">send_reset</span><span class="c">(cm_node</span><span class="pc">,</span> <span class="w">N</span><span class="pc">U</span><span class="c">LL);</span>
					<span class="c">if</span> <span class="c">(</span><span class="pc">e</span><span class="c">rr</span><span class="pc">)</span>
						<span class="w">W</span><span class="c">ARN_ON(</span><span class="w">1</span><span class="pc">);</span>
				<span class="w">}</span> <span class="c">else</span> <span class="pc">{</span>
					<span class="w">cm_id</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">add_ref(c</span><span class="pc">m_i</span><span class="c">d</span><span class="pc">)</span><span class="c">;</span>
				<span class="pc">}</span>
			<span class="pc">}</span>
		<span class="pc">}</span>
	<span class="w">}</span> <span class="w">e</span><span class="c">lse</span> <span class="c">{</span>
		<span class="pc">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">cm_i</span><span class="c">d</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">cm_n</span><span class="c">ode-&gt;</span><span class="w">s</span><span class="pc">tate</span> <span class="pc">=</span><span class="c">=</span> <span class="w">NES_CM_STATE_LISTENER_DESTROYED</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">rem_ref_cm_node</span><span class="c">(</span><span class="w">cm_core</span><span class="pc">,</span> <span class="pc">c</span><span class="c">m_node</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">r</span><span class="pc">em</span><span class="c">_ref_cm_node</span><span class="pc">(</span><span class="w">c</span><span class="pc">m_c</span><span class="c">ore</span><span class="pc">,</span> <span class="w">loopback</span><span class="c">);</span>
		<span class="c">}</span> <span class="c">else</span> <span class="c">{</span>
			<span class="w">ev</span><span class="c">ent</span><span class="w">.</span><span class="c">cm_node</span> <span class="c">=</span> <span class="w">l</span><span class="c">oopback;</span>
			<span class="w">ev</span><span class="c">ent</span><span class="pc">.</span><span class="w">cm_info</span><span class="pc">.</span><span class="w">rem_addr</span> <span class="c">=</span> <span class="w">l</span><span class="c">oopback</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">r</span><span class="c">em_addr;</span>
			<span class="w">ev</span><span class="pc">e</span><span class="c">nt.</span><span class="pc">c</span><span class="c">m_info</span><span class="pc">.</span><span class="w">loc_addr</span> <span class="c">=</span> <span class="pc">l</span><span class="c">oopback</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">l</span><span class="c">oc_addr;</span>
			<span class="w">ev</span><span class="pc">e</span><span class="c">nt</span><span class="pc">.c</span><span class="c">m_info</span><span class="pc">.</span><span class="w">rem_port</span> <span class="c">=</span> <span class="pc">l</span><span class="c">oopback</span><span class="pc">-</span><span class="c">&gt;rem_port</span><span class="pc">;</span>
			<span class="w">ev</span><span class="c">ent.</span><span class="pc">c</span><span class="c">m_info</span><span class="pc">.</span><span class="w">loc_port</span> <span class="c">=</span> <span class="pc">l</span><span class="c">oopback-&gt;loc_port;</span>
			<span class="w">ev</span><span class="pc">e</span><span class="c">nt.cm_info.</span><span class="w">cm_id</span> <span class="c">=</span> <span class="c">loopback-&gt;cm_id;</span>
			<span class="w">cm_event_mpa_reject</span><span class="pc">(&amp;</span><span class="w">e</span><span class="c">vent</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">rem_ref_cm_node</span><span class="pc">(</span><span class="w">cm_core</span><span class="pc">,</span> <span class="w">cm_node</span><span class="c">);</span>
			<span class="w">l</span><span class="c">oopback-&gt;</span><span class="w">s</span><span class="pc">tate</span> <span class="pc">=</span> <span class="w">NES_CM_STATE_CLOSING</span><span class="c">;</span>

			<span class="w">c</span><span class="pc">m_id</span> <span class="pc">=</span> <span class="pc">l</span><span class="c">oopback-&gt;</span><span class="w">c</span><span class="pc">m_id</span><span class="c">;</span>
			<span class="w">r</span><span class="c">em_ref_cm_node</span><span class="pc">(cm_c</span><span class="c">ore</span><span class="pc">,</span> <span class="c">loopback);</span>
			<span class="w">c</span><span class="pc">m_id</span><span class="c">-&gt;</span><span class="w">rem_ref(</span><span class="pc">cm_id</span><span class="c">);</span>
		<span class="pc">}</span>
	<span class="pc">}</span>

	<span class="w">r</span><span class="c">eturn</span> <span class="w">r</span><span class="c">et;</span>
<span class="c">}</span>



<span class="c">static</span> <span class="c">int</span> <span class="w">mini_cm_close</span><span class="c">(struct</span> <span class="w">nes_cm_core</span> <span class="c">*</span><span class="w">c</span><span class="pc">m_c</span><span class="c">ore,</span> <span class="c">struct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="w">cm_node</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">ret</span> <span class="pc">=</span> <span class="c">0;</span>

	<span class="c">if</span> <span class="pc">(!cm_c</span><span class="c">ore</span> <span class="pc">|</span><span class="c">| !</span><span class="pc">c</span><span class="c">m_node</span><span class="pc">)</span>
		<span class="c">return</span> <span class="c">-EINVAL;</span>

	<span class="w">s</span><span class="c">witch</span> <span class="c">(cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">s</span><span class="c">tate) {</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_SYN_RCVD</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_SYN_SENT</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_ONE_SIDE_ESTABLISHED</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_ESTABLISHED</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_ACCEPTING</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_MPAREQ_SENT</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_MPAREQ_RCVD</span><span class="c">:</span>
		<span class="w">cleanup_retrans_entry</span><span class="pc">(c</span><span class="c">m_node);</span>
		<span class="w">send_reset</span><span class="pc">(</span><span class="c">cm_node</span><span class="pc">,</span> <span class="w">NU</span><span class="c">LL);</span>
		<span class="c">break;</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_CLOSE_WAIT</span><span class="c">:</span>
		<span class="w">c</span><span class="pc">m</span><span class="c">_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">st</span><span class="c">ate</span> <span class="c">=</span> <span class="w">NES_CM_STATE_LAST_ACK</span><span class="c">;</span>
		<span class="w">send_fin</span><span class="c">(cm_node</span><span class="pc">,</span> <span class="w">NU</span><span class="c">LL);</span>
		<span class="c">break;</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_FIN_WAIT1</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_FIN_WAIT2</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">N</span><span class="c">ES_CM_STATE_LAST_ACK:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_TIME_WAIT</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_CLOSING</span><span class="c">:</span>
		<span class="w">re</span><span class="pc">t</span> <span class="pc">= </span><span class="c">-</span><span class="pc">1</span><span class="c">;</span>
		<span class="c">break;</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_LISTENING</span><span class="c">:</span>
		<span class="w">cleanup_retrans_entry</span><span class="pc">(c</span><span class="c">m_node);</span>
		<span class="w">send_reset</span><span class="c">(</span><span class="pc">c</span><span class="c">m_node</span><span class="pc">,</span> <span class="w">N</span><span class="pc">U</span><span class="c">LL);</span>
		<span class="c">break;</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_MPAREJ_RCVD</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_UNKNOWN</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_INITED</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_CLOSED</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_LISTENER_DESTROYED</span><span class="c">:</span>
		<span class="w">r</span><span class="pc">et</span> <span class="pc">=</span> <span class="w">rem_ref_cm_node</span><span class="c">(</span><span class="w">cm_core</span><span class="c">,</span> <span class="pc">c</span><span class="c">m_node);</span>
		<span class="c">break;</span>
	<span class="c">case</span> <span class="w">NES_CM_STATE_TSA</span><span class="c">:</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">cm_n</span><span class="c">ode-&gt;</span><span class="w">send_entry</span><span class="pc">)</span>
			<span class="w">p</span><span class="c">rintk(</span><span class="pc">KERN_E</span><span class="c">RR</span> <span class="c">"</span><span class="w">ER</span><span class="c">ROR</span> <span class="w">Close</span> <span class="w">got</span> <span class="w">called</span> <span class="w">f</span><span class="pc">r</span><span class="c">om</span> <span class="w">STATE_TSA</span> <span class="pc">"</span>
			       <span class="c">"</span><span class="w">s</span><span class="pc">e</span><span class="c">nd_entry</span><span class="w">=</span><span class="c">%</span><span class="w">p</span><span class="c">\n",</span> <span class="pc">cm_n</span><span class="c">ode-&gt;</span><span class="pc">s</span><span class="c">end_entry);</span>
		<span class="w">r</span><span class="pc">et</span> <span class="pc">=</span> <span class="w">rem_ref_cm_node</span><span class="c">(</span><span class="w">cm_core</span><span class="c">,</span> <span class="c">cm_node</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="pc">}</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">r</span><span class="c">et;</span>
<span class="c">}</span>



<span class="c">static</span> <span class="c">int</span> <span class="w">mini_cm_recv_pkt</span><span class="c">(struct</span> <span class="w">nes_cm_core</span> <span class="c">*</span><span class="w">c</span><span class="pc">m_c</span><span class="c">ore,</span>
			    <span class="c">struct</span> <span class="w">nes_vnic</span> <span class="c">*</span><span class="w">nesvnic</span><span class="pc">,</span> <span class="c">struct</span> <span class="w">s</span><span class="pc">k</span><span class="c">_buff</span> <span class="c">*skb</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="w">c</span><span class="pc">m_n</span><span class="c">ode</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="c">struct</span> <span class="w">nes_cm_listener</span> <span class="c">*</span><span class="w">listener</span> <span class="pc">=</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="c">struct</span> <span class="w">iphdr</span> <span class="c">*</span><span class="w">ip</span><span class="pc">h;</span>
	<span class="c">struct</span> <span class="w">tcphdr</span> <span class="c">*</span><span class="w">tcph</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">nes_cm_info</span> <span class="w">nfo</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">skb_handled</span> <span class="pc">=</span> <span class="pc">1</span><span class="c">;</span>
	<span class="w">_</span><span class="pc">_be3</span><span class="c">2</span> <span class="w">tmp_daddr</span><span class="pc">,</span> <span class="w">tmp_saddr</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(!</span><span class="w">s</span><span class="pc">kb)</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(</span><span class="w">s</span><span class="pc">kb</span><span class="c">-&gt;</span><span class="pc">l</span><span class="c">en</span> <span class="w">&lt;</span> <span class="pc">s</span><span class="c">izeof(struct</span> <span class="w">i</span><span class="c">phdr</span><span class="w">)</span><span class="pc"> +</span> <span class="c">sizeof</span><span class="pc">(</span><span class="c">struct</span> <span class="w">t</span><span class="pc">cphd</span><span class="c">r))</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>

	<span class="w">ip</span><span class="pc">h</span> <span class="pc">= </span><span class="c">(struct</span> <span class="c">iphdr</span> <span class="c">*)skb-&gt;</span><span class="pc">d</span><span class="c">ata;</span>
	<span class="w">tcph</span> <span class="pc">= </span><span class="c">(</span><span class="pc">st</span><span class="c">ruct</span> <span class="w">t</span><span class="pc">c</span><span class="c">phdr</span> <span class="pc">*)(</span><span class="c">skb-&gt;</span><span class="pc">d</span><span class="c">ata</span> <span class="pc">+</span> <span class="pc">si</span><span class="c">zeof(struct</span> <span class="pc">i</span><span class="c">phdr</span><span class="w">))</span><span class="pc">;</span>

	<span class="w">nfo.loc_addr</span> <span class="c">=</span> <span class="w">ntohl</span><span class="c">(</span><span class="w">ip</span><span class="pc">h</span><span class="c">-&gt;</span><span class="w">d</span><span class="pc">ad</span><span class="c">dr</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">n</span><span class="c">fo</span><span class="pc">.</span><span class="w">loc_port</span> <span class="c">=</span> <span class="w">n</span><span class="pc">tohs</span><span class="c">(</span><span class="w">t</span><span class="pc">cph</span><span class="c">-&gt;</span><span class="w">de</span><span class="pc">st)</span><span class="c">;</span>
	<span class="pc">n</span><span class="c">fo</span><span class="pc">.</span><span class="w">rem_addr</span> <span class="c">=</span> <span class="w">n</span><span class="pc">t</span><span class="c">ohl</span><span class="pc">(</span><span class="w">ip</span><span class="pc">h</span><span class="c">-&gt;</span><span class="w">s</span><span class="pc">a</span><span class="c">ddr</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">nfo</span><span class="pc">.</span><span class="w">rem_port</span> <span class="c">=</span> <span class="w">n</span><span class="pc">tohs</span><span class="c">(</span><span class="pc">t</span><span class="c">cph-&gt;</span><span class="w">so</span><span class="pc">u</span><span class="c">rce</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="c">nfo</span><span class="pc">.</span><span class="w">mapped_loc_addr</span> <span class="c">=</span> <span class="c">ntohl</span><span class="pc">(</span><span class="w">ip</span><span class="c">h-&gt;</span><span class="w">d</span><span class="c">addr);</span>
	<span class="c">nfo</span><span class="pc">.</span><span class="w">mapped_loc_port</span> <span class="c">=</span> <span class="w">n</span><span class="pc">tohs</span><span class="c">(tcph-&gt;</span><span class="w">de</span><span class="pc">st)</span><span class="c">;</span>
	<span class="c">nfo</span><span class="pc">.</span><span class="w">mapped_rem_addr</span> <span class="c">=</span> <span class="c">ntohl</span><span class="pc">(</span><span class="w">ip</span><span class="c">h-&gt;</span><span class="w">s</span><span class="pc">a</span><span class="c">ddr);</span>
	<span class="c">nfo</span><span class="pc">.</span><span class="w">mapped_rem_port</span> <span class="c">=</span> <span class="w">n</span><span class="pc">tohs</span><span class="c">(tcph-&gt;</span><span class="w">so</span><span class="c">urce</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">tmp_daddr</span> <span class="pc">=</span> <span class="w">c</span><span class="c">pu_to_be32(</span><span class="w">i</span><span class="pc">p</span><span class="c">h-&gt;</span><span class="pc">d</span><span class="c">addr);</span>
	<span class="w">tmp_saddr</span> <span class="pc">=</span> <span class="w">c</span><span class="c">pu_to_be32(</span><span class="w">i</span><span class="c">ph-&gt;saddr);</span>

	<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM,</span><span class="pc"> "</span><span class="w">Received</span> <span class="w">p</span><span class="pc">a</span><span class="c">cket</span><span class="w">:</span> <span class="w">des</span><span class="pc">t=</span><span class="c">%</span><span class="w">pI4</span><span class="pc">:0</span><span class="c">x%</span><span class="w">04X</span> <span class="w">sr</span><span class="c">c</span><span class="w">=</span><span class="c">%</span><span class="w">p</span><span class="pc">I</span><span class="c">4</span><span class="w">:</span><span class="c">0x%</span><span class="w">04</span><span class="pc">X</span><span class="c">\n",</span>
		  <span class="w">&amp;tmp_daddr,</span> <span class="w">tcph-</span><span class="c">&gt;</span><span class="w">d</span><span class="pc">e</span><span class="c">st</span><span class="w">,</span><span class="pc"> &amp;</span><span class="c">tmp_saddr</span><span class="pc">,</span> <span class="pc">t</span><span class="c">cph</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">so</span><span class="c">urce</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">do</span> <span class="c">{</span>
		<span class="w">cm_node</span> <span class="pc">=</span> <span class="w">find_node</span><span class="c">(</span><span class="w">cm_core</span><span class="c">,</span>
				    <span class="w">nfo.mapped_rem_port</span><span class="c">,</span> <span class="w">n</span><span class="c">fo</span><span class="w">.mapped_rem_addr</span><span class="pc">,</span>
				    <span class="c">nfo</span><span class="pc">.</span><span class="w">mapped_loc_port</span><span class="pc">,</span> <span class="c">nfo</span><span class="pc">.</span><span class="w">mapped_loc_addr</span><span class="pc">)</span><span class="c">;</span>

		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="c">cm_node</span><span class="pc">) </span><span class="c">{</span>
			
			
			<span class="w">i</span><span class="c">f</span> <span class="w">((!</span><span class="pc">t</span><span class="c">cph</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">syn) |</span><span class="pc">| </span><span class="c">(</span><span class="w">t</span><span class="c">cph</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ack</span><span class="pc">)</span><span class="c">) {</span>
				<span class="w">skb_handled</span> <span class="pc">=</span> <span class="pc">0</span><span class="c">;</span>
				<span class="w">b</span><span class="c">reak;</span>
			<span class="c">}</span>
			<span class="w">listener</span> <span class="pc">=</span> <span class="w">find_listener</span><span class="pc">(</span><span class="w">cm_core</span><span class="c">,</span> <span class="w">n</span><span class="c">fo</span><span class="pc">.</span><span class="w">m</span><span class="pc">apped_loc_a</span><span class="c">ddr</span><span class="pc">,</span>
					<span class="pc">n</span><span class="c">fo</span><span class="pc">.</span><span class="w">m</span><span class="pc">apped_loc_p</span><span class="c">ort</span><span class="pc">,</span>
					<span class="w">NES_CM_LISTENER_ACTIVE_STATE</span><span class="c">,</span> <span class="w">0</span><span class="pc">)</span><span class="c">;</span>
			<span class="c">if</span> <span class="pc">(!l</span><span class="c">istener</span><span class="pc">) </span><span class="c">{</span>
				<span class="pc">n</span><span class="c">fo</span><span class="pc">.</span><span class="w">cm_id</span> <span class="c">=</span> <span class="w">N</span><span class="c">ULL;</span>
				<span class="w">n</span><span class="c">fo</span><span class="pc">.</span><span class="w">conn_type</span> <span class="c">=</span> <span class="c">0;</span>
				<span class="w">nes_debug</span><span class="pc">(</span><span class="w">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">U</span><span class="c">nable</span> <span class="c">to</span> <span class="w">f</span><span class="c">ind</span> <span class="w">l</span><span class="c">istener</span> <span class="w">f</span><span class="pc">o</span><span class="c">r</span> <span class="pc">t</span><span class="c">he</span> <span class="w">pk</span><span class="c">t</span><span class="pc">\</span><span class="c">n");</span>
				<span class="w">skb_handled</span> <span class="pc">=</span> <span class="pc">0</span><span class="c">;</span>
				<span class="w">b</span><span class="c">reak;</span>
			<span class="c">}</span>
			<span class="pc">n</span><span class="c">fo</span><span class="w">.</span><span class="pc">c</span><span class="c">m_id</span> <span class="c">=</span> <span class="w">l</span><span class="c">istener-&gt;</span><span class="pc">c</span><span class="c">m_id</span><span class="pc">;</span>
			<span class="pc">n</span><span class="c">fo.</span><span class="pc">co</span><span class="c">nn_type</span> <span class="c">=</span> <span class="pc">l</span><span class="c">istener</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">co</span><span class="c">nn_type</span><span class="pc">;</span>
			<span class="w">cm_node</span> <span class="w">=</span> <span class="w">make_cm_node</span><span class="pc">(</span><span class="w">cm_core</span><span class="c">,</span> <span class="w">nesvnic</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">n</span><span class="c">fo</span><span class="pc">,</span>
					       <span class="pc">l</span><span class="c">istener);</span>
			<span class="c">if</span> <span class="pc">(!</span><span class="c">cm_node</span><span class="pc">) </span><span class="c">{</span>
				<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">U</span><span class="c">nable</span> <span class="c">to</span> <span class="c">allocate</span> <span class="w">"</span>
					  <span class="w">"no</span><span class="pc">d</span><span class="c">e</span><span class="pc">\</span><span class="c">n</span><span class="pc">")</span><span class="c">;</span>
				<span class="w">cm_packets_dropped+</span><span class="pc">+</span><span class="c">;</span>
				<span class="w">atomic_dec</span><span class="pc">(&amp;l</span><span class="c">istener-&gt;</span><span class="w">ref_count</span><span class="c">);</span>
				<span class="w">dev_kfree_skb_any</span><span class="c">(</span><span class="w">sk</span><span class="c">b</span><span class="pc">)</span><span class="c">;</span>
				<span class="w">b</span><span class="c">reak;</span>
			<span class="c">}</span>
			<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">tcph</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">rst</span> <span class="w">&amp;</span><span class="pc">&amp; </span><span class="c">!</span><span class="w">t</span><span class="c">cph</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">fin</span><span class="pc">)</span><span class="c"> {</span>
				<span class="w">c</span><span class="pc">m_n</span><span class="c">ode</span><span class="w">-</span><span class="c">&gt;</span><span class="w">s</span><span class="pc">tate</span> <span class="c">=</span> <span class="w">NES_CM_STATE_LISTENING</span><span class="c">;</span>
			<span class="c">}</span> <span class="c">else</span> <span class="c">{</span>
				<span class="w">c</span><span class="c">m_packets_dropped</span><span class="w">+</span><span class="c">+;</span>
				<span class="w">rem_ref_cm_node</span><span class="pc">(</span><span class="w">cm_core</span><span class="c">,</span> <span class="pc">c</span><span class="c">m_node);</span>
				<span class="w">d</span><span class="c">ev_kfree_skb_any</span><span class="pc">(</span><span class="c">skb</span><span class="pc">)</span><span class="c">;</span>
				<span class="w">b</span><span class="c">reak;</span>
			<span class="c">}</span>
			<span class="w">add_ref_cm_node</span><span class="pc">(c</span><span class="c">m_node</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">}</span> <span class="w">e</span><span class="c">lse</span> <span class="pc">i</span><span class="c">f</span> <span class="c">(cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s</span><span class="c">tate</span> <span class="pc">=</span><span class="c">=</span> <span class="w">NES_CM_STATE_TSA</span><span class="c">) {</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(cm_node-&gt;</span><span class="w">nesqp-</span><span class="c">&gt;</span><span class="w">pau_mode</span><span class="c">)</span>
				<span class="w">nes_queue_mgt_skbs</span><span class="c">(</span><span class="pc">s</span><span class="c">kb,</span> <span class="w">nesvnic</span><span class="pc">,</span> <span class="pc">cm_n</span><span class="c">ode-&gt;</span><span class="pc">n</span><span class="c">esqp);</span>
			<span class="pc">e</span><span class="c">lse</span> <span class="pc">{</span>
				<span class="w">rem_ref_cm_node</span><span class="c">(</span><span class="w">cm_core</span><span class="c">,</span> <span class="pc">c</span><span class="c">m_node</span><span class="pc">)</span><span class="c">;</span>
				<span class="w">a</span><span class="pc">tomic_i</span><span class="c">nc(&amp;</span><span class="w">cm_accel_dropped_pkts</span><span class="pc">)</span><span class="c">;</span>
				<span class="w">dev_kfree_skb_any</span><span class="c">(</span><span class="pc">s</span><span class="c">kb);</span>
			<span class="c">}</span>
			<span class="w">b</span><span class="pc">r</span><span class="c">eak;</span>
		<span class="c">}</span>
		<span class="w">skb_reset_network_header</span><span class="c">(</span><span class="pc">s</span><span class="c">kb);</span>
		<span class="w">skb_set_transport_header</span><span class="c">(skb,</span> <span class="w">s</span><span class="pc">i</span><span class="c">zeof</span><span class="pc">(*</span><span class="w">tcph</span><span class="pc">))</span><span class="c">;</span>
		<span class="w">s</span><span class="pc">kb</span><span class="c">-&gt;</span><span class="pc">l</span><span class="c">en</span> <span class="c">=</span> <span class="w">n</span><span class="pc">t</span><span class="c">ohs(</span><span class="w">ip</span><span class="c">h-&gt;</span><span class="w">tot_len</span><span class="c">);</span>
		<span class="w">process_packet</span><span class="c">(</span><span class="pc">cm_n</span><span class="c">ode,</span> <span class="c">skb</span><span class="pc">,</span> <span class="w">cm_core</span><span class="c">);</span>
		<span class="w">rem_ref_cm_node</span><span class="c">(</span><span class="w">c</span><span class="pc">m</span><span class="c">_core,</span> <span class="w">c</span><span class="c">m_node</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span> <span class="w">w</span><span class="c">hile</span> <span class="c">(</span><span class="pc">0);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">skb_handled</span><span class="pc">;</span>
<span class="c">}</span>



<span class="c">static</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">nes_cm_core</span> <span class="c">*</span><span class="w">nes_cm_alloc_core</span><span class="c">(</span><span class="pc">v</span><span class="c">oid</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="pc">nes</span><span class="c">_cm_core</span> <span class="c">*</span><span class="pc">c</span><span class="c">m_core</span><span class="pc">;</span>

	
	
	<span class="w">c</span><span class="pc">m</span><span class="c">_core</span> <span class="c">=</span> <span class="pc">k</span><span class="c">zalloc(sizeof</span><span class="pc">(*c</span><span class="c">m_core),</span> <span class="c">GFP_KERNEL);</span>
	<span class="c">if</span> <span class="c">(!cm_core)</span>
		<span class="c">return</span> <span class="pc">N</span><span class="c">ULL;</span>

	<span class="w">I</span><span class="c">NIT_LIST_HEAD(&amp;cm_core-&gt;</span><span class="w">connected_nodes</span><span class="c">);</span>
	<span class="w">init_timer</span><span class="c">(&amp;cm_core-&gt;</span><span class="w">tcp_timer</span><span class="c">);</span>
	<span class="pc">c</span><span class="c">m_core-&gt;</span><span class="pc">t</span><span class="c">cp_timer</span><span class="pc">.</span><span class="w">f</span><span class="pc">u</span><span class="c">nction</span> <span class="pc">=</span> <span class="w">nes_cm_timer_tick</span><span class="c">;</span>

	<span class="c">cm_core-&gt;</span><span class="w">m</span><span class="c">tu</span> <span class="c">=</span> <span class="w">NES_CM_DEFAULT_MTU</span><span class="c">;</span>
	<span class="c">cm_core-&gt;</span><span class="w">sta</span><span class="pc">te</span> <span class="c">=</span> <span class="w">NES_CM_STATE_INITED</span><span class="c">;</span>
	<span class="c">cm_core-&gt;</span><span class="w">free_tx_pkt_max</span> <span class="c">=</span> <span class="w">NES_CM_DEFAULT_FREE_PKTS</span><span class="c">;</span>

	<span class="w">a</span><span class="pc">t</span><span class="c">omic_set(&amp;cm_core-&gt;</span><span class="w">events_posted</span><span class="c">,</span> <span class="pc">0</span><span class="c">);</span>

	<span class="pc">c</span><span class="c">m_core-&gt;</span><span class="w">api</span> <span class="w">=</span><span class="pc"> &amp;</span><span class="w">nes_cm_api</span><span class="c">;</span>

	<span class="w">sp</span><span class="pc">in_l</span><span class="c">ock_init(&amp;cm_core-&gt;</span><span class="w">ht_lock</span><span class="c">);</span>
	<span class="w">s</span><span class="pc">p</span><span class="c">in_lock_init(&amp;cm_core-&gt;</span><span class="w">listen_list_lock</span><span class="c">);</span>

	<span class="w">I</span><span class="c">NIT_LIST_HEAD(&amp;cm_core-&gt;</span><span class="w">listen_list</span><span class="pc">.</span><span class="w">l</span><span class="pc">ist</span><span class="c">);</span>

	<span class="w">nes_debug</span><span class="pc">(</span><span class="w">NES_DBG_CM,</span><span class="pc"> "</span><span class="w">Init</span> <span class="w">CM</span> <span class="w">Core</span> <span class="w">completed</span> <span class="w">--</span> <span class="w">c</span><span class="c">m_core</span><span class="w">=</span><span class="c">%</span><span class="pc">p</span><span class="c">\n",</span> <span class="c">cm_core</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">n</span><span class="pc">es_d</span><span class="c">ebug</span><span class="pc">(N</span><span class="c">ES_DBG_CM</span><span class="w">,</span><span class="pc"> "</span><span class="w">Enable</span> <span class="w">QUEUE</span> <span class="w">EVENTS</span><span class="c">\n");</span>
	<span class="c">cm_core-&gt;</span><span class="w">event_wq</span> <span class="c">=</span> <span class="w">create_singlethread_workqueue(</span><span class="pc">"</span><span class="w">nesewq</span><span class="pc">")</span><span class="c">;</span>
	<span class="w">c</span><span class="pc">m</span><span class="c">_core-&gt;</span><span class="w">post_event</span> <span class="c">=</span> <span class="w">nes_cm_post_event</span><span class="c">;</span>
	<span class="w">n</span><span class="pc">es_</span><span class="c">debug</span><span class="pc">(N</span><span class="c">ES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="pc">E</span><span class="c">nable</span> <span class="w">Q</span><span class="c">UEUE</span> <span class="w">DISCONNECTS\</span><span class="c">n");</span>
	<span class="pc">c</span><span class="c">m_core</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">disconn_wq</span> <span class="c">=</span> <span class="pc">cr</span><span class="c">eate_singlethread_workqueue</span><span class="w">(</span><span class="pc">"</span><span class="w">nesdwq</span><span class="pc">")</span><span class="c">;</span>

	<span class="w">print_core</span><span class="c">(cm_core);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">c</span><span class="c">m_core;</span>
<span class="c">}</span>



<span class="c">static</span> <span class="c">int</span> <span class="w">mini_cm_dealloc_core</span><span class="c">(struct</span> <span class="w">nes_cm_core</span> <span class="c">*cm_core</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">n</span><span class="pc">es_d</span><span class="c">ebug(NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">De</span><span class="pc">-</span><span class="w">Alloc</span> <span class="w">CM</span> <span class="w">Core</span> <span class="w">(</span><span class="pc">%p</span><span class="c">)\n",</span> <span class="c">cm_core</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">c</span><span class="pc">m</span><span class="c">_core</span><span class="pc">)</span>
		<span class="c">return</span> <span class="c">-</span><span class="pc">EI</span><span class="c">NVAL;</span>

	<span class="w">barrier(</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">timer_pending</span><span class="pc">(&amp;</span><span class="c">cm_core-&gt;</span><span class="w">tcp_timer</span><span class="c">))</span>
		<span class="w">del_timer</span><span class="pc">(&amp;</span><span class="c">cm_core-&gt;tcp_timer);</span>

	<span class="w">destroy_workqueue</span><span class="c">(</span><span class="pc">c</span><span class="c">m_core</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">event_wq</span><span class="c">);</span>
	<span class="w">d</span><span class="pc">es</span><span class="c">troy_workqueue(cm_core</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">disconn_wq</span><span class="c">);</span>
	<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM, "</span><span class="pc">\</span><span class="c">n");</span>
	<span class="pc">k</span><span class="c">free(cm_core);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>



<span class="c">static</span> <span class="c">int</span> <span class="w">mini_cm_get</span><span class="c">(struct</span> <span class="w">nes_cm_core</span> <span class="c">*cm_core</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">c</span><span class="c">m_core</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">s</span><span class="c">tate</span><span class="pc">;</span>
<span class="c">}</span>



<span class="c">static</span> <span class="c">int</span> <span class="w">mini_cm_set</span><span class="c">(struct</span> <span class="w">n</span><span class="pc">es_c</span><span class="c">m_core</span> <span class="c">*</span><span class="pc">c</span><span class="c">m_core,</span> <span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">t</span><span class="c">ype,</span> <span class="c">u32</span> <span class="pc">v</span><span class="c">alue)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">r</span><span class="c">et</span> <span class="pc">=</span> <span class="c">0;</span>

	<span class="w">s</span><span class="pc">w</span><span class="c">itch</span> <span class="c">(</span><span class="w">t</span><span class="c">ype) {</span>
	<span class="c">case</span> <span class="w">NES_CM_SET_PKT_SIZE</span><span class="c">:</span>
		<span class="pc">cm</span><span class="c">_core</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">mt</span><span class="c">u</span> <span class="c">=</span> <span class="w">v</span><span class="c">alue;</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="c">case</span> <span class="w">NES_CM_SET_FREE_PKT_Q_SIZE</span><span class="c">:</span>
		<span class="c">cm_core-&gt;</span><span class="w">free_tx_pkt_max</span> <span class="c">=</span> <span class="w">v</span><span class="c">alue;</span>
		<span class="c">break;</span>
	<span class="pc">d</span><span class="c">efault:</span>
		
		<span class="w">r</span><span class="pc">et</span> <span class="pc">= </span><span class="c">-EINVAL;</span>
	<span class="pc">}</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">r</span><span class="c">et;</span>
<span class="c">}</span>



<span class="c">static</span> <span class="c">int</span> <span class="w">nes_cm_init_tsa_conn</span><span class="c">(struct</span> <span class="w">nes_qp</span> <span class="c">*</span><span class="w">nesqp</span><span class="pc">,</span> <span class="c">struct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="w">cm_node</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">ret</span> <span class="c">=</span> <span class="c">0;</span>

	<span class="c">if</span> <span class="pc">(!nesq</span><span class="c">p</span><span class="pc">)</span>
		<span class="c">return</span> <span class="c">-EINVAL;</span>

	<span class="w">n</span><span class="pc">esq</span><span class="c">p</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">nesqp_context-</span><span class="pc">&gt;</span><span class="w">misc</span> <span class="w">|</span><span class="c">=</span> <span class="w">c</span><span class="pc">p</span><span class="c">u_to_le32(</span><span class="w">NES_QPCONTEXT_MISC_IPV4</span> <span class="w">|</span>
						  <span class="w">NES_QPCONTEXT_MISC_NO_NAGLE</span> <span class="c">|</span> <span class="w">NES_QPCONTEXT_MISC_DO_NOT_FRAG</span> <span class="c">|</span>
						  <span class="w">NES_QPCONTEXT_MISC_DROS</span><span class="pc">)</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">c</span><span class="c">m_node-&gt;</span><span class="w">tcp_cntxt</span><span class="pc">.</span><span class="w">snd_wscale</span> <span class="w">|</span><span class="pc">|</span> <span class="pc">c</span><span class="c">m_node-&gt;tcp_cntxt.</span><span class="w">rcv_wscale</span><span class="pc">)</span>
		<span class="w">n</span><span class="pc">esqp</span><span class="c">-&gt;</span><span class="pc">n</span><span class="c">esqp_context</span><span class="pc">-</span><span class="c">&gt;misc</span> <span class="w">|</span><span class="c">=</span> <span class="w">c</span><span class="pc">p</span><span class="c">u_to_le32(</span><span class="w">NES_QPCONTEXT_MISC_WSCALE</span><span class="c">);</span>

	<span class="pc">n</span><span class="c">esqp-&gt;</span><span class="pc">nesqp_</span><span class="c">context</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">misc2</span> <span class="w">|</span><span class="c">=</span> <span class="w">c</span><span class="pc">p</span><span class="c">u_to_le32(</span><span class="w">6</span><span class="pc">4</span> <span class="w">&lt;</span><span class="c">&lt;</span> <span class="w">NES_QPCONTEXT_MISC2_TTL_SHIFT</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">n</span><span class="pc">esqp</span><span class="c">-&gt;nesqp_context</span><span class="pc">-</span><span class="c">&gt;misc2</span> <span class="pc">|</span><span class="c">=</span> <span class="w">c</span><span class="pc">p</span><span class="c">u_to_le32(</span>
		<span class="c">cm_node-&gt;</span><span class="w">tos</span> <span class="w">&lt;</span><span class="c">&lt;</span> <span class="w">NES_QPCONTEXT_MISC2_TOS_SHIFT</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">n</span><span class="pc">esqp</span><span class="c">-&gt;</span><span class="pc">n</span><span class="c">esqp_context</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">mss</span> <span class="pc">|</span><span class="c">=</span> <span class="pc">cp</span><span class="c">u_to_le32</span><span class="w">((</span><span class="pc">(</span><span class="w">u</span><span class="c">32</span><span class="pc">)c</span><span class="c">m_node-&gt;</span><span class="w">tcp_cntxt.</span><span class="pc">m</span><span class="c">ss</span><span class="w">) </span><span class="pc">&lt;</span><span class="c">&lt;</span> <span class="c">16</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">n</span><span class="c">esqp-&gt;nesqp_context</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">tcp_state_flow_label</span> <span class="w">|</span><span class="c">=</span> <span class="w">c</span><span class="pc">p</span><span class="c">u_to_le32(</span>
		<span class="w">(u</span><span class="c">32</span><span class="w">)NES_QPCONTEXT_TCPSTATE_EST</span> <span class="w">&lt;</span><span class="c">&lt;</span> <span class="w">NES_QPCONTEXT_TCPFLOW_TCP_STATE_SHIFT</span><span class="pc">);</span>

	<span class="w">n</span><span class="pc">esqp</span><span class="c">-&gt;nesqp_context</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">pd_index_wscale</span> <span class="w">|</span><span class="c">=</span> <span class="w">c</span><span class="pc">pu_to_le3</span><span class="c">2(</span>
		<span class="w">(c</span><span class="c">m_node-&gt;</span><span class="pc">t</span><span class="c">cp_cntxt</span><span class="pc">.</span><span class="w">snd_wscale</span> <span class="w">&lt;</span><span class="c">&lt;</span> <span class="w">NES_QPCONTEXT_PDWSCALE_SND_WSCALE_SHIFT) &amp;</span>
		<span class="w">NES_QPCONTEXT_PDWSCALE_SND_WSCALE_MASK</span><span class="pc">);</span>

	<span class="w">n</span><span class="pc">esqp</span><span class="c">-&gt;</span><span class="pc">n</span><span class="c">esqp_context</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">p</span><span class="c">d_index_wscale</span> <span class="w">|</span><span class="c">=</span> <span class="pc">c</span><span class="c">pu_to_le32(</span>
		<span class="w">(c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">t</span><span class="c">cp_cntxt</span><span class="w">.rcv_wscale</span> <span class="w">&lt;</span><span class="c">&lt;</span> <span class="w">NES_QPCONTEXT_PDWSCALE_RCV_WSCALE_SHIFT) &amp;</span>
		<span class="w">NES_QPCONTEXT_PDWSCALE_RCV_WSCALE_MASK</span><span class="pc">)</span><span class="c">;</span>

	<span class="c">nesqp-&gt;nesqp_context</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">keepalive</span> <span class="pc">=</span> <span class="pc">cp</span><span class="c">u_to_le32(</span><span class="w">0x8</span><span class="pc">0</span><span class="c">);</span>
	<span class="pc">n</span><span class="c">esqp-&gt;nesqp_context</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ts_recent</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="pc">n</span><span class="c">esqp-&gt;nesqp_context</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ts_age</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="pc">n</span><span class="c">esqp-&gt;nesqp_context</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">snd_nxt</span> <span class="pc">=</span> <span class="w">c</span><span class="pc">pu_to_le3</span><span class="c">2(</span><span class="w">cm_node</span><span class="c">-&gt;</span><span class="w">tcp_cntxt.loc_seq_num</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">n</span><span class="c">esqp-&gt;</span><span class="pc">nesqp_</span><span class="c">context</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">snd_wnd</span> <span class="pc">=</span> <span class="w">c</span><span class="pc">p</span><span class="c">u_to_le32(</span><span class="w">c</span><span class="c">m_node-&gt;tcp_cntxt</span><span class="pc">.s</span><span class="c">nd_wnd</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">n</span><span class="c">esqp-&gt;nesqp_context</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">rcv_nxt</span> <span class="pc">=</span> <span class="w">c</span><span class="pc">p</span><span class="c">u_to_le32(cm_node-&gt;tcp_cntxt</span><span class="pc">.r</span><span class="c">cv_nxt</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">nesqp-&gt;nesqp_context</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">rcv_wnd</span> <span class="pc">=</span> <span class="w">c</span><span class="pc">p</span><span class="c">u_to_le32(cm_node-&gt;tcp_cntxt</span><span class="pc">.r</span><span class="c">cv_wnd</span> <span class="w">&lt;</span><span class="pc">&lt;</span>
						    <span class="pc">c</span><span class="c">m_node-&gt;</span><span class="pc">t</span><span class="c">cp_cntxt</span><span class="pc">.</span><span class="w">rcv_wscale</span><span class="c">);</span>
	<span class="c">nesqp-&gt;</span><span class="pc">n</span><span class="c">esqp_context</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">snd_max</span> <span class="pc">=</span> <span class="pc">c</span><span class="c">pu_to_le32(</span><span class="pc">c</span><span class="c">m_node-&gt;tcp_cntxt</span><span class="pc">.</span><span class="w">loc_seq_num</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">n</span><span class="c">esqp-&gt;nesqp_context</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">snd_una</span> <span class="pc">=</span> <span class="pc">c</span><span class="c">pu_to_le32(</span><span class="pc">c</span><span class="c">m_node-&gt;</span><span class="pc">t</span><span class="c">cp_cntxt</span><span class="pc">.</span><span class="w">l</span><span class="c">oc_seq_num</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">nesqp-&gt;nesqp_context</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">srtt</span> <span class="pc">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="pc">n</span><span class="c">esqp-&gt;</span><span class="pc">n</span><span class="c">esqp_context</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">rttvar</span> <span class="pc">=</span> <span class="w">c</span><span class="pc">pu_to_l</span><span class="c">e32(</span><span class="w">0x6</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">n</span><span class="c">esqp-&gt;nesqp_context</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ssthresh</span> <span class="c">=</span> <span class="w">c</span><span class="pc">p</span><span class="c">u_to_le32(</span><span class="w">0x3FFFC000</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">nesqp</span><span class="c">-&gt;nesqp_context</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">cwnd</span> <span class="pc">=</span> <span class="w">c</span><span class="pc">p</span><span class="c">u_to_le32(</span><span class="w">2</span> <span class="w">*</span> <span class="w">cm_node-</span><span class="c">&gt;</span><span class="w">tcp_cntxt.mss</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">n</span><span class="pc">esqp</span><span class="c">-&gt;nesqp_context</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">snd_wl1</span> <span class="pc">=</span> <span class="pc">c</span><span class="c">pu_to_le32(</span><span class="pc">c</span><span class="c">m_node-&gt;</span><span class="pc">t</span><span class="c">cp_cntxt</span><span class="pc">.</span><span class="w">rcv_nxt</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">nesqp</span><span class="c">-&gt;</span><span class="w">n</span><span class="pc">esqp_</span><span class="c">context</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">snd_wl2</span> <span class="pc">=</span> <span class="w">c</span><span class="pc">p</span><span class="c">u_to_le32(cm_node-&gt;tcp_cntxt</span><span class="pc">.</span><span class="w">loc_seq_num</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">nesqp-&gt;nesqp_context</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">max_snd_wnd</span> <span class="pc">=</span> <span class="pc">cp</span><span class="c">u_to_le32(cm_node-&gt;tcp_cntxt</span><span class="pc">.m</span><span class="c">ax_snd_wnd</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM,</span><span class="pc"> "</span><span class="w">QP</span><span class="c">%</span><span class="pc">u</span><span class="w">:</span> <span class="w">r</span><span class="c">cv_nxt</span> <span class="w">=</span> <span class="c">0x%</span><span class="w">0</span><span class="pc">8X,</span> <span class="w">snd_nxt</span> <span class="pc">=</span> <span class="c">0x%</span><span class="w">0</span><span class="pc">8X</span><span class="w">,</span><span class="pc">"</span>
		  <span class="w">"</span> <span class="w">Setting</span> <span class="w">MSS</span> <span class="w">t</span><span class="c">o</span> <span class="pc">%u</span><span class="w">,</span> <span class="w">PDWscale</span> <span class="w">=</span> <span class="c">0x%</span><span class="w">0</span><span class="pc">8X</span><span class="c">,</span> <span class="w">rcv_wnd</span> <span class="w">=</span><span class="pc"> </span><span class="c">%</span><span class="pc">u</span><span class="c">,</span> <span class="w">cont</span><span class="pc">e</span><span class="c">xt</span> <span class="w">misc</span> <span class="w">=</span> <span class="c">0x%</span><span class="pc">08</span><span class="c">X</span><span class="w">.</span><span class="pc">\</span><span class="c">n",</span>
		  <span class="w">nesqp-</span><span class="c">&gt;</span><span class="w">hwqp</span><span class="pc">.</span><span class="w">qp_id</span><span class="pc">,</span> <span class="w">le</span><span class="pc">3</span><span class="c">2_to_cpu(</span><span class="pc">n</span><span class="c">esqp-&gt;</span><span class="w">nesqp_context-</span><span class="c">&gt;</span><span class="w">rcv_nxt)</span><span class="pc">,</span>
		  <span class="pc">l</span><span class="c">e32_to_cpu(nesqp-&gt;</span><span class="pc">nesqp_</span><span class="c">context-&gt;</span><span class="w">snd_nxt)</span><span class="pc">,</span>
		  <span class="w">cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">tcp_cntxt.mss</span><span class="pc">,</span> <span class="w">l</span><span class="c">e32_to_cpu(</span><span class="pc">n</span><span class="c">esqp-&gt;</span><span class="pc">nesqp_</span><span class="c">context-&gt;</span><span class="w">pd_index_wscale</span><span class="pc">)</span><span class="c">,</span>
		  <span class="w">l</span><span class="c">e32_to_cpu(nesqp-&gt;</span><span class="pc">nesqp_</span><span class="c">context-&gt;</span><span class="w">rcv_wnd</span><span class="pc">)</span><span class="c">,</span>
		  <span class="w">l</span><span class="c">e32_to_cpu(nesqp-&gt;nesqp_context-&gt;</span><span class="w">misc)</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span>  <span class="w">snd_wnd</span>  <span class="w">=</span> <span class="pc">0</span><span class="c">x%</span><span class="w">08</span><span class="pc">X</span><span class="w">.</span><span class="pc">\</span><span class="c">n",</span> <span class="pc">l</span><span class="c">e32_to_cpu(</span><span class="pc">nesqp</span><span class="c">-&gt;nesqp_context-&gt;</span><span class="pc">s</span><span class="c">nd_wnd</span><span class="w">)</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">n</span><span class="pc">es_</span><span class="c">debug</span><span class="pc">(N</span><span class="c">ES_DBG_CM</span><span class="pc">, </span><span class="c">"</span>  <span class="w">snd_cwnd</span> <span class="w">=</span> <span class="c">0x%</span><span class="w">0</span><span class="pc">8X</span><span class="w">.</span><span class="pc">\</span><span class="c">n",</span> <span class="w">l</span><span class="c">e32_to_cpu(nesqp-&gt;nesqp_context</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">cwnd)</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">n</span><span class="c">es_debug(NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span>  <span class="w">max_swnd</span> <span class="w">=</span> <span class="c">0x%</span><span class="w">08</span><span class="pc">X</span><span class="w">.</span><span class="pc">\</span><span class="c">n",</span> <span class="w">l</span><span class="c">e32_to_cpu(nesqp-&gt;nesqp_context</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">max_snd_wnd)</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">n</span><span class="c">es_debug(NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">Change</span> <span class="w">cm_node</span> <span class="w">s</span><span class="pc">tate</span> <span class="w">t</span><span class="c">o</span> <span class="w">TSA</span><span class="pc">\</span><span class="c">n");</span>
	<span class="w">cm</span><span class="pc">_</span><span class="c">node</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">s</span><span class="c">tate</span> <span class="c">=</span> <span class="w">NES_CM_STATE_TSA</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">r</span><span class="c">et;</span>
<span class="c">}</span>



<span class="pc">i</span><span class="c">nt</span> <span class="w">nes_cm_disconn</span><span class="c">(struct</span> <span class="w">nes_qp</span> <span class="c">*nesqp</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">disconn_work</span> <span class="c">*</span><span class="w">wo</span><span class="c">rk</span><span class="pc">;</span>

	<span class="w">wo</span><span class="c">rk</span> <span class="c">=</span> <span class="pc">k</span><span class="c">zalloc(sizeof</span> <span class="w">*wo</span><span class="pc">rk</span><span class="w">,</span> <span class="w">G</span><span class="pc">FP_A</span><span class="c">TOMIC);</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">w</span><span class="pc">o</span><span class="c">rk)</span>
		<span class="c">return</span> <span class="c">-ENOMEM;</span>  

	<span class="w">nes_add_ref</span><span class="pc">(&amp;nesq</span><span class="c">p-&gt;</span><span class="w">ibqp</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">wo</span><span class="pc">rk</span><span class="c">-&gt;</span><span class="pc">nesq</span><span class="c">p</span> <span class="c">=</span> <span class="pc">nesq</span><span class="c">p</span><span class="pc">;</span>
	<span class="w">INIT_WORK</span><span class="c">(&amp;</span><span class="w">wo</span><span class="c">rk-&gt;</span><span class="w">w</span><span class="c">ork</span><span class="pc">,</span> <span class="w">nes_disconnect_worker</span><span class="c">);</span>
	<span class="w">queue_work</span><span class="pc">(</span><span class="w">g_cm_core-</span><span class="c">&gt;</span><span class="w">disconn_wq</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">w</span><span class="pc">o</span><span class="c">rk-&gt;</span><span class="w">w</span><span class="c">ork);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>



<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">n</span><span class="pc">es_</span><span class="c">disconnect_worker(struct</span> <span class="pc">w</span><span class="c">ork_struct</span> <span class="c">*work)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">disconn_work</span> <span class="c">*</span><span class="w">dwork</span> <span class="c">=</span> <span class="c">container_of(work,</span> <span class="c">struct</span> <span class="c">disconn_work,</span> <span class="c">work);</span>
	<span class="c">struct</span> <span class="w">nes_qp</span> <span class="c">*</span><span class="w">nesqp</span> <span class="c">=</span> <span class="c">dwork-&gt;nesqp;</span>

	<span class="w">k</span><span class="c">free(</span><span class="pc">d</span><span class="c">work);</span>
	<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">processing</span> <span class="w">AEQE</span> <span class="w">i</span><span class="pc">d</span> <span class="w">0</span><span class="c">x%</span><span class="w">04X</span> <span class="w">f</span><span class="c">or</span> <span class="w">QP</span><span class="c">%</span><span class="pc">u</span><span class="w">.</span><span class="pc">\</span><span class="c">n",</span>
		  <span class="pc">n</span><span class="c">esqp-&gt;</span><span class="w">last_aeq</span><span class="c">,</span> <span class="pc">n</span><span class="c">esqp-&gt;</span><span class="w">hwqp</span><span class="pc">.</span><span class="w">qp_id</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">nes_cm_disconn_true</span><span class="c">(nesqp</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">nes_rem_ref</span><span class="pc">(&amp;</span><span class="c">nesqp-&gt;</span><span class="w">ibqp</span><span class="c">);</span>
<span class="c">}</span>



<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">n</span><span class="pc">es_c</span><span class="c">m_disconn_true(struct</span> <span class="w">nes_qp</span> <span class="c">*nesqp)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="pc">l</span><span class="c">ong</span> <span class="c">flags;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">ret</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">iw_cm_id</span> <span class="c">*</span><span class="w">cm_id</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">iw_cm_event</span> <span class="w">cm_event</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">nes_vnic</span> <span class="c">*</span><span class="w">nesvnic</span><span class="c">;</span>
	<span class="w">u1</span><span class="c">6</span> <span class="w">last_ae</span><span class="c">;</span>
	<span class="w">u</span><span class="pc">8</span> <span class="w">original_hw_tcp_state</span><span class="c">;</span>
	<span class="c">u8</span> <span class="w">original_ibqp_state</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">disconn_status</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">issue_disconn</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">issue_close</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">issue_flush</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">flush_q</span> <span class="c">=</span> <span class="w">NES_CQP_FLUSH_RQ</span><span class="c">;</span>
	<span class="w">s</span><span class="c">truct</span> <span class="w">ib_event</span> <span class="w">ibevent</span><span class="c">;</span>

	<span class="w">i</span><span class="pc">f</span> <span class="pc">(!</span><span class="w">nesqp</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">nes_debug</span><span class="pc">(</span><span class="w">NES_DBG_CM</span><span class="pc">, "</span><span class="w">disconnect_worker</span> <span class="w">n</span><span class="pc">e</span><span class="c">sqp</span> <span class="w">i</span><span class="pc">s</span> <span class="w">N</span><span class="pc">U</span><span class="c">LL</span><span class="pc">\</span><span class="c">n");</span>
		<span class="c">return</span> <span class="c">-</span><span class="pc">1</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">s</span><span class="pc">p</span><span class="c">in_lock_irqsave(&amp;</span><span class="w">n</span><span class="c">esqp-&gt;lock,</span> <span class="c">flags);</span>
	<span class="w">cm_id</span> <span class="pc">=</span> <span class="pc">n</span><span class="c">esqp</span><span class="pc">-</span><span class="c">&gt;cm_id;</span>
	
	<span class="c">if</span> <span class="pc">(!</span><span class="c">cm_id</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">n</span><span class="pc">es_</span><span class="c">debug</span><span class="pc">(N</span><span class="c">ES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">QP%u</span> <span class="w">d</span><span class="pc">i</span><span class="c">sconnect_worker</span> <span class="w">cmid</span> <span class="w">i</span><span class="pc">s</span> <span class="w">N</span><span class="pc">U</span><span class="c">LL\n",</span>
			  <span class="pc">n</span><span class="c">esqp-&gt;</span><span class="w">hwqp.qp_id</span><span class="c">);</span>
		<span class="pc">s</span><span class="c">pin_unlock_irqrestore(&amp;</span><span class="pc">n</span><span class="c">esqp-&gt;lock,</span> <span class="c">flags);</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="pc">-1</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">nesvnic</span> <span class="pc">=</span> <span class="w">to_nesvnic</span><span class="c">(</span><span class="w">n</span><span class="pc">esq</span><span class="c">p</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ibqp</span><span class="pc">.</span><span class="w">de</span><span class="pc">vi</span><span class="c">ce</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">Disconnecting</span> <span class="w">QP</span><span class="pc">%u</span><span class="c">\n",</span> <span class="pc">nesq</span><span class="c">p-&gt;</span><span class="w">h</span><span class="c">wqp</span><span class="pc">.q</span><span class="c">p_id);</span>

	<span class="w">original_hw_tcp_state</span> <span class="pc">=</span> <span class="c">nesqp</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">hw_tcp_state</span><span class="c">;</span>
	<span class="w">original_ibqp_state</span> <span class="pc">=</span> <span class="pc">n</span><span class="c">esqp-&gt;</span><span class="w">ibqp_state</span><span class="c">;</span>
	<span class="w">last_ae</span> <span class="c">=</span> <span class="c">nesqp-&gt;</span><span class="w">last_aeq</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(nesqp-&gt;</span><span class="w">term_flags</span><span class="c">) {</span>
		<span class="w">issue_disconn</span> <span class="c">=</span> <span class="w">1</span><span class="c">;</span>
		<span class="w">issue_close</span> <span class="c">=</span> <span class="w">1</span><span class="c">;</span>
		<span class="pc">n</span><span class="c">esqp</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">cm_id</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>
		<span class="w">del_timer</span><span class="pc">(&amp;</span><span class="c">nesqp-&gt;</span><span class="w">terminate_timer</span><span class="c">);</span>
		<span class="c">if</span> <span class="c">(</span><span class="pc">n</span><span class="c">esqp-&gt;</span><span class="w">flush_issued</span> <span class="pc">=</span><span class="c">=</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
			<span class="pc">n</span><span class="c">esqp-&gt;flush_issued</span> <span class="c">=</span> <span class="c">1;</span>
			<span class="w">issue_flush</span> <span class="c">=</span> <span class="pc">1</span><span class="c">;</span>
		<span class="pc">}</span>
	<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="pc">i</span><span class="c">f</span> <span class="pc">((</span><span class="w">original_hw_tcp_state</span> <span class="pc">=</span><span class="c">=</span> <span class="w">NES_AEQE_TCP_STATE_CLOSE_WAIT) </span><span class="pc">||</span>
			<span class="w">(</span><span class="pc">(</span><span class="w">original_ibqp_state</span> <span class="pc">=</span><span class="c">=</span> <span class="w">IB_QPS_RTS</span><span class="pc">) &amp;</span><span class="c">&amp;</span>
			<span class="c">(</span><span class="w">last_ae</span> <span class="pc">=</span><span class="c">=</span> <span class="w">NES_AEQE_AEID_LLP_CONNECTION_RESET))</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">issue_disconn</span> <span class="c">=</span> <span class="w">1</span><span class="c">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">l</span><span class="c">ast_ae</span> <span class="c">==</span> <span class="pc">N</span><span class="c">ES_AEQE_AEID_LLP_CONNECTION_RESET</span><span class="pc">)</span>
			<span class="w">disconn_status</span> <span class="w">=</span><span class="pc"> -</span><span class="w">ECONNRESET</span><span class="c">;</span>
	<span class="pc">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="w">((</span><span class="pc">(o</span><span class="c">riginal_hw_tcp_state</span> <span class="pc">=</span><span class="c">=</span> <span class="w">NES_AEQE_TCP_STATE_CLOSED)</span><span class="pc"> |</span><span class="c">|</span>
		 <span class="c">(</span><span class="w">o</span><span class="pc">riginal_h</span><span class="c">w_tcp_state</span> <span class="c">==</span> <span class="w">NES_AEQE_TCP_STATE_TIME_WAIT</span><span class="pc">) </span><span class="c">||</span>
		 <span class="pc">(l</span><span class="c">ast_ae</span> <span class="pc">=</span><span class="c">=</span> <span class="w">NES_AEQE_AEID_RDMAP_ROE_BAD_LLP_CLOSE)</span><span class="pc"> |</span><span class="c">|</span>
		 <span class="c">(</span><span class="pc">l</span><span class="c">ast_ae</span> <span class="pc">=</span><span class="c">=</span> <span class="pc">N</span><span class="c">ES_AEQE_AEID_LLP_CONNECTION_RESET</span><span class="w">))</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">issue_close</span> <span class="c">=</span> <span class="w">1</span><span class="c">;</span>
		<span class="w">nesqp-</span><span class="pc">&gt;</span><span class="w">cm_id</span> <span class="c">=</span> <span class="w">N</span><span class="pc">U</span><span class="c">LL;</span>
		<span class="c">if</span> <span class="c">(nesqp-&gt;</span><span class="w">flush_issued</span> <span class="c">==</span> <span class="pc">0) </span><span class="c">{</span>
			<span class="pc">n</span><span class="c">esqp</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">f</span><span class="c">lush_issued</span> <span class="c">=</span> <span class="c">1;</span>
			<span class="w">issue_flush</span> <span class="c">=</span> <span class="pc">1</span><span class="c">;</span>
		<span class="pc">}</span>
	<span class="pc">}</span>

	<span class="w">sp</span><span class="pc">in_unlock_i</span><span class="c">rqrestore(&amp;nesqp-&gt;lock,</span> <span class="c">flags);</span>

	<span class="c">if</span> <span class="pc">((</span><span class="w">i</span><span class="c">ssue_flush</span><span class="w">) &amp;</span><span class="pc">&amp; </span><span class="c">(nesqp-&gt;</span><span class="w">destroyed</span> <span class="c">==</span> <span class="c">0</span><span class="pc">))</span><span class="c"> {</span>
		
		<span class="pc">if</span> <span class="c">(nesqp-&gt;</span><span class="w">hw_iwarp_state</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="w">NES_AEQE_IWARP_STATE_TERMINATE</span><span class="pc">)</span>
			<span class="w">flush_q</span> <span class="pc">|</span><span class="c">=</span> <span class="w">NES_CQP_FLUSH_SQ</span><span class="c">;</span>
		<span class="w">flush_wqes</span><span class="pc">(</span><span class="w">nesvnic</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">nes</span><span class="pc">d</span><span class="c">ev,</span> <span class="c">nesqp</span><span class="pc">,</span> <span class="pc">f</span><span class="c">lush_q,</span> <span class="w">1</span><span class="c">);</span>

		<span class="pc">i</span><span class="c">f</span> <span class="c">(nesqp-&gt;</span><span class="w">term_flags</span><span class="pc">)</span><span class="c"> {</span>
			<span class="w">ibevent.de</span><span class="pc">vi</span><span class="c">ce</span> <span class="c">=</span> <span class="c">nesqp-&gt;</span><span class="w">ibqp</span><span class="pc">.</span><span class="w">d</span><span class="pc">evi</span><span class="c">ce</span><span class="pc">;</span>
			<span class="pc">ib</span><span class="c">event</span><span class="pc">.</span><span class="w">ev</span><span class="c">ent</span> <span class="c">=</span> <span class="w">n</span><span class="pc">esq</span><span class="c">p</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">terminate_eventtype</span><span class="c">;</span>
			<span class="pc">i</span><span class="c">bevent</span><span class="pc">.</span><span class="w">element</span><span class="pc">.</span><span class="w">q</span><span class="pc">p</span> <span class="w">=</span><span class="pc"> </span><span class="c">&amp;</span><span class="pc">n</span><span class="c">esqp-&gt;</span><span class="pc">ibq</span><span class="c">p</span><span class="pc">;</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(nesqp-&gt;</span><span class="pc">i</span><span class="c">bqp.</span><span class="w">event_handler</span><span class="pc">)</span>
				<span class="c">nesqp-&gt;ibqp.event_handler</span><span class="w">(</span><span class="pc">&amp;</span><span class="c">ibevent</span><span class="pc">,</span> <span class="c">nesqp</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">i</span><span class="c">bqp</span><span class="pc">.</span><span class="w">qp_context</span><span class="c">);</span>
		<span class="c">}</span>
	<span class="pc">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">((</span><span class="w">cm_id) &amp;</span><span class="pc">&amp; </span><span class="c">(</span><span class="w">c</span><span class="pc">m</span><span class="c">_id</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">e</span><span class="c">vent_handler</span><span class="w">)</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="w">issue_disconn</span><span class="pc">)</span><span class="c"> {</span>
			<span class="w">a</span><span class="pc">t</span><span class="c">omic_inc(&amp;</span><span class="w">cm_disconnects</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">cm_event.ev</span><span class="pc">ent</span> <span class="c">=</span> <span class="w">IW_CM_EVENT_DISCONNECT</span><span class="c">;</span>
			<span class="pc">c</span><span class="c">m_event.</span><span class="w">s</span><span class="c">tatus</span> <span class="c">=</span> <span class="w">disconn_status</span><span class="c">;</span>
			<span class="pc">c</span><span class="c">m_event</span><span class="pc">.</span><span class="w">local_addr</span> <span class="c">=</span> <span class="w">c</span><span class="pc">m_i</span><span class="c">d</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">l</span><span class="c">ocal_addr;</span>
			<span class="pc">c</span><span class="c">m_event.</span><span class="w">remote_addr</span> <span class="c">=</span> <span class="w">c</span><span class="pc">m_i</span><span class="c">d</span><span class="pc">-</span><span class="c">&gt;remote_addr;</span>
			<span class="c">cm_event</span><span class="pc">.</span><span class="w">pr</span><span class="pc">iv</span><span class="c">ate_data</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>
			<span class="pc">c</span><span class="c">m_event</span><span class="pc">.</span><span class="w">private_data_len</span> <span class="c">=</span> <span class="c">0;</span>

			<span class="w">nes_debug</span><span class="pc">(</span><span class="w">NES_DBG_CM</span><span class="pc">, "</span><span class="w">Generating</span> <span class="w">a</span> <span class="w">CM</span> <span class="w">Disconnect</span> <span class="w">Ev</span><span class="c">ent</span><span class="w">"</span>
				  <span class="w">"</span> <span class="w">f</span><span class="pc">o</span><span class="c">r</span>  <span class="w">QP</span><span class="pc">%u</span><span class="w">,</span> <span class="w">SQ</span> <span class="w">Head</span> <span class="w">=</span><span class="pc"> </span><span class="c">%u</span><span class="pc">,</span> <span class="w">S</span><span class="c">Q</span> <span class="w">Tail</span> <span class="w">=</span><span class="pc"> </span><span class="c">%u</span><span class="w">. "</span>
				  <span class="w">"cm_id</span> <span class="w">=</span><span class="pc"> </span><span class="c">%</span><span class="w">p</span><span class="pc">,</span> <span class="w">refcount</span> <span class="w">=</span><span class="pc"> </span><span class="c">%</span><span class="pc">u</span><span class="w">.</span><span class="pc">\</span><span class="c">n",</span>
				  <span class="w">nesqp</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">hwqp.qp_id</span><span class="pc">,</span> <span class="w">n</span><span class="pc">e</span><span class="c">sqp</span><span class="pc">-</span><span class="c">&gt;hwqp.</span><span class="w">sq_head</span><span class="pc">,</span>
				  <span class="c">nesqp</span><span class="pc">-</span><span class="c">&gt;hwqp.</span><span class="w">sq_tail</span><span class="pc">,</span> <span class="w">c</span><span class="c">m_id</span><span class="pc">,</span>
				  <span class="w">at</span><span class="c">omic_read(&amp;nesqp-&gt;</span><span class="w">r</span><span class="c">efcount</span><span class="pc">)</span><span class="c">);</span>

			<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="pc">c</span><span class="c">m_id-&gt;</span><span class="w">event_handler(c</span><span class="c">m_id</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">cm_event</span><span class="pc">)</span><span class="c">;</span>
			<span class="c">if</span> <span class="c">(</span><span class="pc">r</span><span class="c">et)</span>
				<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM,</span><span class="pc"> "</span><span class="w">OFA</span> <span class="w">CM</span> <span class="w">e</span><span class="c">vent_handler</span> <span class="w">"</span>
					  <span class="w">"returned,</span> <span class="w">r</span><span class="pc">et</span><span class="w">=</span><span class="pc">%</span><span class="c">d</span><span class="pc">\</span><span class="c">n",</span> <span class="pc">r</span><span class="c">et);</span>
		<span class="pc">}</span>

		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">issue_close</span><span class="pc">)</span><span class="c"> {</span>
			<span class="w">a</span><span class="c">tomic_inc(&amp;</span><span class="w">cm_closes)</span><span class="c">;</span>
			<span class="w">nes_disconnect</span><span class="c">(</span><span class="w">nesqp</span><span class="pc">,</span> <span class="w">1</span><span class="pc">)</span><span class="c">;</span>

			<span class="w">cm_id-</span><span class="c">&gt;</span><span class="w">provider_data</span> <span class="c">=</span> <span class="w">n</span><span class="pc">esq</span><span class="c">p;</span>
			
			<span class="w">cm_event.ev</span><span class="pc">ent</span> <span class="c">=</span> <span class="w">IW_CM_EVENT_CLOSE</span><span class="c">;</span>
			<span class="pc">cm_e</span><span class="c">vent</span><span class="pc">.</span><span class="w">s</span><span class="c">tatus</span> <span class="c">=</span> <span class="c">0;</span>
			<span class="pc">c</span><span class="c">m_event</span><span class="pc">.</span><span class="w">p</span><span class="c">rovider_data</span> <span class="c">=</span> <span class="pc">c</span><span class="c">m_id</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">p</span><span class="c">rovider_data</span><span class="pc">;</span>
			<span class="pc">cm_e</span><span class="c">vent.</span><span class="w">local_addr</span> <span class="c">=</span> <span class="pc">c</span><span class="c">m_id</span><span class="pc">-</span><span class="c">&gt;local_addr;</span>
			<span class="c">cm_event</span><span class="pc">.</span><span class="w">remote_addr</span> <span class="c">=</span> <span class="pc">cm_i</span><span class="c">d-&gt;remote_addr;</span>
			<span class="c">cm_event.</span><span class="w">pr</span><span class="pc">iv</span><span class="c">ate_data</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>
			<span class="pc">c</span><span class="c">m_event</span><span class="pc">.</span><span class="w">private_data_len</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>

			<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="pc">cm_i</span><span class="c">d-&gt;</span><span class="w">event_handler(</span><span class="pc">cm_i</span><span class="c">d</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">cm_e</span><span class="c">vent</span><span class="pc">)</span><span class="c">;</span>
			<span class="c">if</span> <span class="c">(ret</span><span class="pc">)</span>
				<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, "</span><span class="w">OFA</span> <span class="w">CM</span> <span class="w">e</span><span class="c">vent_handler</span> <span class="w">returned,</span> <span class="w">r</span><span class="pc">et</span><span class="w">=</span><span class="pc">%</span><span class="c">d</span><span class="pc">\</span><span class="c">n",</span> <span class="c">ret);</span>

			<span class="w">c</span><span class="pc">m_i</span><span class="c">d-&gt;</span><span class="w">rem_ref(</span><span class="pc">c</span><span class="c">m_id</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">}</span>
	<span class="w">}</span>

	<span class="w">r</span><span class="pc">etu</span><span class="c">rn</span> <span class="pc">0</span><span class="c">;</span>
<span class="c">}</span>



<span class="c">static</span> <span class="c">int</span> <span class="w">nes_disconnect</span><span class="c">(struct</span> <span class="w">nes_qp</span> <span class="c">*</span><span class="w">nesqp</span><span class="c">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">abrupt</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">in</span><span class="c">t</span> <span class="pc">r</span><span class="c">et</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="w">s</span><span class="c">truct</span> <span class="w">nes_vnic</span> <span class="c">*</span><span class="w">nesvnic</span><span class="pc">;</span>
	<span class="c">struct</span> <span class="w">nes_device</span> <span class="c">*</span><span class="w">nesd</span><span class="c">ev;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">nes_ib_device</span> <span class="c">*</span><span class="w">nesibdev</span><span class="c">;</span>

	<span class="w">n</span><span class="pc">esv</span><span class="c">nic</span> <span class="pc">=</span> <span class="w">to_nesvnic</span><span class="pc">(nesq</span><span class="c">p</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ibqp</span><span class="pc">.</span><span class="w">d</span><span class="pc">evi</span><span class="c">ce</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!nesv</span><span class="c">nic</span><span class="pc">)</span>
		<span class="c">return</span> <span class="c">-EINVAL;</span>

	<span class="w">nesd</span><span class="c">ev</span> <span class="pc">=</span> <span class="w">n</span><span class="pc">esv</span><span class="c">nic-&gt;</span><span class="w">nesd</span><span class="c">ev</span><span class="pc">;</span>
	<span class="pc">nesi</span><span class="c">bdev</span> <span class="pc">=</span> <span class="pc">nesv</span><span class="c">nic-&gt;</span><span class="pc">nesi</span><span class="c">bdev;</span>

	<span class="w">nes_debug</span><span class="pc">(</span><span class="w">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">ne</span><span class="pc">t</span><span class="c">dev</span> <span class="w">refcnt</span> <span class="w">= </span><span class="pc">%u</span><span class="w">.</span><span class="pc">\</span><span class="c">n",</span>
			<span class="w">netdev_refcnt_read</span><span class="pc">(</span><span class="c">nesvnic</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">net</span><span class="pc">dev</span><span class="c">));</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">nesqp</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">active_conn</span><span class="c">) {</span>

		
		<span class="w">n</span><span class="c">esqp</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">a</span><span class="c">ctive_conn</span> <span class="c">=</span> <span class="w">0</span><span class="c">;</span>
	<span class="c">}</span> <span class="c">else</span> <span class="c">{</span>
		
		<span class="c">if</span> <span class="c">(</span><span class="w">n</span><span class="pc">esq</span><span class="c">p-&gt;</span><span class="w">ietf_frame</span><span class="c">) {</span>
			<span class="c">if</span> <span class="c">(nesqp-&gt;</span><span class="w">lsmm_mr</span><span class="pc">)</span>
				<span class="w">nesibdev</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ibdev</span><span class="pc">.</span><span class="w">dereg_mr(</span><span class="pc">nesq</span><span class="c">p</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">l</span><span class="c">smm_mr</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">pci_free_consistent</span><span class="c">(</span><span class="w">nes</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="w">pci</span><span class="pc">d</span><span class="c">ev</span><span class="pc">,</span>
					    <span class="c">nesqp-&gt;</span><span class="w">private_data_len</span> <span class="w">+</span> <span class="pc">n</span><span class="c">esqp-&gt;</span><span class="w">ietf_frame_size</span><span class="pc">,</span>
					    <span class="c">nesqp-&gt;</span><span class="pc">ie</span><span class="c">tf_frame</span><span class="pc">,</span> <span class="c">nesqp-&gt;</span><span class="w">ietf_frame_pbase</span><span class="c">);</span>
		<span class="c">}</span>
	<span class="pc">}</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(nesqp-&gt;</span><span class="w">cm_node</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM,</span><span class="pc"> </span><span class="c">"</span><span class="w">Call</span> <span class="w">clo</span><span class="pc">s</span><span class="c">e</span> <span class="w">API</span><span class="c">\n");</span>

		<span class="w">g_cm_core</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">api-</span><span class="c">&gt;</span><span class="w">clo</span><span class="pc">s</span><span class="c">e</span><span class="w">(</span><span class="pc">g</span><span class="c">_cm_core</span><span class="pc">,</span> <span class="pc">n</span><span class="c">esqp-&gt;</span><span class="w">c</span><span class="c">m_node);</span>
	<span class="pc">}</span>

	<span class="w">r</span><span class="c">eturn</span> <span class="c">ret;</span>
<span class="c">}</span>



<span class="pc">i</span><span class="c">nt</span> <span class="w">nes_accept</span><span class="c">(struct</span> <span class="w">iw_cm_id</span> <span class="c">*</span><span class="w">cm_id</span><span class="c">,</span> <span class="c">struct</span> <span class="w">iw_cm_conn_param</span> <span class="c">*</span><span class="w">conn_param</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">u6</span><span class="c">4</span> <span class="w">u64temp</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">ib_qp</span> <span class="c">*</span><span class="w">ibqp</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">nes_qp</span> <span class="c">*</span><span class="w">n</span><span class="pc">es</span><span class="c">qp;</span>
	<span class="c">struct</span> <span class="w">nes_vnic</span> <span class="c">*</span><span class="w">nesvnic</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">nes_device</span> <span class="c">*</span><span class="w">nesd</span><span class="c">ev;</span>
	<span class="c">struct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="w">cm_node</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">nes_adapter</span> <span class="c">*</span><span class="w">a</span><span class="c">dapter;</span>
	<span class="c">struct</span> <span class="w">ib_qp_attr</span> <span class="w">at</span><span class="c">tr;</span>
	<span class="c">struct</span> <span class="w">iw_cm_event</span> <span class="w">cm_event</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">nes_hw_qp_wqe</span> <span class="c">*</span><span class="w">wqe</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">nes_v4_quad</span> <span class="w">nes_quad</span><span class="c">;</span>
	<span class="pc">u3</span><span class="c">2</span> <span class="w">crc_value</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">r</span><span class="c">et;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">passive_state</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">nes_ib_device</span> <span class="c">*</span><span class="w">nesibdev</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">ib_mr</span> <span class="c">*</span><span class="w">ibmr</span> <span class="pc">=</span> <span class="c">NULL;</span>
	<span class="c">struct</span> <span class="w">ib_phys_buf</span> <span class="w">ibphysbuf</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">nes_pd</span> <span class="c">*</span><span class="w">nespd</span><span class="c">;</span>
	<span class="w">u6</span><span class="c">4</span> <span class="w">tagged_offset</span><span class="c">;</span>
	<span class="w">u</span><span class="pc">8</span> <span class="w">mpa_frame_offset</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="w">s</span><span class="c">truct</span> <span class="w">ietf_mpa_v2</span> <span class="c">*</span><span class="w">mpa_v2_frame</span><span class="c">;</span>
	<span class="pc">u</span><span class="c">8</span> <span class="w">start_addr</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="pc">u</span><span class="c">8</span> <span class="c">*</span><span class="w">start_ptr</span> <span class="w">=</span><span class="pc"> &amp;</span><span class="w">s</span><span class="c">tart_addr;</span>
	<span class="w">u</span><span class="pc">8</span> <span class="w">*</span><span class="pc">*</span><span class="w">start_buff</span> <span class="w">=</span><span class="pc"> &amp;start_p</span><span class="c">tr;</span>
	<span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="w">buff_len</span> <span class="pc">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="w">s</span><span class="c">truct</span> <span class="w">sockaddr_in</span> <span class="c">*</span><span class="w">laddr</span> <span class="pc">= (s</span><span class="c">truct</span> <span class="c">sockaddr_in</span> <span class="pc">*)&amp;</span><span class="w">cm_id-</span><span class="c">&gt;</span><span class="w">local_addr</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">so</span><span class="c">ckaddr_in</span> <span class="c">*</span><span class="w">raddr</span> <span class="pc">= (</span><span class="c">struct</span> <span class="w">s</span><span class="pc">o</span><span class="c">ckaddr_in</span> <span class="pc">*)&amp;c</span><span class="c">m_id-&gt;</span><span class="w">remote_addr</span><span class="c">;</span>

	<span class="w">ibqp</span> <span class="pc">=</span> <span class="w">nes_get_qp</span><span class="c">(cm_id-&gt;</span><span class="w">d</span><span class="pc">evi</span><span class="c">ce</span><span class="pc">,</span> <span class="w">conn_param</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">qpn</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">ibqp</span><span class="pc">)</span>
		<span class="c">return</span> <span class="c">-</span><span class="pc">EI</span><span class="c">NVAL;</span>

	
	<span class="w">nesqp</span> <span class="c">=</span> <span class="w">to_nesqp</span><span class="c">(</span><span class="w">i</span><span class="c">bqp</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">nesvnic</span> <span class="pc">=</span> <span class="w">to_nesvnic</span><span class="c">(nesqp</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i</span><span class="pc">b</span><span class="c">qp</span><span class="pc">.</span><span class="w">d</span><span class="pc">e</span><span class="c">vice</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">nes</span><span class="pc">d</span><span class="c">ev</span> <span class="pc">=</span> <span class="c">nesvnic</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">nes</span><span class="pc">d</span><span class="c">ev;</span>
	<span class="w">a</span><span class="c">dapter</span> <span class="pc">=</span> <span class="w">nes</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="w">nesadapter</span><span class="c">;</span>

	<span class="w">cm_node</span> <span class="w">=</span><span class="pc"> (</span><span class="w">s</span><span class="c">truct</span> <span class="w">nes_cm_node</span> <span class="c">*)</span><span class="w">cm_id</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">provider_data</span><span class="c">;</span>
	<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM,</span><span class="pc"> "</span><span class="w">nes_accept:</span> <span class="w">c</span><span class="pc">m_n</span><span class="c">ode</span><span class="w">=</span><span class="pc"> %p</span> <span class="w">n</span><span class="pc">esv</span><span class="c">nic</span><span class="pc">=</span><span class="c">%</span><span class="pc">p,</span> <span class="w">net</span><span class="c">dev=%</span><span class="pc">p</span><span class="w">,"</span>
		<span class="w">"</span><span class="pc">%</span><span class="c">s</span><span class="pc">\</span><span class="c">n",</span> <span class="pc">cm_n</span><span class="c">ode</span><span class="pc">,</span> <span class="w">nes</span><span class="pc">v</span><span class="c">nic,</span> <span class="w">n</span><span class="pc">esv</span><span class="c">nic</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">net</span><span class="c">dev</span><span class="pc">,</span>
		<span class="w">n</span><span class="pc">esv</span><span class="c">nic-&gt;</span><span class="w">ne</span><span class="pc">t</span><span class="c">dev</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">n</span><span class="c">ame</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">NES_CM_STATE_LISTENER_DESTROYED</span> <span class="pc">=</span><span class="c">=</span> <span class="w">c</span><span class="pc">m</span><span class="c">_node-&gt;</span><span class="w">s</span><span class="pc">tate)</span><span class="c"> {</span>
		<span class="c">if</span> <span class="c">(</span><span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">loopbackpartner</span><span class="pc">)</span>
			<span class="w">rem_ref_cm_node</span><span class="c">(cm_node-&gt;</span><span class="w">cm_core</span><span class="c">,</span> <span class="c">cm_node-&gt;</span><span class="pc">l</span><span class="c">oopbackpartner);</span>
		<span class="w">r</span><span class="pc">em</span><span class="c">_ref_cm_node(cm_node-&gt;</span><span class="pc">cm_c</span><span class="c">ore</span><span class="pc">,</span> <span class="w">c</span><span class="pc">m_n</span><span class="c">ode</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">r</span><span class="c">eturn</span> <span class="pc">-EIN</span><span class="c">VAL;</span>
	<span class="c">}</span>

	<span class="w">passive_state</span> <span class="pc">=</span> <span class="w">atomic_add_return</span><span class="c">(</span><span class="w">1</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">c</span><span class="c">m_node-&gt;passive_state</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(passive_state</span> <span class="w">=</span><span class="c">=</span> <span class="w">NES_SEND_RESET_EVENT</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">r</span><span class="pc">em</span><span class="c">_ref_cm_node</span><span class="pc">(</span><span class="c">cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">cm_c</span><span class="c">ore,</span> <span class="pc">c</span><span class="c">m_node);</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="pc">-</span><span class="w">ECONNRESET</span><span class="c">;</span>
	<span class="c">}</span>
	
	<span class="w">nesqp</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">c</span><span class="c">m_node</span> <span class="w">=</span><span class="pc"> (</span><span class="w">v</span><span class="c">oid</span> <span class="pc">*</span><span class="c">)</span><span class="pc">cm_n</span><span class="c">ode</span><span class="pc">;</span>
	<span class="pc">c</span><span class="c">m_node-&gt;</span><span class="pc">n</span><span class="c">esqp</span> <span class="c">=</span> <span class="w">n</span><span class="c">esqp;</span>


	<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM,</span><span class="pc"> "</span><span class="w">QP</span><span class="pc">%u,</span> <span class="pc">c</span><span class="c">m_node</span><span class="w">=</span><span class="c">%</span><span class="pc">p</span><span class="c">,</span> <span class="w">j</span><span class="c">iffies</span> <span class="w">=</span><span class="pc"> </span><span class="c">%</span><span class="w">l</span><span class="pc">u</span> <span class="w">listener</span> <span class="w">=</span><span class="pc"> </span><span class="c">%</span><span class="pc">p</span><span class="c">\n",</span>
		<span class="c">nesqp-&gt;</span><span class="w">hwqp.qp_id</span><span class="c">,</span> <span class="pc">c</span><span class="c">m_node,</span> <span class="w">j</span><span class="c">iffies,</span> <span class="w">c</span><span class="pc">m_</span><span class="c">node-&gt;</span><span class="w">l</span><span class="c">istener</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">at</span><span class="pc">omic_i</span><span class="c">nc(&amp;</span><span class="w">cm_accepts</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">n</span><span class="pc">es_</span><span class="c">debug</span><span class="pc">(N</span><span class="c">ES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">net</span><span class="pc">d</span><span class="c">ev</span> <span class="w">refcnt</span> <span class="w">=</span><span class="pc"> </span><span class="c">%u</span><span class="w">.</span><span class="pc">\</span><span class="c">n",</span>
			<span class="w">netdev_refcnt_read</span><span class="pc">(</span><span class="w">nesvnic</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">net</span><span class="pc">dev</span><span class="c">));</span>

	<span class="pc">n</span><span class="c">esqp-&gt;</span><span class="w">ietf_frame_size</span> <span class="c">=</span> <span class="w">s</span><span class="c">izeof(</span><span class="pc">s</span><span class="c">truct</span> <span class="w">ietf_mpa_v2)</span><span class="pc">;</span>
	
	<span class="w">n</span><span class="c">esqp</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ietf_frame</span> <span class="c">=</span> <span class="w">pci_alloc_consistent</span><span class="pc">(</span><span class="w">nes</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="w">pc</span><span class="pc">id</span><span class="c">ev</span><span class="pc">,</span>
						 <span class="pc">n</span><span class="c">esqp-&gt;</span><span class="pc">ietf_frame_</span><span class="c">size</span> <span class="w">+</span> <span class="w">conn_param</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">private_data_len</span><span class="pc">,</span>
						 <span class="pc">&amp;</span><span class="c">nesqp-&gt;</span><span class="w">ietf_frame_pbase</span><span class="pc">)</span><span class="c">;</span>

	<span class="c">if</span> <span class="pc">(!</span><span class="c">nesqp-&gt;</span><span class="pc">ietf_frame) </span><span class="c">{</span>
		<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM,</span><span class="pc"> </span><span class="c">"</span><span class="w">U</span><span class="c">nable</span> <span class="c">to</span> <span class="pc">a</span><span class="c">llocate</span> <span class="w">m</span><span class="c">emory</span> <span class="pc">f</span><span class="c">or</span> <span class="w">pri</span><span class="pc">vate</span> <span class="w">da</span><span class="c">ta</span><span class="pc">\</span><span class="c">n");</span>
		<span class="c">return</span> <span class="c">-ENOMEM;</span>
	<span class="c">}</span>
	<span class="w">mpa_v2_frame</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="pc">s</span><span class="c">truct</span> <span class="w">ietf_mpa_v2</span> <span class="pc">*)</span><span class="c">nesqp-&gt;</span><span class="pc">ietf_frame;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">mpa_frame_rev</span> <span class="pc">=</span><span class="c">=</span> <span class="w">IETF_MPA_V1</span><span class="c">)</span>
		<span class="w">mpa_frame_offset</span> <span class="pc">=</span> <span class="w">4</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="pc">c</span><span class="c">m_node-&gt;</span><span class="pc">m</span><span class="c">pa_frame_rev</span> <span class="c">==</span> <span class="w">I</span><span class="c">ETF_MPA_V1</span> <span class="pc">|</span><span class="c">|</span>
			<span class="c">cm_node-&gt;</span><span class="w">mpav2_ird_ord</span> <span class="pc">=</span><span class="c">=</span> <span class="w">IETF_NO_IRD_ORD</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">record_ird_ord</span><span class="pc">(c</span><span class="c">m_node</span><span class="w">,</span><span class="pc"> (</span><span class="w">u</span><span class="pc">1</span><span class="c">6</span><span class="w">)conn_param</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ird,</span><span class="pc"> </span><span class="c">(u16</span><span class="w">)c</span><span class="pc">o</span><span class="c">nn_param-&gt;</span><span class="w">ord</span><span class="c">);</span>
	<span class="c">}</span>

	<span class="w">m</span><span class="pc">e</span><span class="c">mcpy(</span><span class="w">mpa_v2_frame</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">priv_data</span><span class="c">,</span> <span class="w">c</span><span class="pc">o</span><span class="c">nn_param</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">pr</span><span class="pc">iva</span><span class="c">te_data,</span>
	       <span class="pc">co</span><span class="c">nn_param-&gt;</span><span class="w">private_data_len</span><span class="c">);</span>

	<span class="w">cm_build_mpa_frame</span><span class="c">(</span><span class="pc">cm</span><span class="c">_node</span><span class="pc">,</span> <span class="w">start_buff</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">buff_len</span><span class="pc">,</span> <span class="w">nesqp</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ietf_frame</span><span class="c">,</span> <span class="w">MPA_KEY_REPLY</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">n</span><span class="c">esqp-&gt;</span><span class="w">p</span><span class="c">rivate_data_len</span> <span class="c">=</span> <span class="c">conn_param-&gt;</span><span class="w">p</span><span class="pc">riva</span><span class="c">te_data_len;</span>

	
	<span class="w">wqe</span> <span class="w">=</span><span class="pc"> &amp;</span><span class="c">nesqp-&gt;</span><span class="w">hwqp</span><span class="pc">.</span><span class="w">sq_vbase[</span><span class="c">0];</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">raddr</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sin_addr</span><span class="c">.</span><span class="w">s_addr</span> <span class="w">!</span><span class="c">=</span> <span class="w">laddr</span><span class="pc">-</span><span class="c">&gt;sin_addr.</span><span class="pc">s_</span><span class="c">addr</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
		<span class="w">u64temp</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="c">long</span><span class="w">)</span><span class="pc">n</span><span class="c">esqp</span><span class="pc">;</span>
		<span class="w">nesibdev</span> <span class="pc">=</span> <span class="w">nesvnic</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">n</span><span class="c">esibdev;</span>
		<span class="w">nespd</span> <span class="pc">=</span> <span class="pc">nesq</span><span class="c">p-&gt;</span><span class="pc">nesp</span><span class="c">d;</span>
		<span class="w">ibphysbuf</span><span class="pc">.</span><span class="w">a</span><span class="pc">d</span><span class="c">dr</span> <span class="c">=</span> <span class="pc">nesq</span><span class="c">p</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ietf_frame_pbase</span> <span class="pc">+</span> <span class="w">mpa_frame_offset</span><span class="c">;</span>
		<span class="pc">ib</span><span class="c">physbuf</span><span class="pc">.</span><span class="w">s</span><span class="pc">iz</span><span class="c">e</span> <span class="c">=</span> <span class="w">buff_len</span><span class="c">;</span>
		<span class="w">tagged_offset</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="w">u</span><span class="pc">64</span><span class="w">)</span><span class="pc">(</span><span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="c">long</span><span class="w">)*start_buff</span><span class="c">;</span>
		<span class="w">ibmr</span> <span class="w">=</span> <span class="pc">nesi</span><span class="c">bdev-&gt;</span><span class="w">ibdev</span><span class="pc">.</span><span class="w">reg_phys_mr(</span><span class="pc">(</span><span class="c">struct</span> <span class="w">ib_pd</span> <span class="pc">*)</span><span class="w">n</span><span class="pc">esp</span><span class="c">d</span><span class="pc">,</span>
						   <span class="w">&amp;</span><span class="pc">ibp</span><span class="c">hysbuf</span><span class="pc">,</span> <span class="w">1</span><span class="pc">,</span>
						   <span class="w">IB_ACCESS_LOCAL_WRITE</span><span class="c">,</span>
						   <span class="c">&amp;</span><span class="w">t</span><span class="c">agged_offset);</span>
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="c">ibmr</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="pc">U</span><span class="c">nable</span> <span class="c">to</span> <span class="w">r</span><span class="pc">eg</span><span class="c">ister</span> <span class="c">memory</span> <span class="w">re</span><span class="pc">gio</span><span class="c">n</span><span class="w">"</span>
				  <span class="w">"</span><span class="c">for</span> <span class="w">lSMM</span> <span class="pc">f</span><span class="c">or</span> <span class="w">cm_node</span> <span class="w">=</span><span class="pc"> </span><span class="c">%</span><span class="w">p</span> <span class="c">\n",</span>
				  <span class="w">c</span><span class="c">m_node</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">pci_free_consistent</span><span class="c">(</span><span class="w">nes</span><span class="pc">d</span><span class="c">ev</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">pc</span><span class="pc">id</span><span class="c">ev,</span>
					    <span class="w">nesqp</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">private_data_len</span> <span class="w">+</span> <span class="w">n</span><span class="c">esqp</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ietf_frame_size</span><span class="c">,</span>
					    <span class="c">nesqp-&gt;</span><span class="w">ietf_frame</span><span class="pc">,</span> <span class="c">nesqp-&gt;</span><span class="w">ietf_frame_pbase</span><span class="c">);</span>
			<span class="pc">r</span><span class="c">eturn</span> <span class="pc">-</span><span class="w">EN</span><span class="pc">OM</span><span class="c">EM;</span>
		<span class="c">}</span>

		<span class="w">ibmr</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">pd</span> <span class="w">=</span><span class="pc"> &amp;</span><span class="w">nespd</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ibpd</span><span class="c">;</span>
		<span class="pc">i</span><span class="c">bmr-&gt;</span><span class="w">d</span><span class="pc">evi</span><span class="c">ce</span> <span class="c">=</span> <span class="w">n</span><span class="pc">esp</span><span class="c">d-&gt;</span><span class="pc">ibp</span><span class="c">d</span><span class="pc">.</span><span class="w">d</span><span class="c">evice</span><span class="pc">;</span>
		<span class="w">n</span><span class="c">esqp-&gt;</span><span class="w">lsmm_mr</span> <span class="c">=</span> <span class="pc">ibm</span><span class="c">r</span><span class="pc">;</span>

		<span class="w">u64temp</span> <span class="w">|</span><span class="c">=</span> <span class="w">NES_SW_CONTEXT_ALIGN</span> <span class="w">&gt;</span><span class="c">&gt;</span> <span class="c">1;</span>
		<span class="w">set_wqe_64bit_value</span><span class="pc">(</span><span class="w">wqe-</span><span class="c">&gt;</span><span class="w">wqe_words</span><span class="c">,</span>
				    <span class="w">NES_IWARP_SQ_WQE_COMP_CTX_LOW_IDX</span><span class="c">,</span>
				    <span class="w">u</span><span class="c">64temp</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">w</span><span class="c">qe-&gt;wqe_words</span><span class="pc">[</span><span class="w">NES_IWARP_SQ_WQE_MISC_IDX</span><span class="c">] =</span>
			<span class="w">c</span><span class="c">pu_to_le32(</span><span class="w">NES_IWARP_SQ_WQE_STREAMING</span> <span class="pc">|</span>
				    <span class="w">NES_IWARP_SQ_WQE_WRPDU</span><span class="c">);</span>
		<span class="pc">w</span><span class="c">qe-&gt;</span><span class="pc">wqe_</span><span class="c">words</span><span class="pc">[</span><span class="w">NES_IWARP_SQ_WQE_TOTAL_PAYLOAD_IDX</span><span class="pc">] </span><span class="c">=</span>
			<span class="w">c</span><span class="c">pu_to_le32(</span><span class="w">buff_len</span><span class="c">);</span>
		<span class="w">s</span><span class="c">et_wqe_64bit_value</span><span class="pc">(</span><span class="c">wqe-&gt;wqe_words,</span>
				    <span class="w">NES_IWARP_SQ_WQE_FRAG0_LOW_IDX</span><span class="pc">,</span>
				    <span class="w">(u6</span><span class="pc">4</span><span class="w">)(u</span><span class="pc">n</span><span class="c">signed</span> <span class="c">long</span><span class="w">)(*start_buff))</span><span class="c">;</span>
		<span class="pc">wqe-</span><span class="c">&gt;wqe_words</span><span class="pc">[</span><span class="w">NES_IWARP_SQ_WQE_LENGTH0_IDX</span><span class="c">] =</span>
			<span class="w">c</span><span class="pc">pu_to_le3</span><span class="c">2(</span><span class="pc">b</span><span class="c">uff_len</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">wqe-&gt;wqe_words[</span><span class="w">NES_IWARP_SQ_WQE_STAG0_IDX</span><span class="c">] =</span> <span class="w">ibmr</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">lkey</span><span class="c">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">nesqp</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sq_kmapped</span><span class="pc">)</span><span class="c"> {</span>
			<span class="w">n</span><span class="c">esqp</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">s</span><span class="c">q_kmapped</span> <span class="c">=</span> <span class="w">0</span><span class="c">;</span>
			<span class="w">kunmap</span><span class="c">(</span><span class="pc">n</span><span class="c">esqp</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">pag</span><span class="c">e</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">}</span>

		<span class="w">n</span><span class="c">esqp</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">nesqp_context-</span><span class="c">&gt;</span><span class="w">ird_ord_sizes</span> <span class="w">|</span><span class="c">=</span>
			<span class="w">c</span><span class="c">pu_to_le32(</span><span class="w">NES_QPCONTEXT_ORDIRD_LSMM_PRESENT</span> <span class="pc">|</span>
				    <span class="w">NES_QPCONTEXT_ORDIRD_WRPDU</span><span class="c">);</span>
	<span class="pc">}</span> <span class="c">else</span> <span class="c">{</span>
		<span class="w">n</span><span class="pc">esqp</span><span class="c">-&gt;</span><span class="w">n</span><span class="pc">esqp_</span><span class="c">context</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">i</span><span class="c">rd_ord_sizes</span> <span class="w">|</span><span class="c">=</span>
			<span class="w">c</span><span class="c">pu_to_le32(</span><span class="pc">NES_QPCONTEXT_ORDIRD_W</span><span class="c">RPDU</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="pc">n</span><span class="c">esqp-&gt;</span><span class="w">skip_lsmm</span> <span class="c">=</span> <span class="w">1</span><span class="c">;</span>

	
	<span class="pc">n</span><span class="c">esqp-&gt;</span><span class="w">cm_id</span> <span class="c">=</span> <span class="w">c</span><span class="c">m_id;</span>
	<span class="w">cm_node</span><span class="c">-&gt;</span><span class="pc">c</span><span class="c">m_id</span> <span class="c">=</span> <span class="pc">c</span><span class="c">m_id</span><span class="pc">;</span>

	
	<span class="w">c</span><span class="pc">m_i</span><span class="c">d-&gt;</span><span class="w">provider_data</span> <span class="c">=</span> <span class="pc">n</span><span class="c">esqp;</span>
	<span class="pc">nesqp</span><span class="c">-&gt;</span><span class="w">active_conn</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">c</span><span class="pc">m_n</span><span class="c">ode-&gt;</span><span class="w">st</span><span class="pc">ate</span> <span class="pc">=</span><span class="c">=</span> <span class="w">NES_CM_STATE_TSA</span><span class="c">)</span>
		<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">Already</span> <span class="w">s</span><span class="pc">t</span><span class="c">ate</span> <span class="pc">=</span> <span class="w">TSA</span> <span class="w">f</span><span class="pc">o</span><span class="c">r</span> <span class="w">c</span><span class="pc">m_n</span><span class="c">ode</span><span class="w">=</span><span class="pc">%</span><span class="w">p</span><span class="pc">\</span><span class="c">n",</span>
			  <span class="pc">c</span><span class="c">m_node</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">nes_cm_init_tsa_conn</span><span class="c">(</span><span class="w">n</span><span class="pc">esq</span><span class="c">p,</span> <span class="c">cm_node</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">n</span><span class="pc">esq</span><span class="c">p-&gt;</span><span class="w">nesqp_context-</span><span class="pc">&gt;</span><span class="w">tcpPorts[</span><span class="c">0</span><span class="pc">] </span><span class="c">=</span>
				<span class="w">cp</span><span class="pc">u_to_le1</span><span class="c">6(cm_node-&gt;</span><span class="w">mapped_loc_port</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">n</span><span class="pc">esqp</span><span class="c">-&gt;</span><span class="pc">n</span><span class="c">esqp_context</span><span class="pc">-</span><span class="c">&gt;tcpPorts</span><span class="pc">[1</span><span class="w">] </span><span class="pc">=</span>
				<span class="w">c</span><span class="pc">pu_to_le1</span><span class="c">6(</span><span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">mapped_rem_port</span><span class="c">);</span>

	<span class="pc">n</span><span class="c">esqp-&gt;nesqp_context</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ip0</span> <span class="pc">=</span> <span class="pc">c</span><span class="c">pu_to_le32(cm_node-&gt;</span><span class="w">mapped_rem_addr</span><span class="c">);</span>

	<span class="w">n</span><span class="pc">esqp</span><span class="c">-&gt;</span><span class="pc">nesqp_</span><span class="c">context-&gt;</span><span class="w">misc2</span> <span class="w">|</span><span class="c">=</span> <span class="pc">cp</span><span class="c">u_to_le32(</span>
		<span class="w">(u</span><span class="c">32</span><span class="w">)PCI_FUNC</span><span class="pc">(</span><span class="w">nes</span><span class="pc">d</span><span class="c">ev</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">pc</span><span class="pc">id</span><span class="c">ev-&gt;</span><span class="w">de</span><span class="pc">vf</span><span class="c">n</span><span class="w">) </span><span class="pc">&lt;</span><span class="c">&lt;</span>
		<span class="w">NES_QPCONTEXT_MISC2_SRC_IP_SHIFT)</span><span class="pc">;</span>

	<span class="w">n</span><span class="c">esqp-&gt;nesqp_context-&gt;</span><span class="w">arp_index_vlan</span> <span class="w">|</span><span class="c">=</span>
		<span class="w">c</span><span class="pc">p</span><span class="c">u_to_le32(</span><span class="w">nes_arp_table</span><span class="pc">(</span><span class="w">nes</span><span class="pc">d</span><span class="c">ev</span><span class="pc">,</span>
					  <span class="w">l</span><span class="pc">e3</span><span class="c">2_to_cpu(nesqp-&gt;nesqp_context-&gt;</span><span class="w">ip0),</span> <span class="w">N</span><span class="c">ULL</span><span class="pc">,</span>
					  <span class="w">NES_ARP_RESOLVE) &lt;</span><span class="c">&lt;</span> <span class="pc">1</span><span class="c">6);</span>

	<span class="pc">n</span><span class="c">esqp-&gt;nesqp_context</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ts_val_delta</span> <span class="pc">=</span> <span class="c">cpu_to_le32(</span>
		<span class="w">j</span><span class="c">iffies</span> <span class="w">-</span> <span class="w">nes_read_indexed</span><span class="pc">(</span><span class="w">nes</span><span class="pc">d</span><span class="c">ev</span><span class="pc">,</span> <span class="w">NES_IDX_TCP_NOW)</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">nesqp</span><span class="c">-&gt;nesqp_context</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ird_index</span> <span class="c">=</span> <span class="pc">c</span><span class="c">pu_to_le32(nesqp-&gt;</span><span class="w">hwqp</span><span class="pc">.</span><span class="w">qp_id</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">nesqp</span><span class="c">-&gt;nesqp_context</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ird_ord_sizes</span> <span class="w">|</span><span class="c">=</span> <span class="w">c</span><span class="c">pu_to_le32(</span>
		<span class="w">(</span><span class="c">(</span><span class="w">u</span><span class="pc">3</span><span class="c">2</span><span class="w">)1</span> <span class="c">&lt;&lt;</span> <span class="w">NES_QPCONTEXT_ORDIRD_IWARP_MODE_SHIFT))</span><span class="c">;</span>
	<span class="w">n</span><span class="c">esqp-&gt;</span><span class="pc">nesqp_</span><span class="c">context</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">ird_o</span><span class="c">rd_sizes</span> <span class="w">|</span><span class="c">=</span>
		<span class="w">c</span><span class="c">pu_to_le32</span><span class="pc">((u</span><span class="c">32)</span><span class="w">cm_node</span><span class="c">-&gt;</span><span class="w">ord_size</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">m</span><span class="pc">ems</span><span class="c">et</span><span class="pc">(&amp;</span><span class="w">nes_quad</span><span class="pc">,</span> <span class="c">0,</span> <span class="c">sizeof(</span><span class="pc">n</span><span class="c">es_quad));</span>
	<span class="pc">nes_</span><span class="c">quad</span><span class="pc">.</span><span class="w">DstIpAdrIndex</span> <span class="c">=</span>
		<span class="pc">cpu_to_le3</span><span class="c">2</span><span class="pc">((u</span><span class="c">32</span><span class="w">)PCI_FUNC</span><span class="c">(</span><span class="w">nes</span><span class="pc">d</span><span class="c">ev</span><span class="w">-</span><span class="c">&gt;</span><span class="w">pc</span><span class="pc">id</span><span class="c">ev</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">de</span><span class="pc">vf</span><span class="c">n</span><span class="w">) &lt;</span><span class="c">&lt;</span> <span class="w">2</span><span class="pc">4);</span>
	<span class="w">n</span><span class="c">es_quad</span><span class="w">.SrcIpadr</span> <span class="c">=</span> <span class="w">h</span><span class="pc">t</span><span class="c">onl(</span><span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">mapped_rem_addr</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">n</span><span class="c">es_quad</span><span class="pc">.</span><span class="w">TcpPorts[</span><span class="c">0] =</span> <span class="w">h</span><span class="c">tons(</span><span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">mapped_rem_port</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">n</span><span class="c">es_quad</span><span class="pc">.T</span><span class="c">cpPorts</span><span class="pc">[</span><span class="w">1</span><span class="c">] =</span> <span class="w">ht</span><span class="pc">ons</span><span class="c">(cm_node-&gt;</span><span class="w">mapped_loc_port</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="w">crc_value</span> <span class="pc">=</span> <span class="w">get_crc_value</span><span class="pc">(&amp;n</span><span class="c">es_quad</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">nesqp</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">hte_index</span> <span class="c">=</span> <span class="w">c</span><span class="pc">pu_to_b</span><span class="c">e32(</span><span class="pc">cr</span><span class="c">c_value</span> <span class="w">^</span> <span class="w">0xff</span><span class="pc">fff</span><span class="c">fff);</span>
	<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM,</span><span class="pc"> "</span><span class="w">HTE</span> <span class="w">Index</span> <span class="w">=</span> <span class="c">0x%</span><span class="w">0</span><span class="pc">8X,</span> <span class="w">CRC</span> <span class="pc">=</span> <span class="c">0x%</span><span class="pc">08</span><span class="c">X</span><span class="pc">\</span><span class="c">n",</span>
		  <span class="c">nesqp-&gt;</span><span class="pc">h</span><span class="c">te_index,</span> <span class="pc">nesq</span><span class="c">p-&gt;</span><span class="pc">h</span><span class="c">te_index</span> <span class="w">&amp;</span> <span class="w">ad</span><span class="pc">apt</span><span class="c">er-&gt;</span><span class="w">hte_index_mask</span><span class="pc">)</span><span class="c">;</span>

	<span class="c">nesqp</span><span class="pc">-</span><span class="c">&gt;hte_index</span> <span class="w">&amp;=</span> <span class="w">a</span><span class="c">dapter-&gt;</span><span class="w">h</span><span class="pc">te_index_</span><span class="c">mask</span><span class="pc">;</span>
	<span class="pc">n</span><span class="c">esqp-&gt;</span><span class="w">nesqp_context-</span><span class="pc">&gt;h</span><span class="c">te_index</span> <span class="w">=</span> <span class="w">c</span><span class="pc">pu_to_le3</span><span class="c">2(nesqp-&gt;</span><span class="pc">h</span><span class="c">te_index</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">cm_core</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">api</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">accelerated(c</span><span class="pc">m_n</span><span class="c">ode-&gt;cm_core</span><span class="pc">,</span> <span class="pc">cm_n</span><span class="c">ode</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM,</span><span class="pc"> "</span><span class="w">QP</span><span class="c">%</span><span class="pc">u</span><span class="w">,</span> <span class="w">Destination</span> <span class="w">IP</span> <span class="w">=</span> <span class="c">0x%</span><span class="w">0</span><span class="pc">8</span><span class="c">X</span><span class="w">:</span><span class="c">0x%</span><span class="w">04X</span><span class="pc">,</span> <span class="w">loc</span><span class="pc">a</span><span class="c">l</span> <span class="w">= "</span>
		  <span class="w">"0</span><span class="pc">x</span><span class="c">%</span><span class="w">08</span><span class="pc">X</span><span class="w">:</span><span class="c">0x%</span><span class="w">04</span><span class="pc">X,</span> <span class="w">rcv_nxt=</span><span class="c">0x%</span><span class="pc">08</span><span class="c">X</span><span class="pc">,</span> <span class="w">snd_nxt=</span><span class="c">0x%</span><span class="pc">08</span><span class="c">X,</span> <span class="w">mpa</span> <span class="w">+ "</span>
		  <span class="w">"pri</span><span class="pc">va</span><span class="c">te</span> <span class="w">da</span><span class="c">ta</span> <span class="w">l</span><span class="pc">eng</span><span class="c">th</span><span class="w">=</span><span class="c">%</span><span class="pc">u</span><span class="w">.</span><span class="pc">\</span><span class="c">n",</span> <span class="w">nesqp</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">hwqp.qp_id</span><span class="pc">,</span>
		  <span class="w">ntohl</span><span class="pc">(</span><span class="w">raddr-</span><span class="c">&gt;</span><span class="w">sin_addr</span><span class="pc">.</span><span class="w">s_addr</span><span class="pc">),</span> <span class="w">n</span><span class="pc">tohs</span><span class="c">(</span><span class="pc">ra</span><span class="c">ddr-&gt;</span><span class="w">sin_port</span><span class="pc">)</span><span class="c">,</span>
		  <span class="w">n</span><span class="pc">t</span><span class="c">ohl</span><span class="pc">(</span><span class="w">laddr-</span><span class="c">&gt;</span><span class="pc">sin_a</span><span class="c">ddr</span><span class="w">.s</span><span class="pc">_</span><span class="c">addr</span><span class="pc">)</span><span class="c">,</span> <span class="w">n</span><span class="pc">tohs</span><span class="c">(</span><span class="pc">l</span><span class="c">addr-&gt;sin_port</span><span class="pc">)</span><span class="c">,</span>
		  <span class="w">l</span><span class="pc">e</span><span class="c">32_to_cpu(</span><span class="w">n</span><span class="c">esqp-&gt;</span><span class="w">nesqp_context-</span><span class="c">&gt;</span><span class="w">rcv_nxt</span><span class="pc">)</span><span class="c">,</span>
		  <span class="pc">le</span><span class="c">32_to_cpu(</span><span class="pc">nesqp</span><span class="c">-&gt;nesqp_context-&gt;</span><span class="w">snd_nxt</span><span class="c">),</span>
		  <span class="w">buff_len)</span><span class="c">;</span>

	
	<span class="w">cm_id</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">add_ref</span><span class="pc">(</span><span class="w">c</span><span class="c">m_id</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">nes_add_ref</span><span class="pc">(&amp;</span><span class="w">n</span><span class="pc">esqp</span><span class="c">-&gt;</span><span class="w">ibqp</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">cm_event.ev</span><span class="pc">e</span><span class="c">nt</span> <span class="c">=</span> <span class="w">IW_CM_EVENT_ESTABLISHED</span><span class="c">;</span>
	<span class="pc">c</span><span class="c">m_event</span><span class="pc">.</span><span class="w">st</span><span class="pc">atu</span><span class="c">s</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="pc">c</span><span class="c">m_event</span><span class="pc">.</span><span class="w">provider_data</span> <span class="pc">= </span><span class="c">(</span><span class="w">v</span><span class="c">oid</span> <span class="pc">*</span><span class="c">)</span><span class="pc">n</span><span class="c">esqp</span><span class="pc">;</span>
	<span class="pc">cm_e</span><span class="c">vent</span><span class="pc">.</span><span class="w">local_addr</span> <span class="c">=</span> <span class="w">c</span><span class="pc">m_i</span><span class="c">d</span><span class="pc">-</span><span class="c">&gt;local_addr;</span>
	<span class="pc">cm_e</span><span class="c">vent</span><span class="pc">.</span><span class="w">remote_addr</span> <span class="c">=</span> <span class="pc">cm_i</span><span class="c">d</span><span class="pc">-</span><span class="c">&gt;remote_addr;</span>
	<span class="pc">c</span><span class="c">m_event.</span><span class="w">pr</span><span class="pc">iv</span><span class="c">ate_data</span> <span class="c">=</span> <span class="w">N</span><span class="c">ULL;</span>
	<span class="w">c</span><span class="c">m_event</span><span class="pc">.</span><span class="w">private_data_len</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="c">cm_event.</span><span class="w">ird</span> <span class="c">=</span> <span class="w">cm_node-</span><span class="c">&gt;</span><span class="w">ird_size</span><span class="pc">;</span>
	<span class="c">cm_event.</span><span class="w">ord</span> <span class="c">=</span> <span class="w">c</span><span class="pc">m_n</span><span class="c">ode</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ord_size</span><span class="c">;</span>

	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">c</span><span class="pc">m_i</span><span class="c">d-&gt;</span><span class="w">event_handler(c</span><span class="pc">m_i</span><span class="c">d</span><span class="pc">, </span><span class="c">&amp;cm_event</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">at</span><span class="pc">t</span><span class="c">r</span><span class="pc">.</span><span class="w">qp_state</span> <span class="c">=</span> <span class="w">IB_QPS_RTS</span><span class="c">;</span>
	<span class="w">nes_modify_qp</span><span class="pc">(&amp;</span><span class="w">nesqp</span><span class="c">-&gt;</span><span class="w">ibqp</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">a</span><span class="pc">t</span><span class="c">tr</span><span class="pc">,</span> <span class="w">IB_QP_STATE</span><span class="pc">,</span> <span class="pc">N</span><span class="c">ULL);</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">c</span><span class="pc">m_n</span><span class="c">ode-&gt;</span><span class="w">loopbackpartner</span><span class="c">) {</span>
		<span class="w">c</span><span class="c">m_node-&gt;loopbackpartner</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">mpa_frame_size</span> <span class="pc">=</span>
			<span class="pc">n</span><span class="c">esqp</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">private_data_len</span><span class="c">;</span>
		
		<span class="w">m</span><span class="pc">e</span><span class="c">mcpy(</span><span class="w">c</span><span class="pc">m_n</span><span class="c">ode-&gt;</span><span class="pc">l</span><span class="c">oopbackpartner</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">mpa_frame_buf</span><span class="pc">,</span>
		       <span class="w">conn_param</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">pri</span><span class="pc">vate_data,</span> <span class="w">c</span><span class="pc">o</span><span class="c">nn_param-&gt;</span><span class="w">p</span><span class="c">rivate_data_len</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">create_event</span><span class="c">(cm_node-&gt;loopbackpartner</span><span class="pc">,</span> <span class="w">NES_CM_EVENT_CONNECTED</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">r</span><span class="c">et)</span>
		<span class="w">p</span><span class="pc">rin</span><span class="c">tk(</span><span class="pc">KERN_E</span><span class="c">RR</span> <span class="pc">"%</span><span class="c">s</span><span class="w">[</span><span class="c">%</span><span class="w">u]</span> <span class="w">OFA</span> <span class="w">CM</span> <span class="w">event_handler</span> <span class="w">returned, "</span>
		       <span class="w">"ret</span><span class="pc">=</span><span class="c">%d\n",</span> <span class="pc">_</span><span class="c">_func__,</span> <span class="w">_</span><span class="c">_LINE__,</span> <span class="w">r</span><span class="c">et);</span>

	<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>
<span class="c">}</span>



<span class="pc">in</span><span class="c">t</span> <span class="w">nes_reject</span><span class="c">(struct</span> <span class="w">iw_cm_id</span> <span class="c">*</span><span class="w">cm_id</span><span class="c">,</span> <span class="w">c</span><span class="pc">o</span><span class="c">nst</span> <span class="pc">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">pd</span><span class="pc">a</span><span class="c">ta,</span> <span class="w">u</span><span class="pc">8</span> <span class="w">pdata_len</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="w">cm_node</span><span class="pc">;</span>
	<span class="c">struct</span> <span class="c">nes_cm_node</span> <span class="c">*</span><span class="w">loopback</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">nes_cm_core</span> <span class="c">*</span><span class="w">cm_core</span><span class="c">;</span>
	<span class="w">u</span><span class="pc">8</span> <span class="c">*</span><span class="w">start_buff</span><span class="c">;</span>

	<span class="w">at</span><span class="pc">omic_i</span><span class="c">nc(&amp;</span><span class="w">cm_rejects</span><span class="c">);</span>
	<span class="w">c</span><span class="pc">m_n</span><span class="c">ode</span> <span class="w">=</span><span class="pc"> (</span><span class="c">struct</span> <span class="w">n</span><span class="c">es_cm_node</span> <span class="c">*)</span><span class="pc">cm_i</span><span class="c">d</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">provider_data</span><span class="c">;</span>
	<span class="w">l</span><span class="c">oopback</span> <span class="w">=</span> <span class="w">c</span><span class="pc">m_n</span><span class="c">ode-&gt;</span><span class="w">loopbackpartner</span><span class="c">;</span>
	<span class="pc">c</span><span class="c">m_core</span> <span class="pc">=</span> <span class="pc">c</span><span class="c">m_node-&gt;cm_core;</span>
	<span class="w">c</span><span class="pc">m_n</span><span class="c">ode-&gt;</span><span class="w">c</span><span class="pc">m_i</span><span class="c">d</span> <span class="c">=</span> <span class="w">c</span><span class="pc">m_i</span><span class="c">d</span><span class="pc">;</span>

	<span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="w">pdata_len</span> <span class="w">+</span> <span class="w">s</span><span class="pc">i</span><span class="c">zeof(</span><span class="pc">s</span><span class="c">truct</span> <span class="w">ietf_mpa_v2) &gt;</span> <span class="w">MAX_CM_BUFFER</span><span class="c">)</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="c">-EINVAL;</span>

	<span class="c">if</span> <span class="c">(</span><span class="pc">l</span><span class="c">oopback</span><span class="w">)</span><span class="c"> {</span>
		<span class="w">m</span><span class="c">emcpy</span><span class="pc">(&amp;l</span><span class="c">oopback-&gt;</span><span class="w">mpa_frame</span><span class="pc">.</span><span class="w">priv_data</span><span class="pc">,</span> <span class="w">pd</span><span class="pc">ata,</span> <span class="w">p</span><span class="c">data_len</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">l</span><span class="c">oopback</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">m</span><span class="c">pa_frame</span><span class="pc">.</span><span class="w">priv_data_len</span> <span class="c">=</span> <span class="w">p</span><span class="c">data_len</span><span class="pc">;</span>
		<span class="w">l</span><span class="c">oopback-&gt;</span><span class="w">mpa_frame_size</span> <span class="c">=</span> <span class="w">p</span><span class="pc">d</span><span class="c">ata_len;</span>
	<span class="pc">}</span> <span class="c">else</span> <span class="c">{</span>
		<span class="w">start_buff</span> <span class="w">=</span><span class="pc"> &amp;</span><span class="w">cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">mpa_frame_buf</span><span class="pc">[</span><span class="c">0</span><span class="w">] +</span> <span class="w">s</span><span class="pc">i</span><span class="c">zeof(struct</span> <span class="w">ietf_mpa_v2)</span><span class="pc">;</span>
		<span class="w">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">m</span><span class="pc">pa_frame_s</span><span class="c">ize</span> <span class="c">=</span> <span class="pc">p</span><span class="c">data_len</span><span class="pc">;</span>
		<span class="w">m</span><span class="pc">e</span><span class="c">mcpy</span><span class="pc">(s</span><span class="c">tart_buff</span><span class="pc">,</span> <span class="w">pd</span><span class="pc">ata,</span> <span class="w">p</span><span class="pc">d</span><span class="c">ata_len</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="w">r</span><span class="c">eturn</span> <span class="w">cm_core</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">api-</span><span class="c">&gt;</span><span class="w">reject(</span><span class="c">cm_core,</span> <span class="pc">c</span><span class="c">m_node</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>



<span class="pc">in</span><span class="c">t</span> <span class="w">nes_connect</span><span class="c">(struct</span> <span class="w">iw_cm_id</span> <span class="c">*</span><span class="w">cm_id</span><span class="c">,</span> <span class="c">struct</span> <span class="w">iw_cm_conn_param</span> <span class="c">*</span><span class="w">conn_param</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">ib_qp</span> <span class="c">*</span><span class="w">ibqp</span><span class="pc">;</span>
	<span class="c">struct</span> <span class="w">nes_qp</span> <span class="c">*</span><span class="w">nesqp</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">nes_vnic</span> <span class="c">*</span><span class="w">nesvnic</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">nes_device</span> <span class="c">*</span><span class="w">nesd</span><span class="c">ev;</span>
	<span class="c">struct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="w">cm</span><span class="pc">_n</span><span class="c">ode;</span>
	<span class="c">struct</span> <span class="w">nes_cm_info</span> <span class="w">cm_info</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">apbvt_set</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">sockaddr_in</span> <span class="c">*</span><span class="w">laddr</span> <span class="w">=</span><span class="pc"> (</span><span class="c">struct</span> <span class="c">sockaddr_in</span> <span class="pc">*)&amp;</span><span class="w">cm_id-</span><span class="c">&gt;</span><span class="w">local_addr</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">s</span><span class="c">ockaddr_in</span> <span class="c">*</span><span class="w">raddr</span> <span class="w">=</span><span class="pc"> (</span><span class="c">struct</span> <span class="w">s</span><span class="c">ockaddr_in</span> <span class="pc">*)&amp;c</span><span class="c">m_id-&gt;</span><span class="w">remote_addr</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">iwpm_dev_data</span> <span class="w">pm_reg_msg</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">iwpm_sa_data</span> <span class="w">pm_msg</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">iwpm_err</span> <span class="pc">=</span> <span class="c">0;</span>

	<span class="pc">if</span> <span class="c">(</span><span class="pc">c</span><span class="c">m_id-&gt;</span><span class="w">r</span><span class="pc">e</span><span class="c">mote_addr</span><span class="pc">.</span><span class="w">ss_family</span> <span class="w">!</span><span class="c">=</span> <span class="w">AF_INET</span><span class="pc">)</span>
		<span class="c">return</span> <span class="c">-</span><span class="w">ENOSYS</span><span class="c">;</span>
	<span class="w">ibqp</span> <span class="pc">=</span> <span class="w">nes_get_qp</span><span class="c">(cm_id</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">d</span><span class="pc">evi</span><span class="c">ce,</span> <span class="w">conn_param</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">qpn</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">ibqp</span><span class="pc">)</span>
		<span class="c">return</span> <span class="c">-</span><span class="pc">EI</span><span class="c">NVAL;</span>
	<span class="w">nesqp</span> <span class="c">=</span> <span class="w">to_nesqp</span><span class="c">(</span><span class="pc">i</span><span class="c">bqp</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">nesqp)</span>
		<span class="c">return</span> <span class="c">-EINVAL;</span>
	<span class="w">nesvnic</span> <span class="c">=</span> <span class="w">to_nesvnic</span><span class="c">(</span><span class="pc">n</span><span class="c">esqp</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i</span><span class="c">bqp.</span><span class="w">d</span><span class="pc">e</span><span class="c">vice</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">nesvnic</span><span class="pc">)</span>
		<span class="c">return</span> <span class="c">-</span><span class="pc">EI</span><span class="c">NVAL;</span>
	<span class="w">nes</span><span class="pc">d</span><span class="c">ev</span> <span class="c">=</span> <span class="c">nesvnic</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">nes</span><span class="pc">d</span><span class="c">ev</span><span class="pc">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">nes</span><span class="pc">d</span><span class="c">ev</span><span class="pc">)</span>
		<span class="c">return</span> <span class="c">-EINVAL;</span>

	<span class="c">if</span> <span class="pc">(!</span><span class="w">laddr-</span><span class="c">&gt;</span><span class="w">sin_port</span> <span class="w">|</span><span class="c">| !</span><span class="w">raddr</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">s</span><span class="c">in_port</span><span class="pc">)</span>
		<span class="c">return</span> <span class="c">-EINVAL;</span>

	<span class="w">nes_debug</span><span class="pc">(</span><span class="w">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">QP</span><span class="pc">%u</span><span class="w">,</span> <span class="w">cu</span><span class="c">rrent</span> <span class="w">IP</span> <span class="w">=</span> <span class="c">0x%</span><span class="w">0</span><span class="pc">8X,</span> <span class="w">Destination</span> <span class="w">I</span><span class="c">P</span> <span class="w">= </span><span class="pc">"</span>
		  <span class="w">"0x</span><span class="c">%</span><span class="w">0</span><span class="pc">8X</span><span class="w">:</span><span class="c">0x%</span><span class="w">04X</span><span class="pc">,</span> <span class="w">loc</span><span class="pc">a</span><span class="c">l</span> <span class="w">=</span> <span class="c">0x%</span><span class="pc">08</span><span class="c">X</span><span class="w">:</span><span class="c">0x%</span><span class="w">04</span><span class="pc">X</span><span class="w">.</span><span class="pc">\</span><span class="c">n",</span> <span class="w">nesqp</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">hwqp.qp_id</span><span class="pc">,</span>
		  <span class="w">ntohl(nesvnic-</span><span class="c">&gt;</span><span class="w">local_ipaddr</span><span class="pc">),</span> <span class="w">n</span><span class="pc">tohl(</span><span class="w">raddr</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sin_addr</span><span class="pc">.</span><span class="w">s_addr</span><span class="pc">),</span>
		  <span class="w">nt</span><span class="pc">ohs</span><span class="c">(</span><span class="pc">r</span><span class="c">addr-&gt;</span><span class="w">sin_port</span><span class="pc">),</span> <span class="w">n</span><span class="pc">t</span><span class="c">ohl</span><span class="pc">(</span><span class="w">laddr</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">sin_a</span><span class="c">ddr</span><span class="pc">.s_</span><span class="c">addr</span><span class="pc">)</span><span class="c">,</span>
		  <span class="w">n</span><span class="pc">tohs</span><span class="c">(</span><span class="pc">l</span><span class="c">addr-&gt;</span><span class="pc">s</span><span class="c">in_port</span><span class="w">)</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">a</span><span class="pc">t</span><span class="c">omic_inc(&amp;</span><span class="w">cm_connects</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">nesqp</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">active_conn</span> <span class="c">=</span> <span class="w">1</span><span class="c">;</span>

	
	<span class="pc">n</span><span class="c">esqp-&gt;</span><span class="w">cm_id</span> <span class="c">=</span> <span class="w">c</span><span class="c">m_id;</span>
	<span class="pc">c</span><span class="c">m_id-&gt;</span><span class="w">provider_data</span> <span class="c">=</span> <span class="c">nesqp;</span>
	<span class="c">nesqp-&gt;</span><span class="w">private_data_len</span> <span class="c">=</span> <span class="w">conn_param</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">p</span><span class="c">rivate_data_len;</span>

	<span class="w">nes_debug</span><span class="pc">(</span><span class="w">NES_DBG_CM,</span><span class="pc"> "</span><span class="w">requested</span> <span class="w">ord</span> <span class="w">=</span> <span class="c">0x%</span><span class="pc">0</span><span class="c">8X</span><span class="w">.</span><span class="pc">\</span><span class="c">n</span><span class="w">"</span><span class="pc">, </span><span class="c">(</span><span class="pc">u</span><span class="c">32</span><span class="pc">)</span><span class="w">c</span><span class="pc">onn</span><span class="c">_param-&gt;</span><span class="w">o</span><span class="c">rd);</span>
	<span class="w">n</span><span class="pc">es_</span><span class="c">debug</span><span class="pc">(</span><span class="c">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">mpa</span> <span class="w">pri</span><span class="pc">vate</span> <span class="w">da</span><span class="pc">ta</span> <span class="w">l</span><span class="pc">e</span><span class="c">n</span> <span class="w">=</span><span class="c">%</span><span class="pc">u</span><span class="c">\n",</span>
		  <span class="w">c</span><span class="c">onn_param-&gt;</span><span class="pc">p</span><span class="c">rivate_data_len</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="w">cm_info.loc_addr</span> <span class="c">=</span> <span class="w">ntohl</span><span class="c">(</span><span class="w">laddr</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sin_addr</span><span class="pc">.</span><span class="w">s_addr</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">c</span><span class="pc">m</span><span class="c">_info</span><span class="pc">.</span><span class="w">loc_port</span> <span class="c">=</span> <span class="w">n</span><span class="pc">tohs</span><span class="c">(</span><span class="pc">l</span><span class="c">addr-&gt;</span><span class="w">sin_port</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">c</span><span class="c">m_info</span><span class="pc">.</span><span class="w">rem_addr</span> <span class="c">=</span> <span class="w">n</span><span class="c">tohl</span><span class="pc">(</span><span class="w">raddr</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s</span><span class="pc">in_a</span><span class="c">ddr</span><span class="pc">.</span><span class="c">s_addr</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">c</span><span class="pc">m</span><span class="c">_info</span><span class="pc">.</span><span class="w">rem_port</span> <span class="c">=</span> <span class="w">n</span><span class="pc">tohs</span><span class="c">(</span><span class="pc">ra</span><span class="c">ddr-&gt;</span><span class="pc">s</span><span class="c">in_port</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">c</span><span class="c">m_info</span><span class="pc">.</span><span class="w">cm_id</span> <span class="c">=</span> <span class="w">c</span><span class="pc">m_id</span><span class="c">;</span>
	<span class="pc">c</span><span class="c">m_info</span><span class="pc">.</span><span class="w">conn_type</span> <span class="c">=</span> <span class="w">NES_CM_IWARP_CONN_TYPE</span><span class="c">;</span>

	
	<span class="pc">c</span><span class="c">m_info</span><span class="pc">.</span><span class="w">mapped_loc_addr</span> <span class="c">=</span> <span class="c">cm_info</span><span class="pc">.</span><span class="w">loc_addr</span><span class="pc">;</span>
	<span class="c">cm_info.</span><span class="w">mapped_loc_port</span> <span class="c">=</span> <span class="c">cm_info</span><span class="pc">.</span><span class="w">loc_port</span><span class="pc">;</span>
	<span class="c">cm_info.</span><span class="w">mapped_rem_addr</span> <span class="c">=</span> <span class="c">cm_info</span><span class="pc">.</span><span class="w">rem_addr</span><span class="pc">;</span>
	<span class="c">cm_info.</span><span class="w">mapped_rem_port</span> <span class="c">=</span> <span class="c">cm_info</span><span class="pc">.</span><span class="w">rem_port</span><span class="pc">;</span>

	<span class="w">nes_form_reg_msg</span><span class="pc">(</span><span class="w">nesvnic</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">pm_reg_msg</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">iwpm_err</span> <span class="c">=</span> <span class="w">iwpm_register_pid</span><span class="pc">(&amp;p</span><span class="c">m_reg_msg</span><span class="pc">,</span> <span class="w">RDMA_NL_NES</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(iwpm_err</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">nes_debug</span><span class="pc">(</span><span class="w">NES_DBG_NLMSG</span><span class="c">,</span>
			<span class="w">"Port</span> <span class="w">Mapper</span> <span class="w">reg</span> <span class="w">pi</span><span class="pc">d</span> <span class="w">fa</span><span class="pc">il</span> <span class="w">(e</span><span class="pc">r</span><span class="c">r</span> <span class="w">=</span><span class="pc"> %</span><span class="c">d</span><span class="w">).\</span><span class="c">n",</span> <span class="w">i</span><span class="c">wpm_err);</span>
	<span class="pc">}</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">iwpm_valid_pid() &amp;&amp; !i</span><span class="c">wpm_err</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">nes_form_pm_msg</span><span class="pc">(&amp;</span><span class="w">cm_info,</span><span class="pc"> &amp;</span><span class="w">pm_msg</span><span class="c">);</span>
		<span class="pc">iw</span><span class="c">pm_err</span> <span class="pc">=</span> <span class="w">iwpm_add_and_query_mapping</span><span class="pc">(&amp;</span><span class="w">p</span><span class="c">m_msg</span><span class="pc">,</span> <span class="w">RDMA_NL_NES</span><span class="c">);</span>
		<span class="c">if</span> <span class="pc">(i</span><span class="c">wpm_err</span><span class="w">)</span>
			<span class="w">nes_debug</span><span class="pc">(</span><span class="w">NES_DBG_NLMSG</span><span class="pc">,</span>
			<span class="w">"Port</span> <span class="w">Mapper</span> <span class="w">query</span> <span class="w">fa</span><span class="pc">il</span> <span class="w">(er</span><span class="pc">r</span> <span class="w">=</span><span class="pc"> %</span><span class="c">d</span><span class="w">).\</span><span class="pc">n</span><span class="c">",</span> <span class="c">iwpm_err</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">e</span><span class="c">lse</span>
			<span class="w">nes_record_pm_msg</span><span class="pc">(&amp;c</span><span class="c">m_info</span><span class="w">,</span><span class="pc"> </span><span class="c">&amp;pm_msg);</span>
	<span class="pc">}</span>

	<span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="w">laddr-</span><span class="c">&gt;</span><span class="w">sin_addr.s_addr</span> <span class="w">!</span><span class="c">=</span> <span class="w">raddr</span><span class="pc">-</span><span class="c">&gt;sin_addr.</span><span class="pc">s_</span><span class="c">addr</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">nes_manage_apbvt</span><span class="c">(</span><span class="w">nesvnic</span><span class="c">,</span> <span class="pc">c</span><span class="c">m_info</span><span class="w">.mapped_loc_port</span><span class="pc">,</span>
			<span class="w">PCI_FUNC(nes</span><span class="pc">d</span><span class="c">ev</span><span class="w">-</span><span class="c">&gt;</span><span class="w">pc</span><span class="pc">id</span><span class="c">ev</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">dev</span><span class="pc">f</span><span class="c">n</span><span class="pc">),</span> <span class="w">NES_MANAGE_APBVT_ADD</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">apbvt_set</span> <span class="pc">=</span> <span class="w">1</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">nes_create_mapinfo</span><span class="pc">(&amp;c</span><span class="c">m_info</span><span class="w">)</span><span class="pc">)</span>
		<span class="c">return</span> <span class="c">-</span><span class="w">E</span><span class="pc">NOM</span><span class="c">EM;</span>

	<span class="w">cm_id</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">add_ref</span><span class="pc">(</span><span class="w">c</span><span class="pc">m_id)</span><span class="c">;</span>

	
	<span class="w">cm_node</span> <span class="pc">=</span> <span class="w">g_cm_core</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">api-</span><span class="c">&gt;</span><span class="w">connect(</span><span class="pc">g</span><span class="c">_cm_core</span><span class="pc">,</span> <span class="w">nesvnic</span><span class="pc">,</span>
					  <span class="w">conn_param</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">private_data_len,</span><span class="pc"> (v</span><span class="c">oid</span> <span class="c">*)</span><span class="pc">co</span><span class="c">nn_param-&gt;</span><span class="w">pri</span><span class="pc">vate_data,</span>
					  <span class="w">&amp;</span><span class="pc">cm_in</span><span class="c">fo</span><span class="pc">);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">c</span><span class="pc">m_n</span><span class="c">ode</span><span class="pc">) </span><span class="c">{</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">apbvt_set</span><span class="pc">)</span>
			<span class="w">nes_manage_apbvt</span><span class="c">(</span><span class="w">n</span><span class="c">esvnic,</span> <span class="w">c</span><span class="pc">m_in</span><span class="c">fo</span><span class="w">.mapped_loc_port</span><span class="pc">,</span>
					 <span class="w">PCI_FUNC</span><span class="pc">(</span><span class="w">nes</span><span class="pc">d</span><span class="c">ev</span><span class="w">-</span><span class="c">&gt;</span><span class="w">pc</span><span class="c">idev</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">dev</span><span class="pc">f</span><span class="c">n</span><span class="w">)</span><span class="pc">,</span>
					 <span class="w">NES_MANAGE_APBVT_DEL</span><span class="pc">)</span><span class="c">;</span>

		<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_NLMSG</span><span class="pc">, "</span><span class="w">Delete</span> <span class="w">m</span><span class="c">apped_loc_port</span> <span class="w">= </span><span class="pc">%</span><span class="w">04X</span><span class="c">\n",</span>
				<span class="w">c</span><span class="pc">m_i</span><span class="c">nfo</span><span class="pc">.m</span><span class="c">apped_loc_port);</span>
		<span class="w">nes_remove_mapinfo</span><span class="c">(cm_info</span><span class="pc">.</span><span class="w">loc_addr</span><span class="c">,</span> <span class="c">cm_info</span><span class="w">.loc_port</span><span class="pc">,</span>
			<span class="c">cm_info</span><span class="pc">.</span><span class="w">mapped_loc_addr</span><span class="pc">,</span> <span class="c">cm_info</span><span class="pc">.m</span><span class="c">apped_loc_port</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">cm_id-</span><span class="c">&gt;</span><span class="w">rem_ref(c</span><span class="pc">m_id)</span><span class="c">;</span>
		<span class="w">r</span><span class="c">eturn</span> <span class="w">-</span><span class="pc">ENOM</span><span class="c">EM;</span>
	<span class="c">}</span>

	<span class="w">record_ird_ord</span><span class="c">(</span><span class="w">cm_node, </span><span class="pc">(</span><span class="w">u</span><span class="pc">1</span><span class="c">6</span><span class="w">)conn_param-</span><span class="c">&gt;</span><span class="w">ird,</span><span class="pc"> (u1</span><span class="c">6</span><span class="w">)c</span><span class="pc">o</span><span class="c">nn_param-&gt;</span><span class="w">ord</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">c</span><span class="pc">m_n</span><span class="c">ode-&gt;</span><span class="w">send_rdma0_op</span> <span class="pc">=</span><span class="c">=</span> <span class="w">SEND_RDMA_READ_ZERO</span> <span class="pc">&amp;</span><span class="c">&amp;</span>
				<span class="w">c</span><span class="pc">m_n</span><span class="c">ode-&gt;</span><span class="w">ord_size</span> <span class="c">==</span> <span class="c">0)</span>
		<span class="w">c</span><span class="pc">m_n</span><span class="c">ode-&gt;</span><span class="pc">o</span><span class="c">rd_size</span> <span class="c">=</span> <span class="pc">1</span><span class="c">;</span>

	<span class="w">c</span><span class="pc">m</span><span class="c">_node-&gt;</span><span class="w">apbvt_set</span> <span class="c">=</span> <span class="w">a</span><span class="c">pbvt_set;</span>
	<span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">tos</span> <span class="c">=</span> <span class="w">cm_id</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">t</span><span class="c">os;</span>
	<span class="w">nesqp</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">cm_n</span><span class="c">ode</span> <span class="c">=</span> <span class="c">cm_node</span><span class="pc">;</span>
	<span class="pc">c</span><span class="c">m_node-&gt;nesqp</span> <span class="c">=</span> <span class="pc">n</span><span class="c">esqp;</span>
	<span class="w">nes_add_ref</span><span class="pc">(&amp;n</span><span class="c">esqp-&gt;</span><span class="w">ibqp</span><span class="c">);</span>

	<span class="w">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>



<span class="w">i</span><span class="c">nt</span> <span class="w">nes_create_listen</span><span class="c">(struct</span> <span class="w">iw_cm_id</span> <span class="c">*</span><span class="w">c</span><span class="pc">m_i</span><span class="c">d,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">backlog</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">nes_vnic</span> <span class="c">*</span><span class="w">nesvnic</span><span class="pc">;</span>
	<span class="c">struct</span> <span class="w">nes_cm_listener</span> <span class="c">*</span><span class="pc">c</span><span class="c">m_node;</span>
	<span class="c">struct</span> <span class="w">nes_cm_info</span> <span class="w">cm_info</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">e</span><span class="c">rr;</span>
	<span class="c">struct</span> <span class="w">sockaddr_in</span> <span class="c">*</span><span class="w">laddr</span> <span class="w">=</span><span class="pc"> (</span><span class="c">struct</span> <span class="c">sockaddr_in</span> <span class="w">*)</span><span class="pc">&amp;</span><span class="w">c</span><span class="pc">m_i</span><span class="c">d-&gt;</span><span class="w">local_addr</span><span class="c">;</span>

	<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM,</span><span class="pc"> "cm_i</span><span class="c">d</span> <span class="w">=</span><span class="pc"> %p,</span> <span class="w">lo</span><span class="pc">cal</span> <span class="w">po</span><span class="pc">r</span><span class="c">t</span> <span class="w">=</span> <span class="w">0</span><span class="pc">x</span><span class="c">%</span><span class="w">04X.</span><span class="pc">\</span><span class="c">n",</span>
		  <span class="w">c</span><span class="pc">m_i</span><span class="c">d</span><span class="pc">,</span> <span class="w">nt</span><span class="c">ohs(</span><span class="w">l</span><span class="c">addr-&gt;</span><span class="w">sin_port</span><span class="c">));</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(cm_id-&gt;</span><span class="w">l</span><span class="pc">o</span><span class="c">cal_addr</span><span class="w">.ss_family</span> <span class="w">!</span><span class="c">=</span> <span class="w">AF_INET</span><span class="pc">)</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="c">-</span><span class="w">ENOSYS</span><span class="c">;</span>
	<span class="w">nesvnic</span> <span class="pc">=</span> <span class="w">to_nesvnic</span><span class="c">(</span><span class="pc">c</span><span class="c">m_id</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">de</span><span class="pc">vi</span><span class="c">ce</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">nesvnic</span><span class="pc">)</span>
		<span class="c">return</span> <span class="c">-</span><span class="pc">EI</span><span class="c">NVAL;</span>

	<span class="w">nes_debug</span><span class="pc">(</span><span class="w">NES_DBG_CM</span><span class="pc">, </span><span class="c">"nesvnic</span><span class="w">=</span><span class="pc">%p,</span> <span class="w">net</span><span class="pc">d</span><span class="c">ev=%</span><span class="pc">p</span><span class="w">,</span><span class="pc"> </span><span class="c">%</span><span class="pc">s</span><span class="c">\n",</span>
			<span class="c">nesvnic</span><span class="pc">,</span> <span class="c">nesvnic</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ne</span><span class="pc">t</span><span class="c">dev,</span> <span class="c">nesvnic-&gt;</span><span class="w">n</span><span class="pc">et</span><span class="c">dev-&gt;</span><span class="pc">n</span><span class="c">ame</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">n</span><span class="pc">es_</span><span class="c">debug(NES_DBG_CM</span><span class="pc">, </span><span class="c">"nesvnic</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">local_ipaddr</span><span class="pc">=0x</span><span class="c">%</span><span class="pc">08</span><span class="c">x</span><span class="pc">,</span> <span class="w">sin_addr.s_addr</span><span class="c">=</span><span class="w">0</span><span class="pc">x</span><span class="c">%</span><span class="w">0</span><span class="pc">8x\</span><span class="c">n",</span>
			<span class="c">nesvnic-&gt;</span><span class="w">l</span><span class="c">ocal_ipaddr,</span> <span class="w">laddr</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">s</span><span class="c">in_addr</span><span class="pc">.s</span><span class="c">_addr</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="w">cm_info.loc_addr</span> <span class="c">=</span> <span class="w">ntohl</span><span class="pc">(n</span><span class="c">esvnic-&gt;</span><span class="pc">loca</span><span class="c">l_ipaddr</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">c</span><span class="c">m_info</span><span class="pc">.</span><span class="w">loc_port</span> <span class="c">=</span> <span class="w">n</span><span class="pc">tohs</span><span class="c">(</span><span class="w">l</span><span class="pc">a</span><span class="c">ddr-&gt;</span><span class="w">sin_port</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">cm_info</span><span class="pc">.</span><span class="w">backlog</span> <span class="c">=</span> <span class="w">b</span><span class="c">acklog;</span>
	<span class="pc">c</span><span class="c">m_info</span><span class="pc">.</span><span class="w">cm_id</span> <span class="c">=</span> <span class="w">c</span><span class="pc">m_id</span><span class="c">;</span>

	<span class="w">c</span><span class="c">m_info.</span><span class="w">conn_type</span> <span class="c">=</span> <span class="w">NES_CM_IWARP_CONN_TYPE</span><span class="c">;</span>

	
	<span class="pc">c</span><span class="c">m_info.</span><span class="w">mapped_loc_addr</span> <span class="c">=</span> <span class="c">cm_info</span><span class="pc">.</span><span class="w">loc_addr</span><span class="pc">;</span>
	<span class="c">cm_info.</span><span class="w">mapped_loc_port</span> <span class="c">=</span> <span class="c">cm_info</span><span class="pc">.</span><span class="w">l</span><span class="pc">oc_p</span><span class="c">ort</span><span class="pc">;</span>

	<span class="w">cm_node</span> <span class="c">=</span> <span class="w">g_cm_core-</span><span class="c">&gt;</span><span class="w">api-</span><span class="c">&gt;</span><span class="w">listen(</span><span class="pc">g</span><span class="c">_cm_core,</span> <span class="w">nesvnic</span><span class="pc">, </span><span class="c">&amp;cm_info);</span>
	<span class="c">if</span> <span class="pc">(!cm_n</span><span class="c">ode) {</span>
		<span class="w">p</span><span class="pc">ri</span><span class="c">ntk(KERN_ERR</span> <span class="pc">"%</span><span class="c">s</span><span class="w">[</span><span class="c">%</span><span class="w">u]</span> <span class="w">E</span><span class="c">rror</span> <span class="w">returned</span> <span class="w">f</span><span class="pc">r</span><span class="c">om</span> <span class="w">li</span><span class="c">sten</span> <span class="w">API</span> <span class="w">ca</span><span class="pc">l</span><span class="c">l</span><span class="pc">\</span><span class="c">n",</span>
		       <span class="c">__func__</span><span class="pc">,</span> <span class="w">_</span><span class="pc">_L</span><span class="c">INE__</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="pc">-</span><span class="w">EN</span><span class="pc">OM</span><span class="c">EM;</span>
	<span class="c">}</span>

	<span class="w">cm_id-</span><span class="c">&gt;</span><span class="w">provider_data</span> <span class="c">=</span> <span class="w">c</span><span class="pc">m_n</span><span class="c">ode</span><span class="pc">;</span>
	<span class="w">c</span><span class="pc">m_n</span><span class="c">ode-&gt;</span><span class="w">tos</span> <span class="c">=</span> <span class="c">cm_id</span><span class="pc">-</span><span class="c">&gt;tos;</span>

	<span class="c">if</span> <span class="pc">(!cm_n</span><span class="c">ode</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">reused_node</span><span class="c">) {</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">nes_create_mapinfo(</span><span class="pc">&amp;</span><span class="w">cm_info</span><span class="pc">)</span><span class="c">)</span>
			<span class="c">return</span> <span class="c">-</span><span class="w">EN</span><span class="pc">OM</span><span class="c">EM;</span>

		<span class="w">e</span><span class="pc">rr</span> <span class="c">=</span> <span class="w">nes_manage_apbvt</span><span class="c">(</span><span class="w">nesvnic</span><span class="c">,</span> <span class="w">c</span><span class="pc">m_n</span><span class="c">ode-&gt;</span><span class="w">mapped_loc_port</span><span class="c">,</span>
				       <span class="w">PCI_FUNC</span><span class="pc">(</span><span class="w">n</span><span class="pc">esv</span><span class="c">nic</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">nes</span><span class="pc">d</span><span class="c">ev</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">pci</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="w">dev</span><span class="pc">f</span><span class="c">n</span><span class="w">),</span>
				       <span class="w">NES_MANAGE_APBVT_ADD</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">e</span><span class="c">rr</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">p</span><span class="c">rintk(KERN_ERR</span> <span class="c">"</span><span class="w">n</span><span class="pc">es_</span><span class="c">manage_apbvt</span> <span class="w">ca</span><span class="pc">l</span><span class="c">l</span> <span class="w">returned</span> <span class="c">%</span><span class="pc">d</span><span class="w">.</span><span class="c">\n",</span>
			       <span class="c">err);</span>
			<span class="w">g_cm_core</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">api-</span><span class="c">&gt;</span><span class="w">stop_listener(</span><span class="pc">g</span><span class="c">_cm_core</span><span class="w">,</span><span class="pc"> (</span><span class="w">v</span><span class="c">oid</span> <span class="c">*)</span><span class="w">cm_node</span><span class="pc">)</span><span class="c">;</span>
			<span class="pc">r</span><span class="c">eturn</span> <span class="pc">e</span><span class="c">rr;</span>
		<span class="c">}</span>
		<span class="w">at</span><span class="pc">omic_i</span><span class="c">nc(&amp;</span><span class="w">cm_listens_created</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">cm_id-</span><span class="c">&gt;</span><span class="w">add_ref</span><span class="pc">(</span><span class="w">c</span><span class="pc">m_i</span><span class="c">d</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">c</span><span class="c">m_id</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">provider_data</span> <span class="w">=</span><span class="pc"> (</span><span class="w">v</span><span class="c">oid</span> <span class="pc">*</span><span class="c">)</span><span class="w">c</span><span class="pc">m_n</span><span class="c">ode</span><span class="pc">;</span>


	<span class="w">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>



<span class="pc">i</span><span class="c">nt</span> <span class="w">nes_destroy_listen</span><span class="c">(struct</span> <span class="w">iw_cm_id</span> <span class="c">*cm_id)</span>
<span class="c">{</span>
	<span class="w">i</span><span class="pc">f</span> <span class="c">(cm_id-&gt;</span><span class="pc">p</span><span class="c">rovider_data</span><span class="w">)</span>
		<span class="w">g_cm_core</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">api-</span><span class="c">&gt;</span><span class="w">stop_listener(</span><span class="pc">g</span><span class="c">_cm_core</span><span class="pc">,</span> <span class="pc">c</span><span class="c">m_id-&gt;</span><span class="pc">p</span><span class="c">rovider_data);</span>
	<span class="w">e</span><span class="c">lse</span>
		<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM,</span><span class="pc"> </span><span class="c">"</span><span class="pc">c</span><span class="c">m_id</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">p</span><span class="c">rovider_data</span> <span class="w">was</span> <span class="w">N</span><span class="pc">U</span><span class="c">LL</span><span class="pc">\</span><span class="c">n");</span>

	<span class="pc">c</span><span class="c">m_id-&gt;</span><span class="w">rem_ref(</span><span class="c">cm_id);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>



<span class="w">i</span><span class="c">nt</span> <span class="w">nes_cm_recv</span><span class="c">(struct</span> <span class="w">s</span><span class="pc">k</span><span class="c">_buff</span> <span class="c">*skb,</span> <span class="c">struct</span> <span class="c">net_device</span> <span class="c">*</span><span class="w">netdevice</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">r</span><span class="pc">c</span> <span class="pc">=</span> <span class="c">0;</span>

	<span class="w">cm_packets_received+</span><span class="c">+;</span>
	<span class="c">if</span> <span class="pc">((</span><span class="w">g_cm_core) &amp;</span><span class="pc">&amp; (</span><span class="w">g</span><span class="c">_cm_core</span><span class="w">-</span><span class="c">&gt;</span><span class="w">api))</span>
		<span class="w">r</span><span class="pc">c</span> <span class="c">=</span> <span class="w">g</span><span class="c">_cm_core</span><span class="pc">-</span><span class="c">&gt;api</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">recv_pkt</span><span class="pc">(</span><span class="w">g</span><span class="c">_cm_core,</span> <span class="w">netd</span><span class="pc">ev_</span><span class="c">priv</span><span class="pc">(</span><span class="w">n</span><span class="c">etdevice</span><span class="pc">),</span> <span class="w">s</span><span class="pc">k</span><span class="c">b);</span>
	<span class="w">e</span><span class="c">lse</span>
		<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM,</span><span class="pc"> "</span><span class="w">U</span><span class="c">nable</span> <span class="c">to</span> <span class="w">process</span> <span class="w">p</span><span class="c">acket</span> <span class="w">f</span><span class="c">or</span> <span class="w">CM,"</span>
			  <span class="w">"</span> <span class="w">cm</span> <span class="w">i</span><span class="c">s</span> <span class="w">n</span><span class="c">ot</span> <span class="w">set</span><span class="pc">u</span><span class="c">p</span> <span class="w">properly.</span><span class="c">\n");</span>

	<span class="c">return</span> <span class="w">r</span><span class="pc">c</span><span class="c">;</span>
<span class="c">}</span>



<span class="pc">i</span><span class="c">nt</span> <span class="w">nes_cm_start</span><span class="c">(</span><span class="pc">v</span><span class="c">oid</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">n</span><span class="c">es_debug</span><span class="pc">(</span><span class="c">NES_DBG_CM</span><span class="w">, </span><span class="pc">"\</span><span class="c">n");</span>
	
	<span class="w">g_cm_core</span> <span class="pc">=</span> <span class="w">nes_cm_alloc_core</span><span class="pc">()</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">g</span><span class="c">_cm_core</span><span class="pc">)</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="pc">0</span><span class="c">;</span>
	<span class="w">e</span><span class="pc">l</span><span class="c">se</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="pc">-ENOM</span><span class="c">EM;</span>
<span class="c">}</span>



<span class="w">i</span><span class="c">nt</span> <span class="w">nes_cm_stop</span><span class="c">(</span><span class="pc">v</span><span class="c">oid</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">g</span><span class="c">_cm_core</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">api-</span><span class="pc">&gt;</span><span class="w">destroy_cm_core(</span><span class="c">g_cm_core);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>



<span class="c">static</span> <span class="c">void</span> <span class="w">cm_event_connected</span><span class="c">(struct</span> <span class="w">nes_cm_event</span> <span class="c">*</span><span class="w">e</span><span class="pc">v</span><span class="c">ent)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">nes_qp</span> <span class="c">*</span><span class="w">nesqp</span><span class="pc">;</span>
	<span class="c">struct</span> <span class="w">nes_vnic</span> <span class="c">*</span><span class="w">nesvnic</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">nes_device</span> <span class="c">*</span><span class="w">nesd</span><span class="c">ev;</span>
	<span class="c">struct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="w">cm_node</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">nes_adapter</span> <span class="c">*</span><span class="w">nesadapter</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">ib_qp_attr</span> <span class="w">a</span><span class="pc">t</span><span class="c">tr;</span>
	<span class="c">struct</span> <span class="w">iw_cm_id</span> <span class="c">*</span><span class="w">cm_id</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">iw_cm_event</span> <span class="w">cm_event</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">nes_v4_quad</span> <span class="w">nes_quad</span><span class="c">;</span>
	<span class="pc">u3</span><span class="c">2</span> <span class="w">crc_value</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">r</span><span class="c">et;</span>
	<span class="c">struct</span> <span class="w">sockaddr_in</span> <span class="c">*</span><span class="w">laddr</span><span class="c">;</span>
	<span class="c">struct</span> <span class="c">sockaddr_in</span> <span class="c">*</span><span class="w">raddr</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">s</span><span class="c">ockaddr_in</span> <span class="c">*</span><span class="w">cm_event_laddr</span><span class="c">;</span>

	
	<span class="w">cm_node</span> <span class="pc">=</span> <span class="w">e</span><span class="pc">v</span><span class="c">ent</span><span class="pc">-</span><span class="c">&gt;cm_node;</span>
	<span class="w">c</span><span class="pc">m_i</span><span class="c">d</span> <span class="pc">=</span> <span class="c">cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">cm_i</span><span class="c">d;</span>
	<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">cm_event_connected</span> <span class="w">- %p</span> <span class="pc">-</span> <span class="w">c</span><span class="pc">m_i</span><span class="c">d</span> <span class="w">=</span><span class="pc"> %p</span><span class="c">\n",</span> <span class="pc">cm_n</span><span class="c">ode</span><span class="pc">,</span> <span class="pc">cm_i</span><span class="c">d);</span>
	<span class="w">nesqp</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="w">s</span><span class="pc">tr</span><span class="c">uct</span> <span class="w">nes_qp</span> <span class="c">*)</span><span class="pc">cm_i</span><span class="c">d</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">provider_data</span><span class="c">;</span>
	<span class="w">nesvnic</span> <span class="pc">=</span> <span class="w">to_nesvnic</span><span class="c">(</span><span class="pc">nesq</span><span class="c">p</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ibqp</span><span class="pc">.</span><span class="w">de</span><span class="pc">vi</span><span class="c">ce</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">nes</span><span class="pc">d</span><span class="c">ev</span> <span class="w">=</span> <span class="c">nesvnic</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">nes</span><span class="pc">d</span><span class="c">ev;</span>
	<span class="w">nesadapter</span> <span class="pc">=</span> <span class="w">nes</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="pc">nesa</span><span class="c">dapter;</span>
	<span class="w">laddr</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="pc">s</span><span class="c">truct</span> <span class="w">sockaddr_in</span> <span class="pc">*)&amp;</span><span class="w">c</span><span class="pc">m_i</span><span class="c">d-&gt;</span><span class="w">local_addr</span><span class="c">;</span>
	<span class="w">raddr</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="pc">s</span><span class="c">truct</span> <span class="pc">s</span><span class="c">ockaddr_in</span> <span class="pc">*)&amp;c</span><span class="c">m_id-&gt;</span><span class="w">remote_addr</span><span class="c">;</span>
	<span class="w">cm_event_laddr</span> <span class="w">=</span><span class="pc"> </span><span class="c">(struct</span> <span class="pc">s</span><span class="c">ockaddr_in</span> <span class="pc">*)&amp;</span><span class="w">cm_event.l</span><span class="pc">o</span><span class="c">cal_addr;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">nesqp</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">destroyed</span><span class="pc">)</span>
		<span class="pc">r</span><span class="c">eturn</span><span class="pc">;</span>
	<span class="w">at</span><span class="pc">omic_i</span><span class="c">nc(&amp;</span><span class="w">cm_connecteds</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, "</span><span class="w">QP</span><span class="c">%</span><span class="pc">u</span> <span class="w">attempting</span> <span class="pc">t</span><span class="c">o</span> <span class="w">connect</span> <span class="w">t</span><span class="c">o</span>  <span class="pc">0</span><span class="c">x%</span><span class="w">0</span><span class="pc">8X</span><span class="w">:</span><span class="c">0x%</span><span class="w">04X</span> <span class="w">o</span><span class="pc">n</span><span class="w">"</span>
		  <span class="w">"</span> <span class="w">lo</span><span class="pc">cal</span> <span class="w">po</span><span class="pc">r</span><span class="c">t</span> <span class="pc">0</span><span class="c">x%</span><span class="w">04</span><span class="pc">X</span><span class="w">.</span> <span class="w">j</span><span class="pc">i</span><span class="c">ffies</span> <span class="w">= </span><span class="pc">%</span><span class="w">l</span><span class="c">u</span><span class="w">.</span><span class="c">\n",</span>
		  <span class="w">nesqp</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">hwqp</span><span class="pc">.</span><span class="w">qp_id</span><span class="pc">,</span> <span class="w">ntohl</span><span class="pc">(</span><span class="w">raddr-</span><span class="c">&gt;</span><span class="w">sin_addr</span><span class="pc">.</span><span class="w">s_addr)</span><span class="pc">,</span>
		  <span class="w">n</span><span class="pc">tohs</span><span class="c">(</span><span class="pc">r</span><span class="c">addr-&gt;</span><span class="w">sin_port</span><span class="pc">),</span> <span class="w">n</span><span class="pc">tohs</span><span class="c">(</span><span class="w">laddr</span><span class="c">-&gt;sin_port</span><span class="pc">),</span> <span class="w">j</span><span class="c">iffies</span><span class="w">)</span><span class="c">;</span>

	<span class="w">nes_cm_init_tsa_conn</span><span class="c">(</span><span class="pc">n</span><span class="c">esqp</span><span class="pc">,</span> <span class="w">cm_node</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="pc">n</span><span class="c">esqp-&gt;</span><span class="w">nesqp_context-</span><span class="c">&gt;</span><span class="w">tcpPorts[</span><span class="c">0</span><span class="pc">] </span><span class="c">=</span>
			<span class="w">c</span><span class="pc">pu_to_le1</span><span class="c">6(</span><span class="w">c</span><span class="c">m_node-&gt;</span><span class="w">mapped_loc_port</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">n</span><span class="pc">esqp</span><span class="c">-&gt;</span><span class="w">n</span><span class="c">esqp_context</span><span class="pc">-</span><span class="c">&gt;tcpPorts[</span><span class="pc">1</span><span class="c">] =</span>
			<span class="w">c</span><span class="pc">pu_to_le1</span><span class="c">6(</span><span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">mapped_rem_port</span><span class="c">);</span>
	<span class="w">n</span><span class="pc">esqp</span><span class="c">-&gt;nesqp_context-&gt;</span><span class="w">ip0</span> <span class="pc">=</span> <span class="pc">c</span><span class="c">pu_to_le32(cm_node-&gt;</span><span class="w">mapped_rem_addr</span><span class="c">);</span>

	<span class="w">n</span><span class="pc">esqp</span><span class="c">-&gt;</span><span class="pc">nesqp_</span><span class="c">context-&gt;</span><span class="w">misc2</span> <span class="w">|</span><span class="c">=</span> <span class="pc">cp</span><span class="c">u_to_le32(</span>
			<span class="w">(u</span><span class="c">32</span><span class="w">)PCI_FUNC</span><span class="pc">(</span><span class="w">nes</span><span class="pc">d</span><span class="c">ev</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">pc</span><span class="pc">id</span><span class="c">ev-&gt;</span><span class="w">de</span><span class="pc">vf</span><span class="c">n</span><span class="w">) </span><span class="pc">&lt;</span><span class="c">&lt;</span>
			<span class="w">NES_QPCONTEXT_MISC2_SRC_IP_SHIFT)</span><span class="pc">;</span>
	<span class="w">n</span><span class="c">esqp-&gt;nesqp_context-&gt;</span><span class="w">arp_index_vlan</span> <span class="w">|</span><span class="c">=</span> <span class="w">c</span><span class="pc">p</span><span class="c">u_to_le32(</span>
			<span class="w">nes_arp_table</span><span class="pc">(</span><span class="w">nes</span><span class="pc">d</span><span class="c">ev</span><span class="pc">,</span>
			<span class="w">l</span><span class="pc">e3</span><span class="c">2_to_cpu(nesqp-&gt;nesqp_context-&gt;</span><span class="w">ip0),</span>
			<span class="w">N</span><span class="c">ULL</span><span class="pc">,</span> <span class="w">NES_ARP_RESOLVE) &lt;</span><span class="c">&lt;</span> <span class="pc">1</span><span class="c">6);</span>
	<span class="pc">n</span><span class="c">esqp-&gt;nesqp_context</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ts_val_delta</span> <span class="pc">=</span> <span class="c">cpu_to_le32(</span>
			<span class="w">j</span><span class="c">iffies</span> <span class="w">-</span> <span class="w">nes_read_indexed</span><span class="pc">(</span><span class="w">nes</span><span class="pc">d</span><span class="c">ev</span><span class="pc">,</span> <span class="w">NES_IDX_TCP_NOW)</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">nesqp</span><span class="c">-&gt;nesqp_context</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ird_index</span> <span class="c">=</span> <span class="pc">c</span><span class="c">pu_to_le32(nesqp-&gt;</span><span class="w">hwqp</span><span class="pc">.</span><span class="w">qp_id</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">nesqp</span><span class="c">-&gt;nesqp_context</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ird_ord_sizes</span> <span class="w">|</span><span class="c">=</span>
			<span class="w">c</span><span class="c">pu_to_le32</span><span class="w">(</span><span class="pc">(</span><span class="w">u</span><span class="c">32</span><span class="w">)1</span> <span class="pc">&lt;</span><span class="c">&lt;</span>
			<span class="w">NES_QPCONTEXT_ORDIRD_IWARP_MODE_SHIFT</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">nesqp-&gt;nesqp_context</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">ird_o</span><span class="c">rd_sizes</span> <span class="w">|</span><span class="c">=</span>
			<span class="w">c</span><span class="c">pu_to_le32</span><span class="pc">((u</span><span class="c">32)</span><span class="w">cm_node</span><span class="c">-&gt;</span><span class="w">ord_size</span><span class="c">);</span>

	
	

	<span class="w">build_rdma0_msg</span><span class="c">(</span><span class="w">c</span><span class="c">m_node</span><span class="w">,</span><span class="pc"> </span><span class="c">&amp;nesqp</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">nes_write32</span><span class="c">(</span><span class="w">nes</span><span class="pc">d</span><span class="c">ev</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">r</span><span class="c">egs</span> <span class="pc">+</span> <span class="w">NES_WQE_ALLOC</span><span class="pc">,</span>
		    <span class="w">(1</span> <span class="pc">&lt;</span><span class="c">&lt;</span> <span class="w">2</span><span class="pc">4</span><span class="w">)</span><span class="pc"> </span><span class="c">|</span> <span class="w">0x00800000</span> <span class="pc">|</span> <span class="pc">nesqp</span><span class="c">-&gt;</span><span class="w">hwqp.qp_id</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">m</span><span class="c">emset(&amp;</span><span class="w">nes_quad</span><span class="c">,</span> <span class="c">0,</span> <span class="c">sizeof(</span><span class="pc">n</span><span class="c">es_quad));</span>

	<span class="pc">n</span><span class="c">es_quad</span><span class="pc">.</span><span class="w">DstIpAdrIndex</span> <span class="c">=</span>
		<span class="w">c</span><span class="pc">pu_to_le3</span><span class="c">2</span><span class="pc">((</span><span class="w">u</span><span class="pc">3</span><span class="c">2</span><span class="w">)PCI_FUNC</span><span class="c">(</span><span class="w">nes</span><span class="pc">d</span><span class="c">ev</span><span class="w">-</span><span class="c">&gt;</span><span class="w">pc</span><span class="pc">id</span><span class="c">ev</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">dev</span><span class="pc">f</span><span class="c">n</span><span class="w">) &lt;</span><span class="c">&lt;</span> <span class="w">2</span><span class="pc">4);</span>
	<span class="w">n</span><span class="c">es_quad</span><span class="w">.SrcIpadr</span> <span class="c">=</span> <span class="w">h</span><span class="pc">t</span><span class="c">onl(</span><span class="w">cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">mapped_rem_addr</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">n</span><span class="c">es_quad</span><span class="pc">.</span><span class="w">TcpPorts[</span><span class="c">0] =</span> <span class="w">h</span><span class="c">tons(</span><span class="pc">c</span><span class="c">m_node-&gt;</span><span class="w">mapped_rem_port</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">n</span><span class="c">es_quad</span><span class="pc">.T</span><span class="c">cpPorts</span><span class="pc">[</span><span class="w">1</span><span class="c">] =</span> <span class="w">ht</span><span class="pc">ons</span><span class="c">(cm_node-&gt;</span><span class="w">mapped_loc_port</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="w">crc_value</span> <span class="pc">=</span> <span class="w">get_crc_value</span><span class="pc">(&amp;n</span><span class="c">es_quad</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">nesqp</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">hte_index</span> <span class="c">=</span> <span class="w">c</span><span class="pc">pu_to_b</span><span class="c">e32(</span><span class="pc">cr</span><span class="c">c_value</span> <span class="w">^</span> <span class="w">0xff</span><span class="pc">fff</span><span class="c">fff);</span>
	<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM,</span><span class="pc"> "</span><span class="w">HTE</span> <span class="w">Index</span> <span class="w">=</span> <span class="c">0x%</span><span class="w">0</span><span class="pc">8X,</span> <span class="w">After</span> <span class="w">CRC</span> <span class="w">=</span> <span class="c">0x%</span><span class="w">0</span><span class="pc">8X</span><span class="c">\n",</span>
		  <span class="pc">n</span><span class="c">esqp-&gt;</span><span class="w">h</span><span class="c">te_index,</span> <span class="pc">n</span><span class="c">esqp</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">h</span><span class="c">te_index</span> <span class="w">&amp;</span> <span class="w">nesadapter</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">hte_index_mask</span><span class="c">);</span>

	<span class="pc">n</span><span class="c">esqp</span><span class="pc">-</span><span class="c">&gt;hte_index</span> <span class="w">&amp;=</span> <span class="w">n</span><span class="pc">esa</span><span class="c">dapter</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">hte_index_</span><span class="c">mask;</span>
	<span class="c">nesqp-&gt;</span><span class="w">nesqp_context-</span><span class="c">&gt;</span><span class="pc">h</span><span class="c">te_index</span> <span class="pc">=</span> <span class="w">c</span><span class="pc">pu_to_le3</span><span class="c">2(nesqp-&gt;</span><span class="pc">h</span><span class="c">te_index</span><span class="pc">)</span><span class="c">;</span>

	<span class="c">nesqp-&gt;</span><span class="w">ietf_frame</span> <span class="w">=</span><span class="pc"> &amp;</span><span class="w">cm_node</span><span class="c">-&gt;</span><span class="w">mpa_frame</span><span class="c">;</span>
	<span class="c">nesqp-&gt;</span><span class="w">private_data_len</span> <span class="w">=</span><span class="pc"> (</span><span class="w">u</span><span class="c">8</span><span class="w">)c</span><span class="c">m_node-&gt;</span><span class="w">mpa_frame_size</span><span class="pc">;</span>
	<span class="w">c</span><span class="c">m_node-&gt;</span><span class="w">cm_core</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">api</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">accelerated(</span><span class="pc">cm_n</span><span class="c">ode-&gt;</span><span class="pc">c</span><span class="c">m_core</span><span class="pc">,</span> <span class="w">c</span><span class="pc">m_n</span><span class="c">ode</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="w">cm_event.e</span><span class="pc">v</span><span class="c">ent</span> <span class="c">=</span> <span class="w">IW_CM_EVENT_CONNECT_REPLY</span><span class="c">;</span>
	<span class="pc">cm_e</span><span class="c">vent</span><span class="pc">.</span><span class="w">s</span><span class="pc">tatu</span><span class="c">s</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="pc">cm_e</span><span class="c">vent</span><span class="pc">.</span><span class="w">provider_data</span> <span class="c">=</span> <span class="w">cm_id</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">p</span><span class="c">rovider_data;</span>
	<span class="w">cm_event_laddr</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sin_family</span> <span class="c">=</span> <span class="w">AF_INET</span><span class="c">;</span>
	<span class="w">c</span><span class="pc">m_event_</span><span class="c">laddr-&gt;</span><span class="w">sin_port</span> <span class="c">=</span> <span class="w">laddr</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">s</span><span class="c">in_port;</span>
	<span class="pc">c</span><span class="c">m_event</span><span class="pc">.</span><span class="w">remote_addr</span> <span class="c">=</span> <span class="w">c</span><span class="pc">m_i</span><span class="c">d</span><span class="pc">-</span><span class="c">&gt;remote_addr;</span>

	<span class="w">c</span><span class="pc">m_event.</span><span class="w">pri</span><span class="pc">v</span><span class="c">ate_data</span> <span class="pc">= (</span><span class="w">v</span><span class="c">oid</span> <span class="c">*)</span><span class="w">ev</span><span class="pc">ent-</span><span class="c">&gt;</span><span class="w">cm_node-</span><span class="c">&gt;</span><span class="w">mpa_frame_buf</span><span class="c">;</span>
	<span class="pc">cm_event.</span><span class="w">private_data_len</span> <span class="pc">= </span><span class="c">(</span><span class="w">u</span><span class="pc">8)</span><span class="w">e</span><span class="pc">v</span><span class="c">ent-&gt;</span><span class="pc">cm_n</span><span class="c">ode</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">mpa_frame_size</span><span class="c">;</span>
	<span class="pc">c</span><span class="c">m_event</span><span class="pc">.</span><span class="w">ird</span> <span class="c">=</span> <span class="w">c</span><span class="c">m_node-&gt;</span><span class="w">ird_size</span><span class="c">;</span>
	<span class="c">cm_event</span><span class="pc">.</span><span class="w">ord</span> <span class="c">=</span> <span class="pc">cm_n</span><span class="c">ode-&gt;</span><span class="w">ord_size</span><span class="c">;</span>

	<span class="w">cm_event_laddr</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sin_addr</span><span class="pc">.</span><span class="w">s_addr</span> <span class="c">=</span> <span class="w">ht</span><span class="pc">onl</span><span class="c">(</span><span class="w">ev</span><span class="pc">e</span><span class="c">nt-&gt;</span><span class="w">cm_info</span><span class="c">.</span><span class="w">rem_addr</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">cm_id</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">event_handler(cm</span><span class="pc">_id, </span><span class="c">&amp;</span><span class="pc">cm_e</span><span class="c">vent</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, "</span><span class="w">OFA</span> <span class="w">CM</span> <span class="w">e</span><span class="c">vent_handler</span> <span class="w">returned,</span> <span class="w">r</span><span class="c">et</span><span class="w">=</span><span class="pc">%</span><span class="c">d\n",</span> <span class="c">ret);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(ret)</span>
		<span class="w">p</span><span class="pc">ri</span><span class="c">ntk(KERN_ERR</span> <span class="pc">"%</span><span class="c">s</span><span class="w">[</span><span class="c">%</span><span class="w">u]</span> <span class="w">O</span><span class="c">FA</span> <span class="w">C</span><span class="c">M</span> <span class="w">e</span><span class="pc">vent_</span><span class="c">handler</span> <span class="pc">r</span><span class="c">eturned</span><span class="w">,</span><span class="pc"> "</span>
		       <span class="w">"r</span><span class="pc">et=</span><span class="c">%d\n",</span> <span class="pc">_</span><span class="c">_func__,</span> <span class="pc">_</span><span class="c">_LINE__,</span> <span class="w">r</span><span class="pc">et</span><span class="c">);</span>
	<span class="w">at</span><span class="pc">t</span><span class="c">r</span><span class="w">.qp_state</span> <span class="c">=</span> <span class="w">IB_QPS_RTS</span><span class="pc">;</span>
	<span class="w">nes_modify_qp</span><span class="pc">(&amp;</span><span class="w">nesqp</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ibqp</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">a</span><span class="c">ttr</span><span class="pc">,</span> <span class="w">IB_QP_STATE</span><span class="pc">,</span> <span class="c">NULL);</span>

	<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">Exiting</span> <span class="w">connect</span> <span class="w">th</span><span class="pc">r</span><span class="c">ead</span> <span class="w">f</span><span class="c">or</span> <span class="w">QP</span><span class="c">%</span><span class="pc">u.</span> <span class="w">j</span><span class="c">iffies</span> <span class="w">= "</span>
		  <span class="w">"%l</span><span class="pc">u\</span><span class="c">n",</span> <span class="c">nesqp-&gt;</span><span class="w">hwqp</span><span class="pc">.</span><span class="w">qp_id</span><span class="pc">,</span> <span class="w">j</span><span class="c">iffies</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span><span class="w">;</span>
<span class="c">}</span>



<span class="pc">s</span><span class="c">tatic</span> <span class="c">void</span> <span class="w">cm_event_connect_error</span><span class="c">(struct</span> <span class="w">nes_cm_event</span> <span class="c">*</span><span class="w">ev</span><span class="pc">e</span><span class="c">nt)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">nes_qp</span> <span class="c">*</span><span class="pc">n</span><span class="c">esqp</span><span class="pc">;</span>
	<span class="c">struct</span> <span class="w">iw_cm_id</span> <span class="c">*</span><span class="w">cm_id</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">iw_cm_event</span> <span class="w">cm_event</span><span class="c">;</span>
	
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">r</span><span class="c">et;</span>

	<span class="w">i</span><span class="pc">f</span> <span class="c">(!</span><span class="w">e</span><span class="pc">v</span><span class="c">ent</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">cm_node</span><span class="pc">)</span>
		<span class="c">return;</span>

	<span class="pc">c</span><span class="c">m_id</span> <span class="pc">=</span> <span class="w">e</span><span class="c">vent-&gt;</span><span class="pc">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">c</span><span class="c">m_id;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">cm_id</span><span class="pc">)</span>
		<span class="c">return</span><span class="pc">;</span>

	<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM,</span><span class="pc"> "cm_n</span><span class="c">ode</span><span class="w">=%</span><span class="pc">p,</span> <span class="c">cm_id=%</span><span class="pc">p\</span><span class="c">n",</span> <span class="w">e</span><span class="pc">v</span><span class="c">ent-&gt;</span><span class="pc">cm_n</span><span class="c">ode</span><span class="pc">,</span> <span class="c">cm_id</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">nesqp</span> <span class="pc">=</span> <span class="w">c</span><span class="pc">m_i</span><span class="c">d</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">provider_data</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="c">nesqp</span><span class="pc">)</span>
		<span class="c">return</span><span class="pc">;</span>

	
	
	<span class="pc">n</span><span class="c">esqp</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">c</span><span class="c">m_id</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="pc">c</span><span class="c">m_id-&gt;</span><span class="pc">p</span><span class="c">rovider_data</span> <span class="c">=</span> <span class="c">NULL;</span>
	<span class="w">cm_event.ev</span><span class="c">ent</span> <span class="c">=</span> <span class="w">IW_CM_EVENT_CONNECT_REPLY</span><span class="c">;</span>
	<span class="pc">cm_e</span><span class="c">vent</span><span class="pc">.</span><span class="w">sta</span><span class="pc">tu</span><span class="c">s</span> <span class="w">=</span><span class="pc"> -</span><span class="w">ECONNRESET</span><span class="c">;</span>
	<span class="pc">c</span><span class="c">m_event</span><span class="pc">.</span><span class="w">p</span><span class="c">rovider_data</span> <span class="c">=</span> <span class="pc">cm_i</span><span class="c">d</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">p</span><span class="c">rovider_data</span><span class="pc">;</span>
	<span class="pc">c</span><span class="c">m_event.</span><span class="w">local_addr</span> <span class="c">=</span> <span class="w">c</span><span class="pc">m_i</span><span class="c">d</span><span class="pc">-</span><span class="c">&gt;local_addr;</span>
	<span class="pc">c</span><span class="c">m_event</span><span class="pc">.</span><span class="w">remote_addr</span> <span class="c">=</span> <span class="c">cm_id-&gt;remote_addr;</span>
	<span class="c">cm_event.</span><span class="w">pr</span><span class="pc">iva</span><span class="c">te_data</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="pc">c</span><span class="c">m_event</span><span class="pc">.</span><span class="w">private_data_len</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>

<span class="w">#</span><span class="c">ifdef</span> <span class="w">CONFIG_INFINIBAND_NES_DEBUG</span>
	<span class="w">{</span>
		<span class="w">s</span><span class="c">truct</span> <span class="w">sockaddr_in</span> <span class="c">*</span><span class="w">cm_event_laddr</span> <span class="w">=</span><span class="pc"> (</span><span class="c">struct</span> <span class="c">sockaddr_in</span> <span class="c">*)</span>
						     <span class="w">&amp;</span><span class="pc">cm_event.</span><span class="w">l</span><span class="c">ocal_addr</span><span class="w">;</span>
		<span class="pc">s</span><span class="c">truct</span> <span class="pc">s</span><span class="c">ockaddr_in</span> <span class="c">*</span><span class="w">cm_event_raddr</span> <span class="pc">= (</span><span class="c">struct</span> <span class="w">s</span><span class="c">ockaddr_in</span> <span class="c">*)</span>
						     <span class="w">&amp;</span><span class="pc">cm_event.</span><span class="w">remote_addr;</span>
		<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM,</span><span class="pc"> "</span><span class="w">ca</span><span class="pc">l</span><span class="c">l</span> <span class="w">CM_EVENT</span> <span class="w">REJECTED,</span> <span class="w">l</span><span class="c">ocal_addr</span><span class="w">=</span><span class="pc">%</span><span class="w">0</span><span class="c">8x,</span> <span class="pc">r</span><span class="c">emote_addr</span><span class="pc">=</span><span class="c">%</span><span class="w">0</span><span class="pc">8</span><span class="c">x</span><span class="pc">\</span><span class="c">n",</span>
			  <span class="w">cm_event_laddr</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sin_addr</span><span class="pc">.</span><span class="w">s_addr</span><span class="c">,</span> <span class="w">c</span><span class="pc">m_event_r</span><span class="c">addr</span><span class="pc">-</span><span class="c">&gt;sin_addr.</span><span class="pc">s_</span><span class="c">addr</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span>
<span class="pc">#</span><span class="c">endif</span>

	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">cm_id-</span><span class="c">&gt;</span><span class="w">event_handler(c</span><span class="pc">m_i</span><span class="c">d</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">cm_event</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM,</span><span class="pc"> "</span><span class="w">OFA</span> <span class="w">CM</span> <span class="w">e</span><span class="c">vent_handler</span> <span class="w">returned,</span> <span class="w">r</span><span class="pc">et</span><span class="w">=</span><span class="pc">%</span><span class="c">d\n",</span> <span class="pc">r</span><span class="c">et);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(ret)</span>
		<span class="w">p</span><span class="pc">ri</span><span class="c">ntk(</span><span class="pc">KERN_E</span><span class="c">RR</span> <span class="pc">"%</span><span class="c">s</span><span class="w">[</span><span class="c">%</span><span class="w">u]</span> <span class="w">O</span><span class="c">FA</span> <span class="w">C</span><span class="c">M</span> <span class="w">e</span><span class="pc">vent_</span><span class="c">handler</span> <span class="pc">r</span><span class="c">eturned</span><span class="w">,</span><span class="pc"> "</span>
		       <span class="w">"r</span><span class="pc">et=</span><span class="c">%d\n",</span> <span class="pc">_</span><span class="c">_func__,</span> <span class="pc">_</span><span class="c">_LINE__,</span> <span class="w">r</span><span class="pc">et</span><span class="c">);</span>
	<span class="w">cm_id</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">rem_ref</span><span class="pc">(</span><span class="w">c</span><span class="pc">m</span><span class="c">_id</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">rem_ref_cm_node</span><span class="c">(</span><span class="w">ev</span><span class="pc">ent-</span><span class="c">&gt;</span><span class="w">cm_node-</span><span class="c">&gt;</span><span class="w">cm_core</span><span class="pc">,</span> <span class="w">e</span><span class="pc">vent</span><span class="c">-&gt;cm_node);</span>
	<span class="pc">r</span><span class="c">eturn</span><span class="pc">;</span>
<span class="c">}</span>



<span class="pc">s</span><span class="c">tatic</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">cm_event_reset</span><span class="c">(struct</span> <span class="w">nes_cm_event</span> <span class="c">*</span><span class="w">ev</span><span class="c">ent)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">nes_qp</span> <span class="c">*</span><span class="w">nesqp</span><span class="pc">;</span>
	<span class="c">struct</span> <span class="w">iw_cm_id</span> <span class="c">*cm_id;</span>
	<span class="c">struct</span> <span class="w">iw_cm_event</span> <span class="w">cm_event</span><span class="c">;</span>
	
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">r</span><span class="c">et;</span>

	<span class="w">i</span><span class="pc">f</span> <span class="pc">(!</span><span class="w">e</span><span class="pc">v</span><span class="c">ent</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">cm</span><span class="pc">_n</span><span class="c">ode</span><span class="w">)</span>
		<span class="c">return;</span>

	<span class="c">if</span> <span class="pc">(!</span><span class="w">e</span><span class="c">vent-&gt;</span><span class="w">c</span><span class="pc">m_n</span><span class="c">ode</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">c</span><span class="c">m_id</span><span class="w">)</span>
		<span class="c">return;</span>

	<span class="pc">c</span><span class="c">m_id</span> <span class="pc">=</span> <span class="w">e</span><span class="pc">ve</span><span class="c">nt-&gt;</span><span class="w">c</span><span class="pc">m_n</span><span class="c">ode</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">c</span><span class="c">m_id</span><span class="pc">;</span>

	<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM,</span><span class="pc"> "%p</span> <span class="w">-</span> <span class="w">c</span><span class="c">m_id</span> <span class="w">=</span><span class="pc"> </span><span class="c">%</span><span class="pc">p</span><span class="c">\n",</span> <span class="w">e</span><span class="pc">v</span><span class="c">ent-&gt;</span><span class="pc">cm_n</span><span class="c">ode</span><span class="pc">,</span> <span class="pc">cm_i</span><span class="c">d</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">nesqp</span> <span class="pc">=</span> <span class="w">c</span><span class="pc">m_i</span><span class="c">d</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">provider_data</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!n</span><span class="c">esqp</span><span class="pc">)</span>
		<span class="c">return</span><span class="pc">;</span>

	<span class="pc">n</span><span class="c">esqp</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">cm_i</span><span class="c">d</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>
	
	<span class="w">cm_event.e</span><span class="pc">ve</span><span class="c">nt</span> <span class="c">=</span> <span class="w">IW_CM_EVENT_DISCONNECT</span><span class="c">;</span>
	<span class="pc">c</span><span class="c">m_event</span><span class="pc">.</span><span class="w">s</span><span class="pc">t</span><span class="c">atus</span> <span class="pc">= -</span><span class="w">ECONNRESET</span><span class="c">;</span>
	<span class="pc">c</span><span class="c">m_event</span><span class="pc">.</span><span class="w">p</span><span class="pc">rov</span><span class="c">ider_data</span> <span class="c">=</span> <span class="w">c</span><span class="pc">m_i</span><span class="c">d</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">p</span><span class="c">rovider_data</span><span class="pc">;</span>
	<span class="pc">c</span><span class="c">m_event.</span><span class="w">local_addr</span> <span class="c">=</span> <span class="pc">cm_i</span><span class="c">d</span><span class="pc">-</span><span class="c">&gt;local_addr;</span>
	<span class="c">cm_event</span><span class="pc">.</span><span class="w">remote_addr</span> <span class="c">=</span> <span class="pc">cm_i</span><span class="c">d-&gt;remote_addr;</span>
	<span class="c">cm_event.</span><span class="w">pr</span><span class="pc">iva</span><span class="c">te_data</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="pc">c</span><span class="c">m_event</span><span class="pc">.</span><span class="w">private_data_len</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>

	<span class="pc">cm_i</span><span class="c">d</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">add_ref(</span><span class="pc">cm_i</span><span class="c">d);</span>
	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="c">cm_id</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">event_handler(</span><span class="pc">cm_i</span><span class="c">d</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">cm_e</span><span class="c">vent</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">at</span><span class="pc">omic_i</span><span class="c">nc(&amp;</span><span class="w">cm_closes</span><span class="c">);</span>
	<span class="pc">cm_e</span><span class="c">vent</span><span class="pc">.</span><span class="w">ev</span><span class="pc">ent</span> <span class="c">=</span> <span class="w">IW_CM_EVENT_CLOSE</span><span class="c">;</span>
	<span class="pc">cm_e</span><span class="c">vent</span><span class="pc">.</span><span class="w">s</span><span class="pc">tatu</span><span class="c">s</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="c">cm_event</span><span class="pc">.</span><span class="w">provider_data</span> <span class="c">=</span> <span class="pc">c</span><span class="c">m_id</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">p</span><span class="c">rovider_data;</span>
	<span class="w">c</span><span class="pc">m_e</span><span class="c">vent.</span><span class="w">local_addr</span> <span class="c">=</span> <span class="c">cm_id-&gt;local_addr;</span>
	<span class="c">cm_event</span><span class="pc">.</span><span class="w">remote_addr</span> <span class="c">=</span> <span class="c">cm_id</span><span class="pc">-</span><span class="c">&gt;remote_addr;</span>
	<span class="c">cm_event.</span><span class="w">pr</span><span class="pc">iv</span><span class="c">ate_data</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="pc">c</span><span class="c">m_event</span><span class="pc">.</span><span class="w">private_data_len</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="w">nes_debug</span><span class="pc">(</span><span class="w">NES_DBG_CM,</span><span class="pc"> "</span><span class="w">NODE</span> <span class="pc">%</span><span class="w">p</span> <span class="w">Generating</span> <span class="w">CLOSE</span><span class="pc">\</span><span class="c">n",</span> <span class="w">ev</span><span class="pc">e</span><span class="c">nt</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">cm_node</span><span class="c">);</span>
	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">c</span><span class="pc">m_i</span><span class="c">d</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">event_handler(</span><span class="pc">cm_i</span><span class="c">d</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">c</span><span class="pc">m_e</span><span class="c">vent</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">n</span><span class="c">es_debug</span><span class="pc">(NE</span><span class="c">S_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">OFA</span> <span class="w">CM</span> <span class="w">e</span><span class="c">vent_handler</span> <span class="w">returned,</span> <span class="w">r</span><span class="c">et</span><span class="w">=</span><span class="pc">%</span><span class="c">d\n",</span> <span class="pc">r</span><span class="c">et);</span>


	
	<span class="w">c</span><span class="c">m_id-&gt;</span><span class="w">rem_ref</span><span class="pc">(c</span><span class="c">m_id</span><span class="pc">)</span><span class="c">;</span>

	<span class="c">return</span><span class="w">;</span>
<span class="c">}</span>



<span class="pc">s</span><span class="c">tatic</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">cm_event_mpa_req</span><span class="c">(struct</span> <span class="w">nes_cm_event</span> <span class="c">*</span><span class="w">ev</span><span class="pc">ent</span><span class="c">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">iw_cm_id</span> <span class="c">*</span><span class="w">c</span><span class="c">m_id</span><span class="pc">;</span>
	<span class="c">struct</span> <span class="w">iw_cm_event</span> <span class="w">cm_event</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">ret;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="w">cm_node</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">sockaddr_in</span> <span class="c">*</span><span class="w">cm_event_laddr</span> <span class="w">=</span><span class="pc"> (</span><span class="c">struct</span> <span class="c">sockaddr_in</span> <span class="pc">*)</span>
					     <span class="w">&amp;c</span><span class="pc">m_event.</span><span class="w">local_addr</span><span class="pc">;</span>
	<span class="c">struct</span> <span class="w">s</span><span class="c">ockaddr_in</span> <span class="c">*</span><span class="w">cm_event_raddr</span> <span class="pc">= (</span><span class="c">struct</span> <span class="w">s</span><span class="c">ockaddr_in</span> <span class="c">*)</span>
					     <span class="w">&amp;c</span><span class="pc">m_event.</span><span class="w">remote_addr;</span>

	<span class="w">c</span><span class="pc">m_n</span><span class="c">ode</span> <span class="pc">=</span> <span class="w">ev</span><span class="pc">ent</span><span class="c">-&gt;</span><span class="pc">cm_n</span><span class="c">ode</span><span class="pc">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">c</span><span class="pc">m_n</span><span class="c">ode</span><span class="pc">)</span>
		<span class="c">return</span><span class="pc">;</span>
	<span class="w">cm_id</span> <span class="c">=</span> <span class="pc">c</span><span class="c">m_node-&gt;</span><span class="pc">cm_i</span><span class="c">d;</span>

	<span class="w">at</span><span class="pc">omic_i</span><span class="c">nc(&amp;</span><span class="w">cm_connect_reqs</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, "cm_n</span><span class="c">ode</span> <span class="w">=</span><span class="pc"> %p</span> <span class="pc">-</span> <span class="w">c</span><span class="pc">m_i</span><span class="c">d</span> <span class="w">=</span><span class="pc"> </span><span class="c">%</span><span class="pc">p,</span> <span class="w">j</span><span class="pc">i</span><span class="c">ffies</span> <span class="w">=</span><span class="pc"> </span><span class="c">%</span><span class="pc">l</span><span class="c">u\n",</span>
		  <span class="c">cm_node</span><span class="pc">,</span> <span class="pc">cm_i</span><span class="c">d</span><span class="pc">,</span> <span class="w">j</span><span class="c">iffies</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">cm_event.e</span><span class="pc">v</span><span class="c">ent</span> <span class="c">=</span> <span class="w">IW_CM_EVENT_CONNECT_REQUEST</span><span class="c">;</span>
	<span class="pc">c</span><span class="c">m_event</span><span class="w">.s</span><span class="pc">t</span><span class="c">atus</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="c">cm_event</span><span class="w">.provider_data</span> <span class="pc">= </span><span class="c">(</span><span class="w">v</span><span class="c">oid</span> <span class="c">*)</span><span class="pc">cm_n</span><span class="c">ode</span><span class="pc">;</span>

	<span class="w">cm_event_laddr</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sin_family</span> <span class="pc">=</span> <span class="w">AF_INET</span><span class="c">;</span>
	<span class="pc">cm_event_</span><span class="c">laddr-&gt;</span><span class="w">sin_port</span> <span class="c">=</span> <span class="w">h</span><span class="pc">t</span><span class="c">ons(</span><span class="w">ev</span><span class="c">ent-&gt;</span><span class="w">cm_info</span><span class="pc">.</span><span class="w">loc_port</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">c</span><span class="c">m_event_laddr-&gt;</span><span class="w">sin_addr</span><span class="pc">.</span><span class="w">s_addr</span> <span class="c">=</span> <span class="w">h</span><span class="c">tonl(</span><span class="w">ev</span><span class="pc">e</span><span class="c">nt-&gt;</span><span class="pc">c</span><span class="c">m_info.</span><span class="w">loc_addr</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">cm_event_raddr</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s</span><span class="pc">in_f</span><span class="c">amily</span> <span class="pc">=</span> <span class="w">A</span><span class="c">F_INET</span><span class="pc">;</span>
	<span class="pc">cm_event_r</span><span class="c">addr-&gt;</span><span class="w">s</span><span class="pc">in_p</span><span class="c">ort</span> <span class="pc">=</span> <span class="w">h</span><span class="c">tons(</span><span class="w">e</span><span class="pc">v</span><span class="c">ent-&gt;</span><span class="pc">cm_i</span><span class="c">nfo.</span><span class="w">rem_port</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">c</span><span class="pc">m_event_r</span><span class="c">addr-&gt;</span><span class="pc">sin_a</span><span class="c">ddr.</span><span class="pc">s</span><span class="c">_addr</span> <span class="pc">=</span> <span class="w">h</span><span class="pc">t</span><span class="c">onl(</span><span class="w">ev</span><span class="pc">e</span><span class="c">nt-&gt;cm_info.</span><span class="w">rem_addr</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">cm_event.pri</span><span class="pc">vate_</span><span class="c">data</span> <span class="c">=</span> <span class="w">cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">mpa_frame_buf</span><span class="pc">;</span>
	<span class="pc">cm_event.</span><span class="w">private_data_len</span> <span class="pc">= (</span><span class="w">u</span><span class="c">8</span><span class="pc">)</span><span class="w">c</span><span class="pc">m_n</span><span class="c">ode-&gt;</span><span class="w">mpa_frame_size</span><span class="pc">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">c</span><span class="pc">m_n</span><span class="c">ode-&gt;</span><span class="w">mpa_frame_rev</span> <span class="pc">=</span><span class="c">=</span> <span class="w">IETF_MPA_V1</span><span class="pc">) </span><span class="c">{</span>
		<span class="pc">c</span><span class="c">m_event</span><span class="pc">.</span><span class="w">ird</span> <span class="c">=</span> <span class="w">NES_MAX_IRD</span><span class="c">;</span>
		<span class="pc">c</span><span class="c">m_event</span><span class="pc">.</span><span class="w">ord</span> <span class="c">=</span> <span class="w">NES_MAX_ORD</span><span class="c">;</span>
	<span class="c">}</span> <span class="c">else</span> <span class="c">{</span>
	<span class="w">c</span><span class="pc">m_e</span><span class="c">vent</span><span class="w">.i</span><span class="c">rd</span> <span class="c">=</span> <span class="pc">cm_n</span><span class="c">ode</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ird_size</span><span class="c">;</span>
	<span class="pc">cm_e</span><span class="c">vent</span><span class="pc">.o</span><span class="c">rd</span> <span class="c">=</span> <span class="c">cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ord_size</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">cm_id</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">event_handler(c</span><span class="pc">m_i</span><span class="c">d</span><span class="pc">, </span><span class="c">&amp;cm_event</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(ret</span><span class="pc">)</span>
		<span class="w">p</span><span class="pc">ri</span><span class="c">ntk(KERN_ERR</span> <span class="pc">"%</span><span class="c">s</span><span class="w">[</span><span class="c">%</span><span class="w">u]</span> <span class="w">OFA</span> <span class="w">CM</span> <span class="w">e</span><span class="c">vent_handler</span> <span class="w">returned,</span> <span class="w">r</span><span class="pc">et</span><span class="w">=</span><span class="pc">%</span><span class="c">d</span><span class="pc">\</span><span class="c">n",</span>
		       <span class="c">__func__,</span> <span class="pc">_</span><span class="c">_LINE__,</span> <span class="w">r</span><span class="c">et);</span>
	<span class="c">return</span><span class="w">;</span>
<span class="c">}</span>


<span class="w">s</span><span class="c">tatic</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">cm_event_mpa_reject</span><span class="c">(struct</span> <span class="w">nes_cm_event</span> <span class="c">*</span><span class="w">ev</span><span class="pc">ent)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">iw_cm_id</span> <span class="c">*</span><span class="w">cm_id</span><span class="pc">;</span>
	<span class="c">struct</span> <span class="w">iw_cm_event</span> <span class="w">cm_event</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">nes_cm_node</span> <span class="c">*</span><span class="w">cm_node</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">ret;</span>
	<span class="c">struct</span> <span class="w">sockaddr_in</span> <span class="c">*</span><span class="w">cm_event_laddr</span> <span class="w">=</span><span class="pc"> (</span><span class="c">struct</span> <span class="c">sockaddr_in</span> <span class="pc">*)</span>
					     <span class="w">&amp;c</span><span class="pc">m_event.</span><span class="w">local_addr</span><span class="pc">;</span>
	<span class="c">struct</span> <span class="w">s</span><span class="c">ockaddr_in</span> <span class="c">*</span><span class="w">cm_event_raddr</span> <span class="pc">= (</span><span class="c">struct</span> <span class="w">s</span><span class="pc">o</span><span class="c">ckaddr_in</span> <span class="c">*)</span>
					     <span class="w">&amp;c</span><span class="pc">m_event.</span><span class="w">remote_addr;</span>

	<span class="w">c</span><span class="pc">m</span><span class="c">_node</span> <span class="pc">=</span> <span class="w">ev</span><span class="pc">ent</span><span class="c">-&gt;</span><span class="pc">cm_n</span><span class="c">ode</span><span class="pc">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="c">cm_node</span><span class="pc">)</span>
		<span class="c">return</span><span class="pc">;</span>
	<span class="w">cm_id</span> <span class="c">=</span> <span class="pc">c</span><span class="c">m_node-&gt;</span><span class="pc">cm_i</span><span class="c">d;</span>

	<span class="w">at</span><span class="pc">omic_i</span><span class="c">nc(&amp;</span><span class="w">cm_connect_reqs</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, "cm_n</span><span class="c">ode</span> <span class="w">=</span><span class="pc"> %p</span> <span class="pc">-</span> <span class="w">c</span><span class="pc">m_i</span><span class="c">d</span> <span class="w">=</span><span class="pc"> </span><span class="c">%</span><span class="pc">p,</span> <span class="w">j</span><span class="pc">i</span><span class="c">ffies</span> <span class="w">=</span><span class="pc"> </span><span class="c">%</span><span class="pc">l</span><span class="c">u\n",</span>
		  <span class="c">cm_node</span><span class="pc">,</span> <span class="pc">cm_i</span><span class="c">d</span><span class="pc">,</span> <span class="w">j</span><span class="c">iffies</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">cm_event.e</span><span class="pc">v</span><span class="c">ent</span> <span class="c">=</span> <span class="w">IW_CM_EVENT_CONNECT_REPLY</span><span class="c">;</span>
	<span class="pc">c</span><span class="c">m_event</span><span class="w">.s</span><span class="pc">t</span><span class="c">atus</span> <span class="pc">= </span><span class="c">-</span><span class="w">ECONNREFUSED</span><span class="c">;</span>
	<span class="c">cm_event</span><span class="w">.provider_data</span> <span class="c">=</span> <span class="w">c</span><span class="pc">m_i</span><span class="c">d</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">p</span><span class="c">rovider_data;</span>

	<span class="w">cm_event_laddr-</span><span class="c">&gt;</span><span class="w">sin_family</span> <span class="c">=</span> <span class="w">AF_INET</span><span class="c">;</span>
	<span class="w">c</span><span class="pc">m_event_</span><span class="c">laddr-&gt;</span><span class="w">sin_port</span> <span class="c">=</span> <span class="w">h</span><span class="pc">t</span><span class="c">ons(</span><span class="w">ev</span><span class="c">ent-&gt;</span><span class="w">cm_info</span><span class="pc">.</span><span class="w">loc_port</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">c</span><span class="c">m_event_laddr-&gt;</span><span class="w">sin_addr</span><span class="pc">.</span><span class="w">s_addr</span> <span class="c">=</span> <span class="w">h</span><span class="pc">t</span><span class="c">onl(</span><span class="w">ev</span><span class="pc">e</span><span class="c">nt-&gt;</span><span class="pc">c</span><span class="c">m_info.</span><span class="w">loc_addr</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">cm_event_raddr</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s</span><span class="pc">in_f</span><span class="c">amily</span> <span class="pc">=</span> <span class="w">A</span><span class="c">F_INET</span><span class="pc">;</span>
	<span class="pc">cm_event_r</span><span class="c">addr-&gt;</span><span class="w">s</span><span class="pc">in_p</span><span class="c">ort</span> <span class="pc">=</span> <span class="w">h</span><span class="c">tons(</span><span class="w">e</span><span class="pc">v</span><span class="c">ent-&gt;</span><span class="pc">cm_i</span><span class="c">nfo.</span><span class="w">rem_port</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">c</span><span class="pc">m_event_r</span><span class="c">addr-&gt;</span><span class="pc">sin_a</span><span class="c">ddr.</span><span class="pc">s</span><span class="c">_addr</span> <span class="pc">=</span> <span class="w">h</span><span class="pc">t</span><span class="c">onl(</span><span class="w">ev</span><span class="pc">e</span><span class="c">nt-&gt;cm_info.</span><span class="w">rem_addr</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">cm_event.pri</span><span class="pc">vate_</span><span class="c">data</span> <span class="c">=</span> <span class="w">cm_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">mpa_frame_buf</span><span class="pc">;</span>
	<span class="pc">cm_event.</span><span class="w">private_data_len</span> <span class="pc">= (</span><span class="w">u</span><span class="c">8</span><span class="pc">)</span><span class="w">c</span><span class="pc">m_n</span><span class="c">ode-&gt;</span><span class="w">mpa_frame_size</span><span class="pc">;</span>

	<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, "</span><span class="w">ca</span><span class="pc">l</span><span class="c">l</span> <span class="w">CM_EVENT_MPA_REJECTED,</span> <span class="w">local_addr=</span><span class="pc">%</span><span class="w">0</span><span class="pc">8x</span><span class="w">,</span><span class="pc"> </span><span class="c">"</span>
		  <span class="w">"remove_addr=</span><span class="c">%</span><span class="w">0</span><span class="c">8x\n",</span>
		  <span class="w">cm_event_laddr</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sin_addr</span><span class="pc">.</span><span class="w">s_addr</span><span class="c">,</span>
		  <span class="w">cm_event_raddr</span><span class="pc">-</span><span class="c">&gt;sin_addr.</span><span class="pc">s_</span><span class="c">addr</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">cm_id</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">event_handler</span><span class="pc">(</span><span class="w">cm</span><span class="pc">_i</span><span class="c">d</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">cm_event</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">r</span><span class="c">et</span><span class="pc">)</span>
		<span class="w">p</span><span class="pc">ri</span><span class="c">ntk(KERN_ERR</span> <span class="pc">"%</span><span class="c">s</span><span class="w">[</span><span class="c">%</span><span class="w">u]</span> <span class="w">OFA</span> <span class="w">CM</span> <span class="w">e</span><span class="pc">v</span><span class="c">ent_handler</span> <span class="w">returned,</span> <span class="w">r</span><span class="pc">et</span><span class="w">=</span><span class="pc">%</span><span class="c">d</span><span class="pc">\</span><span class="c">n",</span>
		       <span class="c">__func__,</span> <span class="w">_</span><span class="c">_LINE__,</span> <span class="w">r</span><span class="c">et);</span>

	<span class="c">return</span><span class="w">;</span>
<span class="c">}</span>


<span class="w">s</span><span class="c">tatic</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">nes_cm_event_handler</span><span class="c">(struct</span> <span class="w">w</span><span class="c">ork_struct</span> <span class="pc">*)</span><span class="c">;</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="c">int</span> <span class="w">nes_cm_post_event</span><span class="c">(struct</span> <span class="w">nes_cm_event</span> <span class="c">*</span><span class="w">ev</span><span class="pc">ent</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">at</span><span class="pc">omic_i</span><span class="c">nc(&amp;</span><span class="w">ev</span><span class="pc">ent</span><span class="c">-&gt;</span><span class="w">cm_node-</span><span class="c">&gt;</span><span class="w">cm_core-</span><span class="c">&gt;</span><span class="w">events_posted</span><span class="c">);</span>
	<span class="w">add_ref_cm_node</span><span class="c">(</span><span class="w">e</span><span class="pc">vent</span><span class="c">-&gt;</span><span class="pc">c</span><span class="c">m_node</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">ev</span><span class="pc">ent</span><span class="c">-&gt;</span><span class="w">cm_info</span><span class="pc">.</span><span class="w">cm_id-</span><span class="c">&gt;</span><span class="w">add_ref(e</span><span class="pc">v</span><span class="c">ent</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">cm_in</span><span class="c">fo</span><span class="pc">.cm_id</span><span class="c">);</span>
	<span class="w">INIT_WORK</span><span class="pc">(&amp;</span><span class="w">e</span><span class="pc">vent</span><span class="c">-&gt;</span><span class="w">event_work</span><span class="pc">,</span> <span class="w">nes_cm_event_handler</span><span class="c">);</span>
	<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM,</span><span class="pc"> "cm_n</span><span class="c">ode</span><span class="w">=</span><span class="c">%</span><span class="pc">p</span> <span class="w">queue_work,</span> <span class="w">ev</span><span class="pc">ent</span><span class="w">=</span><span class="c">%</span><span class="pc">p\</span><span class="c">n",</span>
		  <span class="w">e</span><span class="c">vent</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">c</span><span class="pc">m_n</span><span class="c">ode</span><span class="pc">,</span> <span class="w">e</span><span class="pc">vent</span><span class="c">);</span>

	<span class="w">q</span><span class="c">ueue_work(</span><span class="w">e</span><span class="pc">vent-</span><span class="c">&gt;</span><span class="pc">cm_n</span><span class="c">ode</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">cm_core-</span><span class="pc">&gt;</span><span class="w">event_wq,</span><span class="pc"> &amp;</span><span class="w">e</span><span class="pc">vent</span><span class="c">-&gt;event_work</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">n</span><span class="pc">es_d</span><span class="c">ebug</span><span class="pc">(N</span><span class="c">ES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">Exit</span><span class="pc">\</span><span class="c">n");</span>
	<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>
<span class="c">}</span>



<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">nes_cm_event_handler</span><span class="c">(struct</span> <span class="c">work_struct</span> <span class="c">*work)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">nes_cm_event</span> <span class="c">*</span><span class="w">ev</span><span class="pc">ent</span> <span class="c">=</span> <span class="c">container_of(work,</span> <span class="c">struct</span> <span class="c">nes_cm_event,</span>
						  <span class="w">e</span><span class="pc">vent_wo</span><span class="c">rk);</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">nes_cm_core</span> <span class="c">*</span><span class="w">cm_core</span><span class="pc">;</span>

	<span class="w">i</span><span class="pc">f</span> <span class="w">((!e</span><span class="pc">v</span><span class="c">ent</span><span class="w">) || (!e</span><span class="pc">vent-</span><span class="c">&gt;</span><span class="w">cm_node)</span><span class="pc"> |</span><span class="c">| (!</span><span class="w">ev</span><span class="pc">ent-</span><span class="c">&gt;</span><span class="pc">cm_n</span><span class="c">ode</span><span class="w">-</span><span class="pc">&gt;cm_c</span><span class="c">ore</span><span class="w">)</span><span class="pc">)</span>
		<span class="c">return;</span>

	<span class="pc">c</span><span class="c">m_core</span> <span class="pc">=</span> <span class="w">e</span><span class="pc">vent</span><span class="c">-&gt;</span><span class="pc">cm_n</span><span class="c">ode</span><span class="pc">-</span><span class="c">&gt;cm_core</span><span class="pc">;</span>
	<span class="w">nes_debug</span><span class="pc">(</span><span class="w">NES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">e</span><span class="pc">vent</span><span class="w">=</span><span class="c">%</span><span class="pc">p,</span> <span class="w">e</span><span class="pc">vent-</span><span class="c">&gt;</span><span class="w">t</span><span class="c">ype</span><span class="w">=</span><span class="pc">%u,</span> <span class="w">ev</span><span class="pc">ents</span> <span class="w">posted</span><span class="c">=%</span><span class="pc">u</span><span class="c">\n",</span>
		  <span class="pc">e</span><span class="c">vent</span><span class="pc">,</span> <span class="w">e</span><span class="c">vent</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">t</span><span class="c">ype</span><span class="pc">,</span> <span class="w">a</span><span class="pc">t</span><span class="c">omic_read(&amp;cm_core-&gt;</span><span class="w">events_posted</span><span class="pc">))</span><span class="c">;</span>

	<span class="w">sw</span><span class="c">itch</span> <span class="c">(</span><span class="w">e</span><span class="pc">vent-</span><span class="c">&gt;</span><span class="w">t</span><span class="c">ype) {</span>
	<span class="c">case</span> <span class="w">NES_CM_EVENT_MPA_REQ</span><span class="c">:</span>
		<span class="w">cm_event_mpa_req</span><span class="c">(</span><span class="w">ev</span><span class="pc">ent)</span><span class="c">;</span>
		<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM,</span><span class="pc"> "</span><span class="w">cm_node</span><span class="pc">=</span><span class="c">%</span><span class="pc">p</span> <span class="w">CM</span> <span class="w">Ev</span><span class="c">ent</span><span class="w">:</span> <span class="w">MPA</span> <span class="w">REQUEST</span><span class="c">\n</span><span class="pc">",</span>
			  <span class="w">e</span><span class="pc">vent-</span><span class="c">&gt;</span><span class="pc">cm_n</span><span class="c">ode);</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="pc">c</span><span class="c">ase</span> <span class="w">NES_CM_EVENT_RESET</span><span class="c">:</span>
		<span class="w">n</span><span class="c">es_debug</span><span class="pc">(N</span><span class="c">ES_DBG_CM</span><span class="pc">, "</span><span class="c">cm_node</span> <span class="w">=</span><span class="pc"> </span><span class="c">%</span><span class="pc">p</span> <span class="w">C</span><span class="c">M</span> <span class="w">Ev</span><span class="c">ent</span><span class="w">:</span> <span class="w">RESET</span><span class="pc">\</span><span class="c">n</span><span class="pc">",</span>
			  <span class="w">ev</span><span class="c">ent</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">c</span><span class="c">m_node);</span>
		<span class="w">cm_event_reset</span><span class="c">(</span><span class="w">e</span><span class="c">vent);</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="c">case</span> <span class="w">NES_CM_EVENT_CONNECTED</span><span class="c">:</span>
		<span class="pc">i</span><span class="c">f</span> <span class="w">((!e</span><span class="pc">ve</span><span class="c">nt-&gt;</span><span class="w">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">cm_id) |</span><span class="pc">|</span>
		    <span class="c">(</span><span class="w">e</span><span class="pc">v</span><span class="c">ent-&gt;</span><span class="w">c</span><span class="pc">m_n</span><span class="c">ode-&gt;</span><span class="w">s</span><span class="pc">tate</span> <span class="pc">!</span><span class="c">=</span> <span class="w">NES_CM_STATE_TSA))</span>
			<span class="pc">b</span><span class="c">reak;</span>
		<span class="w">cm_event_connected</span><span class="c">(</span><span class="w">e</span><span class="pc">v</span><span class="c">ent);</span>
		<span class="w">nes_debug</span><span class="c">(</span><span class="w">NES_DBG_CM</span><span class="pc">, "</span><span class="w">CM</span> <span class="w">Ev</span><span class="c">ent</span><span class="w">:</span> <span class="w">CONNECTED</span><span class="pc">\</span><span class="c">n");</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="pc">c</span><span class="c">ase</span> <span class="w">NES_CM_EVENT_MPA_REJECT</span><span class="c">:</span>
		<span class="c">if</span> <span class="w">((</span><span class="pc">!</span><span class="w">e</span><span class="pc">v</span><span class="c">ent-&gt;</span><span class="pc">c</span><span class="c">m_node</span><span class="w">-</span><span class="c">&gt;</span><span class="w">c</span><span class="pc">m_i</span><span class="c">d</span><span class="w">) |</span><span class="c">|</span>
		    <span class="c">(</span><span class="w">e</span><span class="pc">v</span><span class="c">ent-&gt;</span><span class="pc">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">s</span><span class="c">tate</span> <span class="pc">=</span><span class="c">=</span> <span class="w">N</span><span class="pc">ES_CM_S</span><span class="c">TATE_TSA</span><span class="w">)</span><span class="pc">)</span>
			<span class="c">break;</span>
		<span class="w">cm_event_mpa_reject</span><span class="c">(</span><span class="w">e</span><span class="pc">v</span><span class="c">ent);</span>
		<span class="w">n</span><span class="c">es_debug</span><span class="pc">(</span><span class="w">N</span><span class="c">ES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">C</span><span class="c">M</span> <span class="w">Ev</span><span class="c">ent</span><span class="w">:</span> <span class="w">REJECT</span><span class="pc">\</span><span class="c">n");</span>
		<span class="pc">b</span><span class="c">reak;</span>

	<span class="pc">c</span><span class="c">ase</span> <span class="w">NES_CM_EVENT_ABORTED</span><span class="c">:</span>
		<span class="c">if</span> <span class="w">((</span><span class="pc">!</span><span class="w">e</span><span class="pc">v</span><span class="c">ent-&gt;</span><span class="pc">c</span><span class="c">m_node</span><span class="w">-</span><span class="c">&gt;</span><span class="w">c</span><span class="pc">m_i</span><span class="c">d</span><span class="w">) |</span><span class="c">|</span>
		    <span class="c">(</span><span class="w">e</span><span class="pc">v</span><span class="c">ent-&gt;</span><span class="w">c</span><span class="c">m_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">s</span><span class="c">tate</span> <span class="pc">=</span><span class="c">=</span> <span class="w">N</span><span class="pc">ES_CM_S</span><span class="c">TATE_TSA</span><span class="w">)</span><span class="pc">)</span>
			<span class="c">break;</span>
		<span class="w">cm_event_connect_error</span><span class="c">(</span><span class="w">e</span><span class="pc">v</span><span class="c">ent);</span>
		<span class="w">n</span><span class="c">es_debug</span><span class="pc">(</span><span class="w">N</span><span class="c">ES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="w">C</span><span class="c">M</span> <span class="w">Ev</span><span class="c">ent</span><span class="w">:</span> <span class="w">ABORTED</span><span class="pc">\</span><span class="c">n");</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="pc">c</span><span class="c">ase</span> <span class="w">NES_CM_EVENT_DROPPED_PKT</span><span class="c">:</span>
		<span class="pc">n</span><span class="c">es_debug(</span><span class="pc">N</span><span class="c">ES_DBG_CM</span><span class="pc">, </span><span class="c">"</span><span class="pc">C</span><span class="c">M</span> <span class="w">Ev</span><span class="c">ent</span><span class="pc">:</span> <span class="w">DROPPED</span> <span class="w">PKT</span><span class="c">\n");</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="pc">d</span><span class="c">efault:</span>
		<span class="c">nes_debug(NES_DBG_CM</span><span class="pc">,</span><span class="c"> "CM</span> <span class="w">Ev</span><span class="c">ent</span><span class="w">:</span> <span class="w">UNKNOWN</span> <span class="w">EVENT</span> <span class="w">TYPE</span><span class="pc">\</span><span class="c">n");</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="c">}</span>

	<span class="w">atomic_dec</span><span class="pc">(&amp;</span><span class="w">cm_core</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">events_posted</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">ev</span><span class="pc">ent</span><span class="c">-&gt;</span><span class="w">cm_info</span><span class="pc">.</span><span class="w">cm_id-</span><span class="c">&gt;</span><span class="w">rem_ref(e</span><span class="pc">vent-</span><span class="c">&gt;cm_info.</span><span class="pc">cm_id</span><span class="c">);</span>
	<span class="w">rem_ref_cm_node</span><span class="c">(</span><span class="pc">cm_c</span><span class="c">ore</span><span class="pc">,</span> <span class="w">e</span><span class="pc">vent</span><span class="c">-&gt;</span><span class="w">cm_node</span><span class="c">);</span>
	<span class="w">k</span><span class="c">free(</span><span class="w">e</span><span class="pc">vent</span><span class="c">);</span>

	<span class="pc">r</span><span class="c">eturn</span><span class="w">;</span>
<span class="c">}</span>

</pre>
</body>
</html>

