<!DOCTYPE html>
<html>
<head>
<style>
span.c {
    background-color: #CCFFCC;
}
span.pc {
    background-color: #FFEEBB;
}
span.w {
    background-color: #FFCCCC;
}
</style>
</head>
<body>
<pre>


<span class="w">#include</span> <span class="w">&lt;linux/module.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/kernel.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/slab.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/spinlock.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux</span><span class="c">/</span><span class="w">proc_fs</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">capability</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">d</span><span class="pc">ev</span><span class="c">ice.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="pc">d</span><span class="c">elay.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;</span><span class="pc">a</span><span class="c">sm/uaccess.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">sn</span><span class="pc">/</span><span class="w">sn_sal</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;</span><span class="pc">a</span><span class="c">sm/sn/</span><span class="w">addrs</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/sn/</span><span class="w">i</span><span class="pc">o</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;</span><span class="pc">a</span><span class="c">sm/sn/</span><span class="pc">t</span><span class="c">ypes.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/sn/</span><span class="w">shubio</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;</span><span class="pc">a</span><span class="c">sm/sn/</span><span class="w">tiocx</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;</span><span class="pc">a</span><span class="c">sm/sn</span><span class="pc">/</span><span class="w">l1</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;</span><span class="pc">a</span><span class="c">sm/sn</span><span class="pc">/</span><span class="w">m</span><span class="pc">o</span><span class="c">dule.h&gt;</span>
<span class="c">#include</span> <span class="pc">"</span><span class="w">tio</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">xtalk</span><span class="pc">/</span><span class="w">xwidgetdev</span><span class="c">.h"</span>
<span class="c">#</span><span class="pc">i</span><span class="c">nclude</span> <span class="c">"</span><span class="pc">x</span><span class="c">talk</span><span class="pc">/</span><span class="w">hubdev</span><span class="c">.h"</span>

<span class="c">#</span><span class="pc">d</span><span class="c">efine</span> <span class="w">CX_DEV_NONE</span> <span class="pc">0</span>
<span class="c">#define</span> <span class="w">DEVICE_NAME</span> <span class="c">"</span><span class="w">tiocx</span><span class="c">"</span>
<span class="c">#define</span> <span class="w">WIDGET_ID</span> <span class="pc">0</span>
<span class="c">#define</span> <span class="w">TIOCX_DEBUG</span> <span class="pc">0</span>

<span class="c">#</span><span class="w">i</span><span class="pc">f</span> <span class="w">T</span><span class="c">IOCX_DEBUG</span>
<span class="w">#</span><span class="c">define</span> <span class="w">D</span><span class="c">BG(</span><span class="w">f</span><span class="c">mt</span><span class="w">.</span><span class="c">..)</span>    <span class="w">p</span><span class="c">rintk(</span><span class="w">KERN_ALERT</span> <span class="w">f</span><span class="pc">m</span><span class="c">t</span><span class="pc">)</span>
<span class="c">#</span><span class="pc">e</span><span class="c">lse</span>
<span class="pc">#</span><span class="c">define</span> <span class="w">D</span><span class="pc">B</span><span class="c">G(</span><span class="pc">f</span><span class="c">mt</span><span class="w">.</span><span class="c">..)</span>
<span class="pc">#e</span><span class="c">ndif</span>

<span class="w">s</span><span class="pc">tr</span><span class="c">uct</span> <span class="w">de</span><span class="pc">vice_a</span><span class="c">ttribute</span> <span class="w">dev_attr_cxdev_control</span><span class="pc">;</span>


<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="pc">int</span> <span class="w">tiocx_match</span><span class="c">(struct</span> <span class="w">d</span><span class="pc">evi</span><span class="c">ce</span> <span class="c">*dev</span><span class="pc">,</span> <span class="c">struct</span> <span class="w">device_driver</span> <span class="c">*</span><span class="w">d</span><span class="pc">r</span><span class="c">v)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">cx_dev</span> <span class="c">*</span><span class="pc">c</span><span class="c">x_dev</span> <span class="c">=</span> <span class="w">to_cx_dev</span><span class="c">(dev);</span>
	<span class="c">struct</span> <span class="w">cx_drv</span> <span class="c">*cx_drv</span> <span class="c">=</span> <span class="w">to_cx_driver</span><span class="c">(</span><span class="w">d</span><span class="pc">r</span><span class="c">v);</span>
	<span class="w">c</span><span class="pc">o</span><span class="c">nst</span> <span class="c">struct</span> <span class="w">cx_device_id</span> <span class="c">*</span><span class="w">ids</span> <span class="pc">=</span> <span class="pc">cx_dr</span><span class="c">v</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">id</span><span class="pc">_</span><span class="c">table</span><span class="pc">;</span>

	<span class="pc">if</span> <span class="pc">(!</span><span class="c">ids</span><span class="pc">)</span>
		<span class="c">return</span> <span class="w">0</span><span class="c">;</span>

	<span class="w">w</span><span class="c">hile</span> <span class="c">(ids-&gt;</span><span class="w">part_num</span><span class="pc">)</span><span class="c"> {</span>
		<span class="c">if</span> <span class="c">(ids-&gt;</span><span class="pc">p</span><span class="c">art_num</span> <span class="pc">=</span><span class="c">=</span> <span class="w">cx_dev-</span><span class="c">&gt;</span><span class="w">cx_id</span><span class="pc">.p</span><span class="c">art_num</span><span class="w">)</span>
			<span class="pc">r</span><span class="c">eturn</span> <span class="w">1</span><span class="c">;</span>
		<span class="w">i</span><span class="pc">d</span><span class="c">s</span><span class="w">+</span><span class="c">+;</span>
	<span class="c">}</span>
	<span class="w">r</span><span class="c">eturn</span> <span class="pc">0</span><span class="c">;</span>

<span class="c">}</span>

<span class="c">static</span> <span class="pc">int</span> <span class="w">tiocx_uevent</span><span class="c">(struct</span> <span class="w">d</span><span class="pc">e</span><span class="c">vice</span> <span class="c">*dev,</span> <span class="c">struct</span> <span class="w">kobj_uevent_env</span> <span class="c">*</span><span class="w">en</span><span class="pc">v)</span>
<span class="c">{</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">-</span><span class="c">ENODEV;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">tiocx_bus_release</span><span class="c">(struct</span> <span class="c">device</span> <span class="c">*dev</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">k</span><span class="c">free(</span><span class="w">to_cx_dev</span><span class="pc">(</span><span class="c">dev</span><span class="pc">))</span><span class="c">;</span>
<span class="pc">}</span>


<span class="c">static</span> <span class="pc">c</span><span class="c">onst</span> <span class="c">struct</span> <span class="w">cx_device_id</span> <span class="c">*</span><span class="w">cx_device_match</span><span class="c">(</span><span class="pc">c</span><span class="c">onst</span> <span class="c">struct</span> <span class="pc">c</span><span class="c">x_device_id</span>
						  <span class="c">*</span><span class="w">ids</span><span class="pc">,</span>
						  <span class="pc">s</span><span class="c">truct</span> <span class="w">cx_dev</span> <span class="c">*</span><span class="w">cx_device</span><span class="c">)</span>
<span class="c">{</span>
	
	<span class="w">w</span><span class="pc">h</span><span class="c">ile</span> <span class="c">(</span><span class="pc">i</span><span class="c">ds</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">part_num</span> <span class="w">&amp;</span><span class="c">&amp;</span> <span class="w">i</span><span class="c">ds-&gt;</span><span class="w">mfg_num)</span><span class="pc"> </span><span class="c">{</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(ids-&gt;</span><span class="w">p</span><span class="c">art_num</span> <span class="c">==</span> <span class="pc">c</span><span class="c">x_device-&gt;</span><span class="w">cx_id.p</span><span class="c">art_num</span> <span class="w">&amp;</span><span class="pc">&amp;</span>
		    <span class="c">ids-&gt;</span><span class="pc">m</span><span class="c">fg_num</span> <span class="pc">=</span><span class="c">=</span> <span class="c">cx_device-&gt;</span><span class="pc">c</span><span class="c">x_id.</span><span class="pc">m</span><span class="c">fg_num</span><span class="w">)</span>
			<span class="pc">r</span><span class="c">eturn</span> <span class="w">i</span><span class="c">ds</span><span class="pc">;</span>
		<span class="pc">i</span><span class="c">ds</span><span class="w">+</span><span class="pc">+</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">r</span><span class="c">eturn</span> <span class="w">N</span><span class="c">ULL;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">int</span> <span class="w">cx_device_probe</span><span class="c">(struct</span> <span class="w">d</span><span class="pc">e</span><span class="c">vice</span> <span class="c">*dev</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">c</span><span class="pc">o</span><span class="c">nst</span> <span class="c">struct</span> <span class="w">cx_device_id</span> <span class="c">*</span><span class="w">i</span><span class="pc">d;</span>
	<span class="c">struct</span> <span class="w">cx_drv</span> <span class="c">*</span><span class="pc">cx_dr</span><span class="c">v</span> <span class="pc">=</span> <span class="w">to_cx_driver</span><span class="pc">(d</span><span class="c">ev</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">d</span><span class="pc">r</span><span class="c">iver</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">s</span><span class="pc">tr</span><span class="c">uct</span> <span class="w">cx_dev</span> <span class="c">*</span><span class="w">c</span><span class="pc">x_dev</span> <span class="c">=</span> <span class="w">to_cx_dev</span><span class="c">(dev);</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">e</span><span class="pc">rro</span><span class="c">r</span> <span class="pc">=</span> <span class="pc">0</span><span class="c">;</span>

	<span class="c">if</span> <span class="pc">(!</span><span class="w">c</span><span class="pc">x_dev</span><span class="c">-&gt;</span><span class="pc">dr</span><span class="c">iver</span> <span class="pc">&amp;</span><span class="c">&amp;</span> <span class="pc">c</span><span class="c">x_drv-&gt;</span><span class="w">pr</span><span class="pc">ob</span><span class="c">e</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">i</span><span class="pc">d</span> <span class="c">=</span> <span class="w">cx_device_match</span><span class="c">(</span><span class="w">c</span><span class="pc">x_dr</span><span class="c">v</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">id</span><span class="pc">_</span><span class="c">table</span><span class="pc">,</span> <span class="w">c</span><span class="pc">x_de</span><span class="c">v);</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">i</span><span class="pc">d)</span><span class="c"> {</span>
			<span class="pc">i</span><span class="c">f</span> <span class="pc">((e</span><span class="c">rror</span> <span class="w">=</span> <span class="pc">c</span><span class="c">x_drv-&gt;</span><span class="w">pro</span><span class="pc">b</span><span class="c">e</span><span class="w">(</span><span class="pc">c</span><span class="c">x_dev,</span> <span class="w">i</span><span class="c">d</span><span class="w">)) </span><span class="pc">&lt;</span> <span class="c">0</span><span class="pc">)</span>
				<span class="c">return</span> <span class="w">e</span><span class="pc">rro</span><span class="c">r;</span>
			<span class="w">e</span><span class="pc">l</span><span class="c">se</span>
				<span class="w">c</span><span class="pc">x_de</span><span class="c">v</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">dr</span><span class="c">iver</span> <span class="c">=</span> <span class="pc">cx_dr</span><span class="c">v</span><span class="pc">;</span>
		<span class="c">}</span>
	<span class="pc">}</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">e</span><span class="pc">rro</span><span class="c">r;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">int</span> <span class="w">cx_driver_remove</span><span class="c">(struct</span> <span class="pc">d</span><span class="c">evice</span> <span class="c">*dev</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">c</span><span class="pc">x_de</span><span class="c">v</span> <span class="c">*</span><span class="pc">cx_de</span><span class="c">v</span> <span class="c">=</span> <span class="w">to_cx_dev</span><span class="c">(dev);</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">c</span><span class="pc">x_dr</span><span class="c">v</span> <span class="c">*</span><span class="w">c</span><span class="pc">x_dr</span><span class="c">v</span> <span class="c">=</span> <span class="pc">c</span><span class="c">x_dev-&gt;</span><span class="w">dr</span><span class="pc">iver</span><span class="c">;</span>
	<span class="pc">if</span> <span class="c">(</span><span class="w">c</span><span class="pc">x_dr</span><span class="c">v-&gt;</span><span class="w">rem</span><span class="c">ove</span><span class="w">)</span>
		<span class="pc">cx_dr</span><span class="c">v</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">rem</span><span class="c">ove</span><span class="w">(</span><span class="pc">c</span><span class="c">x_dev</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">c</span><span class="pc">x_de</span><span class="c">v-&gt;</span><span class="w">dr</span><span class="pc">iver</span> <span class="w">=</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="w">s</span><span class="pc">tr</span><span class="c">uct</span> <span class="w">bus_type</span> <span class="w">tiocx_bus_type</span> <span class="c">= {</span>
	<span class="c">.</span><span class="pc">n</span><span class="c">ame</span> <span class="c">= "</span><span class="w">tiocx</span><span class="c">",</span>
	<span class="c">.</span><span class="w">m</span><span class="pc">a</span><span class="c">tch</span> <span class="c">=</span> <span class="w">tiocx_match</span><span class="c">,</span>
	<span class="c">.</span><span class="w">uevent</span> <span class="c">=</span> <span class="w">tiocx_uevent</span><span class="c">,</span>
	<span class="c">.</span><span class="w">p</span><span class="pc">r</span><span class="c">obe</span> <span class="c">=</span> <span class="w">cx_device_probe</span><span class="c">,</span>
	<span class="c">.remove</span> <span class="c">=</span> <span class="w">cx_driver_remove</span><span class="c">,</span>
<span class="pc">}</span><span class="c">;</span>


<span class="pc">i</span><span class="c">nt</span> <span class="w">cx_driver_register</span><span class="c">(struct</span> <span class="w">cx_drv</span> <span class="c">*</span><span class="w">cx_driver</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">c</span><span class="pc">x</span><span class="c">_driver</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">d</span><span class="pc">ri</span><span class="c">ver</span><span class="pc">.n</span><span class="c">ame</span> <span class="c">=</span> <span class="c">cx_driver-&gt;</span><span class="w">n</span><span class="c">ame;</span>
	<span class="c">cx_driver-&gt;</span><span class="w">d</span><span class="c">river.</span><span class="w">b</span><span class="pc">u</span><span class="c">s</span> <span class="pc">= </span><span class="c">&amp;</span><span class="w">tiocx_bus_type</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">driver_register</span><span class="pc">(&amp;c</span><span class="c">x_driver-&gt;</span><span class="w">d</span><span class="pc">river)</span><span class="c">;</span>
<span class="pc">}</span>


<span class="w">i</span><span class="c">nt</span> <span class="w">cx_driver_unregister</span><span class="c">(struct</span> <span class="w">c</span><span class="pc">x_drv</span> <span class="c">*cx_driver)</span>
<span class="c">{</span>
	<span class="w">driver_unregister</span><span class="c">(&amp;cx_driver-&gt;</span><span class="pc">dr</span><span class="c">iver</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>


<span class="w">i</span><span class="c">nt</span>
<span class="w">cx_device_register</span><span class="c">(</span><span class="w">nasid_t</span> <span class="w">nasid</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">part_num</span><span class="c">,</span> <span class="c">int</span> <span class="w">mfg_num</span><span class="c">,</span>
		   <span class="pc">s</span><span class="c">truct</span> <span class="w">hubdev_info</span> <span class="c">*</span><span class="w">hubdev</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">bt</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">cx_dev</span> <span class="c">*</span><span class="pc">cx_de</span><span class="c">v</span><span class="pc">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">r</span><span class="c">;</span>

	<span class="w">c</span><span class="pc">x_de</span><span class="c">v</span> <span class="pc">=</span> <span class="c">kzalloc(sizeof</span><span class="pc">(</span><span class="c">struct</span> <span class="c">cx_dev),</span> <span class="c">GFP_KERNEL);</span>
	<span class="w">D</span><span class="pc">B</span><span class="c">G</span><span class="pc">("c</span><span class="c">x_dev</span><span class="w">=</span> <span class="c">0x%</span><span class="w">p</span><span class="c">\n",</span> <span class="c">cx_dev);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">c</span><span class="c">x_dev</span> <span class="pc">=</span><span class="c">=</span> <span class="c">NULL)</span>
		<span class="c">return</span> <span class="c">-ENOMEM;</span>

	<span class="c">cx_dev-&gt;</span><span class="w">cx_id</span><span class="pc">.</span><span class="w">part_num</span> <span class="c">=</span> <span class="pc">p</span><span class="c">art_num;</span>
	<span class="c">cx_dev-&gt;cx_id</span><span class="pc">.</span><span class="w">mfg_num</span> <span class="c">=</span> <span class="pc">m</span><span class="c">fg_num;</span>
	<span class="c">cx_dev-&gt;cx_id</span><span class="pc">.</span><span class="w">nasid</span> <span class="c">=</span> <span class="w">n</span><span class="c">asid;</span>
	<span class="c">cx_dev-&gt;</span><span class="w">hubdev</span> <span class="pc">=</span> <span class="c">hubdev;</span>
	<span class="pc">cx_d</span><span class="c">ev-&gt;</span><span class="w">bt</span> <span class="pc">=</span> <span class="w">bt</span><span class="pc">;</span>

	<span class="c">cx_dev-&gt;</span><span class="w">de</span><span class="pc">v</span><span class="w">.</span><span class="pc">p</span><span class="c">arent</span> <span class="c">=</span> <span class="w">N</span><span class="c">ULL;</span>
	<span class="c">cx_dev-&gt;</span><span class="w">d</span><span class="c">ev</span><span class="pc">.</span><span class="w">b</span><span class="pc">u</span><span class="c">s</span> <span class="pc">= </span><span class="c">&amp;</span><span class="w">tiocx_bus_type</span><span class="c">;</span>
	<span class="c">cx_dev-&gt;dev</span><span class="pc">.</span><span class="w">r</span><span class="c">elease</span> <span class="c">=</span> <span class="w">tiocx_bus_release</span><span class="c">;</span>
	<span class="w">dev_set_name</span><span class="c">(&amp;</span><span class="pc">c</span><span class="c">x_dev-&gt;dev</span><span class="w">,</span><span class="pc"> "%d</span><span class="c">",</span> <span class="c">cx_dev-&gt;</span><span class="w">cx_id</span><span class="pc">.</span><span class="w">nasid</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">r</span> <span class="c">=</span> <span class="w">device_register</span><span class="pc">(&amp;</span><span class="c">cx_dev-&gt;dev);</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">r</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">k</span><span class="c">free(cx_dev</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">return</span> <span class="w">r</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="w">get_device</span><span class="c">(&amp;cx_dev-&gt;dev</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">device_create_file</span><span class="pc">(&amp;</span><span class="c">cx_dev-&gt;dev</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">dev_attr_cxdev_control</span><span class="c">);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>


<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">cx_device_unregister</span><span class="c">(struct</span> <span class="c">cx_dev</span> <span class="c">*</span><span class="pc">c</span><span class="c">x_dev)</span>
<span class="c">{</span>
	<span class="w">put_device</span><span class="pc">(&amp;</span><span class="c">cx_dev-&gt;dev</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">device_unregister</span><span class="pc">(&amp;</span><span class="c">cx_dev-&gt;dev);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">int</span> <span class="w">cx_device_reload</span><span class="c">(struct</span> <span class="pc">c</span><span class="c">x_dev</span> <span class="c">*</span><span class="w">c</span><span class="c">x_dev)</span>
<span class="c">{</span>
	<span class="w">c</span><span class="pc">x_devi</span><span class="c">ce_unregister</span><span class="pc">(</span><span class="c">cx_dev</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">cx_device_register</span><span class="c">(cx_dev</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">cx_id</span><span class="pc">.</span><span class="w">nasid</span><span class="pc">,</span> <span class="c">cx_dev-&gt;</span><span class="pc">cx_i</span><span class="c">d</span><span class="pc">.</span><span class="w">part_num,</span>
				  <span class="c">cx_dev-&gt;</span><span class="pc">cx_i</span><span class="c">d.</span><span class="w">mfg_num</span><span class="pc">,</span> <span class="c">cx_dev-&gt;</span><span class="w">hubdev</span><span class="pc">,</span>
				  <span class="c">cx_dev-&gt;</span><span class="w">bt</span><span class="pc">)</span><span class="c">;</span>
<span class="pc">}</span>

<span class="c">static</span> <span class="pc">inl</span><span class="c">ine</span> <span class="w">u</span><span class="pc">6</span><span class="c">4</span> <span class="w">tiocx_intr_alloc</span><span class="c">(</span><span class="w">nasid_t</span> <span class="w">n</span><span class="c">asid</span><span class="pc">,</span> <span class="w">i</span><span class="c">nt</span> <span class="w">widget</span><span class="c">,</span>
					<span class="w">u</span><span class="pc">6</span><span class="c">4</span> <span class="w">sn_irq_info</span><span class="pc">,</span>
					<span class="pc">i</span><span class="c">nt</span> <span class="w">req_irq</span><span class="c">,</span> <span class="w">n</span><span class="pc">asid_</span><span class="c">t</span> <span class="w">req_nasid</span><span class="c">,</span>
					<span class="pc">i</span><span class="c">nt</span> <span class="w">req_slice</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">ia64_sal_retval</span> <span class="w">rv</span><span class="c">;</span>
	<span class="w">rv.</span><span class="pc">s</span><span class="c">tatus</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="w">rv.v0</span> <span class="c">=</span> <span class="c">0;</span>

	<span class="w">ia64_sal_oemcall_nolock</span><span class="pc">(&amp;</span><span class="w">rv</span><span class="c">,</span> <span class="w">SN_SAL_IOIF_INTERRUPT</span><span class="c">,</span>
				<span class="w">SAL_INTR_ALLOC</span><span class="c">,</span> <span class="w">nasid</span><span class="c">,</span>
				<span class="w">widget</span><span class="c">,</span> <span class="w">s</span><span class="c">n_irq_info,</span> <span class="w">r</span><span class="c">eq_irq,</span>
				<span class="w">r</span><span class="pc">eq_n</span><span class="c">asid,</span> <span class="pc">r</span><span class="c">eq_slice</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">r</span><span class="pc">v</span><span class="w">.s</span><span class="pc">tat</span><span class="c">us</span><span class="pc">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="w">i</span><span class="pc">nl</span><span class="c">ine</span> <span class="c">void</span> <span class="w">tiocx_intr_free</span><span class="c">(</span><span class="w">nasid_t</span> <span class="w">n</span><span class="c">asid,</span> <span class="w">i</span><span class="c">nt</span> <span class="w">w</span><span class="c">idget,</span>
				   <span class="w">s</span><span class="pc">t</span><span class="c">ruct</span> <span class="pc">sn</span><span class="c">_irq_info</span> <span class="c">*</span><span class="w">s</span><span class="c">n_irq_info</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">ia64_sal_retval</span> <span class="w">rv</span><span class="c">;</span>
	<span class="w">rv.s</span><span class="pc">tatu</span><span class="c">s</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="w">rv.v0</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>

	<span class="w">ia64_sal_oemcall_nolock</span><span class="pc">(&amp;</span><span class="w">rv</span><span class="pc">,</span> <span class="w">SN_SAL_IOIF_INTERRUPT</span><span class="pc">,</span>
				<span class="w">SAL_INTR_FREE</span><span class="c">,</span> <span class="w">n</span><span class="pc">asid</span><span class="c">,</span>
				<span class="w">w</span><span class="c">idget,</span> <span class="pc">s</span><span class="c">n_irq_info</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">irq_irq</span><span class="c">,</span>
				<span class="w">s</span><span class="c">n_irq_info</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">irq_cookie</span><span class="c">,</span> <span class="pc">0</span><span class="c">,</span> <span class="c">0</span><span class="pc">)</span><span class="c">;</span>
<span class="pc">}</span>

<span class="w">s</span><span class="pc">tr</span><span class="c">uct</span> <span class="w">s</span><span class="c">n_irq_info</span> <span class="pc">*</span><span class="w">tiocx_irq_alloc</span><span class="c">(</span><span class="w">nasid_t</span> <span class="w">n</span><span class="c">asid,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">w</span><span class="c">idget,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">ir</span><span class="pc">q</span><span class="c">,</span>
				    <span class="w">n</span><span class="pc">asid_</span><span class="c">t</span> <span class="w">req_nasid</span><span class="pc">,</span> <span class="c">int</span> <span class="w">slice</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="c">sn_irq_info</span> <span class="c">*sn_irq_info</span><span class="pc">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">s</span><span class="c">tatus;</span>
	<span class="c">int</span> <span class="w">sn_irq_size</span> <span class="pc">=</span> <span class="w">s</span><span class="pc">i</span><span class="c">zeof(struct</span> <span class="c">sn_irq_info</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">if</span> <span class="pc">((</span><span class="w">n</span><span class="pc">asid</span> <span class="pc">&amp;</span> <span class="w">1) </span><span class="pc">=</span><span class="c">=</span> <span class="c">0</span><span class="pc">)</span>
		<span class="c">return</span> <span class="pc">N</span><span class="c">ULL;</span>

	<span class="w">s</span><span class="c">n_irq_info</span> <span class="pc">=</span> <span class="pc">k</span><span class="c">zalloc(</span><span class="pc">sn</span><span class="c">_irq_size,</span> <span class="c">GFP_KERNEL);</span>
	<span class="c">if</span> <span class="pc">(</span><span class="w">s</span><span class="pc">n_irq_i</span><span class="c">nfo</span> <span class="pc">=</span><span class="c">=</span> <span class="c">NULL)</span>
		<span class="c">return</span> <span class="pc">N</span><span class="c">ULL;</span>

	<span class="w">s</span><span class="pc">t</span><span class="c">atus</span> <span class="c">=</span> <span class="w">tiocx_intr_alloc</span><span class="c">(</span><span class="pc">n</span><span class="c">asid,</span> <span class="w">widget</span><span class="c">,</span> <span class="w">__pa(</span><span class="c">sn_irq_info</span><span class="pc">),</span> <span class="w">ir</span><span class="c">q</span><span class="pc">,</span>
				  <span class="w">req_nasid</span><span class="c">,</span> <span class="w">slice</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">s</span><span class="pc">t</span><span class="c">atus</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">k</span><span class="c">free(</span><span class="pc">sn_irq_i</span><span class="c">nfo);</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">N</span><span class="c">ULL;</span>
	<span class="c">}</span> <span class="w">e</span><span class="pc">l</span><span class="c">se</span> <span class="c">{</span>
		<span class="c">return</span> <span class="w">s</span><span class="c">n_irq_info;</span>
	<span class="c">}</span>
<span class="pc">}</span>

<span class="pc">v</span><span class="c">oid</span> <span class="w">tiocx_irq_free</span><span class="c">(struct</span> <span class="c">sn_irq_info</span> <span class="c">*</span><span class="pc">sn</span><span class="c">_irq_info</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">u6</span><span class="c">4</span> <span class="w">br</span><span class="pc">i</span><span class="c">dge</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="w">u6</span><span class="c">4</span><span class="w">)</span> <span class="pc">sn</span><span class="c">_irq_info</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">irq_bridge</span><span class="c">;</span>
	<span class="w">nasid_t</span> <span class="w">nasid</span> <span class="w">=</span> <span class="w">NASID_GET</span><span class="c">(</span><span class="w">br</span><span class="c">idge</span><span class="pc">);</span>
	<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">widget</span><span class="pc">;</span>

	<span class="pc">if</span> <span class="c">(</span><span class="pc">nasid</span> <span class="pc">&amp;</span> <span class="w">1</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">w</span><span class="pc">i</span><span class="c">dget</span> <span class="pc">=</span> <span class="w">TIO_SWIN_WIDGETNUM</span><span class="c">(</span><span class="w">b</span><span class="pc">r</span><span class="c">idge</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">tiocx_intr_free</span><span class="c">(</span><span class="pc">n</span><span class="c">asid</span><span class="pc">,</span> <span class="w">w</span><span class="c">idget</span><span class="pc">,</span> <span class="c">sn_irq_info);</span>
		<span class="w">k</span><span class="c">free(</span><span class="pc">s</span><span class="c">n_irq_info);</span>
	<span class="c">}</span>
<span class="pc">}</span>

<span class="w">u</span><span class="pc">6</span><span class="c">4</span> <span class="w">tiocx_dma_addr</span><span class="pc">(</span><span class="w">u</span><span class="pc">6</span><span class="c">4</span> <span class="w">a</span><span class="pc">dd</span><span class="c">r</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">PHYS_TO_TIODMA</span><span class="pc">(</span><span class="w">a</span><span class="pc">dd</span><span class="c">r</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="w">u</span><span class="pc">6</span><span class="c">4</span> <span class="w">tiocx_swin_base</span><span class="c">(</span><span class="pc">i</span><span class="c">nt</span> <span class="w">n</span><span class="c">asid</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">TIO_SWIN_BASE</span><span class="pc">(</span><span class="c">nasid,</span> <span class="w">TIOCX_CORELET</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="pc">E</span><span class="c">XPORT_SYMBOL(</span><span class="w">cx_driver_register</span><span class="c">);</span>
<span class="pc">E</span><span class="c">XPORT_SYMBOL(</span><span class="w">cx_driver_unregister</span><span class="c">);</span>
<span class="w">E</span><span class="c">XPORT_SYMBOL(</span><span class="w">cx_device_register</span><span class="c">);</span>
<span class="pc">E</span><span class="c">XPORT_SYMBOL(</span><span class="w">cx_device_unregister</span><span class="c">);</span>
<span class="pc">E</span><span class="c">XPORT_SYMBOL(</span><span class="w">tiocx_irq_alloc</span><span class="c">);</span>
<span class="c">EXPORT_SYMBOL(</span><span class="w">tiocx_irq_free</span><span class="c">);</span>
<span class="pc">E</span><span class="c">XPORT_SYMBOL(</span><span class="w">tiocx_bus_type</span><span class="c">);</span>
<span class="pc">E</span><span class="c">XPORT_SYMBOL(</span><span class="w">tiocx_dma_addr</span><span class="c">);</span>
<span class="c">EXPORT_SYMBOL(</span><span class="w">tiocx_swin_base</span><span class="c">);</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="c">void</span> <span class="w">tio_conveyor_set</span><span class="c">(</span><span class="w">nasid_t</span> <span class="w">nasid</span><span class="pc">,</span> <span class="c">int</span> <span class="w">enable_flag</span><span class="pc">)</span>
<span class="pc">{</span>
	<span class="w">u</span><span class="pc">6</span><span class="c">4</span> <span class="w">ice_frz</span><span class="pc">;</span>
	<span class="c">u64</span> <span class="w">disable_cb</span> <span class="pc">= </span><span class="c">(</span><span class="w">1ull</span> <span class="w">&lt;</span><span class="c">&lt;</span> <span class="w">61)</span><span class="pc">;</span>

	<span class="w">i</span><span class="pc">f</span> <span class="pc">(!(</span><span class="w">n</span><span class="c">asid</span> <span class="c">&amp;</span> <span class="w">1</span><span class="c">))</span>
		<span class="c">return</span><span class="pc">;</span>

	<span class="w">i</span><span class="pc">c</span><span class="c">e_frz</span> <span class="pc">=</span> <span class="w">REMOTE_HUB_L</span><span class="c">(</span><span class="w">n</span><span class="pc">asid</span><span class="c">,</span> <span class="w">TIO_ICE_FRZ_CFG</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">e</span><span class="c">nable_flag</span><span class="pc">) </span><span class="c">{</span>
		<span class="c">if</span> <span class="pc">(!(i</span><span class="c">ce_frz</span> <span class="c">&amp;</span> <span class="w">d</span><span class="c">isable_cb</span><span class="pc">))</span>	
			<span class="c">return</span><span class="pc">;</span>
		<span class="w">i</span><span class="pc">c</span><span class="c">e_frz</span> <span class="w">&amp;</span><span class="pc">=</span><span class="c"> ~</span><span class="pc">d</span><span class="c">isable_cb;</span>
	<span class="c">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">i</span><span class="c">ce_frz</span> <span class="w">&amp;</span> <span class="w">d</span><span class="c">isable_cb</span><span class="pc">)</span>	
			<span class="c">return</span><span class="pc">;</span>
		<span class="pc">ic</span><span class="c">e_frz</span> <span class="pc">|</span><span class="c">=</span> <span class="pc">d</span><span class="c">isable_cb;</span>
	<span class="c">}</span>
	<span class="w">D</span><span class="c">BG(</span><span class="w">KERN_ALERT</span> <span class="w">"T</span><span class="c">IO_ICE_FRZ_CFG</span><span class="w">=</span> <span class="pc">0</span><span class="c">x%</span><span class="pc">l</span><span class="c">x\n",</span> <span class="c">ice_frz</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">REMOTE_HUB_S</span><span class="c">(</span><span class="w">nasid</span><span class="c">,</span> <span class="w">T</span><span class="c">IO_ICE_FRZ_CFG,</span> <span class="c">ice_frz</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="w">#</span><span class="c">define</span> <span class="w">tio_conveyor_enable</span><span class="c">(</span><span class="w">n</span><span class="c">asid</span><span class="pc">)</span> <span class="w">tio_conveyor_set</span><span class="c">(</span><span class="w">n</span><span class="c">asid,</span> <span class="w">1</span><span class="pc">)</span>
<span class="pc">#</span><span class="c">define</span> <span class="w">tio_conveyor_disable</span><span class="c">(</span><span class="w">n</span><span class="c">asid</span><span class="pc">)</span> <span class="w">t</span><span class="pc">io_conveyor_s</span><span class="c">et(nasid,</span> <span class="pc">0</span><span class="c">)</span>

<span class="w">s</span><span class="c">tatic</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">tio_corelet_reset</span><span class="c">(</span><span class="w">nasid_t</span> <span class="pc">n</span><span class="c">asid</span><span class="pc">,</span> <span class="w">i</span><span class="c">nt</span> <span class="w">corelet</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">i</span><span class="pc">f</span> <span class="pc">(!(n</span><span class="c">asid</span> <span class="pc">&amp;</span> <span class="w">1</span><span class="c">))</span>
		<span class="c">return</span><span class="pc">;</span>

	<span class="w">REMOTE_HUB_S</span><span class="c">(nasid,</span> <span class="w">TIO_ICE_PMI_TX_CFG</span><span class="c">,</span> <span class="pc">1</span> <span class="pc">&lt;</span><span class="c">&lt;</span> <span class="pc">c</span><span class="c">orelet</span><span class="pc">);</span>
	<span class="w">u</span><span class="c">delay(</span><span class="w">2000</span><span class="c">);</span>
	<span class="w">R</span><span class="c">EMOTE_HUB_S(nasid,</span> <span class="w">T</span><span class="c">IO_ICE_PMI_TX_CFG,</span> <span class="pc">0</span><span class="c">);</span>
	<span class="pc">u</span><span class="c">delay(</span><span class="w">2</span><span class="pc">0</span><span class="c">00);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">is_fpga_tio</span><span class="c">(</span><span class="pc">i</span><span class="c">nt</span> <span class="pc">n</span><span class="c">asid,</span> <span class="c">int</span> <span class="pc">*</span><span class="w">bt</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="w">uninitialized_var</span><span class="pc">(</span><span class="w">ioboard_type)</span><span class="c">;</span>	
	<span class="w">l</span><span class="pc">o</span><span class="c">ng</span> <span class="pc">r</span><span class="c">c;</span>

	<span class="w">r</span><span class="pc">c</span> <span class="c">=</span> <span class="w">ia64_sn_sysctl_ioboard_get</span><span class="c">(</span><span class="pc">n</span><span class="c">asid</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">i</span><span class="c">oboard_type);</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">r</span><span class="c">c</span><span class="pc">)</span><span class="c"> {</span>
		<span class="pc">p</span><span class="c">rintk(</span><span class="pc">KERN_W</span><span class="c">ARNING</span> <span class="pc">"</span><span class="w">i</span><span class="pc">a</span><span class="c">64_sn_sysctl_ioboard_get</span> <span class="pc">f</span><span class="c">ailed</span><span class="w">:</span><span class="pc"> </span><span class="c">%</span><span class="w">l</span><span class="pc">d</span><span class="c">\n",</span>
		       <span class="pc">r</span><span class="c">c);</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">s</span><span class="pc">w</span><span class="c">itch</span> <span class="c">(ioboard_type) {</span>
	<span class="c">case</span> <span class="w">L1_BRICKTYPE_SA</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">L1_BRICKTYPE_ATHENA</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">L1_BOARDTYPE_DAYTONA</span><span class="c">:</span>
		<span class="w">*bt</span> <span class="pc">=</span> <span class="c">ioboard_type</span><span class="pc">;</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="pc">1</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bitstream_loaded</span><span class="c">(</span><span class="w">nasid_t</span> <span class="w">nasid)</span>
<span class="c">{</span>
	<span class="w">u6</span><span class="c">4</span> <span class="w">cx_credits</span><span class="pc">;</span>

	<span class="w">c</span><span class="c">x_credits</span> <span class="c">=</span> <span class="w">REMOTE_HUB_L</span><span class="c">(</span><span class="pc">n</span><span class="c">asid,</span> <span class="w">TIO_ICE_PMI_TX_DYN_CREDIT_STAT_CB3</span><span class="c">);</span>
	<span class="pc">c</span><span class="c">x_credits</span> <span class="w">&amp;</span><span class="pc">=</span> <span class="w">TIO_ICE_PMI_TX_DYN_CREDIT_STAT_CB3_CREDIT_CNT_MASK</span><span class="c">;</span>
	<span class="w">D</span><span class="c">BG("</span><span class="pc">c</span><span class="c">x_credits</span><span class="pc">=</span> <span class="c">0x%</span><span class="pc">l</span><span class="c">x\n",</span> <span class="c">cx_credits);</span>

	<span class="c">return</span> <span class="w">(</span><span class="pc">c</span><span class="c">x_credits</span> <span class="w">=</span><span class="pc">=</span> <span class="w">0xf)</span><span class="pc"> ?</span> <span class="pc">1</span> <span class="c">:</span> <span class="pc">0</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">int</span> <span class="w">tiocx_reload</span><span class="c">(struct</span> <span class="w">cx_dev</span> <span class="c">*</span><span class="w">c</span><span class="pc">x_d</span><span class="c">ev</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">part_num</span> <span class="pc">=</span> <span class="w">CX_DEV_NONE</span><span class="pc">;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">mfg_num</span> <span class="pc">=</span> <span class="c">CX_DEV_NONE;</span>
	<span class="w">nasid_t</span> <span class="w">nasid</span> <span class="pc">=</span> <span class="w">c</span><span class="pc">x_d</span><span class="c">ev</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">cx_id</span><span class="pc">.nasid;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">bitstream_loaded</span><span class="pc">(</span><span class="c">nasid</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">u6</span><span class="c">4</span> <span class="w">c</span><span class="pc">x_i</span><span class="c">d</span><span class="pc">;</span>
		<span class="pc">in</span><span class="c">t</span> <span class="w">rv</span><span class="c">;</span>

		<span class="w">rv</span> <span class="c">=</span> <span class="w">ia64_sn_sysctl_tio_clock_reset</span><span class="c">(nasid);</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">rv</span><span class="pc">) </span><span class="c">{</span>
			<span class="pc">p</span><span class="c">rintk(</span><span class="w">KERN_ALERT</span> <span class="pc">"</span><span class="w">CX</span> <span class="w">p</span><span class="pc">or</span><span class="c">t</span> <span class="w">JTAG</span> <span class="w">r</span><span class="c">eset</span> <span class="pc">f</span><span class="c">ailed</span><span class="pc">.</span><span class="c">\n");</span>
		<span class="pc">}</span> <span class="c">else</span> <span class="c">{</span>
			<span class="w">c</span><span class="pc">x</span><span class="c">_id</span> <span class="w">= *</span><span class="pc">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">atile</span> <span class="w">u6</span><span class="c">4</span> <span class="c">*)</span>
				<span class="w">(TIO_SWIN_BASE</span><span class="c">(nasid,</span> <span class="w">TIOCX_CORELET) +</span>
					  <span class="w">WIDGET_ID</span><span class="pc">);</span>
			<span class="w">part_num</span> <span class="pc">=</span> <span class="w">XWIDGET_PART_NUM</span><span class="c">(</span><span class="w">c</span><span class="c">x_id</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">mfg_num</span> <span class="pc">=</span> <span class="w">XWIDGET_MFG_NUM</span><span class="c">(</span><span class="w">c</span><span class="c">x_id</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">D</span><span class="c">BG</span><span class="pc">("</span><span class="w">part</span><span class="pc">=</span> <span class="c">0x%</span><span class="pc">x,</span> <span class="w">mfg=</span> <span class="c">0x%x</span><span class="pc">\</span><span class="c">n",</span> <span class="w">p</span><span class="c">art_num,</span> <span class="w">m</span><span class="pc">fg_</span><span class="c">num</span><span class="pc">)</span><span class="c">;</span>
			
			<span class="c">if</span> <span class="c">(</span><span class="w">p</span><span class="c">art_num</span> <span class="pc">=</span><span class="c">=</span> <span class="w">TIO_CE_ASIC_PARTNUM</span><span class="c">)</span>
				<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>
		<span class="pc">}</span>
	<span class="w">}</span>

	<span class="w">cx_dev-</span><span class="pc">&gt;c</span><span class="c">x_id</span><span class="pc">.p</span><span class="c">art_num</span> <span class="c">=</span> <span class="w">p</span><span class="c">art_num;</span>
	<span class="pc">c</span><span class="c">x_dev-&gt;</span><span class="pc">cx_i</span><span class="c">d.</span><span class="pc">m</span><span class="c">fg_num</span> <span class="c">=</span> <span class="pc">m</span><span class="c">fg_num;</span>

	
	<span class="w">r</span><span class="c">eturn</span> <span class="w">cx_device_reload</span><span class="pc">(</span><span class="c">cx_dev</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="w">s</span><span class="pc">s</span><span class="c">ize_t</span> <span class="w">show_cxdev_control</span><span class="c">(struct</span> <span class="c">device</span> <span class="c">*dev,</span> <span class="c">struct</span> <span class="c">device_attribute</span> <span class="c">*attr,</span> <span class="c">char</span> <span class="c">*buf)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="c">cx_dev</span> <span class="c">*</span><span class="pc">c</span><span class="c">x_dev</span> <span class="c">=</span> <span class="w">to_cx_dev</span><span class="c">(dev);</span>

	<span class="c">return</span> <span class="c">sprintf(buf</span><span class="pc">, "</span><span class="c">0x%</span><span class="pc">x</span> <span class="pc">0</span><span class="c">x%</span><span class="pc">x</span> <span class="pc">0</span><span class="c">x%</span><span class="pc">x</span> <span class="pc">0</span><span class="c">x%x\n",</span>
		       <span class="w">c</span><span class="pc">x</span><span class="c">_dev</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">cx_id.nasid</span><span class="pc">,</span>
		       <span class="w">c</span><span class="c">x_dev</span><span class="pc">-</span><span class="c">&gt;cx_id</span><span class="pc">.</span><span class="w">part_num,</span> <span class="c">cx_dev-&gt;cx_id.</span><span class="w">mfg_num</span><span class="pc">,</span>
		       <span class="c">cx_dev-&gt;</span><span class="w">bt</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="w">s</span><span class="pc">s</span><span class="c">ize_t</span> <span class="w">store_cxdev_control</span><span class="c">(struct</span> <span class="pc">d</span><span class="c">evice</span> <span class="c">*dev,</span> <span class="c">struct</span> <span class="c">device_attribute</span> <span class="c">*attr,</span> <span class="pc">co</span><span class="c">nst</span> <span class="c">char</span> <span class="c">*buf,</span>
				   <span class="c">size_t</span> <span class="c">count)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">n</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="pc">cx_d</span><span class="c">ev</span> <span class="c">*</span><span class="w">c</span><span class="pc">x_d</span><span class="c">ev</span> <span class="pc">=</span> <span class="w">to_cx_dev</span><span class="c">(</span><span class="pc">d</span><span class="c">ev);</span>

	<span class="c">if</span> <span class="c">(!</span><span class="w">capable</span><span class="c">(</span><span class="w">CAP_SYS_ADMIN</span><span class="pc">)</span><span class="c">)</span>
		<span class="c">return</span> <span class="c">-</span><span class="pc">EP</span><span class="c">ERM;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">c</span><span class="pc">ou</span><span class="c">nt</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="c">0</span><span class="pc">)</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>

	<span class="w">n</span> <span class="c">=</span> <span class="w">simple_strtoul</span><span class="c">(</span><span class="w">b</span><span class="c">uf,</span> <span class="w">N</span><span class="c">ULL</span><span class="pc">,</span> <span class="pc">0</span><span class="c">);</span>

	<span class="w">s</span><span class="pc">w</span><span class="c">itch</span> <span class="c">(</span><span class="w">n</span><span class="c">) {</span>
	<span class="c">case</span> <span class="pc">1</span><span class="c">:</span>
		<span class="w">tio_corelet_reset</span><span class="pc">(</span><span class="w">cx_dev-</span><span class="pc">&gt;</span><span class="w">cx_id</span><span class="pc">.</span><span class="w">nasid</span><span class="c">,</span> <span class="w">TIOCX_CORELET</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">tiocx_reload</span><span class="c">(</span><span class="pc">cx_d</span><span class="c">ev</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="c">case</span> <span class="w">2</span><span class="c">:</span>
		<span class="w">t</span><span class="c">iocx_reload(cx_dev);</span>
		<span class="c">break;</span>
	<span class="c">case</span> <span class="w">3</span><span class="c">:</span>
		<span class="w">t</span><span class="pc">io_</span><span class="c">corelet_reset(cx_dev</span><span class="pc">-</span><span class="c">&gt;cx_id</span><span class="pc">.n</span><span class="c">asid</span><span class="w">,</span> <span class="pc">T</span><span class="c">IOCX_CORELET);</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="pc">d</span><span class="c">efault:</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="c">}</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">co</span><span class="pc">u</span><span class="c">nt;</span>
<span class="c">}</span>

<span class="w">D</span><span class="pc">E</span><span class="c">VICE_ATTR(</span><span class="w">cxdev_control</span><span class="c">,</span> <span class="w">0</span><span class="pc">6</span><span class="c">44,</span> <span class="w">show_cxdev_control</span><span class="c">,</span> <span class="w">store_cxdev_control</span><span class="c">);</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="c">int</span> <span class="c">__init</span> <span class="w">tiocx_init</span><span class="c">(void)</span>
<span class="c">{</span>
	<span class="w">cnodeid_t</span> <span class="w">cnodeid</span><span class="c">;</span>
	<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">found_tiocx_device</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="c">err;</span>

	<span class="w">i</span><span class="pc">f</span> <span class="pc">(!</span><span class="w">ia64_platform_is(</span><span class="pc">"</span><span class="w">sn2")</span><span class="pc">)</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>

	<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bus_register</span><span class="pc">(&amp;</span><span class="w">tiocx_bus_type</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(err</span><span class="pc">)</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="c">err;</span>

	<span class="w">f</span><span class="c">or</span> <span class="c">(</span><span class="w">cn</span><span class="pc">odeid</span> <span class="c">=</span> <span class="c">0;</span> <span class="w">c</span><span class="pc">nodeid</span> <span class="c">&lt;</span> <span class="w">num_cnodes</span><span class="c">;</span> <span class="c">cnodeid++) {</span>
		<span class="w">nasid_t</span> <span class="w">nasid</span><span class="pc">;</span>
		<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">bt</span><span class="c">;</span>

		<span class="w">n</span><span class="pc">asid</span> <span class="c">=</span> <span class="w">cnodeid_to_nasid</span><span class="pc">(</span><span class="w">c</span><span class="c">nodeid</span><span class="pc">)</span><span class="c">;</span>

		<span class="c">if</span> <span class="pc">((</span><span class="w">n</span><span class="pc">asid</span> <span class="w">&amp;</span> <span class="w">0</span><span class="pc">x1</span><span class="w">) </span><span class="pc">&amp;&amp;</span> <span class="w">is_fpga_tio</span><span class="c">(</span><span class="pc">n</span><span class="c">asid</span><span class="w">,</span><span class="pc"> </span><span class="c">&amp;</span><span class="w">bt</span><span class="pc">)) </span><span class="c">{</span>
			<span class="w">s</span><span class="pc">t</span><span class="c">ruct</span> <span class="w">hubdev_info</span> <span class="c">*</span><span class="w">hubdev</span><span class="pc">;</span>
			<span class="pc">s</span><span class="c">truct</span> <span class="w">xwidget_info</span> <span class="c">*</span><span class="w">widgetp</span><span class="c">;</span>

			<span class="w">D</span><span class="c">BG</span><span class="pc">("</span><span class="w">Found</span> <span class="w">TIO</span> <span class="w">a</span><span class="c">t</span> <span class="w">n</span><span class="pc">asid</span> <span class="w">0</span><span class="c">x%x\n",</span> <span class="pc">n</span><span class="c">asid);</span>

			<span class="w">h</span><span class="c">ubdev</span> <span class="pc">=</span>
			    <span class="w">(s</span><span class="c">truct</span> <span class="pc">h</span><span class="c">ubdev_info</span> <span class="w">*)</span><span class="pc">(</span><span class="w">NODEPDA</span><span class="pc">(</span><span class="w">cnodeid)</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">pdinfo</span><span class="c">);</span>

			<span class="w">w</span><span class="c">idgetp</span> <span class="w">=</span><span class="pc"> &amp;hubdev</span><span class="c">-&gt;</span><span class="w">hdi_xwidget_info</span><span class="pc">[</span><span class="w">TIOCX_CORELET</span><span class="c">];</span>

			
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">w</span><span class="c">idgetp-&gt;</span><span class="w">xwi_hwid</span><span class="pc">.</span><span class="w">part_num</span> <span class="pc">==</span> <span class="w">TIO_CE_ASIC_PARTNUM</span><span class="pc">)</span>
				<span class="w">c</span><span class="pc">o</span><span class="c">ntinue;</span>

			<span class="w">tio_corelet_reset</span><span class="c">(</span><span class="w">n</span><span class="c">asid</span><span class="pc">,</span> <span class="w">T</span><span class="pc">IOC</span><span class="c">X_CORELET</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">tio_conveyor_enable</span><span class="c">(</span><span class="pc">n</span><span class="c">asid);</span>

			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">cx_device_register</span>
			    <span class="c">(</span><span class="pc">n</span><span class="c">asid,</span> <span class="w">w</span><span class="c">idgetp-&gt;</span><span class="w">x</span><span class="c">wi_hwid</span><span class="w">.</span><span class="pc">p</span><span class="c">art_num</span><span class="w">,</span>
			     <span class="pc">w</span><span class="c">idgetp-&gt;xwi_hwid.</span><span class="w">mfg_num</span><span class="c">,</span> <span class="w">hubdev</span><span class="pc">,</span> <span class="w">bt) </span><span class="pc">&lt;</span> <span class="c">0)</span>
				<span class="pc">r</span><span class="c">eturn</span> <span class="c">-</span><span class="w">EN</span><span class="pc">X</span><span class="c">IO;</span>
			<span class="w">e</span><span class="c">lse</span>
				<span class="w">found_tiocx_device+</span><span class="c">+;</span>
		<span class="c">}</span>
	<span class="w">}</span>

	
	<span class="w">D</span><span class="pc">B</span><span class="c">G</span><span class="pc">("</span><span class="w">f</span><span class="c">ound_tiocx_device</span><span class="w">=</span><span class="pc"> %d</span><span class="c">\n",</span> <span class="w">f</span><span class="c">ound_tiocx_device</span><span class="pc">)</span><span class="c">;</span>

	<span class="c">return</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">cx_remove_device</span><span class="c">(struct</span> <span class="w">d</span><span class="pc">e</span><span class="c">vice</span> <span class="c">*</span> <span class="c">dev,</span> <span class="w">v</span><span class="c">oid</span> <span class="c">*</span> <span class="c">data)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">cx_dev</span> <span class="c">*</span><span class="pc">c</span><span class="c">x_dev</span> <span class="c">=</span> <span class="w">to_cx_dev</span><span class="c">(dev);</span>
	<span class="w">device_remove_file</span><span class="c">(dev</span><span class="w">,</span><span class="pc"> &amp;</span><span class="w">dev_attr_cxdev_control</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">cx_device_unregister</span><span class="c">(</span><span class="pc">c</span><span class="c">x_dev</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="c">__exit</span> <span class="w">tiocx_exit</span><span class="c">(void)</span>
<span class="c">{</span>
	<span class="w">D</span><span class="pc">B</span><span class="c">G</span><span class="pc">("</span><span class="w">t</span><span class="pc">io</span><span class="c">cx_exit</span><span class="w">\</span><span class="c">n");</span>

	
	<span class="w">bus_for_each_dev</span><span class="pc">(&amp;</span><span class="w">tiocx_bus_type</span><span class="pc">,</span> <span class="pc">N</span><span class="c">ULL</span><span class="pc">,</span> <span class="pc">N</span><span class="c">ULL</span><span class="pc">,</span> <span class="w">cx_remove_device</span><span class="c">);</span>
	<span class="w">bus_unregister</span><span class="pc">(&amp;</span><span class="w">t</span><span class="c">iocx_bus_type);</span>
<span class="c">}</span>

<span class="w">fs_initcall</span><span class="c">(</span><span class="w">tiocx_init</span><span class="c">);</span>
<span class="pc">m</span><span class="c">odule_exit(</span><span class="pc">tiocx_e</span><span class="c">xit);</span>


<span class="c">MODULE_LICENSE("GPL");</span>
<span class="c">MODULE_AUTHOR("</span><span class="w">Bruce</span> <span class="w">Losure</span> <span class="c">&lt;</span><span class="w">blosure</span><span class="c">@</span><span class="w">sgi</span><span class="c">.com&gt;");</span>
<span class="c">MODULE_DESCRIPTION("</span><span class="w">TIOCX</span> <span class="w">mo</span><span class="pc">dule</span><span class="w">"</span><span class="c">);</span>
<span class="w">MODULE_SUPPORTED_DEVICE</span><span class="c">(</span><span class="w">DEVICE_NAME</span><span class="pc">)</span><span class="c">;</span>

</pre>
</body>
</html>

