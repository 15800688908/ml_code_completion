<!DOCTYPE html>
<html>
<head>
<style>
span.c {
    background-color: #CCFFCC;
}
span.pc {
    background-color: #FFEEBB;
}
span.w {
    background-color: #FFCCCC;
}
</style>
</head>
<body>
<pre>


<span class="w">#ifndef</span> <span class="w">OCFS2_JOURNAL_H</span>
<span class="w">#define</span> <span class="w">OCFS2_JOURNAL_H</span>

<span class="w">#include</span> <span class="w">&lt;linux/fs.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/jbd2.h&gt;</span>

<span class="w">enum</span> <span class="w">ocfs2_journal_state</span> <span class="w">{</span>
	<span class="w">OCFS2_JOURNAL_FREE</span> <span class="w">=</span> <span class="w">0,</span>
	<span class="w">OCFS2_JOURNAL_LOADED,</span>
	<span class="w">OCFS2_JOURNAL_IN_SHUTDOWN,</span>
<span class="w">};</span>

<span class="w">struct</span> <span class="w">ocfs2_super;</span>
<span class="w">struct</span> <span class="w">ocfs2_dinode</span><span class="pc">;</span>



<span class="c">struct</span> <span class="w">ocfs2_recovery_map</span> <span class="c">{</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">rm_used</span><span class="c">;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">*rm_entries</span><span class="c">;</span>
<span class="pc">}</span><span class="c">;</span>


<span class="pc">s</span><span class="c">truct</span> <span class="w">ocfs2_journal</span> <span class="c">{</span>
	<span class="pc">e</span><span class="c">num</span> <span class="w">o</span><span class="c">cfs2_journal_state</span>   <span class="w">j_state</span><span class="c">;</span>    

	<span class="w">journal_t</span>                 <span class="w">*j_journal</span><span class="pc">;</span> 
	<span class="pc">s</span><span class="c">truct</span> <span class="w">ino</span><span class="c">de</span>              <span class="c">*</span><span class="w">j_inode</span><span class="c">;</span>   
	<span class="c">struct</span> <span class="w">o</span><span class="pc">cfs2_s</span><span class="c">uper</span>        <span class="c">*</span><span class="w">j_osb</span><span class="c">;</span>     
	<span class="c">struct</span> <span class="w">buf</span><span class="pc">fer_</span><span class="c">head</span>        <span class="c">*</span><span class="w">j_bh</span><span class="c">;</span>      
	<span class="w">a</span><span class="c">tomic_t</span>                  <span class="w">j_num_trans</span><span class="c">;</span> 
	<span class="w">s</span><span class="pc">p</span><span class="c">inlock_t</span>                <span class="w">j_lock</span><span class="c">;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span>             <span class="w">j_trans_id</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">rw_semaphore</span>       <span class="w">j_trans_barrier</span><span class="c">;</span>
	<span class="w">wait_queue_head_t</span>         <span class="w">j_checkpointed</span><span class="c">;</span>

	
	<span class="pc">s</span><span class="c">truct</span> <span class="c">list_head</span>          <span class="w">j_la_cleanups</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">w</span><span class="pc">o</span><span class="c">rk_struct</span>        <span class="w">j_recovery_work</span><span class="c">;</span>
<span class="pc">}</span><span class="c">;</span>

<span class="w">e</span><span class="pc">x</span><span class="c">tern</span> <span class="w">s</span><span class="pc">p</span><span class="c">inlock_t</span> <span class="w">trans_inc_lock</span><span class="c">;</span>


<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="c">inline</span> <span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="c">long</span> <span class="w">ocfs2_inc_trans_id</span><span class="c">(struct</span> <span class="w">ocfs2_journal</span> <span class="c">*</span><span class="w">j</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="w">old_id</span><span class="c">;</span>
	<span class="w">sp</span><span class="pc">in_lock</span><span class="c">(&amp;</span><span class="pc">t</span><span class="c">rans_inc_lock</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">o</span><span class="pc">l</span><span class="c">d_id</span> <span class="w">=</span> <span class="w">j</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">j_trans_id+</span><span class="pc">+</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(unlikely</span><span class="pc">(!</span><span class="w">j-</span><span class="c">&gt;</span><span class="pc">j</span><span class="c">_trans_id</span><span class="pc">))</span>
		<span class="w">j-</span><span class="pc">&gt;</span><span class="w">j</span><span class="c">_trans_id</span> <span class="c">=</span> <span class="pc">1</span><span class="c">;</span>
	<span class="w">s</span><span class="pc">pin_unlock</span><span class="c">(&amp;</span><span class="pc">t</span><span class="c">rans_inc_lock</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">o</span><span class="c">ld_id;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">inline</span> <span class="c">void</span> <span class="w">ocfs2_set_ci_lock_trans</span><span class="c">(struct</span> <span class="w">ocfs2_journal</span> <span class="c">*</span><span class="w">j</span><span class="pc">o</span><span class="c">urnal</span><span class="pc">,</span>
					   <span class="c">struct</span> <span class="w">ocfs2_caching_info</span> <span class="c">*</span><span class="w">ci</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">s</span><span class="pc">p</span><span class="c">in_lock(&amp;trans_inc_lock</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">ci</span><span class="c">-&gt;</span><span class="w">ci_last_trans</span> <span class="c">=</span> <span class="w">j</span><span class="pc">o</span><span class="c">urnal-&gt;</span><span class="w">j</span><span class="c">_trans_id;</span>
	<span class="w">s</span><span class="c">pin_unlock(&amp;trans_inc_lock</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">inline</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">ocfs2_ci_fully_checkpointed</span><span class="c">(struct</span> <span class="c">ocfs2_caching_info</span> <span class="c">*</span><span class="w">c</span><span class="pc">i</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="pc">r</span><span class="c">et;</span>
	<span class="w">s</span><span class="pc">t</span><span class="c">ruct</span> <span class="w">ocfs2_journal</span> <span class="c">*</span><span class="w">j</span><span class="pc">o</span><span class="c">urnal</span> <span class="pc">=</span>
		<span class="w">OCFS2_SB</span><span class="c">(</span><span class="w">ocfs2_metadata_cache_get_super</span><span class="pc">(</span><span class="w">c</span><span class="pc">i</span><span class="w">))-&gt;j</span><span class="pc">o</span><span class="c">urnal</span><span class="w">;</span>

	<span class="w">s</span><span class="pc">p</span><span class="c">in_lock(&amp;trans_inc_lock</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">time_after</span><span class="c">(</span><span class="w">j</span><span class="pc">o</span><span class="c">urnal</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">j_trans_id</span><span class="pc">,</span> <span class="w">c</span><span class="pc">i</span><span class="c">-&gt;</span><span class="w">ci_last_trans</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">sp</span><span class="pc">in_unlock</span><span class="c">(&amp;trans_inc_lock</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">r</span><span class="c">et;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">inl</span><span class="c">ine</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">ocfs2_ci_is_new</span><span class="c">(struct</span> <span class="w">ocfs2_caching_info</span> <span class="c">*</span><span class="w">c</span><span class="c">i)</span>
<span class="c">{</span>
	<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="pc">r</span><span class="c">et</span><span class="pc">;</span>
	<span class="w">s</span><span class="c">truct</span> <span class="w">ocfs2_journal</span> <span class="c">*</span><span class="w">j</span><span class="pc">o</span><span class="c">urnal</span> <span class="pc">=</span>
		<span class="w">OCFS2_SB</span><span class="c">(</span><span class="w">ocfs2_metadata_cache_get_super</span><span class="pc">(</span><span class="w">c</span><span class="pc">i</span><span class="w">))-&gt;j</span><span class="pc">o</span><span class="c">urnal</span><span class="w">;</span>

	<span class="w">sp</span><span class="pc">in_lock</span><span class="c">(&amp;</span><span class="pc">t</span><span class="c">rans_inc_lock</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">r</span><span class="pc">et</span> <span class="w">= !(time_after</span><span class="c">(</span><span class="w">j</span><span class="pc">o</span><span class="c">urnal</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">j_trans_id</span><span class="pc">,</span> <span class="w">ci</span><span class="c">-&gt;</span><span class="w">ci_created_trans)</span><span class="pc">);</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">r</span><span class="pc">et</span><span class="c">)</span>
		<span class="w">ci</span><span class="c">-&gt;</span><span class="pc">c</span><span class="c">i_created_trans</span> <span class="pc">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="w">s</span><span class="c">pin_unlock(&amp;</span><span class="w">t</span><span class="c">rans_inc_lock</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">r</span><span class="c">et;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">inline</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">ocfs2_inode_is_new</span><span class="c">(struct</span> <span class="w">i</span><span class="pc">n</span><span class="c">ode</span> <span class="c">*inode</span><span class="pc">)</span>
<span class="c">{</span>
	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">OCFS2_I</span><span class="pc">(</span><span class="w">i</span><span class="c">node</span><span class="w">)-</span><span class="c">&gt;</span><span class="w">ip_flags</span> <span class="w">&amp;</span> <span class="w">OCFS2_INODE_SYSTEM_FILE</span><span class="c">)</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>

	<span class="c">return</span> <span class="w">ocfs2_ci_is_new</span><span class="c">(</span><span class="w">INODE_CACHE</span><span class="pc">(</span><span class="w">i</span><span class="pc">no</span><span class="c">de</span><span class="pc">))</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">inline</span> <span class="c">void</span> <span class="w">ocfs2_ci_set_new</span><span class="c">(struct</span> <span class="w">ocfs2_super</span> <span class="c">*</span><span class="w">os</span><span class="c">b</span><span class="pc">,</span>
				    <span class="c">struct</span> <span class="w">ocfs2_caching_info</span> <span class="c">*</span><span class="w">ci</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">s</span><span class="pc">p</span><span class="c">in_lock(&amp;</span><span class="w">trans_inc_lock</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">ci</span><span class="c">-&gt;</span><span class="w">ci_created_trans</span> <span class="c">=</span> <span class="w">os</span><span class="c">b-&gt;</span><span class="w">j</span><span class="pc">o</span><span class="c">urnal</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">j_trans_id</span><span class="c">;</span>
	<span class="w">s</span><span class="pc">p</span><span class="c">in_unlock(&amp;</span><span class="w">t</span><span class="c">rans_inc_lock</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>


<span class="w">v</span><span class="c">oid</span> <span class="w">ocfs2_orphan_scan_init</span><span class="c">(struct</span> <span class="c">ocfs2_super</span> <span class="c">*</span><span class="w">os</span><span class="c">b</span><span class="pc">);</span>
<span class="c">void</span> <span class="w">ocfs2_orphan_scan_start</span><span class="c">(struct</span> <span class="c">ocfs2_super</span> <span class="c">*</span><span class="w">os</span><span class="c">b);</span>
<span class="c">void</span> <span class="w">ocfs2_orphan_scan_stop</span><span class="c">(struct</span> <span class="c">ocfs2_super</span> <span class="c">*</span><span class="w">os</span><span class="c">b);</span>
<span class="c">void</span> <span class="w">ocfs2_orphan_scan_exit</span><span class="c">(struct</span> <span class="c">ocfs2_super</span> <span class="c">*</span><span class="w">os</span><span class="c">b);</span>

<span class="c">void</span> <span class="w">ocfs2_complete_recovery</span><span class="c">(struct</span> <span class="pc">w</span><span class="c">ork_struct</span> <span class="c">*work);</span>
<span class="c">void</span> <span class="w">ocfs2_wait_for_recovery</span><span class="c">(struct</span> <span class="c">ocfs2_super</span> <span class="c">*</span><span class="w">os</span><span class="c">b);</span>

<span class="pc">i</span><span class="c">nt</span> <span class="w">ocfs2_recovery_init</span><span class="c">(struct</span> <span class="c">ocfs2_super</span> <span class="c">*</span><span class="w">os</span><span class="c">b);</span>
<span class="c">void</span> <span class="w">ocfs2_recovery_exit</span><span class="c">(struct</span> <span class="c">ocfs2_super</span> <span class="c">*</span><span class="w">os</span><span class="c">b);</span>

<span class="pc">i</span><span class="c">nt</span> <span class="w">ocfs2_compute_replay_slots</span><span class="c">(struct</span> <span class="c">ocfs2_super</span> <span class="c">*</span><span class="w">os</span><span class="c">b);</span>

<span class="pc">v</span><span class="c">oid</span>   <span class="w">ocfs2_set_journal_params</span><span class="c">(struct</span> <span class="c">ocfs2_super</span> <span class="c">*</span><span class="w">os</span><span class="c">b);</span>
<span class="c">int</span>    <span class="w">ocfs2_journal_init</span><span class="c">(struct</span> <span class="w">ocfs2_journal</span> <span class="c">*</span><span class="w">j</span><span class="pc">o</span><span class="c">urnal</span><span class="pc">,</span>
			  <span class="c">int</span> <span class="pc">*</span><span class="w">dir</span><span class="pc">t</span><span class="c">y);</span>
<span class="c">void</span>   <span class="w">ocfs2_journal_shutdown</span><span class="c">(struct</span> <span class="c">ocfs2_super</span> <span class="c">*</span><span class="w">os</span><span class="c">b);</span>
<span class="c">int</span>    <span class="w">ocfs2_journal_wipe</span><span class="c">(struct</span> <span class="pc">ocfs2_j</span><span class="c">ournal</span> <span class="c">*</span><span class="w">j</span><span class="pc">o</span><span class="c">urnal,</span>
			  <span class="c">int</span> <span class="w">fu</span><span class="pc">l</span><span class="c">l</span><span class="pc">)</span><span class="c">;</span>
<span class="c">int</span>    <span class="w">ocfs2_journal_load</span><span class="c">(struct</span> <span class="c">ocfs2_journal</span> <span class="c">*</span><span class="w">j</span><span class="pc">o</span><span class="c">urnal,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">lo</span><span class="pc">ca</span><span class="c">l,</span>
			  <span class="c">int</span> <span class="w">replayed</span><span class="c">);</span>
<span class="c">int</span>    <span class="w">ocfs2_check_journals_nolocks</span><span class="c">(struct</span> <span class="pc">ocfs2_s</span><span class="c">uper</span> <span class="c">*</span><span class="w">os</span><span class="c">b</span><span class="pc">)</span><span class="c">;</span>
<span class="pc">v</span><span class="c">oid</span>   <span class="w">ocfs2_recovery_thread</span><span class="c">(struct</span> <span class="pc">ocfs2_s</span><span class="c">uper</span> <span class="c">*</span><span class="w">os</span><span class="c">b</span><span class="pc">,</span>
			     <span class="c">int</span> <span class="w">node_num</span><span class="c">);</span>
<span class="c">int</span>    <span class="w">ocfs2_mark_dead_nodes</span><span class="c">(struct</span> <span class="c">ocfs2_super</span> <span class="c">*</span><span class="w">os</span><span class="c">b</span><span class="pc">)</span><span class="c">;</span>
<span class="pc">v</span><span class="c">oid</span>   <span class="w">ocfs2_complete_mount_recovery</span><span class="c">(struct</span> <span class="c">ocfs2_super</span> <span class="c">*</span><span class="w">os</span><span class="c">b);</span>
<span class="pc">v</span><span class="c">oid</span> <span class="w">ocfs2_complete_quota_recovery</span><span class="c">(struct</span> <span class="c">ocfs2_super</span> <span class="c">*</span><span class="w">os</span><span class="c">b);</span>

<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="c">inline</span> <span class="c">void</span> <span class="w">ocfs2_start_checkpoint</span><span class="c">(struct</span> <span class="c">ocfs2_super</span> <span class="c">*</span><span class="w">os</span><span class="c">b</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">wake_up</span><span class="pc">(&amp;</span><span class="w">os</span><span class="c">b-&gt;</span><span class="w">checkpoint_event</span><span class="c">);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">inline</span> <span class="c">void</span> <span class="w">ocfs2_checkpoint_inode</span><span class="c">(struct</span> <span class="w">i</span><span class="pc">n</span><span class="c">ode</span> <span class="c">*inode</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="pc">o</span><span class="c">cfs2_super</span> <span class="c">*</span><span class="w">os</span><span class="c">b</span> <span class="c">=</span> <span class="w">OCFS2_SB</span><span class="c">(</span><span class="w">i</span><span class="c">node-&gt;</span><span class="w">i_</span><span class="pc">s</span><span class="c">b);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">ocfs2_mount_local</span><span class="c">(</span><span class="w">os</span><span class="c">b</span><span class="pc">))</span>
		<span class="c">return</span><span class="w">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">ocfs2_ci_fully_checkpointed</span><span class="c">(</span><span class="w">INODE_CACHE(ino</span><span class="c">de</span><span class="w">))</span><span class="pc">) </span><span class="c">{</span>
		
		<span class="w">ocfs2_start_checkpoint</span><span class="c">(</span><span class="w">os</span><span class="c">b);</span>

		<span class="w">wait_event</span><span class="c">(</span><span class="w">os</span><span class="c">b</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">j</span><span class="pc">o</span><span class="c">urnal-&gt;</span><span class="w">j_checkpointed</span><span class="pc">,</span>
			   <span class="w">o</span><span class="pc">cfs2_c</span><span class="c">i_fully_checkpointed</span><span class="pc">(I</span><span class="c">NODE_CACHE</span><span class="w">(ino</span><span class="c">de</span><span class="w">))</span><span class="pc">);</span>
	<span class="c">}</span>
<span class="pc">}</span>




<span class="w">handle_t</span>		    <span class="w">*ocfs2_start_trans</span><span class="c">(struct</span> <span class="w">ocfs2_super</span> <span class="c">*</span><span class="w">os</span><span class="c">b</span><span class="pc">,</span>
					       <span class="pc">i</span><span class="c">nt</span> <span class="w">max_buffs</span><span class="pc">);</span>
<span class="c">int</span>			     <span class="w">ocfs2_commit_trans</span><span class="c">(struct</span> <span class="pc">o</span><span class="c">cfs2_super</span> <span class="c">*</span><span class="w">os</span><span class="c">b,</span>
						<span class="w">h</span><span class="c">andle_t</span> <span class="pc">*</span><span class="w">h</span><span class="pc">andle</span><span class="c">);</span>
<span class="c">int</span>			     <span class="w">ocfs2_extend_trans</span><span class="c">(</span><span class="w">h</span><span class="c">andle_t</span> <span class="pc">*</span><span class="w">h</span><span class="pc">andle,</span> <span class="c">int</span> <span class="w">nblocks</span><span class="pc">)</span><span class="c">;</span>
<span class="c">int</span>			     <span class="w">ocfs2_allocate_extend_trans</span><span class="c">(</span><span class="w">h</span><span class="c">andle_t</span> <span class="pc">*</span><span class="w">h</span><span class="pc">andle,</span>
						<span class="c">int</span> <span class="w">thresh</span><span class="pc">)</span><span class="c">;</span>


<span class="pc">#</span><span class="c">define</span> <span class="w">OCFS2_MAX_TRANS_DATA</span>	<span class="w">64U</span>


<span class="pc">#</span><span class="c">define</span> <span class="w">OCFS2_JOURNAL_ACCESS_CREATE</span> <span class="c">0</span>
<span class="c">#define</span> <span class="w">OCFS2_JOURNAL_ACCESS_WRITE</span>  <span class="c">1</span>
<span class="c">#define</span> <span class="w">OCFS2_JOURNAL_ACCESS_UNDO</span>   <span class="c">2</span>



<span class="pc">i</span><span class="c">nt</span> <span class="w">ocfs2_journal_access_di</span><span class="c">(</span><span class="w">h</span><span class="c">andle_t</span> <span class="w">*h</span><span class="pc">andle</span><span class="c">,</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">ocfs2_caching_info</span> <span class="c">*</span><span class="w">ci</span><span class="c">,</span>
			    <span class="c">struct</span> <span class="w">buff</span><span class="pc">er_</span><span class="c">head</span> <span class="c">*</span><span class="w">bh</span><span class="c">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">t</span><span class="pc">y</span><span class="c">pe</span><span class="pc">)</span><span class="c">;</span>

<span class="c">int</span> <span class="w">ocfs2_journal_access_eb</span><span class="c">(</span><span class="w">h</span><span class="c">andle_t</span> <span class="pc">*</span><span class="w">h</span><span class="pc">andle</span><span class="c">,</span> <span class="c">struct</span> <span class="pc">ocfs2_c</span><span class="c">aching_info</span> <span class="c">*</span><span class="w">ci</span><span class="pc">,</span>
			    <span class="pc">s</span><span class="c">truct</span> <span class="w">bu</span><span class="pc">ff</span><span class="c">er_head</span> <span class="c">*</span><span class="w">b</span><span class="c">h</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">t</span><span class="pc">y</span><span class="c">pe</span><span class="pc">)</span><span class="c">;</span>

<span class="c">int</span> <span class="w">ocfs2_journal_access_rb</span><span class="c">(</span><span class="pc">h</span><span class="c">andle_t</span> <span class="pc">*</span><span class="w">h</span><span class="pc">andle</span><span class="c">,</span> <span class="c">struct</span> <span class="c">ocfs2_caching_info</span> <span class="c">*</span><span class="w">ci</span><span class="pc">,</span>
			    <span class="c">struct</span> <span class="w">b</span><span class="pc">u</span><span class="c">ffer_head</span> <span class="c">*</span><span class="pc">b</span><span class="c">h,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">t</span><span class="pc">y</span><span class="c">pe</span><span class="pc">)</span><span class="c">;</span>

<span class="c">int</span> <span class="w">ocfs2_journal_access_gd</span><span class="c">(</span><span class="pc">h</span><span class="c">andle_t</span> <span class="pc">*</span><span class="w">h</span><span class="pc">andle</span><span class="c">,</span> <span class="c">struct</span> <span class="c">ocfs2_caching_info</span> <span class="c">*</span><span class="w">ci</span><span class="pc">,</span>
			    <span class="c">struct</span> <span class="w">b</span><span class="pc">u</span><span class="c">ffer_head</span> <span class="c">*</span><span class="pc">b</span><span class="c">h,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">t</span><span class="pc">y</span><span class="c">pe</span><span class="pc">)</span><span class="c">;</span>

<span class="c">int</span> <span class="w">ocfs2_journal_access_xb</span><span class="c">(</span><span class="pc">h</span><span class="c">andle_t</span> <span class="pc">*</span><span class="w">h</span><span class="pc">andle</span><span class="c">,</span> <span class="c">struct</span> <span class="c">ocfs2_caching_info</span> <span class="c">*</span><span class="w">ci</span><span class="pc">,</span>
			    <span class="c">struct</span> <span class="w">b</span><span class="pc">u</span><span class="c">ffer_head</span> <span class="c">*</span><span class="pc">b</span><span class="c">h,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">t</span><span class="pc">y</span><span class="c">pe</span><span class="pc">)</span><span class="c">;</span>

<span class="c">int</span> <span class="w">ocfs2_journal_access_dq</span><span class="c">(</span><span class="pc">h</span><span class="c">andle_t</span> <span class="pc">*</span><span class="w">h</span><span class="pc">andle</span><span class="c">,</span> <span class="c">struct</span> <span class="c">ocfs2_caching_info</span> <span class="c">*</span><span class="w">ci</span><span class="pc">,</span>
			    <span class="c">struct</span> <span class="w">b</span><span class="pc">u</span><span class="c">ffer_head</span> <span class="c">*</span><span class="pc">b</span><span class="c">h,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">t</span><span class="pc">y</span><span class="c">pe</span><span class="pc">)</span><span class="c">;</span>

<span class="c">int</span> <span class="w">ocfs2_journal_access_db</span><span class="c">(</span><span class="pc">h</span><span class="c">andle_t</span> <span class="pc">*</span><span class="w">h</span><span class="pc">andle</span><span class="c">,</span> <span class="c">struct</span> <span class="c">ocfs2_caching_info</span> <span class="c">*</span><span class="w">ci</span><span class="pc">,</span>
			    <span class="c">struct</span> <span class="w">b</span><span class="pc">u</span><span class="c">ffer_head</span> <span class="c">*</span><span class="pc">b</span><span class="c">h,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">t</span><span class="pc">y</span><span class="c">pe</span><span class="pc">)</span><span class="c">;</span>

<span class="c">int</span> <span class="w">ocfs2_journal_access_dr</span><span class="c">(</span><span class="pc">h</span><span class="c">andle_t</span> <span class="pc">*</span><span class="w">h</span><span class="pc">andle</span><span class="c">,</span> <span class="c">struct</span> <span class="c">ocfs2_caching_info</span> <span class="c">*</span><span class="w">ci</span><span class="pc">,</span>
			    <span class="c">struct</span> <span class="w">b</span><span class="pc">u</span><span class="c">ffer_head</span> <span class="c">*</span><span class="pc">b</span><span class="c">h,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">t</span><span class="pc">y</span><span class="c">pe</span><span class="pc">)</span><span class="c">;</span>

<span class="c">int</span> <span class="w">ocfs2_journal_access_dl</span><span class="c">(</span><span class="pc">h</span><span class="c">andle_t</span> <span class="pc">*</span><span class="w">h</span><span class="pc">andle</span><span class="c">,</span> <span class="c">struct</span> <span class="c">ocfs2_caching_info</span> <span class="c">*</span><span class="w">ci</span><span class="pc">,</span>
			    <span class="c">struct</span> <span class="w">b</span><span class="pc">u</span><span class="c">ffer_head</span> <span class="c">*</span><span class="pc">b</span><span class="c">h,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">t</span><span class="pc">y</span><span class="c">pe</span><span class="pc">)</span><span class="c">;</span>

<span class="c">int</span> <span class="w">ocfs2_journal_access</span><span class="c">(</span><span class="pc">h</span><span class="c">andle_t</span> <span class="pc">*</span><span class="w">h</span><span class="pc">andle</span><span class="c">,</span> <span class="c">struct</span> <span class="c">ocfs2_caching_info</span> <span class="c">*</span><span class="w">ci</span><span class="pc">,</span>
			 <span class="c">struct</span> <span class="w">b</span><span class="pc">u</span><span class="c">ffer_head</span> <span class="c">*</span><span class="pc">b</span><span class="c">h,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">t</span><span class="pc">y</span><span class="c">pe</span><span class="pc">)</span><span class="c">;</span>


<span class="pc">v</span><span class="c">oid</span> <span class="w">ocfs2_journal_dirty</span><span class="c">(</span><span class="pc">h</span><span class="c">andle_t</span> <span class="pc">*</span><span class="w">h</span><span class="pc">andle,</span> <span class="c">struct</span> <span class="w">b</span><span class="pc">uff</span><span class="c">er_head</span> <span class="c">*</span><span class="w">bh</span><span class="c">);</span>




<span class="pc">#d</span><span class="c">efine</span> <span class="w">OCFS2_INODE_UPDATE_CREDITS</span> <span class="pc">1</span>


<span class="c">#define</span> <span class="w">OCFS2_XATTR_BLOCK_UPDATE_CREDITS</span> <span class="pc">1</span>


<span class="c">#define</span> <span class="w">OCFS2_QUOTA_BLOCK_UPDATE_CREDITS</span> <span class="pc">1</span>


<span class="c">#define</span> <span class="w">OCFS2_QINFO_WRITE_CREDITS</span> <span class="pc">(</span><span class="w">O</span><span class="pc">CFS2_I</span><span class="c">NODE_UPDATE_CREDITS</span> <span class="w">+ \</span>
				   <span class="pc">O</span><span class="c">CFS2_QUOTA_BLOCK_UPDATE_CREDITS)</span>

<span class="c">#define</span> <span class="w">OCFS2_LOCAL_QINFO_WRITE_CREDITS</span> <span class="w">O</span><span class="pc">CFS2_QU</span><span class="c">OTA_BLOCK_UPDATE_CREDITS</span>



<span class="c">#define</span> <span class="w">OCFS2_QWRITE_CREDITS</span> <span class="c">(</span><span class="w">O</span><span class="pc">CFS2_QI</span><span class="c">NFO_WRITE_CREDITS</span> <span class="w">+</span><span class="c"> \</span>
			      <span class="pc">OCFS2_Q</span><span class="c">UOTA_BLOCK_UPDATE_CREDITS)</span>


<span class="c">#define</span> <span class="w">OCFS2_QSYNC_CREDITS</span> <span class="c">(</span><span class="w">O</span><span class="pc">CFS2_QI</span><span class="c">NFO_WRITE_CREDITS</span> <span class="w">+</span><span class="pc"> </span><span class="c">\</span>
			     <span class="w">2</span> <span class="w">*</span> <span class="pc">OCFS2_QU</span><span class="c">OTA_BLOCK_UPDATE_CREDITS)</span>

<span class="pc">sta</span><span class="c">tic</span> <span class="c">inline</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">ocfs2_quota_trans_credits</span><span class="c">(struct</span> <span class="w">s</span><span class="pc">u</span><span class="c">per_block</span> <span class="c">*</span><span class="w">s</span><span class="pc">b)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">credits</span> <span class="pc">=</span> <span class="c">0;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">OCFS2_HAS_RO_COMPAT_FEATURE</span><span class="c">(</span><span class="w">sb</span><span class="pc">,</span> <span class="w">OCFS2_FEATURE_RO_COMPAT_USRQUOTA</span><span class="pc">))</span>
		<span class="pc">c</span><span class="c">redits</span> <span class="w">+</span><span class="c">=</span> <span class="w">OCFS2_QWRITE_CREDITS</span><span class="pc">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">OCFS2_H</span><span class="c">AS_RO_COMPAT_FEATURE</span><span class="pc">(</span><span class="w">sb</span><span class="pc">,</span> <span class="w">OCFS2_FEATURE_RO_COMPAT_GRPQUOTA</span><span class="pc">)</span><span class="c">)</span>
		<span class="pc">c</span><span class="c">redits</span> <span class="w">+</span><span class="c">=</span> <span class="w">O</span><span class="pc">CFS2_QW</span><span class="c">RITE_CREDITS;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">c</span><span class="c">redits;</span>
<span class="c">}</span>


<span class="pc">#d</span><span class="c">efine</span> <span class="w">OCFS2_GROUP_EXTEND_CREDITS</span>	<span class="c">(</span><span class="w">OCFS2_INODE_UPDATE_CREDITS</span> <span class="pc">+</span> <span class="c">1)</span>


<span class="c">#define</span> <span class="w">OCFS2_GROUP_ADD_CREDITS</span>	<span class="c">(</span><span class="w">O</span><span class="pc">CFS2_I</span><span class="c">NODE_UPDATE_CREDITS</span> <span class="c">+</span> <span class="c">1)</span>


<span class="c">#define</span> <span class="w">OCFS2_SUBALLOC_ALLOC</span> <span class="c">(</span><span class="w">3</span><span class="pc">)</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="c">inline</span> <span class="c">int</span> <span class="w">ocfs2_inline_to_extents_credits</span><span class="c">(struct</span> <span class="w">su</span><span class="c">per_block</span> <span class="c">*</span><span class="w">s</span><span class="c">b)</span>
<span class="c">{</span>
	<span class="c">return</span> <span class="w">O</span><span class="pc">CFS2_S</span><span class="c">UBALLOC_ALLOC</span> <span class="w">+</span> <span class="c">OCFS2_INODE_UPDATE_CREDITS</span> <span class="pc">+</span>
	       <span class="w">ocfs2_quota_trans_credits</span><span class="c">(</span><span class="w">sb</span><span class="c">);</span>
<span class="c">}</span>


<span class="pc">#</span><span class="c">define</span> <span class="w">OCFS2_SUBALLOC_FREE</span>  <span class="c">(</span><span class="w">2</span><span class="c">)</span>

<span class="c">#define</span> <span class="w">OCFS2_TRUNCATE_LOG_UPDATE</span> <span class="pc">O</span><span class="c">CFS2_INODE_UPDATE_CREDITS</span>
<span class="pc">#</span><span class="c">define</span> <span class="w">OCFS2_TRUNCATE_LOG_FLUSH_ONE_REC</span> <span class="c">(</span><span class="w">O</span><span class="pc">CFS2_S</span><span class="c">UBALLOC_FREE</span> 		      <span class="w">\</span>
					 <span class="w">+</span> <span class="w">O</span><span class="pc">CFS2_T</span><span class="c">RUNCATE_LOG_UPDATE</span><span class="pc">)</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="c">inline</span> <span class="c">int</span> <span class="w">ocfs2_remove_extent_credits</span><span class="c">(struct</span> <span class="w">su</span><span class="c">per_block</span> <span class="c">*</span><span class="w">s</span><span class="pc">b)</span>
<span class="c">{</span>
	<span class="c">return</span> <span class="w">O</span><span class="pc">CFS2_T</span><span class="c">RUNCATE_LOG_UPDATE</span> <span class="w">+</span> <span class="c">OCFS2_INODE_UPDATE_CREDITS</span> <span class="w">+</span>
	       <span class="pc">o</span><span class="c">cfs2_quota_trans_credits(</span><span class="w">sb</span><span class="c">);</span>
<span class="c">}</span>


<span class="pc">#</span><span class="c">define</span> <span class="w">OCFS2_DIR_LINK_ADDITIONAL_CREDITS</span> <span class="c">(</span><span class="w">1</span> <span class="w">+</span> <span class="w">OCFS2_SUBALLOC_ALLOC</span> <span class="w">+</span> <span class="c">1)</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="c">inline</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">ocfs2_add_dir_index_credits</span><span class="c">(struct</span> <span class="w">su</span><span class="c">per_block</span> <span class="c">*</span><span class="w">s</span><span class="c">b)</span>
<span class="c">{</span>
	
	<span class="c">return</span> <span class="w">1</span> <span class="w">+</span> <span class="w">2</span> <span class="w">*</span> <span class="w">O</span><span class="pc">CFS2_S</span><span class="c">UBALLOC_ALLOC</span> <span class="w">+</span>
		<span class="w">ocfs2_clusters_to_blocks</span><span class="c">(</span><span class="w">sb</span><span class="pc">,</span> <span class="pc">1</span><span class="c">);</span>
<span class="pc">}</span>


<span class="c">static</span> <span class="c">inline</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">ocfs2_mknod_credits</span><span class="c">(struct</span> <span class="w">su</span><span class="c">per_block</span> <span class="c">*</span><span class="w">s</span><span class="pc">b</span><span class="c">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">is_dir</span><span class="c">,</span>
				      <span class="c">int</span> <span class="w">xattr_credits</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">dir_credits</span> <span class="c">=</span> <span class="w">OCFS2_DIR_LINK_ADDITIONAL_CREDITS</span><span class="pc">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="pc">i</span><span class="c">s_dir</span><span class="pc">)</span>
		<span class="w">d</span><span class="c">ir_credits</span> <span class="w">+</span><span class="c">=</span> <span class="w">ocfs2_add_dir_index_credits</span><span class="pc">(</span><span class="w">sb</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">4</span> <span class="w">+</span> <span class="w">OCFS2_SUBALLOC_ALLOC</span> <span class="w">+</span> <span class="w">d</span><span class="c">ir_credits</span> <span class="w">+</span> <span class="pc">x</span><span class="c">attr_credits</span> <span class="w">+</span>
	       <span class="w">ocfs2_quota_trans_credits</span><span class="pc">(</span><span class="w">sb</span><span class="c">);</span>
<span class="c">}</span>


<span class="pc">#d</span><span class="c">efine</span> <span class="w">OCFS2_WINDOW_MOVE_CREDITS</span> <span class="c">(</span><span class="w">OCFS2_INODE_UPDATE_CREDITS</span>                 <span class="w">\</span>
				  <span class="w">+</span> <span class="w">O</span><span class="c">CFS2_SUBALLOC_ALLOC</span> <span class="pc">+</span> <span class="w">OCFS2_SUBALLOC_FREE</span><span class="c">)</span>


<span class="c">#define</span> <span class="w">OCFS2_SIMPLE_DIR_EXTEND_CREDITS</span> <span class="c">(</span><span class="w">2</span><span class="pc">)</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="c">inline</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">ocfs2_link_credits</span><span class="c">(struct</span> <span class="w">s</span><span class="pc">u</span><span class="c">per_block</span> <span class="c">*</span><span class="w">s</span><span class="pc">b</span><span class="c">)</span>
<span class="c">{</span>
	<span class="c">return</span> <span class="w">2</span><span class="pc">*</span><span class="c">OCFS2_INODE_UPDATE_CREDITS</span> <span class="w">+</span> <span class="pc">4</span> <span class="w">+</span>
	       <span class="w">o</span><span class="c">cfs2_quota_trans_credits(</span><span class="w">sb</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">inline</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">ocfs2_unlink_credits</span><span class="c">(struct</span> <span class="w">su</span><span class="c">per_block</span> <span class="c">*</span><span class="w">sb</span><span class="pc">)</span>
<span class="c">{</span>
	
	<span class="c">return</span> <span class="w">2</span> <span class="pc">*</span> <span class="c">OCFS2_INODE_UPDATE_CREDITS</span> <span class="w">+</span> <span class="pc">3</span> <span class="w">+</span> <span class="w">o</span><span class="pc">cfs2_l</span><span class="c">ink_credits</span><span class="w">(sb</span><span class="pc">);</span>
<span class="pc">}</span>


<span class="pc">#</span><span class="c">define</span> <span class="w">OCFS2_DELETE_INODE_CREDITS</span> <span class="c">(</span><span class="w">3</span> <span class="pc">*</span> <span class="pc">O</span><span class="c">CFS2_INODE_UPDATE_CREDITS</span> <span class="pc">+</span> <span class="pc">4)</span>


<span class="c">#define</span> <span class="w">OCFS2_INODE_ADD_TO_ORPHAN_CREDITS</span>  <span class="c">(</span><span class="w">2</span> <span class="pc">*</span> <span class="pc">O</span><span class="c">CFS2_INODE_UPDATE_CREDITS</span> <span class="pc">+</span> <span class="pc">4</span><span class="c">)</span>
<span class="c">#define</span> <span class="w">OCFS2_INODE_DEL_FROM_ORPHAN_CREDITS</span>  <span class="w">O</span><span class="pc">CFS2_INODE_A</span><span class="c">DD_TO_ORPHAN_CREDITS</span>


<span class="w">s</span><span class="c">tatic</span> <span class="c">inline</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">ocfs2_rename_credits</span><span class="c">(struct</span> <span class="w">su</span><span class="c">per_block</span> <span class="c">*</span><span class="w">s</span><span class="pc">b</span><span class="c">)</span>
<span class="c">{</span>
	<span class="c">return</span> <span class="w">3</span> <span class="pc">*</span> <span class="c">OCFS2_INODE_UPDATE_CREDITS</span> <span class="w">+</span> <span class="w">6</span> <span class="w">+</span> <span class="w">ocfs2_unlink_credits</span><span class="c">(</span><span class="w">sb</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>


<span class="pc">#</span><span class="c">define</span> <span class="w">OCFS2_XATTR_BLOCK_CREATE_CREDITS</span> <span class="c">(</span><span class="w">OCFS2_SUBALLOC_ALLOC</span> <span class="w">*</span> <span class="w">2</span> <span class="w">+ \</span>
					  <span class="w">+</span> <span class="pc">OCFS2_I</span><span class="c">NODE_UPDATE_CREDITS</span> <span class="w">\</span>
					  <span class="w">+</span> <span class="w">OCFS2_XATTR_BLOCK_UPDATE_CREDITS</span><span class="pc">)</span>


<span class="c">#define</span> <span class="w">OCFS2_DX_ROOT_REMOVE_CREDITS</span> <span class="c">(</span><span class="pc">OCFS2_I</span><span class="c">NODE_UPDATE_CREDITS</span> <span class="w">+	\</span>
				      <span class="w">OCFS2_SUBALLOC_FREE</span><span class="pc">)</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="c">inline</span> <span class="c">int</span> <span class="w">ocfs2_calc_dxi_expand_credits</span><span class="c">(</span><span class="pc">s</span><span class="c">truct</span> <span class="w">su</span><span class="pc">p</span><span class="c">er_block</span> <span class="c">*</span><span class="w">s</span><span class="c">b)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">credits</span> <span class="pc">=</span> <span class="w">1</span> <span class="w">+</span> <span class="w">O</span><span class="pc">CFS2_SUBALLOC_A</span><span class="c">LLOC;</span>

	<span class="w">c</span><span class="pc">r</span><span class="c">edits</span> <span class="w">+</span><span class="pc">=</span> <span class="w">ocfs2_clusters_to_blocks</span><span class="pc">(</span><span class="w">sb</span><span class="pc">,</span> <span class="w">1</span><span class="c">);</span>
	<span class="pc">c</span><span class="c">redits</span> <span class="w">+</span><span class="c">=</span> <span class="w">ocfs2_quota_trans_credits</span><span class="c">(</span><span class="w">sb</span><span class="c">);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">c</span><span class="c">redits</span><span class="pc">;</span>
<span class="c">}</span>


<span class="pc">#d</span><span class="c">efine</span> <span class="w">OCFS2_REFCOUNT_TREE_CREATE_CREDITS</span> <span class="c">(</span><span class="w">OCFS2_INODE_UPDATE_CREDITS</span> <span class="pc">+</span> <span class="c">1</span> <span class="w">\</span>
					    <span class="w">+</span> <span class="w">O</span><span class="pc">CFS2_S</span><span class="c">UBALLOC_ALLOC</span><span class="pc">)</span>


<span class="c">#define</span> <span class="w">OCFS2_REFCOUNT_TREE_SET_CREDITS</span> <span class="c">(</span><span class="w">O</span><span class="pc">CFS2_I</span><span class="c">NODE_UPDATE_CREDITS</span> <span class="pc">+</span> <span class="c">1)</span>


<span class="c">#define</span> <span class="w">OCFS2_REFCOUNT_TREE_REMOVE_CREDITS</span> <span class="c">(</span><span class="w">O</span><span class="pc">CFS2_I</span><span class="c">NODE_UPDATE_CREDITS</span> <span class="pc">+</span> <span class="c">1)</span>


<span class="c">#define</span> <span class="w">OCFS2_EXPAND_REFCOUNT_TREE_CREDITS</span> <span class="c">(</span><span class="w">O</span><span class="pc">CFS2_S</span><span class="c">UBALLOC_ALLOC</span> <span class="w">*</span> <span class="w">2</span> <span class="w">+</span> <span class="w">3</span><span class="c">)</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="pc">inl</span><span class="c">ine</span> <span class="c">int</span> <span class="w">ocfs2_calc_extend_credits</span><span class="c">(struct</span> <span class="w">su</span><span class="c">per_block</span> <span class="c">*</span><span class="w">sb</span><span class="pc">,</span>
					    <span class="c">struct</span> <span class="w">ocfs2_extent_list</span> <span class="c">*</span><span class="w">root_el</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">bitmap_blocks</span><span class="pc">,</span> <span class="w">sysfile_bitmap_blocks,</span> <span class="w">extent_blocks;</span>

	
	<span class="w">b</span><span class="c">itmap_blocks</span> <span class="pc">=</span> <span class="pc">OCFS2_S</span><span class="c">UBALLOC_ALLOC</span><span class="pc">;</span>

	
	<span class="w">s</span><span class="c">ysfile_bitmap_blocks</span> <span class="c">=</span> <span class="w">1</span> <span class="w">+</span>
		<span class="w">(</span><span class="pc">OCFS2_S</span><span class="c">UBALLOC_ALLOC</span> <span class="w">-</span> <span class="c">1</span><span class="w">)</span><span class="pc"> </span><span class="c">*</span> <span class="w">ocfs2_extend_meta_needed</span><span class="pc">(</span><span class="w">r</span><span class="c">oot_el</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="w">e</span><span class="pc">xten</span><span class="c">t_blocks</span> <span class="pc">=</span> <span class="w">1</span> <span class="w">+</span> <span class="c">1</span> <span class="w">+</span> <span class="w">le1</span><span class="c">6_to_cpu(</span><span class="w">r</span><span class="c">oot_el-&gt;</span><span class="w">l_tree_depth</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">b</span><span class="c">itmap_blocks</span> <span class="pc">+</span> <span class="c">sysfile_bitmap_blocks</span> <span class="pc">+</span> <span class="c">extent_blocks</span> <span class="pc">+</span>
	       <span class="w">ocfs2_quota_trans_credits</span><span class="pc">(</span><span class="w">sb</span><span class="c">);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="w">i</span><span class="pc">nl</span><span class="c">ine</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">ocfs2_calc_symlink_credits</span><span class="c">(struct</span> <span class="w">su</span><span class="c">per_block</span> <span class="c">*</span><span class="w">s</span><span class="pc">b)</span>
<span class="c">{</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">bl</span><span class="pc">ocks</span> <span class="c">=</span> <span class="w">ocfs2_mknod_credits</span><span class="c">(</span><span class="w">sb</span><span class="pc">,</span> <span class="w">0</span><span class="pc">,</span> <span class="pc">0</span><span class="c">);</span>

	
	<span class="w">bl</span><span class="pc">ocks</span> <span class="w">+</span><span class="pc">=</span> <span class="w">ocfs2_clusters_to_blocks</span><span class="c">(</span><span class="w">sb</span><span class="pc">,</span> <span class="pc">1</span><span class="c">);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">bl</span><span class="c">ocks</span> <span class="w">+</span> <span class="w">o</span><span class="pc">cfs2_q</span><span class="c">uota_trans_credits(</span><span class="w">sb</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">inl</span><span class="c">ine</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">ocfs2_calc_group_alloc_credits</span><span class="c">(struct</span> <span class="w">su</span><span class="c">per_block</span> <span class="c">*sb,</span>
						 <span class="pc">un</span><span class="c">signed</span> <span class="c">int</span> <span class="w">cpg</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">bl</span><span class="c">ocks</span><span class="pc">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">bitmap_blocks</span> <span class="pc">=</span> <span class="w">OCFS2_SUBALLOC_ALLOC</span> <span class="w">+</span> <span class="pc">1</span><span class="c">;</span>
	
	<span class="w">bl</span><span class="pc">o</span><span class="c">cks</span> <span class="c">=</span> <span class="w">1</span> <span class="w">+</span> <span class="pc">1</span> <span class="pc">+</span> <span class="pc">1</span> <span class="w">+</span> <span class="pc">b</span><span class="c">itmap_blocks;</span>
	<span class="w">r</span><span class="c">eturn</span> <span class="w">bl</span><span class="pc">ocks</span><span class="c">;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">inl</span><span class="c">ine</span> <span class="c">int</span> <span class="w">ocfs2_calc_bg_discontig_credits</span><span class="c">(struct</span> <span class="w">su</span><span class="c">per_block</span> <span class="c">*</span><span class="w">s</span><span class="c">b</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">return</span> <span class="w">ocfs2_extent_recs_per_gd</span><span class="c">(</span><span class="w">sb</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">inline</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">ocfs2_calc_tree_trunc_credits</span><span class="c">(struct</span> <span class="w">su</span><span class="c">per_block</span> <span class="c">*</span><span class="w">s</span><span class="pc">b</span><span class="c">,</span>
						<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">clusters_to_del</span><span class="pc">,</span>
						<span class="pc">s</span><span class="c">truct</span> <span class="w">ocfs2_dinode</span> <span class="c">*</span><span class="w">fe</span><span class="c">,</span>
						<span class="c">struct</span> <span class="w">ocfs2_extent_list</span> <span class="c">*</span><span class="w">last_el</span><span class="pc">)</span>
<span class="c">{</span>
 	
	<span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="w">next_free</span> <span class="pc">=</span> <span class="pc">le</span><span class="c">16_to_cpu(</span><span class="pc">l</span><span class="c">ast_el-&gt;</span><span class="w">l_next_free_rec</span><span class="c">);</span>
	<span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="w">tree_depth</span> <span class="pc">=</span> <span class="c">le16_to_cpu(</span><span class="w">f</span><span class="pc">e</span><span class="c">-&gt;</span><span class="w">id2</span><span class="c">.</span><span class="w">i_list</span><span class="pc">.</span><span class="w">l_tree_depth</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">credits</span> <span class="pc">=</span> <span class="w">1</span> <span class="w">+</span> <span class="pc">t</span><span class="c">ree_depth</span> <span class="w">+</span> <span class="c">1</span><span class="pc">;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="pc">i;</span>

	<span class="w">i</span> <span class="c">=</span> <span class="w">n</span><span class="c">ext_free</span> <span class="w">-</span> <span class="c">1;</span>
	<span class="w">B</span><span class="c">UG_ON(</span><span class="pc">i</span> <span class="c">&lt;</span> <span class="c">0</span><span class="pc">);</span>

	
	<span class="c">if</span> <span class="c">(</span><span class="pc">t</span><span class="c">ree_depth</span> <span class="w">&amp;</span><span class="pc">&amp;</span> <span class="pc">n</span><span class="c">ext_free</span> <span class="c">==</span> <span class="pc">1</span> <span class="pc">&amp;</span><span class="c">&amp;</span>
	    <span class="w">ocfs2_rec_clusters</span><span class="c">(</span><span class="w">last_el,</span><span class="pc"> </span><span class="c">&amp;</span><span class="w">l</span><span class="pc">a</span><span class="c">st_el</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">l_recs</span><span class="pc">[</span><span class="c">i</span><span class="w">]) ==</span> <span class="w">clusters_to_del)</span>
		<span class="w">credits</span> <span class="w">+</span><span class="pc">=</span> <span class="c">1</span> <span class="w">+</span> <span class="w">t</span><span class="c">ree_depth;</span>

	
	<span class="w">c</span><span class="pc">r</span><span class="c">edits</span> <span class="w">+</span><span class="c">=</span> <span class="w">OCFS2_TRUNCATE_LOG_UPDATE</span><span class="c">;</span>

	<span class="pc">c</span><span class="c">redits</span> <span class="pc">+</span><span class="c">=</span> <span class="w">ocfs2_quota_trans_credits</span><span class="pc">(</span><span class="w">sb</span><span class="c">);</span>

	<span class="w">r</span><span class="c">eturn</span> <span class="w">c</span><span class="pc">r</span><span class="c">edits;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">inl</span><span class="c">ine</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">ocfs2_jbd2_file_inode</span><span class="c">(</span><span class="w">handle_t</span> <span class="pc">*</span><span class="w">h</span><span class="pc">andle,</span> <span class="c">struct</span> <span class="w">i</span><span class="pc">n</span><span class="c">ode</span> <span class="c">*</span><span class="pc">i</span><span class="c">node</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">return</span> <span class="w">jbd2_journal_file_inode</span><span class="c">(</span><span class="w">h</span><span class="pc">andle, </span><span class="c">&amp;</span><span class="w">OCFS2_I</span><span class="pc">(i</span><span class="c">node</span><span class="w">)</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ip_jinode</span><span class="pc">);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">inline</span> <span class="c">int</span> <span class="w">ocfs2_begin_ordered_truncate</span><span class="c">(struct</span> <span class="c">inode</span> <span class="c">*inode,</span>
					       <span class="w">l</span><span class="pc">of</span><span class="c">f_t</span> <span class="w">new_size</span><span class="c">)</span>
<span class="c">{</span>
	<span class="c">return</span> <span class="w">jbd2_journal_begin_ordered_truncate</span><span class="c">(</span>
				<span class="w">OCFS2_SB</span><span class="pc">(</span><span class="w">i</span><span class="c">node</span><span class="w">-</span><span class="c">&gt;</span><span class="w">i_</span><span class="c">sb</span><span class="w">)-</span><span class="pc">&gt;</span><span class="w">j</span><span class="pc">o</span><span class="c">urnal</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">j_journal</span><span class="pc">,</span>
				<span class="c">&amp;</span><span class="w">O</span><span class="pc">CFS2_I</span><span class="w">(i</span><span class="pc">n</span><span class="c">ode</span><span class="w">)</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i</span><span class="pc">p</span><span class="c">_jinode</span><span class="pc">,</span>
				<span class="c">new_size);</span>
<span class="pc">}</span>

<span class="c">static</span> <span class="c">inline</span> <span class="c">void</span> <span class="w">ocfs2_update_inode_fsync_trans</span><span class="c">(</span><span class="w">handle_t</span> <span class="pc">*</span><span class="w">h</span><span class="pc">andle,</span>
						  <span class="c">struct</span> <span class="pc">i</span><span class="c">node</span> <span class="c">*inode,</span>
						  <span class="pc">int</span> <span class="w">datasync</span><span class="c">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">ocfs2_inode_info</span> <span class="c">*</span><span class="w">oi</span> <span class="c">=</span> <span class="w">O</span><span class="c">CFS2_I(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode);</span>

	<span class="w">o</span><span class="c">i</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_sync_tid</span> <span class="c">=</span> <span class="w">ha</span><span class="pc">ndle-</span><span class="c">&gt;</span><span class="w">h_transaction-</span><span class="c">&gt;</span><span class="w">t_tid</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">d</span><span class="c">atasync</span><span class="pc">)</span>
		<span class="pc">o</span><span class="c">i-&gt;</span><span class="w">i_datasync_tid</span> <span class="c">=</span> <span class="w">h</span><span class="pc">andle-</span><span class="c">&gt;</span><span class="w">h</span><span class="pc">_</span><span class="c">transaction</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">t</span><span class="c">_tid;</span>
<span class="pc">}</span>

<span class="pc">#</span><span class="c">endif</span> 

</pre>
</body>
</html>

